<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedVault</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="/medvault-logo.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-purple': '#7209B7',
                        'brand-lavender': '#B8BDFF',
                        'brand-bg': '#F8F7FF',
                        'brand-peach-light': '#FFEEDD',
                        'brand-peach-dark': '#FFD8BE',
                        'brand-yellow': '#fff380',
                        'brand-yellow-lighter': '#FFFDE7',
                        'brand-pistachio': '#C5E1A5',
                        'brand-pistachio-light': '#F1F8E9',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'serif': ['Playfair Display', 'serif'],
                    },
                    backgroundImage: {
                        'hero-pattern': "url('https://i.pinimg.com/1200x/2b/21/83/2b218345934f046c6dc48881fb743233.jpg')",
                    }
                }
            }
        }
    </script>
    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            gap: 0.25rem;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            font-size: 2.5rem;
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f59e0b; /* amber-500 */
        }
        /* Custom Tailwind Utilities for 70/30 split */
        .lg\:w-7\/10 {
            width: 70%;
        }
        .lg\:w-3\/10 {
            width: 30%;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Sidebar scrollbar - thin purple, always visible */
        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: rgba(114, 9, 183, 0.1);
            border-radius: 2px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: rgba(114, 9, 183, 0.5);
            border-radius: 2px;
            transition: background 0.3s;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(114, 9, 183, 0.8);
        }
        /* Horizontal scrollbar */
        .sidebar-scroll::-webkit-scrollbar:horizontal {
            height: 4px;
        }
    </style>
</head>
<body class="bg-brand-bg">
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- UTILITY FUNCTION ---
    const getISTGreeting = () => {
        const date = new Date();
        // Convert client time to IST string
        const istString = date.toLocaleString("en-US", { timeZone: "Asia/Kolkata" });
        const istDate = new Date(istString);
        const hour = istDate.getHours();

        if (hour >= 0 && hour < 12) return "Good Morning";
        if (hour >= 12 && hour < 17) return "Good Afternoon";
        return "Good Evening";
    };
    const scrollToSection = (id) => {
        const element = document.getElementById(id);
        if (element) {
            // Scroll element into view, aligning it to the start of the viewport
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };
    
    // --- DASHBOARD MENU COMPONENT ---
    const DashboardMenu = ({ menuItems }) => {
        const [isOpen, setIsOpen] = useState(false);
        const menuRef = useRef(null);

        useEffect(() => {
            const handleClickOutside = (event) => {
                if (menuRef.current && !menuRef.current.contains(event.target)) {
                    setIsOpen(false);
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [menuRef]);

        const handleMenuItemClick = (id) => {
            scrollToSection(id);
            setIsOpen(false);
        };

        return (
            <div className="relative inline-block text-left" ref={menuRef}>
                <div>
                    <button
                        type="button"
                        className="p-2 text-slate-600 hover:text-brand-purple"
                        onClick={() => setIsOpen(!isOpen)}
                        aria-expanded={isOpen}
                        aria-haspopup="true"
                    >
                        <i className="fas fa-ellipsis-v text-xl"></i> {/* Three-dot icon */}
                    </button>
                </div>

                {isOpen && (
                    <div
                        className="absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50"
                        role="menu"
                        aria-orientation="vertical"
                    >
                        <div className="py-1" role="none">
                            {menuItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => handleMenuItemClick(item.id)}
                                    className="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-brand-purple transition-colors"
                                    role="menuitem"
                                >
                                    <i className={`fas ${item.icon} mr-2 w-5 text-center`}></i>
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // --- DoctorCard Component ---
    const DoctorCard = ({ doctor }) => (
        <div className="bg-white/70 backdrop-blur-md rounded-2xl shadow-lg p-6 hover:shadow-2xl hover:scale-105 transition-all duration-300 border border-white/50">
            <img src={doctor.image} alt={doctor.name} className="w-32 h-32 rounded-full mx-auto object-cover mb-4 border-4 border-white shadow-md" />
            <h3 className="text-xl font-bold text-slate-800 text-center mt-4">{doctor.name}</h3>
            <p className="text-brand-purple font-semibold text-center">{doctor.specialization}</p>
            <p className="text-slate-600 text-center text-sm mb-4">{doctor.qualification}</p>
            <div className="space-y-2 mt-4">
                <p className="text-sm text-slate-600 flex items-center justify-center gap-2">
                    <i className="fas fa-envelope text-brand-purple"></i>
                    {doctor.email}
                </p>
                <p className="text-sm text-slate-600 text-center italic mt-3">{doctor.description}</p>
            </div>
        </div>
    );

    // --- DoctorsPage Component ---
    const DoctorsPage = ({ onBack }) => {
        const doctors = [
            {
                image: 'https://i.pinimg.com/736x/f4/c9/ef/f4c9ef33d04a22050038e9e53eeb7d85.jpg',
                name: 'Dr. John Smith',
                qualification: 'MDS',
                specialization: 'Dentist',
                email: 'dr.john.smith@medvault.com',
                description: 'A dedicated dentist with 2 years of experience, focusing on family and cosmetic dentistry.'
            },
            {
                image: 'https://t4.ftcdn.net/jpg/03/20/74/45/240_F_320744517_TaGkT7aRlqqWdfGUuzRKDABtFEoN5CiO.jpg',
                name: 'Dr. Asmi Sharma',
                qualification: 'MBBS',
                specialization: 'General Physician',
                email: 'dr.asmi.sharma@medvault.com',
                description: 'Experienced in providing comprehensive primary care for all ages. Committed to your health.'
            },
            {
                image: 'https://i.pinimg.com/1200x/6c/59/95/6c599523460f54ddeba81f3cd689ae04.jpg',
                name: 'Dr. Priya Sharma',
                qualification: 'MD, MBBS',
                specialization: 'General Physician',
                email: 'dr.priya.sharma@medvault.com',
                description: 'A compassionate general physician with over 12 years of experience in internal medicine.'
            },
            {
                image: 'https://i.pinimg.com/736x/f6/2d/a3/f62da3aacbaf68f5a3853da5a20b3fb0.jpg',
                name: 'Dr. Meera Patel',
                qualification: 'MD Pediatrics',
                specialization: 'Pediatrician',
                email: 'dr.meera.patel@medvault.com',
                description: 'Child health specialist with a gentle approach, caring for children from newborns to adolescents.'
            },
            {
                image: 'https://i.pinimg.com/1200x/77/9f/23/779f23ae620f11a2fca378dcf3fe580d.jpg',
                name: 'Dr. Amit Verma',
                qualification: 'DM Cardiology',
                specialization: 'Cardiologist',
                email: 'dr.amit.verma@medvault.com',
                description: 'Heart specialist with expertise in interventional cardiology and preventive cardiac care.'
            }
        ];

        return (
            <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
                <header className="bg-white/70 backdrop-blur-md shadow-sm">
                    <div className="container mx-auto p-4 flex items-center gap-4">
                        <button onClick={onBack} className="text-slate-600 hover:text-purple-600">
                            <i className="fas fa-arrow-left text-xl"></i>
                        </button>
                        <h1 className="text-2xl font-extrabold text-brand-purple flex items-center">
                            <i className="fas fa-user-md text-3xl mr-2"></i>Meet Our Professionals
                        </h1>
                    </div>
                </header>
                
                <main className="container mx-auto p-8">
                    <h2 className="text-4xl font-bold text-slate-800 mb-8 text-center">Our Expert Medical Team</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {doctors.map((doctor, index) => (
                            <DoctorCard key={index} doctor={doctor} />
                        ))}
                    </div>
                </main>
            </div>
        );
    };

    // --- Support Page Component ---
    const SupportPage = ({ onBack }) => {
        const [formData, setFormData] = useState({ name: '', email: '', phone: '', subject: '', message: '' });
        const [expandedFaq, setExpandedFaq] = useState(null);
        const [submitStatus, setSubmitStatus] = useState({ message: '', type: '' });
        const faqs = [
            { q: 'How do I book an appointment?', a: 'Sign in as a patient, navigate to Book Appointment, select a doctor, date, and time, then confirm.' },
            { q: 'Can I cancel my appointment?', a: 'YES, go to your appointments section and click cancel on the appointment you wish to cancel.' },
            { q: 'How do I upload medical records?', a: 'In your dashboard, go to Health Records section and click Add Record to upload documents.' },
            { q: 'Is my data secure?', a: 'YES, we use industry-standard encryption to protect all your medical data.' }
        ];
        
        const handleSubmitIssue = async (e) => {
            e.preventDefault();
            setSubmitStatus({ message: 'Submitting...', type: 'info' });
            try {
                const response = await fetch('http://localhost:8080/api/issues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: formData.name,
                        email: formData.email,
                        phoneNumber: formData.phone,
                        subject: formData.subject || 'Support Request',
                        message: formData.message,
                        userType: 'GUEST'
                    })
                });
                if (response.ok) {
                    setSubmitStatus({ message: '✅ Issue submitted successfully! We will get back to you soon.', type: 'success' });
                    setFormData({ name: '', email: '', phone: '', subject: '', message: '' });
                } else {
                    setSubmitStatus({ message: '❌ Failed to submit issue. Please try again.', type: 'error' });
                }
            } catch (error) {
                setSubmitStatus({ message: '❌ Error: ' + error.message, type: 'error' });
            }
            setTimeout(() => setSubmitStatus({ message: '', type: '' }), 5000);
        };
        
        return (
            <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
                <header className="bg-white shadow-sm">
                    <div className="container mx-auto p-4 flex items-center gap-4">
                        <button onClick={onBack} className="text-slate-600 hover:text-purple-600">
                            <i className="fas fa-arrow-left text-xl"></i>
                        </button>
                        <h1 className="text-2xl font-extrabold text-brand-purple flex items-center">
                            <i className="fas fa-shield-heart text-3xl mr-2"></i>MedVault Support
                        </h1>
                    </div>
                </header>
                
                <main className="container mx-auto p-8">
                    <h2 className="text-4xl font-bold text-slate-800 mb-8 text-center">How can we help you?</h2>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                        <div className="bg-white/70 backdrop-blur-md p-8 rounded-2xl shadow-lg border border-white/50">
                            <h3 className="text-2xl font-bold text-slate-800 mb-6">Submit an Issue</h3>
                            {submitStatus.message && (
                                <div className={`mb-4 p-3 rounded-lg text-center font-medium ${submitStatus.type === 'success' ? 'bg-green-100 text-green-700' : submitStatus.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`}>
                                    {submitStatus.message}
                                </div>
                            )}
                            <form onSubmit={handleSubmitIssue}>
                                <div className="mb-4">
                                    <label className="block text-slate-700 font-semibold mb-2">Name</label>
                                    <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full p-3 border rounded-lg" required />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-slate-700 font-semibold mb-2 flex items-center"><i className="fas fa-envelope mr-2"></i>Email</label>
                                    <input type="email" value={formData.email} onChange={(e) => setFormData({...formData, email: e.target.value})} className="w-full p-3 border rounded-lg" required />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-slate-700 font-semibold mb-2">Phone Number</label>
                                    <input type="tel" value={formData.phone} onChange={(e) => setFormData({...formData, phone: e.target.value})} className="w-full p-3 border rounded-lg" />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-slate-700 font-semibold mb-2">Subject</label>
                                    <input type="text" value={formData.subject} onChange={(e) => setFormData({...formData, subject: e.target.value})} className="w-full p-3 border rounded-lg" placeholder="Brief description of your issue" required />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-slate-700 font-semibold mb-2">Message / Issue Description</label>
                                    <textarea rows="4" value={formData.message} onChange={(e) => setFormData({...formData, message: e.target.value})} className="w-full p-3 border rounded-lg" placeholder="Please describe your issue in detail..." required></textarea>
                                </div>
                                <button type="submit" className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 rounded-lg hover:opacity-90">
                                    Submit Issue
                                </button>
                            </form>
                        </div>
                        
                        <div className="bg-white/70 backdrop-blur-md p-8 rounded-2xl shadow-lg border border-white/50">
                            <h3 className="text-2xl font-bold text-slate-800 mb-6">Frequently Asked Questions</h3>
                            <div className="space-y-3">
                                {faqs.map((faq, i) => (
                                    <div key={i} className="border rounded-lg">
                                        <button onClick={() => setExpandedFaq(expandedFaq === i ? null : i)} className="w-full p-4 text-left font-semibold text-slate-800 hover:bg-slate-50 flex justify-between items-center">
                                            {faq.q}
                                            <i className={`fas fa-chevron-${expandedFaq === i ? 'up' : 'down'}`}></i>
                                        </button>
                                        {expandedFaq === i && (
                                            <div className="p-4 bg-slate-50 text-slate-600 border-t">{faq.a}</div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-white/70 backdrop-blur-md p-8 rounded-2xl shadow-lg border border-white/50">
                        <h3 className="text-2xl font-bold text-slate-800 mb-6 text-center">Contact Information</h3>
                        <div className="flex flex-wrap justify-center gap-8">
                            <div className="flex items-center gap-3">
                                <i className="fas fa-envelope text-2xl text-purple-600"></i>
                                <div>
                                    <p className="font-semibold text-slate-800">Email</p>
                                    <p className="text-slate-600">mahesh123qr@gmail.com</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <i className="fas fa-phone text-2xl text-blue-600"></i>
                                <div>
                                    <p className="font-semibold text-slate-800">Phone</p>
                                    <p className="text-slate-600">+91 8680072366</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <i className="fas fa-map-marker-alt text-2xl text-green-600"></i>
                                <div>
                                    <p className="font-semibold text-slate-800">Address</p>
                                    <p className="text-slate-600">123 Health St, Wellness City, 45678</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <i className="fas fa-globe text-2xl text-pink-600"></i>
                                <div>
                                    <p className="font-semibold text-slate-800">Website</p>
                                    <p className="text-slate-600">www.medvault.com</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        );
    };
    
    // --- Chat Widget Component ---
    const ChatWidget = () => {
        const [isOpen, setIsOpen] = useState(false);
        const [messages, setMessages] = useState([]);
        const [inputValue, setInputValue] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [activeCategoryPhrases, setActiveCategoryPhrases] = useState(null); // New state for category phrases
        const chatBoxRef = useRef(null);

        // Define chatbot categories and phrases
        const chatbotCategories = [
            {
                heading: "Medicine Check",
                phrases: [
                    "I took Aspirin and Ibuprofen together — is it safe?",
                    "Are there interactions between Warfarin and Amiodarone?",
                    "I took two medicines at the same time, what will happen?",
                    "Can I take Metformin after taking Paracetamol?",
                    "Does this medicine interact with my current treatment?"
                ]
            },
            {
                heading: "Symptoms & Triage",
                phrases: [
                    "I have fever and sore throat — which doctor should I see?",
                    "I am having chest pain — what should I do?",
                    "I have stomach pain for 3 days — any suggestions?",
                    "I feel dizzy and weak — is it serious?",
                    "I have skin rashes — which department should I visit?"
                ]
            },
            {
                heading: "Drug Side Effects",
                phrases: [
                    "What are the side effects of Paracetamol?",
                    "Does Ibuprofen cause acidity?",
                    "Is Metformin safe for long-term use?",
                    "Will this medicine make me sleepy?",
                    "Can this medicine affect my kidneys?"
                ]
            },
            {
                heading: "Appointment Help",
                phrases: [
                    "I booked an appointment — when will it be approved?",
                    "How many days until my appointment?",
                    "Can I reschedule my appointment?",
                    "What is the status of my booking?",
                    "My appointment still shows pending — why?"
                ]
            },
            {
                heading: "Doctor Search",
                phrases: [
                    "Find a General Physician near me.",
                    "Show Dermatologists within 10 km.",
                    "Search for Cardiologists available today.",
                    "Who is the best Orthopedic doctor near me?",
                    "Find doctors by specialty."
                ]
            },
            {
                heading: "Report an Issue",
                phrases: [
                    "I submitted an issue — when will it be resolved?",
                    "I can’t upload my lab report — please help.",
                    "My payment failed — what should I do?",
                    "I got the wrong appointment time.",
                    "My prescription is not visible in the app."
                ]
            },
            {
                heading: "Lab Reports & Tests",
                phrases: [
                    "Explain my CBC report.",
                    "What does high cholesterol mean?",
                    "My thyroid (TSH) is high — should I be worried?",
                    "Help me understand my kidney function test.",
                    "What tests should I do for fatigue?"
                ]
            },
            {
                heading: "General Queries",
                phrases: [
                    "What are your clinic working hours?",
                    "How do I upload documents?",
                    "How to contact support?",
                    "Where can I view my prescriptions?",
                    "How to update my profile?"
                ]
            }
        ];

        const fetchInitialGreeting = async () => {
            setIsLoading(true);
            try {
                const response = await fetch('http://localhost:8001/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "INITIAL_GREETING" })
                });
                if (!response.ok) throw new Error('Failed to fetch initial greeting');
                const data = await response.json();
                const welcomeMessage = { sender: 'bot', text: data.reply }; // Initial greeting doesn't send specific suggestions now
                setMessages([welcomeMessage]);
            } catch (error) {
                setMessages([{ sender: 'bot', text: 'Welcome! How can I help?' }]);
            } finally {
                setIsLoading(false);
            }
        };

        useEffect(() => {
            if (isOpen) {
                fetchInitialGreeting();
            }
        }, [isOpen]);

        useEffect(() => {
            if (chatBoxRef.current) {
                chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
            }
        }, [messages]);
        
        const sendMessage = async (messageText) => {
            if (!messageText.trim()) return;

            const userMessage = { sender: 'user', text: messageText };
            setMessages(prev => [...prev, userMessage]);
            setInputValue('');
            setActiveCategoryPhrases(null); // Close phrases drawer after sending
            setIsLoading(true);

            try {
                const response = await fetch('http://localhost:8001/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                const botMessage = { sender: 'bot', text: data.reply, action: data.action }; // Suggestions are now handled by UI
                setMessages(prev => [...prev, botMessage]);

            } catch (error) {
                const errorMessage = { sender: 'bot', text: 'Sorry, I am having trouble connecting. Please try again later.' };
                setMessages(prev => [...prev, errorMessage]);
            } finally {
                setIsLoading(false);
            }
        };


        const handleFormSubmit = (e) => {
            e.preventDefault();
            sendMessage(inputValue);
        };
        
        const handlePhraseClick = (phrase) => {
            setInputValue(phrase);
            setActiveCategoryPhrases(null); // Close drawer after selecting a phrase
            // Optionally, send the message directly:
            // sendMessage(phrase);
        };

        const handleCategoryClick = (categoryHeading) => {
            if (activeCategoryPhrases && activeCategoryPhrases.heading === categoryHeading) {
                setActiveCategoryPhrases(null); // Close if already open
            } else {
                const category = chatbotCategories.find(cat => cat.heading === categoryHeading);
                setActiveCategoryPhrases(category);
            }
        };

        const handleActionClick = (action) => {
            if (action === 'BOOK_NOW') {
                 // This will now trigger the main app's routing to the patient registration flow
                 window.location.hash = 'patient';
                 setIsOpen(false);
            }
        };

        if (!isOpen) {
            return (
                <div className="fixed bottom-8 right-8 z-50 flex flex-col items-end gap-3">
                    {/* Floating message bubble - now above the button */}
                    <div className="bg-white px-4 py-2 rounded-2xl shadow-xl border-2 border-brand-purple/30 max-w-xs">
                        <p className="text-sm font-semibold text-slate-700">
                            How may I help you?
                        </p>
                    </div>
                    {/* Chat button */}
                    <button
                        onClick={() => setIsOpen(true)}
                        className="bg-brand-purple text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center hover:bg-purple-700 transition-all hover:scale-110"
                    >
                        <img src="/medbuddy_icon.svg" alt="MedBuddy Icon" className="w-8 h-8" />
                    </button>
                </div>
            );
        }

        return (
            <div className="fixed bottom-8 right-8 w-96 h-[600px] bg-white rounded-2xl shadow-2xl flex flex-col z-50 border-2 border-brand-purple/50">
                {/* Header */}
                <div className="bg-brand-purple text-white p-4 rounded-t-xl flex justify-between items-center">
                    <h3 className="font-bold text-lg">MedBuddy</h3>
                    <button onClick={() => setIsOpen(false)} className="hover:text-purple-200">
                        <i className="fas fa-times text-xl"></i>
                    </button>
                </div>

                {/* Messages */}
                <div ref={chatBoxRef} className="flex-1 p-4 overflow-y-auto bg-slate-50 space-y-4">
                    {messages.map((msg, index) => (
                        <div key={index}>
                            <div className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`p-3 rounded-xl max-w-xs ${msg.sender === 'user' ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-800'}`}>
                                    <p>{msg.text}</p>
                                    {msg.action && (
                                         <button
                                            onClick={() => handleActionClick(msg.action)}
                                            className="mt-2 bg-white text-brand-purple font-bold py-2 px-4 rounded-lg shadow hover:bg-slate-100"
                                        >
                                            Book Now
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                    {isLoading && (
                        <div className="flex justify-start">
                             <div className="p-3 rounded-xl bg-slate-200 text-slate-500">
                                ...
                             </div>
                        </div>
                    )}
                </div>
                
                {/* Master Headings (Categories) */}
                <div className="p-2 bg-white border-t border-b overflow-x-auto whitespace-nowrap scrollbar-hide">
                    {chatbotCategories.map((category) => (
                        <button
                            key={category.heading}
                            onClick={() => handleCategoryClick(category.heading)}
                            className={`inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-full transition-colors duration-200 ease-in-out m-1
                                ${activeCategoryPhrases && activeCategoryPhrases.heading === category.heading
                                    ? 'bg-brand-purple text-white shadow-lg'
                                    : 'bg-purple-100 text-brand-purple hover:bg-purple-200'}`
                            }
                        >
                            {category.heading}
                        </button>
                    ))}
                </div>

                {/* Suggested Phrases Drawer */}
                {activeCategoryPhrases && (
                    <div className="p-4 bg-white shadow-inner border-t">
                        <ul className="space-y-2">
                            {activeCategoryPhrases.phrases.map((phrase, index) => (
                                <li key={index}>
                                    <button
                                        onClick={() => handlePhraseClick(phrase)}
                                        className="w-full text-left text-sm text-slate-700 hover:text-brand-purple hover:bg-slate-50 p-2 rounded-lg transition-colors"
                                    >
                                        • {phrase}
                                    </button>
                                </li>
                            ))}
                        </ul>
                    </div>
                )}

                {/* Input */}
                <form onSubmit={handleFormSubmit} className="p-4 border-t bg-white rounded-b-xl">
                    <div className="flex gap-2">
                        <input
                            type="text"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            className="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-brand-purple"
                            placeholder="Ask me anything..."
                            disabled={isLoading}
                        />
                        <button type="submit" className="bg-brand-purple text-white px-4 rounded-lg font-bold hover:bg-purple-700" disabled={isLoading}>
                            <i className="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        );
    };

    // --- Main App Component ---
    const App = () => {
        const [page, setPage] = useState('home');
        const [selectedRole, setSelectedRole] = useState(null);
        const [authBackPage, setAuthBackPage] = useState('role_select');
        const [loggedInUser, setLoggedInUser] = useState(null);

        // Restore user from sessionStorage on page load
        useEffect(() => {
            const storedUser = sessionStorage.getItem('loggedInUser');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    setLoggedInUser(userData);
                } catch (e) {
                    console.error('Failed to parse stored user data', e);
                    sessionStorage.removeItem('loggedInUser');
                }
            }
        }, []);

        const navigateTo = (targetPage, role = null, backTarget = null) => {
            window.scrollTo(0, 0);
            setPage(targetPage);
            if (role) setSelectedRole(role);
            if (backTarget) setAuthBackPage(backTarget);
            
            // Update URL hash based on page
            if (targetPage === 'home') {
                window.location.hash = '';
            } else if (targetPage === 'role_select') {
                window.location.hash = 'role-selection';
            } else if (targetPage === 'auth' && role) {
                window.location.hash = `${role}`;
            } else if (targetPage === 'dashboard' && role) {
                // Use role-dashboard for all roles
                window.location.hash = `${role}-dashboard`;
            } else if (targetPage === 'support') {
                window.location.hash = 'support';
            } else if (targetPage === 'doctors') {
                window.location.hash = 'doctors';
            }
        };
        
        // --- Hash-based Routing Hook ---
        useEffect(() => {
            const checkHash = () => {
                const hash = window.location.hash.replace('#', '');
                
                // Handle empty hash (home page)
                if (!hash || hash === '') {
                    if (page !== 'home' && !loggedInUser) {
                        setPage('home');
                    }
                    return;
                }
                
                // Handle role selection
                if (hash === 'role-selection') {
                    if (!loggedInUser) {
                        setPage('role_select');
                    }
                    return;
                }
                
                // Handle patient (auth or dashboard)
                if (hash === 'patient') {
                    if (loggedInUser && loggedInUser.role === 'patient') {
                        // If logged in, redirect to dashboard
                        window.location.hash = 'patient-dashboard';
                    } else if (!loggedInUser) {
                        // If not logged in, show auth page
                        setPage('auth');
                        setSelectedRole('patient');
                        setAuthBackPage('role_select');
                    }
                    return;
                }
                
                // Handle patient dashboard
                if (hash === 'patient-dashboard') {
                    if (loggedInUser && loggedInUser.role === 'patient') {
                        setPage('dashboard');
                    } else if (!loggedInUser) {
                        // Redirect to patient login if not logged in
                        setPage('auth');
                        setSelectedRole('patient');
                        setAuthBackPage('home');
                    }
                    return;
                }
                
                // Handle doctor (auth or dashboard)
                if (hash === 'doctor') {
                    if (loggedInUser && loggedInUser.role === 'doctor') {
                        // If logged in, redirect to dashboard
                        window.location.hash = 'doctor-dashboard';
                    } else if (!loggedInUser) {
                        // If not logged in, show auth page
                        setPage('auth');
                        setSelectedRole('doctor');
                        setAuthBackPage('home');
                    }
                    return;
                }
                
                // Handle doctor dashboard
                if (hash === 'doctor-dashboard') {
                    if (loggedInUser && loggedInUser.role === 'doctor') {
                        setPage('dashboard');
                    } else if (!loggedInUser) {
                        setPage('auth');
                        setSelectedRole('doctor');
                        setAuthBackPage('home');
                    }
                    return;
                }
                
                // Admin is handled by separate admin.html file - no routing needed here
                
                // Handle support page
                if (hash === 'support') {
                    setPage('support');
                    return;
                }
                
                // Handle doctors page
                if (hash === 'our-doctors') {
                    setPage('doctors');
                    return;
                }
                
                // Handle register with parameters
                if (hash === 'register' || hash.startsWith('register?')) {
                    const hashParams = new URLSearchParams(hash.replace('register?', '').replace('register', ''));
                    const role = hashParams.get('role');
                    const email = hashParams.get('email');
                    
                    if (!loggedInUser) {
                        if (role === 'doctor') {
                            setPage('auth');
                            setSelectedRole('doctor');
                            setAuthBackPage('home');
                            if (email) {
                                sessionStorage.setItem('invitedDoctorEmail', email);
                            }
                        } else if (role === 'patient') {
                            setPage('auth');
                            setSelectedRole('patient');
                            setAuthBackPage('home');
                        } else {
                            setPage('auth');
                            setSelectedRole('patient');
                            setAuthBackPage('home');
                        }
                    }
                    return;
                }
                
                // Handle login with parameters
                if (hash === 'login' || hash.startsWith('login?')) {
                    const hashParams = new URLSearchParams(hash.replace('login?', '').replace('login', ''));
                    const role = hashParams.get('role');
                    
                    if (!loggedInUser) {
                        if (role === 'doctor') {
                            setPage('auth');
                            setSelectedRole('doctor');
                            setAuthBackPage('home');
                        } else {
                            setPage('auth');
                            setSelectedRole('patient');
                            setAuthBackPage('home');
                        }
                    }
                    return;
                }
            };
            
            // Check hash on mount and when it changes
            checkHash(); 
            
            window.addEventListener('hashchange', checkHash); 
            
            return () => {
                window.removeEventListener('hashchange', checkHash);
            };
        }, [loggedInUser, page]); 


        const handleLoginSuccess = (userData) => {
            setLoggedInUser(userData);
            // Store user data in sessionStorage to persist across page reloads
            sessionStorage.setItem('loggedInUser', JSON.stringify(userData));
            navigateTo('dashboard', userData.role);
        };

        const handleLogout = () => {
            const userRole = loggedInUser?.role;
            setLoggedInUser(null);
            // Clear sessionStorage on logout
            sessionStorage.removeItem('loggedInUser');
            
            // Redirect based on user role
            if (userRole === 'patient') {
                setPage('patient-login');
                window.location.hash = '#patient';
            } else if (userRole === 'doctor') {
                setPage('doctor-login');
                window.location.hash = '#doctor';
            } else {
                setPage('home');
                window.location.hash = '';
            }
        };

        const renderPage = () => {
        // --- NEW LOGIC ---
        // 1. Check for special pages like 'support' first.
        if (page === 'support') {
            // If we are logged in, the 'Back' button should go to the dashboard, not 'home'.
            const onBackAction = loggedInUser 
                ? () => navigateTo('dashboard', loggedInUser.role) 
                : () => navigateTo('home');
            
            return <SupportPage onBack={onBackAction} />;
        }

        
        if (page === 'doctors') {
            const onBackAction = loggedInUser 
                ? () => navigateTo('dashboard', loggedInUser.role) 
                : () => navigateTo('home');
            return <DoctorsPage onBack={onBackAction} />;
        }

        // --- EXISTING LOGIC (MOVED) ---
        // 2. If not a special page, THEN check if we are logged in.
        if (loggedInUser) {
            switch(loggedInUser.role) {
                case 'patient':
                    return <PatientDashboard user={loggedInUser} onLogout={handleLogout} />;
                case 'doctor':
                    return <DoctorDashboard user={loggedInUser} onLogout={handleLogout} />;
                default:
                    // Admin uses separate admin.html file
                    return <div className="p-8"><h1>Dashboard for {loggedInUser.role}</h1><button onClick={handleLogout}>Logout</button></div>
            }
        }

        // --- EXISTING LOGIC (MOVED) ---
        // 3. If not logged in and not on a special page, show public pages.
        switch (page) {
            case 'auth':
                return <AuthPage role={selectedRole} onBack={() => navigateTo('home')} onLoginSuccess={handleLoginSuccess} />;
            case 'home':
            default:
                return <HomePage
                    onNavigateToPatientAuth={() => navigateTo('auth', 'patient', 'home')}
                    loggedIn={!!loggedInUser}
                    onLogout={handleLogout}
                    onNavigateToDashboard={() => navigateTo('dashboard', loggedInUser.role)}
                />;
        }
    };

        return (
            <div>
                {renderPage()}
                <ChatWidget />
            </div>
        );
    };

    // --- Static Page Components (Unchanged) ---
    const HomePage = ({ onNavigateToRoleSelect, onNavigateToPatientAuth, loggedIn, onLogout, onNavigateToDashboard }) => {
        const [activeSection, setActiveSection] = useState('');
        
        useEffect(() => {
            // Track hash changes
            const handleHashChange = () => {
                const hash = window.location.hash.replace('#', '');
                setActiveSection(hash);
            };
            
            handleHashChange();
            window.addEventListener('hashchange', handleHashChange);
            
            // Intersection Observer to detect visible sections
            const sections = ['about', 'shop', 'checkups', 'services', 'our-doctors', 'contact-support'];
            const observerOptions = {
                root: null,
                rootMargin: '-50% 0px -50% 0px',
                threshold: 0
            };
            
            const observerCallback = (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const sectionId = entry.target.id;
                        setActiveSection(sectionId);
                        // Update hash without scrolling
                        if (sectionId) {
                            window.history.replaceState(null, null, `#${sectionId}`);
                        } else {
                            window.history.replaceState(null, null, window.location.pathname);
                        }
                    }
                });
            };
            
            const observer = new IntersectionObserver(observerCallback, observerOptions);
            
            // Observe all sections
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) observer.observe(element);
            });
            
            // Observe hero section for "Home"
            const heroSection = document.querySelector('.hero-section');
            if (heroSection) {
                heroSection.id = 'home-section';
                observer.observe(heroSection);
            }
            
            return () => {
                window.removeEventListener('hashchange', handleHashChange);
                observer.disconnect();
            };
        }, []);
        
        const getLinkClass = (section) => {
            // Handle home section specially
            if (section === '' && (activeSection === '' || activeSection === 'home-section')) {
                return 'text-brand-purple font-bold border-b-2 border-brand-purple';
            }
            return activeSection === section 
                ? 'text-brand-purple font-bold border-b-2 border-brand-purple' 
                : 'hover:text-brand-purple';
        };
        
        return (
            <div className="bg-white">
                <header className="sticky top-0 bg-white/95 backdrop-blur-lg z-20 shadow-sm border-b">
                    <div className="container mx-auto p-4 flex justify-between items-center">
                        <h1 className="text-2xl font-extrabold text-brand-purple flex items-center cursor-pointer" onClick={() => window.location.reload()}>
                            <i className="fas fa-shield-heart text-3xl mr-2"></i>
                            MedVault </h1>
                        <nav className="hidden md:flex items-center gap-6 text-slate-600 font-semibold">
                            <a href="#" className={getLinkClass('')}>Home</a>
                            <a href="#about" className={getLinkClass('about')}>About</a>
                            <a href="#shop" className={getLinkClass('shop')}>Shop</a>
                            <a href="#checkups" className={getLinkClass('checkups')}>Packages</a>
                            <a href="#services" className={getLinkClass('services')}>Services</a>
                            <a href="#our-doctors" onClick={(e) => { e.preventDefault(); window.location.hash = 'our-doctors'; }} className={`${getLinkClass('our-doctors')} cursor-pointer`}>Know Our Doctors</a>
                            <a href="#contact-support" className={getLinkClass('contact-support')}>Contact</a>
                        </nav>
                        <div className="flex items-center gap-4">
                            {loggedIn ? (
                                <>
                                    <button onClick={onNavigateToDashboard} className="bg-brand-purple text-white px-4 py-2 rounded-full font-semibold hover:bg-purple-700 flex items-center gap-2">
                                        <i className="fas fa-tachometer-alt"></i> Dashboard
                                    </button>
                                    <button onClick={onLogout} className="text-slate-600 hover:text-red-500 font-semibold">
                                        <i className="fas fa-sign-out-alt"></i>
                                    </button>
                                </>
                            ) : (
                                <button onClick={onNavigateToPatientAuth} className="bg-gradient-to-r from-purple-600 to-brand-purple text-white px-6 py-2 rounded-full font-bold hover:shadow-lg transition-all">
                                    Sign In / Sign Up
                                </button>
                            )}
                        </div>
                    </div>
                </header>
                
                {/* Hero Section */}
                <main className="relative overflow-hidden" style={{backgroundImage: 'url("https://i.pinimg.com/1200x/2b/21/83/2b218345934f046c6dc48881fb743233.jpg")', backgroundSize: 'cover', backgroundPosition: 'top'}}>
                    <div className="absolute inset-0 bg-white/60"></div>
                    <div className="container mx-auto px-8 py-16 relative z-10 max-w-6xl">
                        <div className="grid md:grid-cols-2 gap-8 items-start">
                            <div>
                                <h2 className="text-5xl font-extrabold text-slate-900 mb-4 leading-tight drop-shadow-lg font-serif">The Future of <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">Healthcare</span></h2>
                                <p className="text-lg text-slate-800 font-semibold mb-6 leading-relaxed">
                                    Securely manage your medical records, book appointments with top professionals, and take control of your health journey with MedVault.
                                </p>
                                <div className="flex gap-4">
                                    <button onClick={onNavigateToPatientAuth} className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-full font-bold text-lg hover:shadow-2xl hover:scale-110 hover:from-pink-600 hover:to-orange-500 transition-all">
                                        Book Appointment
                                    </button>
                                    <button onClick={() => scrollToSection('about')} className="bg-white text-purple-600 px-8 py-4 rounded-full font-bold text-lg border-2 border-purple-600 hover:bg-gradient-to-r hover:from-purple-600 hover:to-pink-600 hover:text-white hover:scale-105 transition-all">
                                        Learn More
                                    </button>
                                </div>
                            </div>
                            <div></div>
                        </div>
                        <div className="relative mt-12">
                            <div className="flex gap-4">
                                <div className="bg-white/70 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/50 flex-1">
                                    <p className="text-4xl font-extrabold text-purple-600 mb-1">30+</p>
                                    <p className="text-sm text-slate-700 font-medium">Years Experience</p>
                                </div>
                                <div className="bg-white/70 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/50 flex-1">
                                    <p className="text-4xl font-extrabold text-blue-600 mb-1">4,500+</p>
                                    <p className="text-sm text-slate-700 font-medium">Happy Patients</p>
                                </div>
                                <div className="bg-white/70 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/50 flex-1">
                                    <p className="text-4xl font-extrabold text-green-600 mb-1">84+</p>
                                    <p className="text-sm text-slate-700 font-medium">Professionals</p>
                                </div>
                                <div className="bg-white/70 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/50 flex-1">
                                    <p className="text-4xl font-extrabold text-pink-600 mb-1">300+</p>
                                    <p className="text-sm text-slate-700 font-medium">Support Staff</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                
                {/* Medical News Section */}
                <section className="py-16 px-8 bg-gradient-to-br from-slate-50 to-slate-100">
                    <div className="container mx-auto">
                        <div className="mb-8 text-center">
                            <h2 className="text-4xl font-bold text-slate-800 mb-2 flex items-center justify-center">
                                <i className="fas fa-newspaper text-purple-600 mr-3"></i> Recent Medical News
                            </h2>
                            <p className="text-slate-600">Stay updated with breakthroughs, research, and global health developments</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                            <div className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all cursor-pointer">
                                <img src="https://www.news-medical.net/image-handler/ts/20170407035009/ri/350/picture/2017/4/Blood_pressure_measuring-Sappasit_c7dd0e34690648c9b114f8414f59e269-620x480.jpg" alt="Blood Pressure" className="w-full h-40 object-cover" />
                                <div className="p-4">
                                    <p className="text-sm font-semibold text-slate-800 leading-tight">Adolescents with migraines likely to have high blood pressure</p>
                                    <p className="text-xs text-slate-500 mt-2">Recent studies show correlation between migraines and hypertension in teens</p>
                                </div>
                            </div>
                            <div className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all cursor-pointer">
                                <img src="https://www.news-medical.net/image-handler/ts/20180706063721/ri/350/picture/2018/7/Red_eye_for_allergy_-_sruilk_M3_04161d0d61de409b863eee9f8a1f46e8-620x480.jpg" alt="Allergy" className="w-full h-40 object-cover" />
                                <div className="p-4">
                                    <p className="text-sm font-semibold text-slate-800 leading-tight">Reluctance among obstetricians to refer pregnant patients to allergy specialists</p>
                                    <p className="text-xs text-slate-500 mt-2">Study reveals gaps in allergy care during pregnancy</p>
                                </div>
                            </div>
                            <div className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all cursor-pointer">
                                <img src="https://www.news-medical.net/image-handler/ts/20160209090612/ri/350/picture/2016/2/shutterstock_332159408_21374075cfba45e28314da6171c8137b-620x480.jpg" alt="Asthma" className="w-full h-40 object-cover" />
                                <div className="p-4">
                                    <p className="text-sm font-semibold text-slate-800 leading-tight">Thunderstorms trigger asthma emergency visits</p>
                                    <p className="text-xs text-slate-500 mt-2">Weather patterns linked to respiratory emergencies</p>
                                </div>
                            </div>
                            <div className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all cursor-pointer">
                                <img src="https://www.sapnamed.com/wp-content/uploads/2021/03/difference-between-headaches-and-migraines-1200x800.jpg" alt="Headaches" className="w-full h-40 object-cover" />
                                <div className="p-4">
                                    <p className="text-sm font-semibold text-slate-800 leading-tight">How caffeine can help you manage headaches and other tips</p>
                                    <p className="text-xs text-slate-500 mt-2">Moderate caffeine intake may help reduce headache pain</p>
                                </div>
                            </div>
                            <div className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all cursor-pointer">
                                <img src="https://www.childrenscolorado.org/globalassets/parenting-advice/articles/cold-vs-flu-article-image_1280x720.jpeg" alt="Flu Season" className="w-full h-40 object-cover" />
                                <div className="p-4">
                                    <p className="text-sm font-semibold text-slate-800 leading-tight">Health officials worried as flu season comes five weeks early</p>
                                    <p className="text-xs text-slate-500 mt-2">Earlier-than-usual flu activity raising concerns</p>
                                </div>
                            </div>
                            <div className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all cursor-pointer">
                                <img src="https://i0.wp.com/www.sciencenews.org/wp-content/uploads/2025/03/030425_mr_SSRIs_feat.jpg" alt="Antidepressants" className="w-full h-40 object-cover" />
                                <div className="p-4">
                                    <p className="text-sm font-semibold text-slate-800 leading-tight">Effects of antidepressants on physical health ranked for first time</p>
                                    <p className="text-xs text-slate-500 mt-2">Study compares antidepressants impact on weight and metabolism</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                {/* About Section */}
                <section id="about" className="py-16 px-8 bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
                    <div className="container mx-auto text-center max-w-5xl">
                        <div className="bg-white/95 backdrop-blur-sm rounded-3xl shadow-xl p-12 border border-purple-100">
                            <div className="mb-4">
                                <i className="fas fa-shield-heart text-5xl text-purple-600 mb-3"></i>
                            </div>
                            <h2 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 mb-4">About MedVault</h2>
                            <p className="text-slate-700 text-lg leading-relaxed mb-6">MedVault is reimagining how individuals interact with their health data. Our mission is to create a unified health experience where patients, doctors, and caregivers work together effortlessly. Through secure digital record management, real-time communication, and personalized care tools, MedVault aims to build a future where healthcare is more transparent, accessible, and empowering for everyone.</p>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                <div className="rounded-xl overflow-hidden shadow-lg">
                                    <img src="https://i.pinimg.com/736x/5f/2d/22/5f2d223bda16519ab98be294fc2c372c.jpg" alt="Medical Team" className="w-full h-48 object-cover" />
                                </div>
                                <div className="rounded-xl overflow-hidden shadow-lg">
                                    <img src="https://i.pinimg.com/1200x/a3/49/0d/a3490d94e72bea469dc193034de1c864.jpg" alt="Healthcare" className="w-full h-48 object-cover" />
                                </div>
                                <div className="rounded-xl overflow-hidden shadow-lg">
                                    <img src="https://i.pinimg.com/1200x/04/0a/f4/040af4ba6c4c22d9a4dbcd344b91dbb7.jpg" alt="Medical Care" className="w-full h-48 object-cover" />
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                {/* Shop by Categories */}
                <section id="shop" className="py-20 px-8" style={{background: 'linear-gradient(to bottom right, #F1F8E9, #E8F5E9, #DCEDC8)'}}>
                    <div className="container mx-auto">
                        <h2 className="text-4xl font-bold text-slate-800 mb-4 text-center">Shop by Health Essentials</h2>
                        <p className="text-slate-600 text-center mb-12">Your daily healthcare needs, delivered</p>
                        <div className="relative">
                            <button onClick={() => document.getElementById('shop-scroll').scrollBy({left: -300, behavior: 'smooth'})} className="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white p-3 rounded-full shadow-lg">
                                <i className="fas fa-chevron-left text-2xl text-slate-800"></i>
                            </button>
                            <div id="shop-scroll" className="flex gap-6 overflow-x-auto scrollbar-hide scroll-smooth pb-4" style={{scrollbarWidth: 'none', msOverflowStyle: 'none'}}>
                                {[
                                    {name: 'Must Haves', img: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=200'},
                                    {name: 'Personal Care', img: 'https://cdn.thewirecutter.com/wp-content/media/2024/12/ROUNDUP-KOREAN-SKINCARE-2048px-9732-3x2-1.jpg?auto=webp&quality=75&crop=4:3,smart&width=1024'},
                                    {name: 'Vitamins', img: 'https://cdn-magazine.nutrabay.com/wp-content/uploads/2022/10/Pills-1067x800-1.jpg'},
                                    {name: 'Diabetes Care', img: 'https://images.unsplash.com/photo-1615486511484-92e172cc4fe0?w=200'},
                                    {name: 'Sports Nutrition', img: 'https://images.unsplash.com/photo-1593095948071-474c5cc2989d?w=200'},
                                    {name: 'Mother & Baby', img: 'https://images.unsplash.com/photo-1515488042361-ee00e0ddd4e4?w=200'},
                                    {name: 'Wellness Packs', img: 'https://images.unsplash.com/photo-1505751172876-fa1923c5c528?w=200'},
                                    {name: 'Ayurveda', img: 'https://images.unsplash.com/photo-1608571423902-eed4a5ad8108?w=200'}
                                ].map((cat, i) => (
                                    <div key={i} className="flex-shrink-0 w-64 bg-white p-4 rounded-2xl shadow-lg hover:shadow-2xl hover:scale-105 transition-all cursor-pointer text-center">
                                        <img src={cat.img} alt={cat.name} className="w-full h-32 object-cover rounded-xl mb-3" />
                                        <p className="font-bold text-slate-800">{cat.name}</p>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => document.getElementById('shop-scroll').scrollBy({left: 300, behavior: 'smooth'})} className="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white p-3 rounded-full shadow-lg">
                                <i className="fas fa-chevron-right text-2xl text-slate-800"></i>
                            </button>
                        </div>
                    </div>
                </section>
                
                {/* Health Checkup Packages */}
                <section id="checkups" className="py-20 px-8 bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
                    <div className="container mx-auto">
                        <div className="text-center mb-12">
                            <h2 className="text-4xl font-bold text-slate-800 mb-4">Frequently Booked Health Checkups</h2>
                        </div>
                        <div className="grid md:grid-cols-4 gap-8">
                            {[
                                {name: 'Full Body Checkup', discount: '60%', price: '₹999', original: '₹2499', desc: 'Complete health screening', color: 'purple'},
                                {name: 'Diabetes Package', discount: '50%', price: '₹599', original: '₹1199', desc: 'Blood sugar monitoring', color: 'pink'},
                                {name: 'Heart Health', discount: '55%', price: '₹799', original: '₹1799', desc: 'Cardiac wellness check', color: 'blue'},
                                {name: 'Thyroid Profile', discount: '45%', price: '₹499', original: '₹899', desc: 'Thyroid function tests', color: 'indigo'}
                            ].map((pkg, i) => (
                                <div key={i} className="bg-white rounded-3xl shadow-xl p-6 hover:shadow-2xl hover:scale-105 transition-all relative overflow-hidden">
                                    <span className={`absolute top-4 right-4 bg-${pkg.color}-500 text-white px-2 py-0.5 rounded-full text-xs font-bold`}>{pkg.discount} OFF</span>
                                    <div className="mb-4">
                                        <h3 className="text-lg font-bold text-slate-800 mb-2">{pkg.name}</h3>
                                        <p className="text-slate-600">{pkg.desc}</p>
                                    </div>
                                    <div className="mb-6">
                                        <span className="text-slate-400 line-through text-lg">{pkg.original}</span>
                                        <span className={`text-4xl font-bold text-${pkg.color}-600 ml-3`}>{pkg.price}</span>
                                    </div>
                                    <button className={`w-full bg-gradient-to-r from-${pkg.color}-500 to-${pkg.color}-600 text-white py-3 rounded-full font-bold hover:shadow-2xl hover:scale-105 hover:from-${pkg.color}-600 hover:to-${pkg.color}-700 transition-all`}>
                                        Book Now
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </section>

                
                {/* Our Services Section */}
                <section id="services" className="py-20 px-8 bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100">
                    <div className="container mx-auto text-center">
                        <h2 className="text-4xl font-bold text-slate-800 mb-4">Our Services</h2>
                        <p className="text-slate-600 mb-12">Comprehensive healthcare solutions tailored for you</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition-all">
                                <div className="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fas fa-laptop-medical text-white text-2xl"></i>
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Advanced Technology</h3>
                                <p className="text-slate-600 text-sm">State-of-the-art equipment ensuring reliable care.</p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition-all">
                                <div className="w-16 h-16 bg-gradient-to-br from-green-400 to-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fas fa-couch text-white text-2xl"></i>
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Comfortable Environment</h3>
                                <p className="text-slate-600 text-sm">Designed to make your healthcare experience stress-free.</p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition-all">
                                <div className="w-16 h-16 bg-gradient-to-br from-purple-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fas fa-user-md text-white text-2xl"></i>
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Expert Doctors</h3>
                                <p className="text-slate-600 text-sm">Connect with certified healthcare professionals across all specializations</p>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition-all">
                                <div className="w-16 h-16 bg-gradient-to-br from-red-400 to-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fas fa-ambulance text-white text-2xl"></i>
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Emergency Support</h3>
                                <p className="text-slate-600 text-sm">24/7 emergency support with instant doctor connectivity</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                {/* Contact & Support Section */}
                <section id="contact-support" className="py-20 px-8 bg-gradient-to-br from-slate-50 to-slate-100">
                    <div className="container mx-auto">
                        <h2 className="text-4xl font-bold text-slate-800 mb-12 text-center">Contact & Support</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-xl shadow-md text-center">
                                <i className="fas fa-map-marker-alt text-3xl text-purple-600 mb-3"></i>
                                <h3 className="font-bold text-slate-800 mb-2">Office</h3>
                                <p className="text-slate-600 text-sm">123 Health St, Wellness City, 45678</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-md text-center">
                                <i className="fas fa-phone text-3xl text-blue-600 mb-3"></i>
                                <h3 className="font-bold text-slate-800 mb-2">Phone Number</h3>
                                <p className="text-slate-600 text-sm">+91 8680072366</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-md text-center">
                                <i className="fas fa-envelope text-3xl text-green-600 mb-3"></i>
                                <h3 className="font-bold text-slate-800 mb-2">Email</h3>
                                <p className="text-slate-600 text-sm">mahesh123qr@gmail.com</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-md text-center">
                                <i className="fas fa-globe text-3xl text-pink-600 mb-3"></i>
                                <h3 className="font-bold text-slate-800 mb-2">Website</h3>
                                <p className="text-slate-600 text-sm">www.medvault.com</p>
                            </div>
                        </div>
                        <div className="text-center">
                            <button onClick={() => window.location.hash = 'support'} className="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 px-12 rounded-full hover:shadow-2xl hover:scale-105 transition-all text-lg">
                                <i className="fas fa-headset mr-2"></i>Contact Support
                            </button>
                        </div>
                    </div>
                </section>
                
                {/* CTA Section */}
                <section className="py-20 px-8 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 text-white">
                    <div className="container mx-auto text-center">
                        <h2 className="text-5xl font-extrabold mb-4">Ready to Take Control of Your Health?</h2>
                        <p className="text-purple-100 max-w-2xl mx-auto mb-8 text-lg">Join thousands of patients managing their healthcare journey with MedVault</p>
                        <button onClick={onNavigateToPatientAuth} className="bg-white text-purple-600 font-bold py-4 px-12 rounded-full hover:shadow-2xl hover:scale-110 hover:bg-gradient-to-r hover:from-yellow-400 hover:to-orange-400 hover:text-white transition-all text-xl">
                            Book Your Appointment
                        </button>
                    </div>
                </section>
                <Footer />
            </div>
        );
    };
    const Footer = ({}) => (
        <footer id="contact" className="bg-slate-900 text-slate-300 py-16 px-8">
            <div className="container mx-auto">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-12 mb-12">
                    <div>
                        <h3 className="text-xl font-bold text-white mb-4 flex items-center"><i className="fas fa-shield-heart mr-2 text-purple-400"></i>MedVault</h3>
                        <p className="text-sm">Your trusted healthcare partner. Secure, reliable, and always here for you.</p>
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-white mb-4">Quick Links</h3>
                        <div className="space-y-2 text-sm">
                            <p className="hover:text-purple-400 cursor-pointer">About Us</p>
                            <p className="hover:text-purple-400 cursor-pointer">Services</p>
                            <p className="hover:text-purple-400 cursor-pointer">Doctors</p>
                            <p className="hover:text-purple-400 cursor-pointer">Contact</p>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-white mb-4">Contact</h3>
                        <p className="text-sm mb-2"><i className="fas fa-map-marker-alt mr-2 text-purple-400"></i>123 Health St, Wellness City, 45678</p>
                        <p className="text-sm mb-2"><i className="fas fa-envelope mr-2 text-purple-400"></i>mahesh123qr@gmail.com</p>
                        <p className="text-sm"><i className="fas fa-phone mr-2 text-purple-400"></i>+91 8680072366</p>
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-white mb-4">Follow Us</h3>
                        <div className="flex gap-4 items-center">
                            <a href="#" className="hover:opacity-70 transition-opacity"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Instagram_logo_2016.svg/198px-Instagram_logo_2016.svg.png" alt="Instagram" className="h-6" /></a>
                            <a href="#" className="hover:opacity-70 transition-opacity"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/2023_Facebook_icon.svg/800px-2023_Facebook_icon.svg.png" alt="Facebook" className="h-6" /></a>
                            <a href="#" className="hover:opacity-70 transition-opacity"><img src="https://upload.wikimedia.org/wikipedia/commons/5/57/X_logo_2023_%28white%29.png" alt="X" className="h-5" /></a>
                            <a href="#" className="hover:opacity-70 transition-opacity"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/Linked-in-alt.svg/800px-Linked-in-alt.svg.png" alt="LinkedIn" className="h-6" /></a>
                        </div>
                    </div>
                </div>
                <div className="border-t border-slate-700 pt-8">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <p className="text-sm text-slate-500">&copy; {new Date().getFullYear()} MedVault. All Rights Reserved.</p>
                        <div className="flex items-center gap-4">
                            <p className="text-xs text-slate-400">Payment Partners:</p>
                            <div className="flex gap-3 flex-wrap items-center">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/1200px-Visa_Inc._logo.svg.png?20170118154621" alt="Visa" className="h-5" />
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1158px-Mastercard-logo.svg.png?20210817144358" alt="Mastercard" className="h-6" />
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b5/PayPal.svg/1920px-PayPal.svg.png?20241230110020svg/186px-PayPal.svg.png?20241230110020" alt="PayPal" className="h-5" />
                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/24/Paytm_Logo_%28standalone%29.svg" alt="Paytm" className="h-5" />
                                <img src="https://upload.wikimedia.org/wikipedia/commons/f/f2/Google_Pay_Logo.svg" alt="GPay" className="h-5" />
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/PhonePe_Logo.svg/1920px-PhonePe_Logo.svg.png?20210407195407/71/PhonePe_Logo.svg/345px-PhonePe_Logo.svg" alt="PhonePe" className="h-6" />
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d1/RuPay.svg/1920px-RuPay.svg.png?20200901070738" alt="RuPay" className="h-6" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    );
    // --- RoleSelectionPage ---


    // --- DASHBOARD COMPONENTS ---
    const StatusMessage = ({ message }) => {
        if (!message) return null;
        return (
            <div className="bg-purple-100 text-purple-700 border border-purple-300 text-center py-2 font-medium rounded-md mb-6">
            {message}
            </div>
        );
    };
    // ---  FEEDBACK MODAL ---
    const FeedbackModal = ({ appointment, user, doctors, onClose, onFeedbackSubmitted }) => {
        const [rating, setRating] = useState(0);
        const [feedbackText, setFeedbackText] = useState("");
        const [message, setMessage] = useState("");
        const [isSubmitting, setIsSubmitting] = useState(false);

        // 1. Determine Record Type & ID
        // If it has a requestId, it's an Emergency. Otherwise, it's an Appointment.
        const isEmergency = appointment.requestId !== undefined;
        const recordId = isEmergency ? appointment.requestId : appointment.appointmentId;

        // 2. Safely Get Doctor ID
        // Emergency requests usually have 'doctorId' directly. Appointments might have it nested.
        const getDoctorId = () => {
            if (appointment.doctorId) return appointment.doctorId;
            if (appointment.doctor) return appointment.doctor.id || appointment.doctor.doctorId || appointment.doctor.professionalId;
            return null;
        };
        const doctorId = getDoctorId();

        // 3. Safely Get Doctor Name (for display)
        // We try to find the doctor object in the full 'doctors' list first for accuracy
        const docObj = doctors ? doctors.find(d => (d.id || d.doctorId || d.professionalId) === doctorId) : null;
        const doctorName = docObj 
            ? `Dr. ${docObj.firstName} ${docObj.lastName}` 
            : (appointment.doctor ? `Dr. ${appointment.doctor.firstName} ${appointment.doctor.lastName}` : "Dr. N/A");

        // 4. Safely Get Date
        const dateRaw = isEmergency ? appointment.requestDateTime : appointment.appointmentDateTime;
        const dateStr = dateRaw ? new Date(dateRaw).toLocaleDateString() : "N/A";

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (rating === 0) {
                setMessage("Please select a star rating.");
                return;
            }
            if (!doctorId) {
                setMessage("Error: Could not identify the doctor.");
                return;
            }

            setIsSubmitting(true);

            // 5. Construct Payload (FIXED KEYS)
            const reviewData = {
                patientId: user.patientId,
                doctorId: doctorId,
                // Send ID to the correct field, set the other to null
                appointmentId: !isEmergency ? recordId : null,
                requestId: isEmergency ? recordId : null, 
                rating: rating,
                feedbackText: feedbackText, // <--- FIXED: Changed from 'feedback' to 'feedbackText'
                reviewDate: new Date().toISOString()
            };

            try {
                console.log("Submitting Review Payload:", reviewData);

                const response = await fetch(`http://localhost:8080/api/reviews`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(reviewData),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || "Submission failed");
                }
                
                // Success
                onFeedbackSubmitted(); 
                onClose(); 

            } catch (error) {
                console.error("Feedback Error:", error);
                setMessage("Error submitting feedback. Please try again.");
            } finally {
                setIsSubmitting(false);
            }
        };

        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                    
                    <div className="flex justify-between items-start mb-4">
                        <h2 className="text-2xl font-bold text-slate-800">Leave Feedback</h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                    </div>

                    <div className="mb-6 text-center bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p className="text-slate-500 text-sm mb-1">
                            {isEmergency ? "Emergency Request" : "Appointment"} with
                        </p>
                        <h3 className="text-lg font-bold text-brand-purple">{doctorName}</h3>
                        <p className="text-xs text-slate-400 mt-1">{dateStr}</p>
                    </div>

                    <form onSubmit={handleSubmit}>
                        <div className="mb-6 text-center">
                            <label className="block text-base font-semibold text-slate-700 mb-3">Your Rating</label>
                            <div className="flex justify-center gap-2 flex-row-reverse">
                                {[5, 4, 3, 2, 1].map((star) => (
                                    <React.Fragment key={star}>
                                        <input 
                                            type="radio" 
                                            id={`star${star}`} 
                                            name="rating" 
                                            value={star} 
                                            className="hidden"
                                            onChange={() => setRating(star)} 
                                        />
                                        <label 
                                            htmlFor={`star${star}`} 
                                            className={`text-4xl cursor-pointer transition-colors ${rating >= star ? 'text-amber-400' : 'text-gray-300'} hover:text-amber-400`}
                                        >
                                            ★
                                        </label>
                                    </React.Fragment>
                                ))}
                            </div>
                        </div>

                        <div className="mb-6">
                            <label className="block text-sm font-bold text-slate-700 mb-2">Your Comments</label>
                            <textarea
                                rows="4"
                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-purple resize-none text-slate-700"
                                placeholder="How was your experience?"
                                value={feedbackText}
                                onChange={(e) => setFeedbackText(e.target.value)}
                                required
                            ></textarea>
                        </div>

                        {message && <p className="text-red-600 text-center mb-4 text-sm font-bold bg-red-50 p-2 rounded">{message}</p>}

                        <button 
                            type="submit" 
                            disabled={isSubmitting}
                            className={`w-full bg-brand-purple text-white font-bold py-3 rounded-xl hover:bg-purple-700 transition-all shadow-md ${isSubmitting ? 'opacity-70 cursor-not-allowed' : ''}`}
                        >
                            {isSubmitting ? "Submitting..." : "Submit Feedback"}
                        </button>
                    </form>
                </div>
            </div>
        );
    };
    const AddConditionModal = ({ user, onClose, onConditionAdded }) => {
    const [conditionName, setConditionName] = useState("");
    const [diagnosedDate, setDiagnosedDate] = useState(""); 
    const [status, setStatus] = useState("");             
    const [notes, setNotes] = useState("");
    const [message, setMessage] = useState("");
    useEffect(() => {
  console.log("User object in AddConditionModal:", user);
}, [user]);

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // 1. Mandatory Frontend Validation
        if (!conditionName) {
            setMessage("Please enter a condition name.");
            return;
        }
        if (!user.patientId) {
            setMessage("Cannot add condition: Patient ID is missing.");
            return;
        }
        
        // 2. Build Payload with Robust Null Checks
        const conditionData = {
            conditionId: null,
            patientId: user.patientId,
            conditionName,
            diagnosedDate: diagnosedDate ? diagnosedDate : null,
            status: status ? status : 'Unknown',
            notes: notes ? notes : null
};
        try {
            const response = await fetch(`http://localhost:8080/api/medical-conditions`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(conditionData),
            });

            // If the server returns a 400, try to get the error message
            if (!response.ok) {
                const errorText = await response.text(); 
                // Throw the error with any text received from the server (e.g., Spring validation errors)
                throw new Error(errorText || "Failed to add condition due to Bad Request (400)"); 
            }
            
            onConditionAdded();
            onClose();

        } catch (error) {
            setMessage(`Error adding condition. Details: ${error.message}. Please check server log.`);
            console.error("Condition POST failed:", error);
        }
    };

    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold text-slate-800">Add Medical Condition</h2>
                    <button onClick={onClose} className="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="mb-6">
                        <label htmlFor="conditionName" className="block text-lg font-medium text-slate-700 mb-2">Condition Name</label>
                        <input
                            id="conditionName"
                            type="text"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple"
                            placeholder="e.g., Asthma, Hypertension"
                            value={conditionName}
                            onChange={(e) => setConditionName(e.target.value)}
                            required
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="mb-6">
                            <label htmlFor="diagnosedDate" className="block text-lg font-medium text-slate-700 mb-2">Diagnosed Date</label>
                            <input
                                id="diagnosedDate"
                                type="date"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple"
                                value={diagnosedDate}
                                onChange={(e) => setDiagnosedDate(e.target.value)}
                            />
                        </div>

                        <div className="mb-6">
                            <label htmlFor="status" className="block text-lg font-medium text-slate-700 mb-2">Status</label>
                            <select
                                id="status"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple"
                                value={status}
                                onChange={(e) => setStatus(e.target.value)}
                            >
                                <option value="">Select Status</option>
                                <option value="Chronic">Chronic</option>
                                <option value="Resolved">Resolved</option>
                                <option value="Acute">Acute</option>
                                <option value="Managing">Managing</option>
                            </select>
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <label htmlFor="notes" className="block text-lg font-medium text-slate-700 mb-2">Notes (Optional)</label>
                        <textarea
                            id="notes"
                            rows="3"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple"
                            placeholder="e.g., Diagnosed in 2010, managed with daily medication."
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                        ></textarea>
                    </div>
                    {message && <p className="text-red-600 text-center mb-4">{message}</p>}
                    <button type="submit" className="w-full bg-brand-purple text-white font-semibold py-3 rounded-lg hover:bg-purple-700">
                        Add Condition
                    </button>
                </form>
            </div>
        </div>
    );
};
    
const AddRecordModal = ({ user, onClose, onRecordAdded }) => {
      const [patientName, setPatientName] = useState("Loading...");
      
      const [recordAddress, setRecordAddress] = useState("");
      const [maritalStatus, setMaritalStatus] = useState("");
      const [aadhaarNumber, setAadhaarNumber] = useState("");
      const [insuranceDetails, setInsuranceDetails] = useState("");
      const [birthMark, setBirthMark] = useState("");
      const [weightKg, setWeightKg] = useState("");
      const [heightCm, setHeightCm] = useState("");
      const [bmi, setBmi] = useState("");
      const [pulseRate, setPulseRate] = useState("");
      const [bodyTemperature, setBodyTemperature] = useState("");
      const [smokingStatus, setSmokingStatus] = useState("");
      const [alcoholConsumption, setAlcoholConsumption] = useState("");
      const [dietPreference, setDietPreference] = useState("");
      const [physicalActivityLevel, setPhysicalActivityLevel] = useState("");
      const [sleepHours, setSleepHours] = useState("");
      const [stressLevel, setStressLevel] = useState("");
      const [recordType, setRecordType] = useState("Lab Report");
      const [title, setTitle] = useState("");
      const [recordDate, setRecordDate] = useState("");
      const [description, setDescription] = useState("");
      const [selectedFile, setSelectedFile] = useState(null);
      const [message, setMessage] = useState("");
      const fileInputRef = useRef(null);

      useEffect(() => {
        if (user?.patientId) {
            fetch(`http://localhost:8080/api/patients/${user.patientId}`)
                .then(res => res.json())
                .then(data => {
                    const fName = data.firstName || data.first_name || "";
                    const lName = data.lastName || data.last_name || "";
                    setPatientName(`${fName} ${lName}`.trim() || user.name || "Name not found");
                })
                .catch(e => setPatientName("Error loading name"));
        }
      }, [user]);

      useEffect(() => {
        if (weightKg && heightCm) {
            const heightM = heightCm / 100;
            const val = (weightKg / (heightM * heightM)).toFixed(2);
            setBmi(val);
        } else {
            setBmi("");
        }
      }, [weightKg, heightCm]);

      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            if (!['image/jpeg', 'image/jpg', 'application/pdf'].includes(file.type)) {
                setMessage("Error: Only JPG, JPEG, and PDF files are allowed.");
                setSelectedFile(null); e.target.value = null; return;
            }
            setSelectedFile(file); setMessage("");
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage("Uploading...");
        if (!title || !selectedFile || !user?.patientId || !recordDate) { 
             setMessage("Error: Please fill all required fields, including the date."); return; 
        }

        const formData = new FormData();
        formData.append("patientId", user.patientId);
        formData.append("createdBy", user.userId || user.patientId);
        formData.append("recordType", recordType);
        formData.append("title", title);
        formData.append("recordDate", recordDate);
        formData.append("description", description);
        formData.append("file", selectedFile);
        
        if (recordAddress) formData.append("address", recordAddress);
        if (maritalStatus) formData.append("maritalStatus", maritalStatus);
        if (aadhaarNumber) formData.append("aadhaarNumber", aadhaarNumber);
        if (insuranceDetails) formData.append("insuranceDetails", insuranceDetails);
        if (birthMark) formData.append("birthMark", birthMark);
        if (weightKg) formData.append("weightKg", weightKg);
        if (heightCm) formData.append("heightCm", heightCm);
        if (bmi) formData.append("bmi", bmi);
        if (pulseRate) formData.append("pulseRate", pulseRate);
        if (bodyTemperature) formData.append("bodyTemperature", bodyTemperature);
        if (smokingStatus) formData.append("smokingStatus", smokingStatus);
        if (alcoholConsumption) formData.append("alcoholConsumption", alcoholConsumption);
        if (dietPreference) formData.append("dietPreference", dietPreference);
        if (physicalActivityLevel) formData.append("physicalActivityLevel", physicalActivityLevel);
        if (sleepHours) formData.append("sleepHours", sleepHours);
        if (stressLevel) formData.append("stressLevel", stressLevel);

        try {
          const res = await fetch(`http://localhost:8080/api/records/uploads/${user.patientId}`, {
            method: "POST", body: formData
          });
          if (!res.ok) throw new Error("Server rejected the upload");
          
          setMessage("✅ Record added successfully!");
          setTimeout(() => { onRecordAdded(); onClose(); }, 1000);
        } catch (err) {
          setMessage("Failed to add record: " + err.message);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content bg-white rounded-xl shadow-2xl" onClick={e => e.stopPropagation()} style={{ width: '90%', maxWidth: '900px', maxHeight: '85vh', overflowY: 'auto' }}>
            <div className="sticky top-0 bg-white z-50 border-b px-6 py-4 flex justify-between items-center">
              <h2 className="text-2xl font-bold text-brand-purple flex items-center"><i className="fas fa-file-medical-alt mr-2"></i> Add Health Record</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-red-500 text-3xl font-bold">&times;</button>
            </div>
            
            <form onSubmit={handleSubmit} className="p-6 space-y-6">
              
              {/* 1. Basic Info */}
              <div className="bg-slate-50 p-5 rounded-xl border border-slate-200">
                <h3 className="font-bold text-slate-700 mb-4 text-lg border-b pb-2">Personal Information</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label className="block text-xs font-bold text-slate-500 uppercase">Patient Name</label>
                        <div className="mt-1 p-3 bg-white border rounded-lg text-slate-800 font-medium shadow-sm">{patientName}</div>
                    </div>
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-1">Marital Status</label>
                        <select value={maritalStatus} onChange={e => setMaritalStatus(e.target.value)} className="w-full p-3 border rounded-lg">
                            <option value="">Select Status...</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                        </select>
                    </div>
                    <div className="md:col-span-2">
                        <label className="block text-sm font-bold text-slate-700 mb-1">Address</label>
                        <textarea
                            value={recordAddress}
                            onChange={e => setRecordAddress(e.target.value)}
                            className="w-full p-3 border rounded-lg"
                            placeholder="Enter the address for this record..."
                            rows="2"
                        ></textarea>
                    </div>
                </div>
              </div>

              {/* 2. Identification Details */}
              <div className="bg-orange-50 p-5 rounded-xl border border-orange-200">
                <h3 className="font-bold text-orange-800 mb-4 text-lg border-b border-orange-200 pb-2">Identification Details</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label className="block text-sm font-bold mb-1">Aadhaar Number</label><input type="text" value={aadhaarNumber} onChange={e => setAadhaarNumber(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="XXXX-XXXX-XXXX" /></div>
                    <div><label className="block text-sm font-bold mb-1">Insurance Details</label><input type="text" value={insuranceDetails} onChange={e => setInsuranceDetails(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="Policy No" /></div>
                    <div><label className="block text-sm font-bold mb-1">Birth Mark</label><input type="text" value={birthMark} onChange={e => setBirthMark(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="Visible mark" /></div>
                </div>
              </div>
              
              {/* 3. Current Health (Vitals) */}
              <div className="bg-blue-50 p-5 rounded-xl border border-blue-200">
                <h3 className="font-bold text-blue-800 mb-4 text-lg border-b border-blue-200 pb-2">Current Healt</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
                    <div><label className="block text-sm font-bold mb-1">Weight (kg)</label><input type="number" value={weightKg} onChange={e => setWeightKg(e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                    <div><label className="block text-sm font-bold mb-1">Height (cm)</label><input type="number" value={heightCm} onChange={e => setHeightCm(e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                    <div><label className="block text-sm font-bold mb-1">BMI</label><input type="text" value={bmi} disabled className="w-full p-3 border rounded-lg bg-slate-100" /></div>
                    <div><label className="block text-sm font-bold mb-1">Pulse Rate (bpm)</label><input type="number" value={pulseRate} onChange={e => setPulseRate(e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                    <div><label className="block text-sm font-bold mb-1">Body Temp (°C)</label><input type="number" step="0.1" value={bodyTemperature} onChange={e => setBodyTemperature(e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                </div>
              </div>

              {/* 4. Lifestyle */}
              <div className="bg-green-50 p-5 rounded-xl border border-green-200">
                <h3 className="font-bold text-green-800 mb-4 text-lg border-b border-green-200 pb-2">Lifestyle</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div><label className="block text-sm font-bold mb-1">Smoking</label><select value={smokingStatus} onChange={e => setSmokingStatus(e.target.value)} className="w-full p-3 border rounded-lg"><option value="">Select...</option><option value="Non-smoker">Non-smoker</option><option value="Former smoker">Former smoker</option><option value="Current smoker">Current smoker</option></select></div>
                    <div><label className="block text-sm font-bold mb-1">Alcohol</label><select value={alcoholConsumption} onChange={e => setAlcoholConsumption(e.target.value)} className="w-full p-3 border rounded-lg"><option value="">Select...</option><option value="Never">Never</option><option value="Occasionally">Occasionally</option><option value="Regularly">Regularly</option></select></div>
                    <div><label className="block text-sm font-bold mb-1">Diet</label><select value={dietPreference} onChange={e => setDietPreference(e.target.value)} className="w-full p-3 border rounded-lg"><option value="">Select...</option><option value="Vegetarian">Vegetarian</option><option value="Non-Vegetarian">Non-Vegetarian</option><option value="Vegan">Vegan</option></select></div>
                    <div><label className="block text-sm font-bold mb-1">Activity</label><select value={physicalActivityLevel} onChange={e => setPhysicalActivityLevel(e.target.value)} className="w-full p-3 border rounded-lg"><option value="">Select...</option><option value="Sedentary">Sedentary</option><option value="Light">Light</option><option value="Moderate">Moderate</option><option value="Active">Active</option></select></div>
                    <div><label className="block text-sm font-bold mb-1">Sleep (hrs/night)</label><input type="number" value={sleepHours} onChange={e => setSleepHours(e.target.value)} className="w-full p-3 border rounded-lg" /></div>
                    <div><label className="block text-sm font-bold mb-1">Stress Level</label><select value={stressLevel} onChange={e => setStressLevel(e.target.value)} className="w-full p-3 border rounded-lg"><option value="">Select...</option><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select></div>
                </div>
              </div>
              
              {/* 5. Add Document */}
              <div className="bg-purple-50 p-5 rounded-xl border border-purple-200">
                 <h3 className="font-bold text-purple-800 mb-4 text-lg border-b border-purple-200 pb-2">Add Document</h3>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label className="block text-sm font-bold mb-1">Record Type *</label>
                        <select value={recordType} onChange={e => setRecordType(e.target.value)} className="w-full p-3 border rounded-lg">
                            <option value=" ">Select type...</option>
                            <option value="Lab Report">Lab Report</option>
                            <option value="Imaging">Imaging (X-Ray, MRI)</option>
                            <option value="Visit Summary">Vaccination</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-bold mb-1">Record Date *</label>
                        <input type="date" value={recordDate} onChange={e => setRecordDate(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="dd-mm-yyyy" required />
                    </div>
                    <div className="md:col-span-2"><label className="block text-sm font-bold mb-1">Title / Document Name *</label><input type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-3 border rounded-lg" required /></div>
                    <div className="md:col-span-2"><label className="block text-sm font-bold mb-1">Description (Optional)</label><textarea rows="2" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-3 border rounded-lg"></textarea></div>
                    <div className="md:col-span-2"><label className="block text-sm font-bold mb-1">Upload File * <span className="font-normal text-xs text-slate-500">(JPG, PDF)</span></label><input ref={fileInputRef} type="file" accept=".jpg,.jpeg,.pdf" onChange={handleFileChange} className="w-full p-2 bg-white border rounded-lg" required /></div>
                 </div>
              </div>

              {message && <div className={`p-4 rounded-lg text-center font-bold ${message.includes('Error') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{message}</div>}
              
              <div className="flex gap-4 pt-4 border-t sticky bottom-0 bg-white py-4 px-6 -m-6 mt-6">
                  <button type="button" onClick={onClose} className="flex-1 py-3 rounded-lg border border-slate-300 hover:bg-slate-100 font-bold text-slate-700">Cancel</button>
                  <button type="submit" className="flex-[2] bg-brand-purple text-white py-3 rounded-lg font-bold hover:opacity-90 shadow-lg">Save Record</button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // --- ViewRecordModal  ---
    
    const ViewRecordModal = ({ record, patientProfile, onClose }) => {
        
        // --- HELPER 1: Gets data *ONLY* from the RECORD ---
        const getRecordData = (key, defaultVal = 'N/A') => {
            if (!record) return defaultVal;
            const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
            const value = record[key] || record[snakeKey];
            
            if (value !== undefined && value !== null && String(value).trim() !== '') {
                return value;
            }
            return defaultVal; 
        };

        // --- HELPER 2: Gets data *ONLY* from the main PROFILE ---
        const getPatientData = (key, defaultVal = 'N/A') => {
            if (!patientProfile) return defaultVal;
            const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
            const value = patientProfile[key] || patientProfile[snakeKey];
            if (value !== undefined && value !== null && String(value).trim() !== '') {
                return value;
            }
            return defaultVal;
        };

        const handleDownload = () => {
            alert('Downloading document...');
            window.open(getRecordData('fileUrl', '#'), '_blank');
        };

        // --- Component for colored boxes ---
        const ProfileData = ({ label, value, icon }) => (
            <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                <span className="block text-xs font-bold text-slate-400 uppercase mb-1 flex items-center">
                    <i className={`fas ${icon} fa-fw mr-2`}></i>{label}
                </span>
                <p className="text-slate-700 font-medium">{value}</p>
            </div>
        );
        
         const VitalData = ({ label, value, unit }) => (
            <div className="bg-white p-3 rounded-lg border border-blue-100 text-center shadow-sm">
                <span className="block text-xs font-bold text-blue-400 uppercase mb-1">{label}</span>
                <p className="text-slate-700 font-bold text-lg">
                    {value} {unit || ''}
                </p>
            </div>
        );
        
        // --- Component for simple prescription layout ---
        const PrescriptionDetail = ({ label, value }) => (
            <div>
                <label className="block text-sm font-bold text-slate-500">{label}</label>
                <p className="text-slate-800 font-medium text-lg capitalize">{value}</p>
            </div>
        );
        
        // --- DATA LOGIC ---
        const isPrescription = !!getRecordData('medicationName', null); 
        const title = isPrescription ? getRecordData('medicationName') : getRecordData('title');
        
        const date = isPrescription 
            ? (getRecordData('startDate', null) ? new Date(getRecordData('startDate')).toLocaleDateString() : 'N/A')
            : (getRecordData('recordDate', null) ? new Date(getRecordData('recordDate')).toLocaleDateString() : 'N/A');
            
        const description = getRecordData('description', null) || getRecordData('notes', 'No description provided.');
        const recordType = isPrescription ? 'Prescription' : getRecordData('recordType');

        let fullName = getPatientData('name');
        if (fullName === 'N/A' || !fullName) {
            fullName = `${getPatientData('firstName')} ${getPatientData('lastName')}`;
        }
        
        // --- DATA FIX: Get all other data *from the record* ---
        const maritalStatus = getRecordData('maritalStatus');
        const displayAddress = getRecordData('address') || 'N/A';
        const weightKg = getRecordData('weightKg');
        const heightCm = getRecordData('heightCm');
        const bmi = getRecordData('bmi');
        const pulseRate = getRecordData('pulseRate');
        const bodyTemperature = getRecordData('bodyTemperature');
        const aadhaarNumber = getRecordData('aadhaarNumber');
        const insuranceDetails = getRecordData('insuranceDetails');
        const birthMark = getRecordData('birthMark');
        const smokingStatus = getRecordData('smokingStatus');
        const alcoholConsumption = getRecordData('alcoholConsumption');
        const dietPreference = getRecordData('dietPreference');
        const physicalActivityLevel = getRecordData('physicalActivityLevel');
        const sleepHours = getRecordData('sleepHours');
        const stressLevel = getRecordData('stressLevel');

        // --- Data for Prescriptions ---
        const dosage = getRecordData('dosage');
        const frequency = getRecordData('frequency');


        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content bg-slate-50 rounded-xl shadow-2xl" onClick={e => e.stopPropagation()} style={{ width: '90%', maxWidth: '800px', maxHeight: '90vh', display: 'flex', flexDirection: 'column' }}>
                    
                    <div className="sticky top-0 bg-white z-10 border-b px-6 py-4 flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-brand-purple flex items-center gap-3 capitalize">
                            <i className={`fas ${isPrescription ? 'fa-prescription-bottle-alt' : 'fa-file-alt'}`}></i>
                            {isPrescription ? title : `Patient Information for '${title}'`}
                        </h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-red-500 text-3xl font-bold">&times;</button>
                    </div>

                   {/* =======================================
                    === 1. PRESCRIPTION LAYOUT (UPDATED)
                    =======================================
                    */}
                    {isPrescription ? (
                        <>
                            <div className="p-6 space-y-6 overflow-y-auto">
                                <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm space-y-6">
                                    <PrescriptionDetail label="Medicine Name:" value={title} />
                                    <PrescriptionDetail label="Dosage:" value={dosage} />
                                    <PrescriptionDetail label="Frequency:" value={frequency} />
                                    
                                    {/* --- ADDED DATES --- */}
                                    <div className="grid grid-cols-2 gap-4 pt-4 border-t">
                                        <PrescriptionDetail 
                                            label="Start Date:" 
                                            value={getRecordData('startDate', null) ? new Date(getRecordData('startDate')).toLocaleDateString() : 'N/A'} 
                                        />
                                        <PrescriptionDetail 
                                            label="End Date:" 
                                            value={getRecordData('endDate', null) ? new Date(getRecordData('endDate')).toLocaleDateString() : 'N/A'}
                                        />
                                    </div>
                                    {/* --- END ADDED DATES --- */}

                                    <PrescriptionDetail label="Description:" value={description} />
                                </div>
                            </div>
                            <div className="sticky bottom-0 bg-slate-50 z-10 p-6 border-t border-slate-200">
                                <button
                                    onClick={handleDownload}
                                    className="w-full bg-brand-purple text-white font-bold py-3 rounded-lg hover:opacity-90 shadow-lg flex items-center justify-center gap-2"
                                >
                                    <i className="fas fa-download"></i> Download Prescription
                                </button>
                            </div>
                        </>
                    ) : (
                    /* =======================================
                    === 2. HEALTH RECORD LAYOUT
                    =======================================
                    */
                    <>
                        {/* --- LAYOUT FIX: Simple text, no container --- */}
                        <div className="px-6 pt-4 pb-2 bg-white border-b">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase">Type</label>
                                    <p className="text-slate-700 font-medium">{recordType}</p>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase">Date</label>
                                    <p className="text-slate-700 font-medium">{date}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-6 space-y-6 overflow-y-auto">
                            <div className="bg-slate-100 p-5 rounded-xl border border-slate-200">
                                <h3 className="font-bold text-slate-700 mb-4 text-lg border-b pb-2">Basic Info</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <ProfileData label="Full Name" value={fullName} icon="fa-user" />
                                    <ProfileData label="Marital Status" value={maritalStatus} icon="fa-heart" />
                                    <ProfileData label="Full Address" value={displayAddress} icon="fa-map-marker-alt" />
                                </div>
                            </div>
                            
                            <div className="bg-blue-50 p-5 rounded-xl border border-blue-200">
                                <h3 className="font-bold text-blue-800 mb-4 text-lg border-b border-blue-200 pb-2">Current Health (Vitals)</h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                    <VitalData label="Weight" value={weightKg} unit="kg" />
                                    <VitalData label="Height" value={heightCm} unit="cm" />
                                    <VitalData label="BMI" value={bmi} />
                                    <VitalData label="Pulse" value={pulseRate} unit="bpm" />
                                    <VitalData label="Temp" value={bodyTemperature} unit="°C" />
                                </div>
                            </div>

                            <div className="bg-orange-50 p-5 rounded-xl border border-orange-200">
                                <h3 className="font-bold text-orange-800 mb-4 text-lg border-b border-orange-200 pb-2">Identification Details</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <ProfileData label="Aadhaar Number" value={aadhaarNumber} icon="fa-id-badge" />
                                    <ProfileData label="Insurance" value={insuranceDetails} icon="fa-shield-alt" />
                                    <ProfileData label="Birth Mark" value={birthMark} icon="fa-star" />
                                </div>
                            </div>

                            <div className="bg-green-50 p-5 rounded-xl border border-green-200">
                                <h3 className="font-bold text-green-800 mb-4 text-lg border-b border-green-200 pb-2">Lifestyle</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <ProfileData label="Smoking" value={smokingStatus} icon="fa-smoking" />
                                    <ProfileData label="Alcohol" value={alcoholConsumption} icon="fa-wine-glass" />
                                    <ProfileData label="Diet" value={dietPreference} icon="fa-carrot" />
                                    <ProfileData label="Activity" value={physicalActivityLevel} icon="fa-running" />
                                    <ProfileData label="Sleep" value={sleepHours !== 'N/A' ? `${sleepHours} hrs/night` : 'N/A'} icon="fa-bed" />
                                    <ProfileData label="Stress Level" value={stressLevel} icon="fa-brain" />
                                </div>
                            </div>

                            {/* --- LAYOUT FIX: Description moved to end --- */}
                            <div className="bg-purple-50 p-5 rounded-xl border border-purple-200 shadow-sm">
                                <h3 className="font-bold text-purple-800 mb-4 text-lg border-b border-purple-200 pb-2">
                                    Description / Notes
                                </h3>
                                <p className="text-slate-700 font-medium">{description}</p>
                            </div>
                        </div>
                        <div className="sticky bottom-0 bg-slate-50 z-10 p-6 border-t border-slate-200">
                            <button
                                onClick={handleDownload}
                                className="w-full bg-brand-purple text-white font-bold py-3 rounded-lg hover:opacity-90 shadow-lg flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-download"></i> Download Attached Document
                            </button>
                        </div>
                    </>
                    )}
                </div>
            </div>
        );
    };
     const DoctorAddPrescriptionModal = ({ doctorUser, patient, onClose, onRecordAdded }) => {
      const [medicationName, setMedicationName] = useState("");
      const [dosage, setDosage] = useState("");
      const [frequency, setFrequency] = useState("");
      const [startDate, setStartDate] = useState("");
      const [endDate, setEndDate] = useState("");
      const [prescribedBy, setPrescribedBy] = useState("");
      const [notes, setNotes] = useState("");
      const [selectedFile, setSelectedFile] = useState(null);
      const [message, setMessage] = useState("");
      const prescriptionFileInputRef = useRef(null);
      
      // Set doctor name when component mounts
      useEffect(() => {
        if (doctorUser?.firstName && doctorUser?.lastName) {
          setPrescribedBy(`Dr. ${doctorUser.firstName} ${doctorUser.lastName}`);
        }
      }, [doctorUser]);
      
      // Debug logging
      useEffect(() => {
        console.log("DoctorAddPrescriptionModal mounted with:", {
          doctorUser,
          patient,
          prescribedBy
        });
      }, []);

      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                setMessage("Only JPG, JPEG, and PDF files are allowed.");
                setSelectedFile(null);
                e.target.value = null;
                return;
            }
            setSelectedFile(file);
            setMessage("");
        } else {
            setSelectedFile(null);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        // Validation
        if (!medicationName) { setMessage("Please enter medication name."); return; }
        if (!dosage) { setMessage("Please enter dosage."); return; }
        if (!frequency) { setMessage("Please enter frequency."); return; }
        if (!startDate || !endDate) { setMessage("Please select start and end dates."); return; }
        if (!prescribedBy) { setMessage("Please enter prescriber ID or name."); return; }
        if (!patient?.patientId) { setMessage("Patient ID missing."); return; }
        if (!selectedFile) { setMessage("Please upload a JPG, JPEG, or PDF file."); return; }

        console.log("Submitting prescription with data:", {
            patientId: patient.patientId,
            medicationName,
            dosage,
            frequency,
            startDate,
            endDate,
            prescribedBy,
            notes,
            file: selectedFile
        });

        
        const formData = new FormData();
        formData.append("patientId", patient.patientId);
        formData.append("medicationName", medicationName);
        formData.append("dosage", dosage);
        formData.append("frequency", frequency);
        formData.append("startDate", startDate);
        formData.append("endDate", endDate);
        formData.append("prescribedBy", prescribedBy);
        formData.append("notes", notes);
        if (selectedFile) formData.append("file", selectedFile);

        try {
          // --- THIS IS THE KEY CHANGE ---
          // It now posts to your dedicated medications endpoint
          console.log("Making request to medications endpoint...");
          console.log("Form data contents:");
          for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + (pair[0] === 'file' ? 'File object' : pair[1]));
          }
          
          const res = await fetch(`http://localhost:8080/api/medications/uploads`, {
            method: "POST",
            body: formData,
            credentials: 'include'
            // Don't set any headers for multipart/form-data - browser will handle it
          });
          
          console.log("Response status:", res.status);
          const responseText = await res.text();
          console.log("Response text:", responseText);
          
          if (!res.ok) {
            throw new Error(responseText || "Failed to add prescription");
          }
          
          let jsonData;
          try {
            jsonData = JSON.parse(responseText);
            console.log("Parsed response:", jsonData);
          } catch (e) {
            console.warn("Could not parse response as JSON:", e);
          }
          
          // Reset form and file input
          setMedicationName("");
          setDosage("");
          setFrequency("");
          setStartDate("");
          setEndDate("");
          setNotes("");
          setSelectedFile(null);
          if (prescriptionFileInputRef.current) prescriptionFileInputRef.current.value = '';
          
          onRecordAdded();
          onClose();
          setMessage("Prescription uploaded successfully!");
          setTimeout(() => setMessage(""), 5000);
          return jsonData;
        } catch (err) {
          console.error("Prescription POST failed:", err);
          setMessage("Error adding prescription: " + err.message);
          // Clear error message after 10 seconds
          setTimeout(() => setMessage(""), 5000);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold">Add Prescription for {patient.firstName}</h2>
              <button onClick={onClose} className="text-2xl">&times;</button>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="mb-4">
                  <label className="block mb-2 font-medium text-slate-700">Medication Name</label>
                  <input type="text" value={medicationName} onChange={e => setMedicationName(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" required />
                </div>
                <div className="mb-4">
                  <label className="block mb-2 font-medium text-slate-700">Dosage</label>
                  <input type="text" value={dosage} onChange={e => setDosage(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" required />
                </div>
                <div className="mb-4">
                  <label className="block mb-2 font-medium text-slate-700">Frequency</label>
                  <input type="text" value={frequency} onChange={e => setFrequency(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" required />
                </div>
                <div className="mb-4">
                  <label className="block mb-2 font-medium text-slate-700">Prescribed By</label>
                  <input type="text" value={prescribedBy} onChange={e => setPrescribedBy(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" required />
                </div>
                <div className="mb-4">
                  <label className="block mb-2 font-medium text-slate-700">Start Date</label>
                  <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" required />
                </div>
                <div className="mb-4">
                  <label className="block mb-2 font-medium text-slate-700">End Date</label>
                  <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" required />
                </div>
              </div>
              
              <div className="mb-6">
                <label className="block mb-2 font-medium text-slate-700">Upload File (JPG, JPEG, or PDF)</label>
                <input 
                    ref={prescriptionFileInputRef}
                    type="file" 
                    accept=".jpg,.jpeg,.pdf"
                    onChange={handleFileChange} 
                    className="w-full text-slate-700 text-sm 
                               file:mr-4 file:py-2 file:px-4
                               file:rounded-full file:border-0
                               file:text-sm file:font-semibold
                               file:bg-brand-lavender/50 file:text-brand-purple
                               hover:file:bg-brand-lavender/70
                               border border-gray-300 rounded-lg p-3"
                    required
                />
                {selectedFile && (
                    <p className="text-sm text-green-600 mt-2 flex items-center">
                         <i className="fas fa-check-circle mr-1"></i> File selected: {selectedFile.name}
                    </p>
                )}
              </div>
              
              <div className="mb-4">
                <label className="block mb-2 font-medium text-slate-700">Notes (Optional)</label>
                <textarea rows="4" value={notes} onChange={e => setNotes(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" />
              </div>

              {message && <p className={`mb-4 text-center font-medium ${message.includes('Error') ? 'text-red-600' : 'text-green-600'}`}>{message}</p>}
              <button type="submit" className="w-full bg-brand-purple text-white py-3 rounded-lg font-semibold hover:bg-purple-700">Add Prescription</button>
            </form>
          </div>
        </div>
      );
    };

    const DoctorViewRecordsModal = ({ patient, doctorId, onClose, onViewRecord, onUploadPrescription }) => {
        const [records, setRecords] = useState([]); // For api/records
        const [conditions, setConditions] = useState([]); // For api/medical-conditions
        const [prescriptions, setPrescriptions] = useState([]); // For api/medications
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedRecord, setSelectedRecord] = useState(null); // For viewing any file
        const [prescriptionFiles, setPrescriptionFiles] = useState([]);
        const [fullPatientProfile, setFullPatientProfile] = useState(null);
        // API CALL TO FETCH ALL PATIENT DATA
        useEffect(() => {
            const fetchAllData = async () => {
                if (!patient?.patientId) {
                    console.error("No patient ID available");
                    return;
                }
                
                setLoading(true);
                setError(null);
                console.log("Fetching data for patient:", patient.patientId);
                
                try {
                    // --- 1. FETCH HEALTH RECORDS (without doctorId - consent already verified) ---
                    console.log("Fetching health records...");
                    // Note: We don't pass doctorId here because consent was already verified before opening this modal
                    const [recordsRes, prescriptionsRes] = await Promise.all([
                        fetch(`http://localhost:8080/api/records/patient/${patient.patientId}`, {
                            credentials: 'include'
                        }),
                        
                        fetch(`http://localhost:8080/api/medications/patient/${patient.patientId}`, {
                            credentials: 'include'
                        })
                    ]);
                    
                    if (!recordsRes.ok) {
                        if (recordsRes.status === 403) {
                            throw new Error('Access denied. You need patient consent to view their records.');
                        }
                        throw new Error(`Failed to fetch records (HTTP ${recordsRes.status})`);
                    }
                    if (!prescriptionsRes.ok) {
                        if (prescriptionsRes.status === 403) {
                            throw new Error('Access denied. You need patient consent to view their prescriptions.');
                        }
                        throw new Error(`Failed to fetch prescriptions (HTTP ${prescriptionsRes.status})`);
                    }
                    
                    const [recordsData, prescriptionsData] = await Promise.all([
                        recordsRes.json(),
                        prescriptionsRes.json()
                    ]);
                    
                    console.log("Received health records:", recordsData);
                    console.log("Received prescriptions:", prescriptionsData);
                    
                    setRecords(recordsData);
                    setPrescriptions(prescriptionsData);
                } catch (e) {
                    console.error("Error fetching patient data:", e);
                    setError(e.message);
                    setRecords([]);
                    setPrescriptions([]);
                } finally {
                    setLoading(false);
                }
                try {
                        console.log("Fetching full patient profile for modal...");
                        const profileRes = await fetch(`http://localhost:8080/api/patients/${patient.patientId}`);
                        if (profileRes.ok) {
                            const profileData = await profileRes.json();
                            setFullPatientProfile(profileData); // Set the full profile
                        } else {
                            throw new Error('Failed to fetch patient profile');
                        }
                    } catch (e) {
                        console.error("Error fetching full patient profile:", e);
                        setFullPatientProfile(patient); // Fallback to minimal patient object
                    }
                // --- 2. FETCH MEDICAL CONDITIONS (api/medical-conditions) ---
                try {
                    console.log("Fetching medical conditions...");
                    const conditionsUrl = `http://localhost:8080/api/medical-conditions/patient/${patient.patientId}`;
                    const res = await fetch(conditionsUrl);
                    if (!res.ok) throw new Error(`Failed to fetch conditions (HTTP ${res.status})`);
                    const conditions = await res.json();
                    console.log("Received medical conditions:", conditions);
                    setConditions(conditions);
                } catch (e) {
                    console.error("Error fetching medical conditions:", e);
                    console.warn("Could not load medical conditions.");
                    setConditions([]);
                }
                
                // --- 3. FETCH PRESCRIPTION FILES (api/medications) ---
                try {
                    console.log("Fetching prescriptions...");
                    const prescriptionsUrl = `http://localhost:8080/api/medications/patient/${patient.patientId}`;
                    const res = await fetch(prescriptionsUrl);
                    if (!res.ok) throw new Error(`Failed to fetch prescriptions (HTTP ${res.status})`);
                    const data = await res.json();
                    console.log("Received prescriptions:", data);
                    setPrescriptions(data.sort((a, b) => new Date(b.created_at || b.start_date) - new Date(a.created_at || a.start_date)));
                } catch (e) {
                    console.error("Error fetching prescription files:", e);
                    console.warn("Could not load prescription files.");
                    setPrescriptions([]);
                }

                setLoading(false);
            };
            
            fetchAllData();
        }, [patient.patientId]);

        // RecordItem component for displaying individual records
       const RecordItem = ({ r, isPrescription, onViewRecord }) => {
        const fileIcon = (r.document_path || r.fileUrl || "").endsWith('.pdf') ? 'fa-file-pdf' : 'fa-file-image';
        
        // Styles
        const cardClasses = isPrescription 
            ? "bg-brand-purple/5 border-brand-purple/20" 
            : "bg-white border-slate-200 hover:border-brand-purple/50";

        const titleClasses = isPrescription 
            ? "text-brand-purple font-extrabold" 
            : "text-slate-800 font-bold";

        // Data Mapping
        const title = isPrescription ? (r.medication_name || r.medicationName) : r.title;
        const dateRaw = isPrescription ? (r.start_date || r.startDate) : r.recordDate;
        const date = dateRaw ? new Date(dateRaw).toLocaleDateString() : 'N/A';
        
        // Check for extra info tags
        const hasVitals = r.weightKg || r.bmi || r.bodyTemperature;
        const hasLifestyle = r.smokingStatus || r.dietPreference;

        return (
            <div className={`p-5 rounded-xl border shadow-sm hover:shadow-md transition-all duration-300 flex flex-col h-full ${cardClasses}`}>
                
                {/* Top Row: Icon & Date */}
                <div className="flex justify-between items-start mb-2">
                    <div className={`p-2 rounded-lg ${isPrescription ? 'bg-purple-100 text-purple-600' : 'bg-blue-50 text-blue-600'}`}>
                        <i className={`fas ${isPrescription ? 'fa-prescription' : 'fa-file-medical'} text-xl`}></i>
                    </div>
                    <span className="text-xs font-semibold text-slate-400 bg-slate-50 px-2 py-1 rounded-full">{date}</span>
                </div>

                {/* Title */}
                <h4 className={`text-lg mb-1 ${titleClasses} line-clamp-1`}>{title}</h4>
                <p className="text-xs text-slate-500 font-medium uppercase tracking-wide mb-3">
                    {isPrescription ? 'Prescription' : r.recordType}
                </p>

                {/* Brief Summary / Description Truncated */}
                <div className="flex-grow mb-4">
                    {r.description || r.notes ? (
                        <p className="text-sm text-slate-600 line-clamp-2">
                            {r.description || r.notes}
                        </p>
                    ) : (
                        <p className="text-sm text-slate-400 italic">No additional notes.</p>
                    )}
                </div>

                {/* Quick Tags (Summary of what's inside) */}
                {!isPrescription && (
                    <div className="flex flex-wrap gap-2 mb-4">
                        {hasVitals && <span className="text-[10px] font-bold px-2 py-1 bg-blue-100 text-blue-700 rounded-full">VITALS</span>}
                        {hasLifestyle && <span className="text-[10px] font-bold px-2 py-1 bg-green-100 text-green-700 rounded-full">LIFESTYLE</span>}
                        {(r.document_path || r.fileUrl) && <span className="text-[10px] font-bold px-2 py-1 bg-gray-100 text-gray-600 rounded-full">FILE</span>}
                    </div>
                )}

                {/* Actions */}
                <div className="mt-auto pt-3 border-t border-slate-100 flex gap-2">
                    <button
                        onClick={() => onViewRecord(r)}
                        className="flex-1 text-sm font-semibold text-brand-purple bg-purple-50 hover:bg-purple-100 py-2 rounded-lg transition-colors flex items-center justify-center gap-2"
                    >
                        <i className="fas fa-eye"></i> View Details
                    </button>
                </div>
            </div>
        );
    };
        return (
            <div className="modal-overlay" onClick={onClose}>
                <div className="modal-content max-w-4xl w-full h-5/6 flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-2xl font-bold text-slate-800">
                            Patient Records: {patient.firstName} {patient.lastName}
                        </h2>
                        <button onClick={onClose} className="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                    </div>
                    
                    {loading && (
                        <div className="flex justify-center items-center p-8">
                            <span className="text-brand-purple text-lg">Loading patient records...</span>
                        </div>
                    )}
                    
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                            Error loading records: {error}
                        </div>
                    )}

                    {!loading && !error && (
                        <div className="flex-grow overflow-y-auto pr-2 space-y-6">
                            
                            {/* --- 1. MEDICAL CONDITIONS --- */}
                            <div className="bg-slate-50 p-4 rounded-lg shadow-inner mb-6" id="doctor-medical-conditions">
                                <h3 className="text-2xl font-bold text-slate-800 mb-4 flex items-center">
                                    <i className="fas fa-notes-medical mr-2"></i> Medical Conditions ({conditions.length})
                                </h3>
                                <div className="space-y-3">
                                    {conditions.length === 0 ? (
                                        <p className="text-slate-500">No medical conditions recorded for this patient.</p>
                                    ) : (
                                        conditions.map((c) => (
                                            <div key={c.conditionId} className="p-4 bg-white rounded-lg border border-slate-200">
                                                <p className="font-semibold text-slate-800">{c.conditionName}</p>
                                                <div className="flex flex-wrap gap-4 text-sm text-slate-600 mt-1">
                                                    {c.diagnosedDate && (
                                                        <p><span className="font-medium">Diagnosed:</span> {new Date(c.diagnosedDate).toLocaleDateString()}</p>
                                                    )}
                                                    {c.status && (
                                                        <p><span className="font-medium">Status:</span> 
                                                            <span className={`ml-1 px-2 py-0.5 rounded-full text-xs font-semibold ${
                                                                c.status.toUpperCase() === 'RESOLVED' ? 'bg-green-100 text-green-800' :
                                                                'bg-yellow-100 text-yellow-800'
                                                            }`}>{c.status}</span>
                                                        </p>
                                                    )}
                                                </div>
                                                {c.notes && <p className="text-slate-600 text-sm italic mt-1">Notes: {c.notes}</p>}
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                            
                            {/* --- 2. PRESCRIPTIONS CONTAINER (MODIFIED) --- */}
                            <div className="bg-slate-50 p-4 rounded-lg shadow-inner" id="doctor-prescriptions">
                                <h3 className="text-2xl font-bold text-brand-purple mb-4 flex items-center">
                                    <i className="fas fa-prescription-bottle-alt mr-2"></i> Prescriptions ({prescriptions.length})
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {prescriptions.length === 0 ? (
                                        <p className="text-slate-500 col-span-full">No prescriptions found for this patient.</p>
                                    ) : (
                                        prescriptions.map(r => <RecordItem key={r.medication_id} r={r} isPrescription={true} onViewRecord={setSelectedRecord} />)
                                    )}
                                </div>
                            </div>

                            {/* --- 3. OTHER RECORDS CONTAINER (MODIFIED) --- */}
                            <div className="bg-slate-50 p-4 rounded-lg shadow-inner" id="doctor-other-records">
                                <h3 className="text-2xl font-bold text-slate-800 mb-4 flex items-center">
                                    <i className="fas fa-file-medical mr-2"></i> Health Records ({records.length})
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {records.length === 0 ? (
                                        <p className="text-slate-500 col-span-full">No lab reports, imaging, or notes found for this patient.</p>
                                    ) : (
                                        records.map(r => <RecordItem key={r.recordId} r={r} isPrescription={false} onViewRecord={setSelectedRecord} />)
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                {/* Modal to view single record detail (unchanged) */}
                {/* Modal to view single record detail (FIXED) */}
                {selectedRecord && (
                    <ViewRecordModal 
                        record={selectedRecord} 
                        patientProfile={fullPatientProfile || patient} // <-- This is the fix
                        onClose={() => setSelectedRecord(null)} 
                    />
                )}
            </div>
        );
    };
   const RecordItem = ({ r, isPrescription, onViewRecord }) => {
        const fileIcon = r.document_path?.endsWith('.pdf') ? 'fa-file-pdf' : 
                      r.document_path?.includes('jpg') ? 'fa-file-image' : 
                      'fa-file';
        
        // Highlight prescriptions visually
        const cardClasses = isPrescription 
            ? "bg-brand-purple/10 border-brand-purple/50" 
            : "bg-brand-peach-light/50 border-brand-peach-dark/30";

        const titleClasses = isPrescription 
            ? "text-brand-purple font-extrabold" 
            : "text-slate-800";

        // Handle different title fields for prescriptions vs records
        const title = isPrescription ? r.medication_name : r.title;
        const date = isPrescription 
            ? r.start_date ? new Date(r.start_date).toLocaleDateString() : 'N/A'
            : r.recordDate ? new Date(r.recordDate).toLocaleDateString() : 'N/A';

        return (
            <div key={isPrescription ? r.medication_id : r.recordId} className={`p-4 rounded-xl border hover:shadow-md transition-shadow ${cardClasses}`}>
                <p className={`font-semibold leading-tight ${titleClasses}`}>{title}</p>
                <p className="text-xs text-slate-500 mt-1">
                    <span className="font-medium">{isPrescription ? 'Prescription' : r.recordType}</span> | {date}
                </p>
                {isPrescription && r.dosage && (
                    <p className="text-xs text-slate-600 mt-1">
                        {r.dosage} - {r.frequency}
                    </p>
                )}
                {r.document_path && (
                    <p className="text-xs text-slate-500 mt-1 flex items-center gap-1">
                        <i className={`fas ${fileIcon} mr-2 text-brand-purple`}></i>
                        {r.document_path.split('/').pop()}
                    </p>
                )}
                <div className="mt-3 flex gap-2">
                    <button
                        onClick={() => onViewRecord(r)}
                        className="text-xs font-semibold text-blue-600 hover:text-blue-800 p-1 rounded transition-colors flex items-center gap-1"
                    >
                        <i className="fas fa-eye"></i> View
                    </button>
                    {r.document_path && (
                        <button
                            onClick={() => alert('Downloading...')}
                            className="text-xs font-semibold text-green-600 hover:text-green-800 p-1 rounded transition-colors flex items-center gap-1"
                        >
                            <i className="fas fa-download"></i> Download
                        </button>
                    )}
                </div>
            </div>
        );
    };

    // --- Other Health Records Section (Top in 30% aside) ---
    const OtherRecordsSection = ({ records, onAddRecord, onViewRecord }) => {
        const otherRecords = records.filter(r => r.recordType !== 'Prescription');

        return (
            <div className="flex flex-col bg-white rounded-2xl shadow-xl mb-6" id="other-records">
                <div className="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 className="text-2xl font-bold text-slate-800 flex items-center">
                        <i className="fas fa-file-medical mr-2"></i> Health Records 
                    </h3>
                    <button
                        onClick={onAddRecord}
                        className="bg-brand-purple text-white font-semibold py-1 px-3 rounded-lg hover:bg-purple-700 text-sm"
                        title="Add New Record"
                    >
                        <i className="fas fa-plus mr-1"></i> Add
                    </button>
                </div>

                <div className="p-4 space-y-4 overflow-y-auto">
                    
                    {otherRecords.length === 0 ? (
                        <p className="text-slate-500 p-2 text-sm text-center bg-slate-50 rounded-lg">No lab reports, imaging, or visit notes uploaded yet.</p>
                    ) : (
                        otherRecords.map((r) => (
                            <RecordItem key={r.recordId} r={r} isPrescription={false} onViewRecord={onViewRecord} />
                        ))
                    )}
                </div>
            </div>
        );
    };

    // --- Prescriptions Sidebar Section (Bottom in 30% aside) ---
    const PrescriptionsSidebar = ({ user, onViewRecord }) => {
        const [prescriptions, setPrescriptions] = useState([]);
        const [loading, setLoading] = useState(true);
        
        useEffect(() => {
            const fetchPrescriptions = async () => {
                if (!user?.patientId) {
                    console.error("No patient ID available");
                    return;
                }
                
                setLoading(true);
                try {
                    console.log("Fetching prescriptions for patient:", user.patientId);
                    const response = await fetch(`http://localhost:8080/api/medications/patient/${user.patientId}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    // Transform and validate the data
                    const validPrescriptions = data.map(p => ({
                        ...p,
                        medication_id: p.medicationId || p.medication_id,
                        medication_name: p.medicationName || p.medication_name,
                        prescribed_by: p.prescribedBy || p.prescribed_by,
                        document_path: p.documentPath || p.document_path,
                        start_date: p.startDate || p.start_date,
                        end_date: p.endDate || p.end_date,
                    })).filter(p => p.medication_name); // Only include prescriptions with valid names
                    
                    console.log("Processed prescriptions:", validPrescriptions);
                    setPrescriptions(validPrescriptions);
                } catch (error) {
                    console.error("Error fetching prescriptions:", error);
                } finally {
                    setLoading(false);
                }
            };
            fetchPrescriptions();
        }, [user?.patientId]);

        return (
            <div className="flex flex-col bg-white rounded-2xl shadow-xl" id="prescriptions-sidebar">
                <div className="p-6 border-b border-slate-100 sticky top-0 bg-white z-10">
                    <h3 className="text-2xl font-bold text-brand-purple flex items-center">
                        <i className="fas fa-prescription-bottle-alt mr-2"></i> My Prescriptions 
                        <span className="ml-2 text-sm text-gray-500">({prescriptions.length})</span> 
                    </h3>
                </div>

                <div className="p-4 space-y-4 overflow-y-auto">
                    
                    {loading ? (
                        <div className="flex justify-center items-center p-4">
                            <span className="text-brand-purple">Loading prescriptions...</span>
                        </div>
                    ) : prescriptions.length === 0 ? (
                        <p className="text-slate-500 p-2 text-sm text-center bg-slate-50 rounded-lg">No prescriptions from your doctors yet.</p>
                    ) : (
                        <div className="grid grid-cols-1 gap-4">
                            {prescriptions.map((r) => (
                                <div key={r.medication_id} className="p-4 rounded-xl border border-brand-purple/20 bg-brand-purple/5 hover:shadow-md transition-shadow">
                                    <div className="flex justify-between items-start mb-2">
                                        <h4 className="font-semibold text-brand-purple">{r.medication_name}</h4>
                                        <span className="text-xs text-slate-500">{new Date(r.start_date).toLocaleDateString()}</span>
                                    </div>
                                    <p className="text-sm text-slate-600">
                                        <span className="font-medium">Dosage:</span> {r.dosage}
                                    </p>
                                    <p className="text-sm text-slate-600">
                                        <span className="font-medium">Frequency:</span> {r.frequency}
                                    </p>
                                    <p className="text-sm text-slate-600">
                                        <span className="font-medium">Prescribed by:</span> {r.prescribed_by}
                                    </p>
                                    {r.notes && (
                                        <p className="text-sm text-slate-500 mt-2 italic">
                                            Note: {r.notes}
                                        </p>
                                    )}
                                    <div className="mt-3 flex gap-2">
                                        <button
                                            onClick={() => onViewRecord(r)}
                                            className="text-xs font-semibold text-blue-600 hover:text-blue-800 p-1 rounded transition-colors flex items-center gap-1"
                                        >
                                            <i className="fas fa-eye"></i> View
                                        </button>
                                        {r.document_path && (
                                            <button
                                                onClick={() => alert('Downloading prescription...')}
                                                className="text-xs font-semibold text-green-600 hover:text-green-800 p-1 rounded transition-colors flex items-center gap-1"
                                            >
                                                <i className="fas fa-download"></i> Download
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );
    };
    
    // --- SearchableDoctorDropdown 
    const SearchableDoctorDropdown = ({ doctors, selectedDoctorId, onSelectDoctor, loading = false, error = null }) => {
        const [searchTerm, setSearchTerm] = useState("");
        const [isOpen, setIsOpen] = useState(false);
        const dropdownRef = useRef(null);

        const filteredDoctors = doctors.filter(doc =>
            `${doc.firstName} ${doc.lastName} ${doc.specialization}`
            .toLowerCase()
            .includes(searchTerm.toLowerCase())
        );

        const selectedDoctor = doctors.find(doc => doc.id === selectedDoctorId);
        
        const displayValue = selectedDoctor && !isOpen 
            ? `Dr. ${selectedDoctor.firstName} ${selectedDoctor.lastName}` 
            : searchTerm;
        
        const placeholder = loading 
            ? "Loading doctors..."
            : error 
            ? "Error loading doctors"
            : "Select Doctor..."; // <--- Placeholder Updated

        useEffect(() => {
            const handleClickOutside = (event) => {
                if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                    setIsOpen(false);
                    setSearchTerm("");
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [dropdownRef]);
        
        const handleInputFocus = () => {
            if (loading || error) return;
            setIsOpen(true);
            setSearchTerm("");
        };
        
        const handleInputChange = (e) => {
            if (loading || error) return;
            setSearchTerm(e.target.value);
            if (!isOpen) setIsOpen(true);
        };
        
        const handleSelectDoctor = (doc) => {
            onSelectDoctor(doc.id);
            setSearchTerm("");
            setIsOpen(false);
        };

        return (
            <div className="relative" ref={dropdownRef}>
                {/* This wrapper makes the whole thing clickable like a dropdown */}
                <div 
                    className={`w-full p-3 pl-3 pr-10 bg-white border rounded-lg focus:ring-2 focus:ring-brand-purple flex justify-between items-center cursor-pointer ${ // <-- FIX: bg-white ADDED
                        error ? 'border-red-300 bg-red-50' : 'border-gray-300'
                    } ${loading ? 'cursor-wait' : ''}`}
                    onClick={handleInputFocus} // Open list when clicking anywhere
                >
                    {/* Show selected doctor or placeholder */}
                    <span className={selectedDoctor ? 'text-slate-800' : 'text-slate-400'}>
                        {selectedDoctor ? `Dr. ${selectedDoctor.firstName} ${selectedDoctor.lastName}` : placeholder}
                    </span>
                    
                    {/* --- Arrow Icon --- */}
                    <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <i className="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
                
                {isOpen && !loading && !error && (
                    <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        {/* Search bar inside the dropdown */}
                        <input
                            type="text"
                            className="w-full p-3 border-b border-gray-200 sticky top-0"
                            placeholder="Search by name or specialty..."
                            autoFocus
                            onChange={handleInputChange}
                        />
                        {filteredDoctors.length > 0 ? (
                            filteredDoctors.map(doc => (
                                <div
                                    key={doc.id}
                                    className="p-3 hover:bg-brand-lavender/30 cursor-pointer"
                                    onMouseDown={(e) => {
                                        e.preventDefault();
                                        handleSelectDoctor(doc);
                                    }}
                                >
                                    <div className="flex items-center gap-2">
                                        <span>Dr. {doc.firstName} {doc.lastName}</span>
                                        <span className="text-slate-500">({doc.specialization})</span>
                                        {(doc.isVerified || doc.verified) && (
                                            <img src="https://cdn-icons-png.flaticon.com/128/2143/2143150.png" alt="Verified" title="Verified" className="w-5 h-5" />
                                        )}
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="p-3 text-slate-500">No doctors found.</div>
                        )}
                    </div>
                )}
                {loading && (
                    <div className="absolute right-10 top-1/2 transform -translate-y-1/2">
                        <i className="fas fa-spinner fa-spin text-brand-purple"></i>
                    </div>
                )}
                {error && (
                    <div className="absolute right-10 top-1/2 transform -translate-y-1/2">
                        <i className="fas fa-exclamation-triangle text-red-500"></i>
                    </div>
                )}
            </div>
        );
    };
    
    // --- MODIFIED DUMMY PAYMENT MODAL ---
    // --- MODIFIED DUMMY PAYMENT MODAL ---
    const DummyPaymentModal = ({ fee, onClose, onConfirmPayment, loading }) => {
        const [step, setStep] = useState(1); // 1: Select Method, 2: OTP
        const [method, setMethod] = useState('card');
        const [otp, setOtp] = useState('');
        const [paymentMessage, setPaymentMessage] = useState('');
        const [showCancelConfirm, setShowCancelConfirm] = useState(false);
        
        // This is the function passed from PatientDashboard (which includes the reset)
        const handleCloseClick = () => {
            if (!loading) setShowCancelConfirm(true);
        };
        
        const confirmCancel = () => {
            setShowCancelConfirm(false);
            onClose(); // <-- This now calls resetAppointmentForms()
        };
        
        const handlePayClick = () => {
            setPaymentMessage('');
            setStep(2); // Go to OTP step
        };
        
        const handleOtpConfirm = () => {
            if (otp.length !== 4) {
                setPaymentMessage('Please enter OTP.');
                return;
            }
            setPaymentMessage('Verifying OTP...');
            setTimeout(() => {
                onConfirmPayment();
            }, 1000); 
        };

        const renderPaymentForm = () => {
            if (method === 'card') {
                return (
                    <div className="space-y-4">
                        <input type="text" placeholder="Card Number (XXXX XXXX XXXX XXXX)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" maxLength="16" />
                        <div className="flex gap-4">
                            <input type="text" placeholder="MM/YY" className="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" maxLength="5" />
                            <input type="text" placeholder="CVV" className="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" maxLength="3" />
                        </div>
                        <input type="text" placeholder="Name on Card" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" />
                    </div>
                );
            } else if (method === 'upi') {
                return (
                    <div className="space-y-4">
                        <input type="text" placeholder="UPI ID (e.g., name@bank)" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" />
                        <p className="text-sm text-slate-500">A payment request will be sent to your UPI app.</p>
                    </div>
                );
            } else if (method === 'wallet') {
                return (
                    <div className="space-y-4">
                        <select className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple">
                            <option>Select Wallet</option>
                            <option>Paytm</option>
                            <option>Google Pay</option>
                            <option>PhonePe</option>
                        </select>
                        <input type="text" placeholder="Mobile Number" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-purple" maxLength="10" />
                    </div>
                );
            }
        };

        return (
            <div className="modal-overlay" onClick={handleCloseClick}>
                <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-800">Complete Your Payment</h2>
                        <button onClick={handleCloseClick} className="text-slate-500 hover:text-slate-800 text-2xl" disabled={loading}>&times;</button>
                    </div>
                    <div className="text-center mb-4">
                        <img src="https://razorpay.com/assets/razorpay-logo.svg" alt="Razorpay" className="h-12 mx-auto mb-4" />
                        <p className="text-lg text-slate-600">Total Amount:</p>
                        <p className="text-4xl font-bold text-brand-purple">₹{fee}</p>
                    </div>

                    {step === 1 && (
                        <>
                            <div className="flex justify-center mb-6 border-b">
                                {['card', 'upi', 'wallet'].map((m) => (
                                    <button
                                        key={m}
                                        className={`px-4 py-2 font-semibold capitalize ${
                                            method === m ? 'border-b-4 border-brand-purple text-brand-purple' : 'text-slate-500 hover:text-slate-800'
                                        }`}
                                        onClick={() => setMethod(m)}
                                    >
                                        {m}
                                    </button>
                                ))}
                            </div>
                            
                            <div className="mb-6 p-4 border rounded-lg bg-slate-50">
                                {renderPaymentForm()}
                            </div>

                            <button 
                                onClick={handlePayClick}
                                disabled={loading}
                                className={`w-full text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 ${
                                    loading ? "bg-gray-400 cursor-not-allowed" : "bg-brand-purple hover:bg-purple-700"
                                }`}
                            >
                                {loading ? "Processing Payment..." : `Pay ₹${fee}`}
                            </button>
                        </>
                    )}

                    {step === 2 && (
                        <div className="text-center">
                            <p className="text-slate-600 mb-4">
                                Enter the 4-digit OTP sent to your number/email to confirm payment.
                            </p>
                            <div className="flex justify-center space-x-2 mb-6">
                                <input
                                    type="text"
                                    value={otp}
                                    onChange={(e) => setOtp(e.target.value.replace(/[^0-9]/g, '').slice(0, 4))}
                                    placeholder="••••"
                                    maxLength="4"
                                    className="text-3xl font-bold text-center w-32 p-3 border-2 border-brand-purple rounded-lg focus:outline-none focus:border-purple-700"
                                />
                            </div>
                            {paymentMessage && <p className="text-red-600 text-sm mb-4">{paymentMessage}</p>}
                            <button
                                onClick={handleOtpConfirm}
                                disabled={loading}
                                className={`w-full text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 ${
                                    loading ? "bg-gray-400 cursor-not-allowed" : "bg-green-600 hover:bg-green-700"
                                }`}
                            >
                                {loading ? "Verifying..." : "Confirm OTP & Pay"}
                            </button>
                            <button
                                onClick={() => setStep(1)}
                                disabled={loading}
                                className="w-full text-slate-500 font-semibold py-2 mt-2"
                            >
                                Go Back
                            </button>
                        </div>
                    )}
                </div>
                {showCancelConfirm && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={(e) => e.stopPropagation()}>
                        <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm">
                            <h3 className="text-xl font-bold text-slate-800 mb-4">Cancel Payment?</h3>
                            <p className="text-slate-600 mb-6">Are you sure you want to cancel this payment?</p>
                            <div className="flex gap-3">
                                <button onClick={confirmCancel} className="flex-1 bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700">Yes, Cancel</button>
                                <button onClick={() => setShowCancelConfirm(false)} className="flex-1 bg-gray-300 text-slate-800 py-2 rounded-lg font-semibold hover:bg-gray-400">No, Continue</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };
    // --- NEW SIDEBAR COMPONENT (Handles form reset) ---
    // --- REUSABLE SIDEBAR COMPONENT (UPDATED) ---
    // Replace your OLD Sidebar const with this one.
    const Sidebar = ({ isOpen, toggle, activeSection, onSelectSection, menuItems, onLogout, userRole = 'patient' }) => {
        
        // Theme configuration: 
        // 'doctor' = Purple & Yellow
        // 'patient' = Purple & Pink (Default)
        const theme = userRole === 'doctor' ? {
            active: 'bg-gradient-to-r from-purple-600 to-yellow-500 text-white shadow-lg transform scale-105',
            hover: 'text-slate-500 hover:bg-yellow-50 hover:text-yellow-600',
            toggle: 'text-yellow-600 hover:bg-yellow-50',
            logo: 'from-purple-600 to-yellow-500',
            logout: 'text-red-500 hover:bg-red-50'
        } : {
            active: 'bg-gradient-to-r from-purple-600 to-brand-purple text-white shadow-lg transform scale-105',
            hover: 'text-slate-500 hover:bg-purple-50 hover:text-brand-purple',
            toggle: 'text-brand-purple hover:bg-purple-50',
            logo: 'from-purple-600 to-green-500',
            logout: 'text-red-500 hover:bg-red-50'
        };

        return (
            <div className={`${isOpen ? 'w-72' : 'w-20'} bg-white h-screen transition-all duration-300 ease-in-out flex flex-col border-r border-slate-200 fixed left-0 top-0 z-50 shadow-2xl overflow-hidden`}>
                {/* Toggle Button Area */}
                <div className="h-24 flex items-center justify-center border-b border-slate-100">
                    <button 
                        onClick={toggle} 
                        className={`${theme.toggle} p-3 rounded-xl transition-all duration-200 focus:outline-none transform hover:scale-110`}
                    >
                        <i className="fas fa-bars text-3xl"></i>
                    </button>
                    {isOpen && (
                        <span className={`ml-3 font-extrabold text-2xl text-transparent bg-clip-text bg-gradient-to-r ${theme.logo} tracking-tight whitespace-nowrap animate-fade-in`}>
                            MedVault
                        </span>
                    )}
                </div>

                {/* Menu Items */}
                <nav className="flex-1 overflow-y-auto overflow-x-hidden py-6 space-y-2 pl-3 pr-5 sidebar-scroll">
                    {menuItems.map((item) => (
                        <button
                            key={item.id}
                            onClick={() => onSelectSection(item.id)}
                            className={`w-full flex items-center ${isOpen ? 'justify-start px-3 gap-3' : 'justify-center'} py-3 rounded-xl transition-all duration-200 relative group ${
                                activeSection === item.id ? theme.active : theme.hover
                            }`}
                            title={!isOpen ? item.label : ''}
                        >
                            <i className={`fas ${item.icon} text-lg transition-transform ${activeSection === item.id ? 'scale-110' : ''} flex-shrink-0`}></i>
                            {isOpen && <span className="font-semibold text-base leading-tight whitespace-nowrap pr-3">{item.label}</span>}
                        </button>
                    ))}
                </nav>

                {/* Logout */}
                <div className="p-4 border-t border-slate-100">
                    <button 
                        onClick={onLogout}
                        className={`w-full flex items-center ${isOpen ? 'justify-start px-3 gap-3' : 'justify-center'} py-3 ${theme.logout} rounded-xl transition-colors font-semibold text-base`}
                    >
                        <i className="fas fa-sign-out-alt text-lg"></i>
                        {isOpen && <span className="whitespace-nowrap pr-3">Logout</span>}
                    </button>
                </div>
            </div>
        );
    };
    // --- FINAL PATIENT DASHBOARD (Feedback Box Fixed, Urgency Icons Updated) ---
const PatientDashboard = ({ user, onLogout }) => {
        // --- STATE ---
        const [doctors, setDoctors] = useState([]);
        const [appointments, setAppointments] = useState([]);
        const [medicalRecords, setMedicalRecords] = useState([]);
        const [medicalConditions, setMedicalConditions] = useState([]);
        const [prescriptions, setPrescriptions] = useState([]);
        const [emergencyRequests, setEmergencyRequests] = useState([]);
        const [notifications, setNotifications] = useState([]);
        const [pendingConsentRequests, setPendingConsentRequests] = useState([]);
        const [accessRequests, setAccessRequests] = useState([]);
        const [userIssues, setUserIssues] = useState([]);
        const [showReportIssueModal, setShowReportIssueModal] = useState(false);
        const [issueForm, setIssueForm] = useState({ name: '', email: '', phoneNumber: '', subject: '', message: '' });
        
        // --- UI STATE ---
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);
        const [activeSection, setActiveSection] = useState('dashboard');
        const [activeTab, setActiveTab] = useState('all');
        const [showNotifications, setShowNotifications] = useState(false);
        const [unreadCount, setUnreadCount] = useState(0);
        
        // --- FORMS & DATA ---
        const [profileData, setProfileData] = useState({});
        const [isEditingProfile, setIsEditingProfile] = useState(false);
        const [selectedDoctorId, setSelectedDoctorId] = useState("");
        const [selectedDate, setSelectedDate] = useState("");
        const [selectedTime, setSelectedTime] = useState("");
        const [availableSlots, setAvailableSlots] = useState([]);
        const [reason, setReason] = useState("");
        const [selectedDoctorFee, setSelectedDoctorFee] = useState(null); // <-- Fee state
        
        const defaultEmergencyData = {
            doctorId: '', urgencyLevel: '', preferredDate: '', preferredTime: '', currentLocation: '', conditionDescription: ''
        };
        const [emergencyData, setEmergencyData] = useState(defaultEmergencyData);

        // --- LOADERS & MODALS ---
        const [loading, setLoading] = useState(false);
        const [doctorsLoading, setDoctorsLoading] = useState(true);
        const [loadingSlots, setLoadingSlots] = useState(false);
        const [successMessage, setSuccessMessage] = useState("");
        const [errorMessage, setErrorMessage] = useState("");
        const [conditionMessage, setConditionMessage] = useState("");
        
        const [showDummyPaymentModal, setShowDummyPaymentModal] = useState(false);
        const [showFeedbackModal, setShowFeedbackModal] = useState(false);
        const [selectedAppointmentForFeedback, setSelectedAppointmentForFeedback] = useState(null);
        const [showAddConditionModal, setShowAddConditionModal] = useState(false);
        
        // Reschedule Modal State
        const [showRescheduleModal, setShowRescheduleModal] = useState(false);
        const [selectedAppointmentForReschedule, setSelectedAppointmentForReschedule] = useState(null);
        const [rescheduleDate, setRescheduleDate] = useState('');
        const [rescheduleTime, setRescheduleTime] = useState('');
        const [rescheduleSlotId, setRescheduleSlotId] = useState(null); // Track selected slot ID for rescheduling
        const [availableSlotsForReschedule, setAvailableSlotsForReschedule] = useState([]);
        const [allDoctorSlotsForReschedule, setAllDoctorSlotsForReschedule] = useState([]);
        const [showAddRecordModal, setShowAddRecordModal] = useState(false);
        const [selectedRecordForView, setSelectedRecordForView] = useState(null);

        const sidebarItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-line' },
            { id: 'profile', label: 'My Profile', icon: 'fa-user-circle' },
            { id: 'book-appointment', label: 'Book Appointment', icon: 'fa-calendar-plus' },
            { id: 'emergency', label: 'Emergency Appointment', icon: 'fa-ambulance' },
            { id: 'appointments', label: 'Appointments', icon: 'fa-calendar-alt' },
            { id: 'conditions', label: 'Medical Conditions', icon: 'fa-notes-medical' },
            { id: 'records', label: 'Health Records', icon: 'fa-file-medical' },
            { id: 'prescriptions', label: 'Prescriptions', icon: 'fa-prescription-bottle-alt' },
            { id: 'reports', label: 'Reports & Issues', icon: 'fa-flag' },
        ];
        // --- NOTIFICATION: Reusable function to fetch all notifications ---
        const fetchNotifications = () => {
            if (!user?.userId) return; // Use userId for both patients and doctors
            fetch(`http://localhost:8080/api/notifications/user/${user.userId}`)
                .then(r => r.ok ? r.json() : [])
                .then(d => { 
                    setNotifications(d); 
                    setUnreadCount(d.filter(n => !n.isRead).length); 
                })
                .catch(console.error);
        };

        // --- NOTIFICATION: Handler for clicking the bell icon ---
        const handleBellClick = () => {
            setShowNotifications(prev => !prev); // Toggle the view
            
            // If we are opening the list AND there are unread items
            if (!showNotifications && unreadCount > 0) {
                fetch(`http://localhost:8080/api/notifications/user/${user.userId}/read-all`, {
                    method: 'PUT'
                })
                .then(res => {
                    if (res.ok) {
                        setUnreadCount(0); // Optimistically set count to 0
                        
                        // Update the local list to show as "read"
                        setNotifications(prev => prev.map(n => ({ ...n, isRead: true })));
                    }
                })
                .catch(console.error);
            }
        };

        // --- NOTIFICATION: Handler for clicking a single notification item ---
        const handleNotificationClick = (notification) => {
            // Mark as read if it's not already
            if (!notification.isRead) {
                fetch(`http://localhost:8080/api/notifications/${notification.notificationId}/read`, {
                    method: 'PUT'
                })
                .catch(console.error); // Fire and forget
            }
            
            // --- Navigation Logic ---
            // If it's an appointment, go to the appointments page
            if (notification.notificationType && notification.notificationType.includes('APPOINTMENT')) {
                setActiveSection('appointments');
            }
            
            setShowNotifications(false); // Close dropdown
        };
        // --- HELPER: Get Doctor ID ---
        const getDocId = (d) => d.id || d.doctorId || d.userId || d.professionalId;

        // --- HELPER: Time Slots ---
        const generateTimeSlots = () => {
            const slots = [];
            for (let hour = 9; hour < 21; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const startHour = hour;
                    const startMin = minute;
                    const startTime = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`;
                    const period = startHour >= 12 ? 'PM' : 'AM';
                    const displayHour = startHour > 12 ? startHour - 12 : startHour;
                    const displayMin = String(startMin).padStart(2, '0');
                    slots.push({ value: startTime, label: `${displayHour}:${displayMin} ${period}` });
                }
            }
            return slots;
        };
        const allTimeSlots = generateTimeSlots();

        // --- FILTERS ---
        // Completed emergencies: status is COMPLETED OR (status is APPROVED AND date has passed)
        const completedEmergencies = emergencyRequests.filter(req => 
            req.status === 'COMPLETED' || 
            (req.status === 'APPROVED' && new Date(req.requestDateTime) < new Date())
        );
        
        // Active emergencies: PENDING status OR (APPROVED and future date)
        const activeEmergencies = emergencyRequests.filter(req => 
            req.status === 'PENDING' || 
            (req.status === 'APPROVED' && new Date(req.requestDateTime) >= new Date())
        );
        
        // Include only APPROVED emergency appointments with FUTURE dates for Next Appointments section
        const approvedEmergencyAppointments = emergencyRequests.filter(req => {
            const reqDate = new Date(req.requestDateTime);
            const now = new Date();
            const isFuture = reqDate >= now;
            console.log('🚨 Emergency check:', req.requestId, 'status:', req.status, 'date:', req.requestDateTime, 'isFuture:', isFuture);
            return req.status === 'APPROVED' && isFuture;
        });
        console.log('🚨 Approved Emergency Appointments for Next:', approvedEmergencyAppointments);
        
        // For Approved tab: ONLY regular appointments (no emergency)
        const upcoming = appointments.filter((a) => a.status && a.status.toUpperCase() === "APPROVED");
        
        // For Next Appointments section: Include both regular and emergency
        const nextAppointments = [...upcoming, ...approvedEmergencyAppointments];
        console.log('📅 Next Appointments total:', nextAppointments.length, 'regular:', upcoming.length, 'emergency:', approvedEmergencyAppointments.length);
        console.log('📅 nextAppointments array:', nextAppointments);
        console.log('📅 emergencyRequests state:', emergencyRequests);
        const pending = appointments.filter((a) => a.status && a.status.toUpperCase() === "PENDING");
        const rejected = appointments.filter((a) => a.status && a.status.toUpperCase() === "REJECTED");
        const completed = [
            ...appointments.filter((a) => a.status && a.status.toUpperCase() === "COMPLETED"),
            ...completedEmergencies.map(e => ({...e, isEmergency: true, displayStatus: 'COMPLETED (Emergency)'}))
        ];
        const today = new Date(new Date().setHours(0, 0, 0, 0));
        const activePrescriptions = prescriptions.filter(p => new Date(p.endDate || p.end_date) >= today);
        const pastPrescriptions = prescriptions.filter(p => new Date(p.endDate || p.end_date) < today);
        // --- DATA FETCHING ---
        useEffect(() => {
            const fetchDoctors = async () => {
                setDoctorsLoading(true);
                try {
                    const response = await fetch(`http://localhost:8080/api/doctors`);
                    if (!response.ok) throw new Error('Failed');
                    const data = await response.json();
                    setDoctors(Array.isArray(data) ? data : []);
                } catch (err) { setDoctors([]); } 
                finally { setDoctorsLoading(false); }
            };
            fetchDoctors();

            if (user?.patientId) {
                 fetch(`http://localhost:8080/api/patients/${user.patientId}`).then(r=>r.json()).then(d=> setProfileData(d)).catch(console.error);
                 fetch(`http://localhost:8080/api/notifications/user/${user.userId}`).then(r => r.ok ? r.json() : []).then(d => { setNotifications(d); setUnreadCount(d.filter(n => !n.isRead).length); }).catch(console.error);
                 fetch(`http://localhost:8080/api/consent-requests/pending?patientId=${user.patientId}`, { credentials: 'include' }).then(r=>r.ok?r.json():[]).then(setPendingConsentRequests).catch(console.error);

                 fetchPatientAppointments();
                 fetchMedicalRecords();
                 fetchMedicalConditions();
                 fetchPrescriptions();
                 fetchEmergencyRequests();
                 fetchUserIssues();
            }
        }, [user]);

        const fetchMedicalRecords = () => { if (user?.patientId) fetch(`http://localhost:8080/api/records/patient/${user.patientId}`).then(r=>r.json()).then(d=>setMedicalRecords(d.sort((a, b) => new Date(b.recordDate) - new Date(a.recordDate)))).catch(console.error); };
        const fetchPatientAppointments = () => { 
            if (user?.patientId) {
                fetch(`http://localhost:8080/api/appointments/patient/${user.patientId}`)
                    .then(r => r.json())
                    .then(d => {
                        console.log('📅 Fetched appointments:', d);
                        console.log('📅 Rejected appointments:', d.filter(a => a.status && a.status.toUpperCase() === 'REJECTED'));
                        setAppointments(Array.isArray(d) ? d : []);
                    })
                    .catch(err => {
                        console.error('❌ Error fetching appointments:', err);
                        setAppointments([]);
                    });
            }
        };
        const fetchMedicalConditions = () => { if (user?.patientId) fetch(`http://localhost:8080/api/medical-conditions/patient/${user.patientId}`).then(r=>r.json()).then(d=>setMedicalConditions(d)).catch(console.error); };
        const fetchPrescriptions = () => { if (user?.patientId) fetch(`http://localhost:8080/api/medications/patient/${user.patientId}`).then(r=>r.json()).then(d=>setPrescriptions(d.sort((a, b) => new Date(b.start_date) - new Date(a.start_date)))).catch(console.error); };
        const fetchEmergencyRequests = () => { 
            if (user?.patientId) {
                console.log('🚨 Fetching emergency requests for patient:', user.patientId);
                fetch(`http://localhost:8080/api/emergency-requests/patient/${user.patientId}`)
                    .then(r => {
                        if (!r.ok) {
                            console.error('❌ Emergency requests fetch failed with status:', r.status);
                            return [];
                        }
                        return r.json();
                    })
                    .then(d => {
                        console.log('🚨 Emergency requests received:', d);
                        setEmergencyRequests(Array.isArray(d) ? d : []);
                    })
                    .catch(err => {
                        console.error('❌ Error fetching emergency requests:', err);
                        setEmergencyRequests([]);
                    });
            }
        };
        const fetchUserIssues = () => { if (user?.email) fetch(`http://localhost:8080/api/issues/email/${user.email}`).then(r=>r.ok?r.json():[]).then(d=>setUserIssues(d)).catch(console.error); };

        // --- SLOT LOGIC ---
        const [allSlotsBookedForDate, setAllSlotsBookedForDate] = useState(false);
        const [doctorHasNoSlots, setDoctorHasNoSlots] = useState(false);
        
        useEffect(() => {
            if (selectedDoctorId && selectedDate) {
                setLoadingSlots(true);
                setAvailableSlots([]); 
                setSelectedTime("");
                setAllSlotsBookedForDate(false);
                setDoctorHasNoSlots(false);
                
                // Fetch all slots for the doctor on this date (both available and booked)
                Promise.all([
                    fetch(`http://localhost:8080/api/slots/available/${selectedDoctorId}?date=${selectedDate}`).then(res => res.ok ? res.json() : []),
                    fetch(`http://localhost:8080/api/slots/doctor/${selectedDoctorId}`).then(res => res.ok ? res.json() : [])
                ])
                .then(([availableData, allDoctorSlots]) => {
                    const available = Array.isArray(availableData) ? availableData : [];
                    const allSlots = Array.isArray(allDoctorSlots) ? allDoctorSlots : [];
                    
                    // Filter slots for the selected date
                    const slotsForDate = allSlots.filter(s => s.slotDate === selectedDate);
                    
                    if (slotsForDate.length === 0) {
                        // Doctor has no slots defined for this date - allow any time
                        setDoctorHasNoSlots(true);
                        setAllSlotsBookedForDate(false);
                    } else if (available.length === 0) {
                        // Doctor has slots but all are booked
                        setAllSlotsBookedForDate(true);
                        setDoctorHasNoSlots(false);
                    }
                    
                    setAvailableSlots(available);
                    setLoadingSlots(false);
                })
                .catch(() => { 
                    setAvailableSlots([]); 
                    setLoadingSlots(false); 
                    setDoctorHasNoSlots(true); // On error, allow any time selection
                });
            }
        }, [selectedDoctorId, selectedDate]);

        // --- NEW: Function to reset appointment and emergency forms ---
        const resetAppointmentForms = () => {
            console.log("Resetting forms...");
            // Reset regular appointment
            setSelectedDoctorId("");
            setSelectedDate("");
            setSelectedTime("");
            setAvailableSlots([]);
            setReason("");
            setSelectedDoctorFee(null); // <-- FIX: Reset fee
            setAllSlotsBookedForDate(false);
            setDoctorHasNoSlots(false);
            
            // Reset emergency request
            setEmergencyData(defaultEmergencyData);
            
            // Clear any lingering messages
            setSuccessMessage("");
            setErrorMessage("");
        };

        // --- NEW: Handler for changing sections that also resets forms ---
        const handleSectionSelect = (sectionId) => {
            // If we are navigating *away* from these sections, reset them.
            if (activeSection === 'book-appointment' || activeSection === 'emergency') {
                if (sectionId !== 'book-appointment' && sectionId !== 'emergency') {
                     resetAppointmentForms();
                }
            }
            setActiveSection(sectionId);
        };
        
        // --- UPDATED: Handler for doctor selection (to set fee) ---
        const handleDoctorSelect = (id) => {
            setSelectedDoctorId(id);
            setSelectedDate("");
            setSelectedTime("");
            setAvailableSlots([]);
            // --- FIX: Set fee on select ---
            const doctor = doctors.find(d => getDocId(d) === id);
            setSelectedDoctorFee(doctor?.consultationFee > 0 ? doctor.consultationFee : null); 
        };
        
        // --- UPDATED: Handler for emergency doctor selection (to set fee) ---
        const handleEmergencyDoctorSelect = (id) => {
            setEmergencyData({...emergencyData, doctorId: id});
            // --- FIX: Set fee on select ---
            const doctor = doctors.find(d => getDocId(d) === id);
            setSelectedDoctorFee(doctor?.consultationFee > 0 ? doctor.consultationFee : null);
        };

        const handleDateChange = (date) => { setSelectedDate(date); setSelectedTime(""); };

        // --- PAYMENT & BOOKING ---
        const initiatePayment = () => {
             if (activeSection === 'book-appointment' && (!selectedDoctorId || !selectedDate || !selectedTime)) { 
                 setErrorMessage("Please select details"); return; 
             }
             if (activeSection === 'emergency' && !emergencyData.doctorId) {
                 setErrorMessage("Please select a doctor"); return;
             }
             setErrorMessage("");
             
             if (selectedDoctorFee && selectedDoctorFee > 0) {
                 setShowDummyPaymentModal(true);
             } else {
                 if (activeSection === 'emergency') submitEmergencyRequest();
                 else processBooking(null);
             }
        };

        const processBooking = async (pid) => {
             // Find the selected slot to get its slotId
             const selectedSlot = availableSlots.find(slot => slot.slotTime === selectedTime || slot.value === selectedTime);
             // Fix: Handle time format - if already has seconds (HH:mm:ss), don't add more
             const timeFormatted = selectedTime.split(':').length >= 3 ? selectedTime : `${selectedTime}:00`;
             const appointmentData = { 
                 doctorId: selectedDoctorId, 
                 patientId: user.patientId, 
                 appointmentDateTime: `${selectedDate}T${timeFormatted}`, 
                 reason: reason || "General",
                 slotId: selectedSlot?.slotId || null
             };
             
             console.log('📅 Booking appointment with data:', appointmentData);
             
             try {
                 const response = await fetch(`http://localhost:8080/api/appointments/book`, { 
                     method: "POST", 
                     headers: { "Content-Type": "application/json" }, 
                     body: JSON.stringify(appointmentData) 
                 });
                 
                 if (!response.ok) {
                     const errorText = await response.text();
                     console.error("❌ Booking failed:", errorText);
                     setErrorMessage("Failed to book appointment: " + errorText);
                     return;
                 }
                 
                 const result = await response.json();
                 console.log('✅ Appointment booked successfully:', result);
                 
                 fetchPatientAppointments();
                 resetAppointmentForms();
                 // Show success message AFTER reset so it doesn't get cleared
                 setSuccessMessage("Appointment Booked Successfully!"); 
                 setTimeout(()=>setSuccessMessage(""),5000); 
             } catch(e) { 
                 console.error("❌ Booking error:", e);
                 setErrorMessage("Failed to book appointment: " + e.message); 
             }
        };

        const submitEmergencyRequest = async () => {
            try {
                await fetch(`http://localhost:8080/api/emergency-requests/create`, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patientId: user.patientId, doctorId: emergencyData.doctorId, conditionDescription: emergencyData.conditionDescription, urgencyLevel: emergencyData.urgencyLevel, currentLocation: emergencyData.currentLocation, requestDateTime: `${emergencyData.preferredDate}T${emergencyData.preferredTime}` })
                });
                fetchEmergencyRequests();
                resetAppointmentForms();
                // Show success message AFTER reset so it doesn't get cleared
                setSuccessMessage("Emergency Request Sent Successfully!");
                setTimeout(()=>setSuccessMessage(""),5000);
            } catch(e) { setErrorMessage("Failed to send request"); }
        };

        const handleDummyPaymentConfirm = async () => {
            setShowDummyPaymentModal(false);
            if (activeSection === 'emergency') {
                await submitEmergencyRequest();
            } else { 
                await processBooking("dummy_id"); 
            }
        };

        const handleProfileUpdate = async () => {
            try {
                const response = await fetch(`http://localhost:8080/api/patients/${user.patientId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(profileData) });
                if (response.ok) { setSuccessMessage('✅ Profile updated successfully!'); setIsEditingProfile(false); setTimeout(() => setSuccessMessage(''), 3000); }
            } catch (err) { setErrorMessage('Failed to update profile'); }
        };
        
        const handleConsentResponse = async (requestId, status) => {
            try {
                const response = await fetch(`http://localhost:8080/api/consent-requests/${requestId}`, { 
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${user.token}` }, 
                    body: JSON.stringify({ status }) 
                });
                if (response.ok) {
                    setSuccessMessage(`Access ${status.toLowerCase()}!`);
                    setPendingConsentRequests(prev => prev.filter(req => req.id !== requestId));
                    setTimeout(() => setSuccessMessage(""), 3000);
                } else {
                    const error = await response.text();
                    setErrorMessage(error);
                }
            } catch (error) { setErrorMessage(error.message); }
        };

        return (
            <div className="flex min-h-screen bg-brand-bg font-sans">
                {/* SIDEBAR (Prop updated) */}
                <Sidebar 
                    isOpen={isSidebarOpen} 
                    toggle={() => setIsSidebarOpen(!isSidebarOpen)} 
                    activeSection={activeSection}
                    onSelectSection={handleSectionSelect} // <-- UPDATED PROP
                    menuItems={sidebarItems}
                    onLogout={onLogout}
                />

                {/* CONTENT */}
                <div className={`flex-1 flex flex-col transition-all duration-300 ${isSidebarOpen ? 'ml-72' : 'ml-20'}`}>
                    
                    {/* HEADER */}
                    <header className="bg-gradient-to-r from-purple-600 to-green-500 shadow-lg sticky top-0 z-30 px-8 py-4 h-20 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <h1 className="text-2xl font-extrabold text-white flex items-center cursor-pointer" onClick={()=>window.location.reload()}>
                                <i className="fas fa-shield-heart text-3xl mr-2"></i> MedVault
                            </h1>
                        </div>

                        <div className="flex items-center gap-6">
                            <button onClick={() => { sessionStorage.removeItem('loggedInUser'); window.location.href = 'http://localhost:5173/'; }} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-full font-bold flex items-center transition-all">
                                <i className="fas fa-home mr-2"></i> Home
                            </button>
                            <button onClick={() => { window.location.hash = '#support'; }} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-full font-bold flex items-center transition-all">
                                <i className="fas fa-exclamation-circle mr-2"></i> Report Issue
                            </button>
                            <div className="relative">
                                <button onClick={handleBellClick} className="text-white hover:text-yellow-200 relative transition-colors transform hover:scale-110">
                                    <i className="fas fa-bell text-2xl"></i>
                                    {unreadCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">{unreadCount}</span>}
                                </button>
                                 {showNotifications && (
                                    <div className="absolute right-0 mt-4 w-80 bg-white rounded-xl shadow-2xl z-50 max-h-96 overflow-y-auto border border-slate-100">
                                        <div className="p-4 border-b bg-purple-50"><h3 className="font-bold text-brand-purple">Notifications</h3></div>
                                        {notifications.length === 0 ? <p className="p-4 text-slate-500 text-center">No notifications</p> : notifications.map(n => (
                                            <div key={n.notificationId} className="p-4 border-b hover:bg-slate-50"><p className="text-sm text-slate-800">{n.message}</p></div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="p-8 pb-20 max-w-7xl w-full mx-auto">
                        
                        {/* BANNER */}
                        <div className="flex items-center gap-6 bg-gradient-to-r from-purple-600 to-brand-purple rounded-3xl shadow-lg p-8 mb-10 text-white animate-fade-in">
                            <img
                                src={user.profilePictureUrl || `https://placehold.co/128x128/B8BDFF/7209B7?text=${user.name?.charAt(0)}`}
                                alt="Profile"
                                className="w-24 h-24 rounded-full border-4 border-white shadow-lg object-cover"
                            />
                            <div>
                                <h2 className="text-4xl font-bold mb-2">{getISTGreeting()}, {profileData.firstName || user.name}!</h2>
                                <p className="text-purple-100 text-lg opacity-90 italic">Let's take care of your health today.</p>
                            </div>
                        </div>

                        {/* DASHBOARD STATS */}
                        {activeSection === 'dashboard' && (
                            <div className="animate-fade-in">
                                {pendingConsentRequests.length > 0 && (
                                    <div className="mb-8 bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-r-xl shadow-sm">
                                        <h4 className="text-lg font-bold text-yellow-800 mb-4 flex items-center">
                                            <i className="fas fa-key mr-2"></i> Pending Access Requests
                                        </h4>
                                        <div className="space-y-3">
                                            {pendingConsentRequests.map(req => (
                                                <div key={req.id} className="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                                                    <div>
                                                        <p className="font-bold text-slate-800">Dr. {req.doctorName}</p>
                                                        <p className="text-sm text-slate-600">Requests access to your records.</p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleConsentResponse(req.id, 'APPROVED')} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm font-bold">Approve</button>
                                                        <button onClick={() => handleConsentResponse(req.id, 'REJECTED')} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm font-bold">Deny</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-purple-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i className="fas fa-calendar-check text-2xl"></i></div>
                                        <div><p className="text-3xl font-bold text-slate-800">{nextAppointments.length}</p><p className="text-slate-500 font-bold text-xs uppercase">Upcoming Appointments</p></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-green-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i className="fas fa-clipboard-check text-2xl"></i></div>
                                        <div><p className="text-3xl font-bold text-slate-800">{completed.length}</p><p className="text-slate-500 font-bold text-xs uppercase">Completed Appointments</p></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-blue-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i className="fas fa-prescription-bottle-alt text-2xl"></i></div>
                                        {/* --- UPDATE THIS LINE --- */}
                                        <div><p className="text-3xl font-bold text-slate-800">{activePrescriptions.length}</p><p className="text-slate-500 font-bold text-xs uppercase">Active Prescriptions</p></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-teal-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-teal-100 rounded-full flex items-center justify-center text-teal-600"><i className="fas fa-notes-medical text-2xl"></i></div>
                                        <div><p className="text-3xl font-bold text-slate-800">{medicalConditions.length}</p><p className="text-slate-500 font-bold text-xs uppercase">Medical Conditions</p></div>
                                    </div>
                                </div>
                                
                                {/* Next Appointments - Show ALL upcoming appointments */}
                                <div className="bg-white rounded-2xl shadow-lg p-6">
                                    <h4 className="text-xl font-bold text-slate-800 mb-4 flex items-center"><i className="fas fa-calendar-alt mr-2 text-purple-600"></i> Next Appointments ({nextAppointments.length})</h4>
                                    {nextAppointments.length === 0 ? <p className="text-slate-500 text-center py-8">No upcoming appointments.</p> : (
                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {nextAppointments.map(a => {
                                                const isEmergency = a.requestDateTime !== undefined;
                                                const dateTime = isEmergency ? a.requestDateTime : a.appointmentDateTime;
                                                const doctorName = isEmergency 
                                                    ? (doctors.find(d => (d.professionalId || d.id) === a.doctorId) ? `Dr. ${doctors.find(d => (d.professionalId || d.id) === a.doctorId).firstName} ${doctors.find(d => (d.professionalId || d.id) === a.doctorId).lastName}` : 'Dr. N/A')
                                                    : `Dr. ${a.doctor?.firstName} ${a.doctor?.lastName}`;
                                                const reason = isEmergency ? a.conditionDescription : a.reason;
                                                const doctorInitial = isEmergency 
                                                    ? (doctors.find(d => (d.professionalId || d.id) === a.doctorId)?.firstName?.charAt(0) || 'D')
                                                    : (a.doctor?.firstName?.charAt(0) || 'D');
                                                
                                                return (
                                                    <div key={a.appointmentId || a.requestId} className={`flex justify-between items-center p-4 rounded-xl border ${isEmergency ? 'bg-red-50 border-red-300 shadow-lg animate-pulse-slow' : 'bg-green-50 border-green-100'}`}>
                                                        <div className="flex items-center gap-4">
                                                            <div className={`w-12 h-12 ${isEmergency ? 'bg-red-600' : 'bg-brand-purple'} text-white rounded-full flex items-center justify-center font-bold text-xl`}>
                                                                {isEmergency ? '🚨' : doctorInitial}
                                                            </div>
                                                            <div>
                                                                <p className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                                                    {doctorName}
                                                                    {isEmergency && <span className="text-xs bg-red-600 text-white px-2 py-1 rounded-full font-bold">EMERGENCY</span>}
                                                                </p>
                                                                <div className="flex items-center gap-3">
                                                                    <p className="text-sm text-slate-600 font-medium">{new Date(dateTime).toLocaleString()}</p>
                                                                    {reason && <span className="text-sm text-slate-500 border-l border-slate-300 pl-3">{reason}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <span className={`px-3 py-1 ${isEmergency ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'} rounded-full text-xs font-bold`}>
                                                            {isEmergency ? 'EMERGENCY' : 'APPROVED'}
                                                        </span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* PROFILE */}
                        {activeSection === 'profile' && (
                            <section className="bg-white rounded-2xl shadow-lg p-8 animate-fade-in">
                                <div className="flex justify-between items-center mb-8 border-b pb-4">
                                    <div className="flex items-center gap-3">
                                        <i className="fas fa-user-circle text-4xl text-slate-800"></i>
                                        <h3 className="text-3xl font-bold text-slate-800">My Profile</h3>
                                    </div>
                                    {!isEditingProfile ? (
                                        <button onClick={() => setIsEditingProfile(true)} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700 transition-all"><i className="fas fa-edit mr-2"></i>Edit Profile</button>
                                    ) : (
                                        <div className="flex gap-3">
                                            <button onClick={handleProfileUpdate} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold">Save</button>
                                            <button onClick={() => setIsEditingProfile(false)} className="bg-slate-500 text-white px-6 py-2 rounded-lg font-bold">Cancel</button>
                                        </div>
                                    )}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {['firstName', 'lastName'].map(field => (
                                        <div key={field}>
                                            <label className="block text-sm font-bold text-slate-800 mb-2 capitalize">{field.replace(/([A-Z])/g, ' $1').trim()}</label>
                                            <input 
                                                type="text"
                                                value={profileData[field] || ''} 
                                                disabled={!isEditingProfile}
                                                onChange={(e) => setProfileData({...profileData, [field]: e.target.value})}
                                                className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500 bg-slate-50 disabled:bg-slate-100 disabled:text-slate-600"
                                            />
                                        </div>
                                    ))}
                                    {/* Email field - fetched from User object */}
                                    <div>
                                        <label className="block text-sm font-bold text-slate-800 mb-2 capitalize">Email</label>
                                        <input 
                                            type="email"
                                            value={profileData.email || ''} 
                                            disabled={true} // Email should not be editable from here
                                            className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500 bg-slate-100 text-slate-600"
                                        />
                                    </div>
                                    {/* Gender field */}
                                    <div>
                                        <label className="block text-sm font-bold text-slate-800 mb-2">Gender</label>
                                        <select 
                                            value={profileData.gender?.toLowerCase() || ''} 
                                            disabled={!isEditingProfile} 
                                            onChange={(e) => setProfileData({...profileData, gender: e.target.value})} 
                                            className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500 bg-slate-50 disabled:bg-slate-100 appearance-none"
                                        >
                                            <option value="">Select Gender</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    {['phone', 'dateOfBirth', 'bloodGroup', 'address', 'city', 'state', 'country', 'postalCode', 'emergencyContactName', 'emergencyContactPhone'].map(field => (
                                        <div key={field} className={field === 'address' ? "md:col-span-2" : ""}>
                                            <label className="block text-sm font-bold text-slate-800 mb-2 capitalize">{field.replace(/([A-Z])/g, ' $1').trim()}</label>
                                            <input 
                                                type={field.includes('date') ? 'date' : 'text'}
                                                value={profileData[field] || ''} 
                                                disabled={!isEditingProfile}
                                                onChange={(e) => setProfileData({...profileData, [field]: e.target.value})}
                                                className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500 bg-slate-50 disabled:bg-slate-100 disabled:text-slate-600"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}

                        {/* BOOK APPOINTMENT (Fee logic fixed) */}
                        {activeSection === 'book-appointment' && (
                            <section className="bg-white rounded-2xl shadow-lg p-8 mb-32 animate-fade-in">
                                 <h3 className="text-2xl font-bold text-slate-800 mb-6">Book an Appointment</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <SearchableDoctorDropdown doctors={doctors} selectedDoctorId={selectedDoctorId} onSelectDoctor={handleDoctorSelect} loading={doctorsLoading} error={errorMessage} />
                                    <input type="date" value={selectedDate} onChange={(e) => handleDateChange(e.target.value)} min={new Date().toISOString().split('T')[0]} className="p-3 border rounded-lg focus:ring-2 focus:ring-brand-purple" />
                                    <select value={selectedTime} onChange={(e) => setSelectedTime(e.target.value)} disabled={loadingSlots || !selectedDate || (availableSlots.length === 0 && allSlotsBookedForDate)} className="p-3 border rounded-lg focus:ring-2 focus:ring-brand-purple">
                                        <option value="">{loadingSlots ? "Loading..." : (!selectedDoctorId || !selectedDate ? "Select Date First" : allSlotsBookedForDate ? "No slots available" : availableSlots.length > 0 ? "Select Doctor Slot" : "Select Time")}</option>
                                        {(allSlotsBookedForDate ? [] : (availableSlots.length > 0 ? availableSlots : (doctorHasNoSlots ? allTimeSlots : []))).map((s,i) => (
                                            <option key={i} value={s.value || s.slotTime}>{s.label || s.slotTime}</option>
                                        ))}
                                    </select>
                                    <input type="text" placeholder="Reason for visit" value={reason} onChange={(e)=>setReason(e.target.value)} className="p-3 border rounded-lg focus:ring-2 focus:ring-brand-purple" />
                                </div>
                                
                                {/* --- Slot availability messages --- */}
                                {allSlotsBookedForDate && selectedDoctorId && selectedDate && (
                                    <div className="mt-4 p-4 bg-red-50 text-red-700 font-semibold text-center rounded-lg border border-red-200">
                                        <i className="fas fa-calendar-times mr-2"></i>
                                        All slots are booked for this date. Please select a different date.
                                    </div>
                                )}
                                {doctorHasNoSlots && selectedDoctorId && selectedDate && !loadingSlots && (
                                    <div className="mt-4 p-4 bg-amber-50 text-amber-700 font-semibold text-center rounded-lg border border-amber-200">
                                        <i className="fas fa-info-circle mr-2"></i>
                                        No pre-defined slots for this date. You can select any available time.
                                    </div>
                                )}
                                
                                {/* --- FIX: Fee only shows when selected --- */}
                                {selectedDoctorFee !== null && selectedDoctorFee > 0 && (
                                    <div className="mt-6 p-4 bg-purple-50 text-brand-purple font-bold text-center rounded-lg border border-purple-200">
                                        Consultation Fee: ₹{selectedDoctorFee}
                                    </div>
                                )}
                                
                                <button 
                                    onClick={initiatePayment} 
                                    disabled={!selectedDoctorId || !selectedDate || !selectedTime} 
                                    className={`mt-6 w-full bg-gradient-to-r from-purple-600 to-brand-purple text-white py-4 rounded-xl font-bold hover:shadow-lg transition-all ${
                                        (!selectedDoctorId || !selectedDate || !selectedTime) ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-2xl'
                                    }`}
                                >
                                    Pay & Book Appointment
                                </button>
                                {successMessage && <p className="mt-4 text-center text-green-600 font-bold bg-green-50 p-2 rounded">{successMessage}</p>}
                            </section>
                        )}
    
                        {/* APPOINTMENTS LIST */}
                        {activeSection === 'appointments' && (
                            <section className="bg-white rounded-2xl shadow-lg p-8 animate-fade-in">
                                <div className="flex gap-6 mb-6 border-b pb-2 overflow-x-auto">
                                    <button onClick={() => setActiveTab('all')} className={`pb-2 font-bold capitalize transition-all whitespace-nowrap ${activeTab === 'all' ? 'border-b-4 border-purple-500 text-purple-500' : 'text-slate-500 hover:text-slate-700'}`}>All ({appointments.length + emergencyRequests.length})</button>
                                    <button onClick={() => setActiveTab('emergency')} className={`pb-2 font-bold capitalize transition-all whitespace-nowrap ${activeTab === 'emergency' ? 'border-b-4 border-red-500 text-red-500' : 'text-slate-500 hover:text-red-600'}`}><i className="fas fa-ambulance mr-2"></i>Emergency ({activeEmergencies.length})</button>
                                    <button onClick={() => setActiveTab('pending')} className={`pb-2 font-bold capitalize transition-all whitespace-nowrap ${activeTab === 'pending' ? 'border-b-4 border-yellow-500 text-yellow-500' : 'text-slate-500 hover:text-yellow-600'}`}>Pending ({pending.length + activeEmergencies.filter(e => e.status === 'PENDING').length})</button>
                                    <button onClick={() => setActiveTab('upcoming')} className={`pb-2 font-bold capitalize transition-all whitespace-nowrap ${activeTab === 'upcoming' ? 'border-b-4 border-green-500 text-green-500' : 'text-slate-500 hover:text-green-600'}`}>Approved ({upcoming.length})</button>
                                    <button onClick={() => setActiveTab('rejected')} className={`pb-2 font-bold capitalize transition-all whitespace-nowrap ${activeTab === 'rejected' ? 'border-b-4 border-red-500 text-red-500' : 'text-slate-500 hover:text-red-600'}`}>Rejected ({rejected.length})</button>
                                    <button onClick={() => setActiveTab('completed')} className={`pb-2 font-bold capitalize transition-all whitespace-nowrap ${activeTab === 'completed' ? 'border-b-4 border-blue-500 text-blue-500' : 'text-slate-500 hover:text-blue-600'}`}>Completed ({completed.length})</button>
                                </div>

                                {/* Emergency List */}
                                {activeTab === 'emergency' && (
                                    <div className="bg-red-50 border border-red-100 rounded-xl p-4">
                                        <h4 className="text-red-600 font-bold mb-4 flex items-center"><i className="fas fa-ambulance mr-2"></i> Active Emergency Requests</h4>
                                        {activeEmergencies.length === 0 ? <p className="text-center p-4 text-slate-500">No active emergency requests.</p> : (
                                            <table className="w-full text-left">
                                                <thead><tr className="border-b border-red-200 text-red-800"><th className="p-3">Doctor</th><th className="p-3">Date & Time</th><th className="p-3">Urgency</th><th className="p-3">Condition</th><th className="p-3">Status</th></tr></thead>
                                                <tbody>
                                                    {activeEmergencies.map(req => {
                                                        const doc = doctors.find(d => getDocId(d) === req.doctorId);
                                                        return (
                                                            <tr key={req.requestId} className="border-b border-red-100">
                                                                <td className="p-3 font-bold text-slate-700">Dr. {doc ? `${doc.firstName} ${doc.lastName}` : 'N/A'}</td>
                                                                <td className="p-3 text-slate-600">{new Date(req.requestDateTime).toLocaleString()}</td>
                                                                <td className="p-3"><span className="bg-red-200 text-red-800 px-2 py-1 rounded text-xs font-bold">{req.urgencyLevel}</span></td>
                                                                <td className="p-3 text-slate-600">{req.conditionDescription}</td>
                                                                <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${(req.status || 'PENDING') === 'PENDING' ? 'bg-yellow-100 text-yellow-800' : req.status === 'APPROVED' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{req.status || 'PENDING'}</span></td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                )}

                                {/* Regular Lists */}
                                {activeTab !== 'emergency' && (
                                    <div className="space-y-4">
                                        {/* Empty state messages for each filter */}
                                        {activeTab === 'upcoming' && upcoming.length === 0 && (
                                            <div className="text-center py-12 bg-white rounded-xl border border-slate-200">
                                                <i className="fas fa-calendar-check text-4xl text-green-300 mb-4"></i>
                                                <p className="text-slate-500 font-medium">No approved appointments</p>
                                                <p className="text-slate-400 text-sm mt-1">Your approved appointments will appear here</p>
                                            </div>
                                        )}
                                        {activeTab === 'pending' && [...pending, ...activeEmergencies.filter(e => e.status === 'PENDING')].length === 0 && (
                                            <div className="text-center py-12 bg-white rounded-xl border border-slate-200">
                                                <i className="fas fa-clock text-4xl text-yellow-300 mb-4"></i>
                                                <p className="text-slate-500 font-medium">No pending appointments</p>
                                                <p className="text-slate-400 text-sm mt-1">Appointments awaiting approval will appear here</p>
                                            </div>
                                        )}
                                        {activeTab === 'rejected' && rejected.length === 0 && (
                                            <div className="text-center py-12 bg-white rounded-xl border border-slate-200">
                                                <i className="fas fa-times-circle text-4xl text-red-300 mb-4"></i>
                                                <p className="text-slate-500 font-medium">No rejected appointments</p>
                                                <p className="text-slate-400 text-sm mt-1">Rejected appointments will appear here</p>
                                            </div>
                                        )}
                                        {activeTab === 'completed' && completed.length === 0 && (
                                            <div className="text-center py-12 bg-white rounded-xl border border-slate-200">
                                                <i className="fas fa-check-circle text-4xl text-blue-300 mb-4"></i>
                                                <p className="text-slate-500 font-medium">No completed appointments</p>
                                                <p className="text-slate-400 text-sm mt-1">Your completed appointments will appear here</p>
                                            </div>
                                        )}
                                        {activeTab === 'all' && [...appointments, ...emergencyRequests].length === 0 && (
                                            <div className="text-center py-12 bg-white rounded-xl border border-slate-200">
                                                <i className="fas fa-calendar-alt text-4xl text-slate-300 mb-4"></i>
                                                <p className="text-slate-500 font-medium">No appointments found</p>
                                                <p className="text-slate-400 text-sm mt-1">Book an appointment to get started</p>
                                            </div>
                                        )}
                                        {(activeTab === 'upcoming' ? upcoming : activeTab === 'pending' ? [...pending, ...activeEmergencies.filter(e => e.status === 'PENDING')] : activeTab === 'rejected' ? rejected : activeTab === 'completed' ? completed : activeTab === 'all' ? [...appointments, ...emergencyRequests] : appointments).map(a => {
                                            const isEmergency = a.requestDateTime !== undefined;
                                            const date = isEmergency ? a.requestDateTime : a.appointmentDateTime;
                                            const doctorName = isEmergency 
                                                ? (doctors.find(d => getDocId(d) === a.doctorId) ? `Dr. ${doctors.find(d => getDocId(d) === a.doctorId).firstName} ${doctors.find(d => getDocId(d) === a.doctorId).lastName}` : 'Dr. N/A')
                                                : (a.doctor ? `Dr. ${a.doctor.firstName} ${a.doctor.lastName}` : 'Dr. N/A');
                                            // Use displayStatus if available, otherwise determine status
                                            // For emergencies: show EMERGENCY (COMPLETED) or EMERGENCY (UPCOMING)
                                            const isUpcomingEmergency = isEmergency && a.status === 'APPROVED' && new Date(a.requestDateTime) >= new Date();
                                            const isCompletedEmergency = isEmergency && (a.status === 'COMPLETED' || (a.status === 'APPROVED' && new Date(a.requestDateTime) < new Date()));
                                            const status = a.displayStatus || (isEmergency ? (a.status === 'PENDING' ? 'PENDING' : isCompletedEmergency ? 'EMERGENCY (COMPLETED)' : isUpcomingEmergency ? 'EMERGENCY (UPCOMING)' : a.status) : a.status);
                                            const reasonText = isEmergency ? a.conditionDescription : a.reason;

                                            return (
                                                <div key={isEmergency ? `em-${a.requestId}` : a.appointmentId} className={`flex ${activeTab === 'completed' && a.review ? 'flex-col items-start' : 'justify-between items-center'} p-6 border rounded-xl hover:shadow-md transition-all ${isUpcomingEmergency ? 'bg-red-50 border-red-300' : 'border-slate-200 bg-white'}`}>
                                                    <div className="flex items-center gap-4 w-full justify-between">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-12 h-12 bg-brand-purple text-white rounded-full flex items-center justify-center font-bold text-xl"><i className="fas fa-user-md"></i></div>
                                                            <div>
                                                                <p className="font-bold text-xl text-slate-800">{doctorName}</p>
                                                                <div className="flex items-center gap-4 text-slate-500 text-sm mt-1 font-medium">
                                                                    <span>{new Date(date).toLocaleString()}</span>
                                                                    {reasonText && <span className="border-l border-slate-300 pl-4 italic">Reason: {reasonText}</span>}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Right Side: Status & Action */}
                                                        <div className="text-right flex flex-col items-end gap-2">
                                                            <span className={`px-4 py-2 rounded-full text-xs font-extrabold uppercase tracking-wide ${
                                                                status.includes('EMERGENCY (COMPLETED)') ? 'bg-orange-100 text-orange-800' :
                                                                status.includes('EMERGENCY (UPCOMING)') ? 'bg-red-100 text-red-800' :
                                                                status.includes('APPROVED') ? 'bg-green-100 text-green-800' : 
                                                                status.includes('PENDING') ? 'bg-yellow-100 text-yellow-800' : 
                                                                status.includes('REJECTED') ? 'bg-red-100 text-red-800' :
                                                                status.includes('COMPLETED') ? 'bg-blue-100 text-blue-800' :
                                                                'bg-slate-100 text-slate-800'
                                                            }`}>{status}</span>
                                                            
                                                            {/* Reschedule & Cancel buttons for APPROVED appointments */}
                                                            {(activeTab === 'upcoming' || status.includes('APPROVED')) && !isEmergency && (
                                                                <div className="flex gap-2">
                                                                    <button 
                                                                        onClick={async () => {
                                                                            setSelectedAppointmentForReschedule(a);
                                                                            setRescheduleDate('');
                                                                            setRescheduleTime('');
                                                                            setAvailableSlotsForReschedule([]);
                                                                            setAllDoctorSlotsForReschedule([]);
                                                                            setShowRescheduleModal(true);
                                                                            // Fetch ALL slots for the doctor (to distinguish "no slots" vs "all booked")
                                                                            try {
                                                                                const doctorId = a.doctor?.professionalId || a.doctorId;
                                                                                const res = await fetch(`http://localhost:8080/api/slots/doctor/${doctorId}`);
                                                                                if (res.ok) {
                                                                                    const slots = await res.json();
                                                                                    // Store all slots (for checking if date has any slots)
                                                                                    setAllDoctorSlotsForReschedule(slots);
                                                                                    // Filter to only available slots for selection
                                                                                    const availableSlots = slots.filter(s => s.isAvailable);
                                                                                    setAvailableSlotsForReschedule(availableSlots);
                                                                                }
                                                                            } catch (error) {
                                                                                console.error('Error fetching slots:', error);
                                                                            }
                                                                        }}
                                                                        className="text-xs text-blue-600 font-bold hover:bg-blue-50 px-3 py-1 rounded-lg border border-blue-200"
                                                                    >
                                                                        <i className="fas fa-calendar-alt mr-1"></i> Reschedule
                                                                    </button>
                                                                    <button 
                                                                        onClick={async () => {
                                                                            if (confirm('Are you sure you want to cancel this appointment?')) {
                                                                                try {
                                                                                    const res = await fetch(`http://localhost:8080/api/appointments/${a.appointmentId}/status`, {
                                                                                        method: 'PUT',
                                                                                        headers: { 'Content-Type': 'application/json' },
                                                                                        body: JSON.stringify({ status: 'CANCELLED' })
                                                                                    });
                                                                                    if (res.ok) {
                                                                                        setSuccessMessage('✅ Appointment cancelled successfully');
                                                                                        fetchPatientAppointments();
                                                                                    } else {
                                                                                        setErrorMessage('Failed to cancel appointment');
                                                                                    }
                                                                                } catch (e) {
                                                                                    setErrorMessage('Error cancelling appointment');
                                                                                }
                                                                                setTimeout(() => { setSuccessMessage(''); setErrorMessage(''); }, 3000);
                                                                            }
                                                                        }}
                                                                        className="text-xs text-red-600 font-bold hover:bg-red-50 px-3 py-1 rounded-lg border border-red-200"
                                                                    >
                                                                        <i className="fas fa-times mr-1"></i> Cancel
                                                                    </button>
                                                                </div>
                                                            )}
                                                            
                                                            {/* Show "Leave Feedback" button if no review yet */}
                                                            {activeTab === 'completed' && !a.review && (
                                                                <button 
                                                                    onClick={() => setSelectedAppointmentForFeedback(a)} 
                                                                    className="text-sm text-brand-purple font-bold hover:underline bg-purple-50 px-3 py-1 rounded-lg"
                                                                >
                                                                    Leave Feedback
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* FEEDBACK BOX */}
                                                    {activeTab === 'completed' && a.review && (
                                                        <div className="mt-4 w-full bg-slate-50 border border-slate-200 rounded-xl p-4 animate-fade-in">
                                                            <p className="font-bold text-slate-700 flex items-center gap-2 mb-2">
                                                                <i className="fas fa-star text-amber-500"></i> Your Feedback
                                                            </p>
                                                            <div className="flex text-amber-400 text-lg mb-2">
                                                                {[...Array(5)].map((_, i) => (
                                                                    <span key={i}>{i < a.review.rating ? '★' : '☆'}</span>
                                                                ))}
                                                            </div>
                                                            <p className="text-slate-600 italic text-sm">"{a.review.feedback || a.review.feedbackText}"</p>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </section>
                        )}

                        {/* RECORDS + ACCESS REQUESTS */}
                        {activeSection === 'records' && (
                            <section className="bg-white rounded-2xl shadow-lg p-8 animate-fade-in">
                                <div className="flex justify-between mb-6">
                                    <h3 className="text-2xl font-bold text-slate-800">Health Records</h3>
                                    <button onClick={() => setShowAddRecordModal(true)} className="bg-brand-purple text-white px-4 py-2 rounded-lg font-bold">+ Upload</button>
                                </div>
                                
                                {/* ACCESS REQUESTS */}
                                {accessRequests.filter(r => r.status === 'PENDING').length > 0 && (
                                    <div className="mb-8 bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-r-xl shadow-sm">
                                        <h4 className="text-lg font-bold text-yellow-800 mb-4 flex items-center">
                                            <i className="fas fa-key mr-2"></i> Pending Access Requests
                                        </h4>
                                        <div className="space-y-3">
                                            {accessRequests.filter(r => r.status === 'PENDING').map(req => (
                                                <div key={req.requestId} className="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                                                    <div>
                                                        <p className="font-bold text-slate-800">Dr. {req.doctorName}</p>
                                                        <p className="text-sm text-slate-600">Requests access for appointment on: {new Date(req.appointmentDate).toLocaleDateString()}</p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleConsentResponse(req.requestId, 'APPROVED', req.doctorName)} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm font-bold">Approve</button>
                                                        <button onClick={() => handleConsentResponse(req.requestId, 'REJECTED', req.doctorName)} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm font-bold">Reject</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {medicalRecords.map(r => (
                                        <div key={r.recordId} className="p-6 border border-blue-200 rounded-xl hover:shadow-lg transition-all bg-blue-50 flex flex-col">
                                            <div className="mb-2">
                                                <p className="font-bold text-xl text-slate-800 break-words">Patient Information for '{r.title}'</p>
                                                <p className="text-xs text-slate-500 font-bold uppercase mt-1 tracking-wider">{r.recordType || 'General Record'}</p>
                                            </div>
                                            <p className="text-sm text-slate-500 mb-4 border-b border-blue-200 pb-2">{new Date(r.recordDate).toLocaleDateString()}</p>
                                            <button onClick={() => setSelectedRecordForView(r)} className="mt-auto w-full py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 shadow-md transition-colors"><i className="fas fa-eye"></i> View</button>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )}

                        {/* PRESCRIPTIONS */}
                        {activeSection === 'prescriptions' && (
                            <section className="animate-fade-in space-y-8">
                                {/* --- ACTIVE PRESCRIPTIONS --- */}
                                <div className="bg-white rounded-2xl shadow-lg p-8">
                                    <h3 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                                        <i className="fas fa-prescription-bottle-alt text-green-600"></i> Active Prescriptions ({activePrescriptions.length})
                                    </h3>
                                    {activePrescriptions.length === 0 ? (
                                        <p className="text-slate-500 text-center py-4">No active prescriptions found.</p>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {activePrescriptions.map(p => {
                                                // --- THIS LINE IS FIXED ---
                                                const dateStr = (p.startDate || p.start_date) ? new Date(p.startDate || p.start_date).toLocaleDateString() : 'N/A';
                                                return (
                                                    <div key={p.medication_id} className="bg-green-50 rounded-xl p-6 shadow-sm border border-green-200 hover:shadow-md transition-all">
                                                        <h4 className="text-xl font-bold text-green-700 mb-3 capitalize">{p.medication_name || p.medicationName || "Medicine"}</h4>
                                                        <div className="space-y-2 text-sm text-slate-700 mb-4">
                                                            <p><span className="font-bold text-slate-500">Dosage:</span> {p.dosage}</p>
                                                            <p><span className="font-bold text-slate-500">Frequency:</span> {p.frequency}</p>
                                                            <p><span className="font-bold text-slate-500">Ends On:</span> {new Date(p.endDate || p.end_date).toLocaleDateString()}</p>
                                                            {/* --- THIS LINE USES THE FIX --- */}
                                                            <p className="text-slate-400 text-xs mt-2 pt-2 border-t border-green-200">Started: {dateStr}</p>
                                                        </div>
                                                        <div className="flex gap-3">
                                                            <button onClick={() => setSelectedRecordForView({...p, title: p.medication_name})} className="flex items-center gap-1 text-blue-600 font-bold text-sm hover:text-blue-800"><i className="fas fa-eye"></i> View</button>
                                                            <button onClick={() => alert('Downloading...')} className="flex items-center gap-1 text-green-600 font-bold text-sm hover:text-green-800"><i className="fas fa-download"></i> Download</button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>

                                {/* --- PAST PRESCRIPTIONS --- */}
                                <div className="bg-white rounded-2xl shadow-lg p-8">
                                    <h3 className="text-2xl font-bold text-slate-500 mb-6 flex items-center gap-2">
                                        <i className="fas fa-history text-slate-500"></i> Past Prescriptions ({pastPrescriptions.length})
                                    </h3>
                                    {pastPrescriptions.length === 0 ? (
                                        <p className="text-slate-500 text-center py-4">No past prescriptions found.</p>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {pastPrescriptions.map(p => {
                                                // --- THIS LINE IS ALSO FIXED ---
                                                const dateStr = (p.startDate || p.start_date) ? new Date(p.startDate || p.start_date).toLocaleDateString() : 'N/A';
                                                return (
                                                    <div key={p.medication_id} className="bg-slate-50 rounded-xl p-6 shadow-sm border border-slate-200 opacity-80 hover:opacity-100 transition-all">
                                                        <h4 className="text-xl font-bold text-slate-600 mb-3 capitalize">{p.medication_name || p.medicationName || "Medicine"}</h4>
                                                        <div className="space-y-2 text-sm text-slate-600 mb-4">
                                                            <p><span className="font-bold text-slate-500">Dosage:</span> {p.dosage}</p>
                                                            <p><span className="font-bold text-slate-500">Frequency:</span> {p.frequency}</p>
                                                            <p><span className="font-bold text-slate-500">Ended On:</span> {new Date(p.endDate || p.end_date).toLocaleDateString()}</p>
                                                            {/* --- THIS LINE USES THE FIX --- */}
                                                            <p className="text-slate-400 text-xs mt-2 pt-2 border-t border-slate-200">Started: {dateStr}</p>
                                                        </div>
                                                        <div className="flex gap-3">
                                                            <button onClick={() => setSelectedRecordForView({...p, title: p.medication_name})} className="flex items-center gap-1 text-blue-600 font-bold text-sm hover:text-blue-800"><i className="fas fa-eye"></i> View</button>
                                                            <button onClick={() => alert('Downloading...')} className="flex items-center gap-1 text-green-600 font-bold text-sm hover:text-green-800"><i className="fas fa-download"></i> Download</button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </section>
                        )}

                        {/* EMERGENCY REQUEST FORM (Fee logic fixed) */}
                        {activeSection === 'emergency' && (
                            <section className="bg-red-50 rounded-2xl shadow-lg p-8 border-2 border-red-100 animate-fade-in">
                                <h3 className="text-2xl font-bold text-red-700 mb-6 flex items-center"><i className="fas fa-ambulance mr-2"></i> Emergency Request</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <SearchableDoctorDropdown doctors={doctors} selectedDoctorId={emergencyData.doctorId} onSelectDoctor={handleEmergencyDoctorSelect} />
                                    <select value={emergencyData.urgencyLevel} onChange={(e) => setEmergencyData({...emergencyData, urgencyLevel: e.target.value})} className="p-3 border border-red-200 rounded-lg font-medium text-slate-700">
                                        <option value="">Select Urgency Level</option>
                                        <option value="HIGH">⚡ HIGH - Immediate attention needed</option>
                                        <option value="MEDIUM">⚠️ MEDIUM - Urgent but not critical</option>
                                        <option value="LOW">🟢 LOW - Can wait for a few hours</option>
                                    </select>
                                    <input type="date" value={emergencyData.preferredDate} onChange={(e)=>setEmergencyData({...emergencyData, preferredDate:e.target.value})} className="p-3 border border-red-200 rounded-lg" />
                                    <input type="time" value={emergencyData.preferredTime} onChange={(e)=>setEmergencyData({...emergencyData, preferredTime:e.target.value})} className="p-3 border border-red-200 rounded-lg" />
                                    <input type="text" placeholder="Location" value={emergencyData.currentLocation} onChange={(e)=>setEmergencyData({...emergencyData, currentLocation:e.target.value})} className="p-3 border border-red-200 rounded-lg" />
                                    <textarea placeholder="Describe Condition..." value={emergencyData.conditionDescription} className="md:col-span-2 p-3 border border-red-200 rounded-lg h-32" onChange={(e)=>setEmergencyData({...emergencyData, conditionDescription:e.target.value})}></textarea>
                                </div>
                                
                                {/* --- FIX: Fee only shows when selected --- */}
                                {selectedDoctorFee !== null && selectedDoctorFee > 0 && (
                                    <div className="mt-4 p-3 bg-red-100 text-red-800 font-bold text-center rounded-lg border border-red-200">
                                        Emergency Fee: ₹{selectedDoctorFee}
                                    </div>
                                )}
                                <button onClick={initiatePayment} className="mt-6 w-full bg-red-600 text-white py-4 rounded-xl font-bold hover:bg-red-700 shadow-lg">Pay & Send Emergency Request</button>
                                {successMessage && <p className="mt-4 text-center text-green-600 font-bold bg-green-50 p-3 rounded-lg border border-green-200">{successMessage}</p>}
                                {errorMessage && <p className="mt-4 text-center text-red-600 font-bold bg-red-50 p-3 rounded-lg border border-red-200">{errorMessage}</p>}
                            </section>
                        )}

                        {/* CONDITIONS */}
                        {activeSection === 'conditions' && (
                            <section className="bg-white rounded-2xl shadow-lg p-8 animate-fade-in">
                                <div className="flex justify-between mb-6">
                                    <h3 className="text-2xl font-bold text-slate-800">Medical Conditions</h3>
                                    <button onClick={() => setShowAddConditionModal(true)} className="text-brand-purple font-bold bg-purple-50 px-4 py-2 rounded-lg">+ Add</button>
                                </div>
                                {medicalConditions.map(c => (
                                    <div key={c.conditionId} className="p-4 border border-yellow-200 rounded-lg mb-3 bg-yellow-50">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <p className="font-bold text-lg text-slate-800">{c.conditionName}</p>
                                                <p className="text-sm text-slate-500">Diagnosed: {new Date(c.diagnosedDate).toLocaleDateString()}</p>
                                            </div>
                                            <span className="bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-xs font-bold">{c.status}</span>
                                        </div>
                                        {c.notes && <div className="text-base text-slate-700 mt-2 p-3 bg-white border border-yellow-100 rounded-lg italic">Note: {c.notes}</div>}
                                    </div>
                                ))}
                            </section>
                        )}

                        {/* REPORTS & ISSUES - PATIENT */}
                        {activeSection === 'reports' && (
                            <section className="animate-fade-in space-y-6">
                                <div className="bg-white rounded-2xl shadow-lg p-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                            <i className="fas fa-flag text-orange-500"></i> My Reports & Issues
                                        </h3>
                                        <button onClick={() => { window.location.hash = '#support'; }} className="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg font-bold hover:shadow-lg transition-all">
                                            <i className="fas fa-plus mr-2"></i> Report New Issue
                                        </button>
                                    </div>
                                    
                                    {userIssues.length === 0 ? (
                                        <div className="text-center py-12">
                                            <i className="fas fa-check-circle text-6xl text-green-300 mb-4"></i>
                                            <p className="text-slate-500 text-lg">No issues reported yet.</p>
                                            <p className="text-slate-400 text-sm mt-2">If you face any problems, click "Report New Issue" above.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {userIssues.map(issue => {
                                                const statusLower = (issue.status || 'pending').toLowerCase();
                                                const isResolved = statusLower === 'resolved';
                                                const isInProgress = statusLower === 'in-progress' || statusLower === 'in_progress';
                                                return (
                                                <div key={issue.id} className={`p-5 rounded-xl border-2 ${isResolved ? 'bg-green-50 border-green-200' : isInProgress ? 'bg-blue-50 border-blue-200' : 'bg-orange-50 border-orange-200'}`}>
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <h4 className="font-bold text-lg text-slate-800">{issue.subject || 'Issue Report'}</h4>
                                                            <p className="text-sm text-slate-500">Submitted: {new Date(issue.createdAt).toLocaleDateString()}</p>
                                                        </div>
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${isResolved ? 'bg-green-500 text-white' : isInProgress ? 'bg-blue-500 text-white' : 'bg-orange-500 text-white'}`}>
                                                            {issue.status || 'PENDING'}
                                                        </span>
                                                    </div>
                                                    <p className="text-slate-700 mb-3">{issue.message}</p>
                                                    {issue.adminMessage && (
                                                        <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                            <p className="text-sm font-bold text-blue-700 mb-1"><i className="fas fa-reply mr-1"></i> Admin Response:</p>
                                                            <p className="text-slate-700">{issue.adminMessage}</p>
                                                        </div>
                                                    )}
                                                </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </section>
                        )}

                    </main>
                </div>

                {/* --- MODALS --- */}
                {showDummyPaymentModal && 
                    <DummyPaymentModal 
                        fee={selectedDoctorFee} 
                        loading={loading} 
                        onClose={() => {
                            setShowDummyPaymentModal(false);
                            resetAppointmentForms(); // <-- RESET ADDED HERE
                        }} 
                        onConfirmPayment={handleDummyPaymentConfirm} 
                    />
                }
                
                {selectedAppointmentForFeedback && (
                    <FeedbackModal
                        appointment={selectedAppointmentForFeedback}
                        user={user}
                        doctors={doctors}
                        onClose={() => setSelectedAppointmentForFeedback(null)}
                        onFeedbackSubmitted={() => {
                            fetchPatientAppointments(); 
                            fetchEmergencyRequests();
                        }}
                    />
                )}
                
                {/* Reschedule Appointment Modal */}
                {showRescheduleModal && selectedAppointmentForReschedule && (() => {
                    const rescheduleDoctorName = selectedAppointmentForReschedule.doctor 
                        ? `Dr. ${selectedAppointmentForReschedule.doctor.firstName} ${selectedAppointmentForReschedule.doctor.lastName}`
                        : (doctors.find(d => (d.id || d.doctorId || d.professionalId) === selectedAppointmentForReschedule.doctorId)
                            ? `Dr. ${doctors.find(d => (d.id || d.doctorId || d.professionalId) === selectedAppointmentForReschedule.doctorId).firstName} ${doctors.find(d => (d.id || d.doctorId || d.professionalId) === selectedAppointmentForReschedule.doctorId).lastName}`
                            : 'Dr. N/A');
                    
                    // Generate 30-minute time slots for the full day (8 AM to 8 PM)
                    const generateTimeSlots = () => {
                        const slots = [];
                        for (let hour = 8; hour < 20; hour++) {
                            const h = hour.toString().padStart(2, '0');
                            slots.push(`${h}:00:00`);
                            slots.push(`${h}:30:00`);
                        }
                        return slots;
                    };
                    const defaultTimeSlots = generateTimeSlots();
                    
                    return (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-fade-in mx-4">
                            <div className="sticky top-0 bg-white p-6 pb-4 border-b border-slate-100 z-10">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800"><i className="fas fa-calendar-alt text-purple-600 mr-2"></i>Reschedule Appointment</h2>
                                        <p className="text-slate-500 text-sm mt-1">Select a new date and time</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            setShowRescheduleModal(false);
                                            setSelectedAppointmentForReschedule(null);
                                        }}
                                        className="p-2 hover:bg-slate-100 rounded-lg transition-colors text-slate-500 text-2xl">
                                        &times;
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-6">
                                {/* Current Appointment Info */}
                                <div className="bg-slate-50 rounded-xl p-4 mb-6">
                                    <p className="text-xs text-slate-500 font-semibold mb-3">CURRENT APPOINTMENT</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <p className="text-xs text-slate-500">Doctor</p>
                                            <p className="font-semibold text-purple-600">{rescheduleDoctorName}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Reason</p>
                                            <p className="font-semibold text-slate-800">{selectedAppointmentForReschedule.reason || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Current Date</p>
                                            <p className="font-semibold text-slate-800">{selectedAppointmentForReschedule.appointmentDateTime?.split('T')[0] || selectedAppointmentForReschedule.date}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Current Time</p>
                                            <p className="font-semibold text-slate-800">{selectedAppointmentForReschedule.appointmentDateTime?.split('T')[1]?.substring(0,5) || selectedAppointmentForReschedule.time}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* New Date Selection */}
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">Select New Date</label>
                                        <input 
                                            type="date"
                                            value={rescheduleDate}
                                            onChange={(e) => {
                                                setRescheduleDate(e.target.value);
                                                setRescheduleTime('');
                                                setRescheduleSlotId(null); // Reset slot ID when date changes
                                                // Filter to only available slots for the selected date
                                                const filteredSlots = allDoctorSlotsForReschedule.filter(s => s.slotDate === e.target.value && s.isAvailable);
                                                setAvailableSlotsForReschedule(filteredSlots);
                                            }}
                                            min={new Date().toISOString().split('T')[0]}
                                            className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                        />
                                    </div>
                                    
                                    {rescheduleDate && (() => {
                                        // Check slot availability for the selected date
                                        // allDoctorSlotsForReschedule contains ALL slots (both available and booked)
                                        const allSlotsForDate = allDoctorSlotsForReschedule.filter(s => s.slotDate === rescheduleDate);
                                        const availableSlotsForDate = allSlotsForDate.filter(s => s.isAvailable);
                                        
                                        // Doctor has no slots defined at all
                                        const doctorHasNoSlots = allDoctorSlotsForReschedule.length === 0;
                                        // Doctor has no slots for this specific date
                                        const noSlotsForThisDate = allSlotsForDate.length === 0;
                                        // Doctor has slots for this date but all are booked
                                        const allSlotsBookedForDate = allSlotsForDate.length > 0 && availableSlotsForDate.length === 0;
                                        // Doctor has available slots for this date
                                        const hasAvailableSlots = availableSlotsForDate.length > 0;
                                        
                                        return (
                                        <div>
                                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                                                {hasAvailableSlots 
                                                    ? `Available Slots (${availableSlotsForDate.length} available)`
                                                    : allSlotsBookedForDate 
                                                        ? `No slots available for ${rescheduleDate}`
                                                        : `Select Time Slot`
                                                }
                                            </label>
                                            {hasAvailableSlots ? (
                                                /* Doctor has available slots - show them */
                                                <div className="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                                                    {availableSlotsForDate.map(slot => (
                                                        <button
                                                            key={slot.slotId}
                                                            onClick={() => {
                                                                setRescheduleTime(slot.slotTime);
                                                                setRescheduleSlotId(slot.slotId); // Track the slot ID
                                                                if (slot.slotDate) setRescheduleDate(slot.slotDate);
                                                            }}
                                                            className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                                rescheduleSlotId === slot.slotId
                                                                    ? 'bg-purple-600 text-white shadow-lg'
                                                                    : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                                                            }`}>
                                                            <div>{slot.slotTime}</div>
                                                        </button>
                                                    ))}
                                                </div>
                                            ) : allSlotsBookedForDate ? (
                                                /* Doctor has slots for this date but all are booked */
                                                <div className="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                                                    <i className="fas fa-calendar-times text-red-500 text-2xl mb-2"></i>
                                                    <p className="text-red-700 font-medium">All slots are booked for this date</p>
                                                    <p className="text-red-600 text-sm mt-1">Please select a different date</p>
                                                </div>
                                            ) : (
                                                /* Doctor has no slots defined for this date - allow any time */
                                                <div>
                                                    <div className="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-3">
                                                        <p className="text-amber-700 text-sm"><i className="fas fa-info-circle mr-1"></i>No pre-defined slots for this date. Select a time below:</p>
                                                    </div>
                                                    <select
                                                        value={rescheduleTime}
                                                        onChange={(e) => setRescheduleTime(e.target.value)}
                                                        className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none bg-white"
                                                    >
                                                        <option value="">-- Select Time Slot --</option>
                                                        {defaultTimeSlots.map(time => {
                                                            const [h, m] = time.split(':');
                                                            const endH = m === '00' ? h : (parseInt(h) + 1).toString().padStart(2, '0');
                                                            const endM = m === '00' ? '30' : '00';
                                                            return (
                                                                <option key={time} value={time}>
                                                                    {h}:{m.substring(0,2)} - {endH}:{endM}
                                                                </option>
                                                            );
                                                        })}
                                                    </select>
                                                </div>
                                            )}
                                        </div>
                                        );
                                    })()}
                                    
                                    {!rescheduleDate && (
                                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                                            <i className="fas fa-calendar text-blue-500 text-2xl mb-2"></i>
                                            <p className="text-blue-700 font-medium">Select a date to see available slots</p>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => {
                                            setShowRescheduleModal(false);
                                            setSelectedAppointmentForReschedule(null);
                                            setRescheduleSlotId(null); // Reset slot ID
                                        }}
                                        className="flex-1 px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50 transition-colors">
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            if (!rescheduleDate || !rescheduleTime) {
                                                setErrorMessage('Please select both date and time');
                                                setTimeout(() => setErrorMessage(''), 3000);
                                                return;
                                            }
                                            try {
                                                // Handle time format - ensure it has seconds
                                                const timeWithSeconds = rescheduleTime.includes(':') && rescheduleTime.split(':').length === 3 
                                                    ? rescheduleTime 
                                                    : `${rescheduleTime}:00`;
                                                const appointmentDateTime = `${rescheduleDate}T${timeWithSeconds}`;
                                                const response = await fetch(`http://localhost:8080/api/appointments/${selectedAppointmentForReschedule.appointmentId}`, {
                                                    method: 'PUT',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({
                                                        appointmentDateTime: appointmentDateTime,
                                                        reason: selectedAppointmentForReschedule.reason || 'Rescheduled appointment',
                                                        slotId: rescheduleSlotId // Include the new slot ID
                                                    })
                                                });
                                                if (response.ok) {
                                                    setSuccessMessage(`✅ Appointment rescheduled to ${rescheduleDate} at ${rescheduleTime}!`);
                                                    setShowRescheduleModal(false);
                                                    setSelectedAppointmentForReschedule(null);
                                                    setRescheduleSlotId(null); // Reset slot ID
                                                    fetchPatientAppointments();
                                                } else {
                                                    const error = await response.text();
                                                    setErrorMessage(`Failed to reschedule: ${error || 'Unknown error'}`);
                                                }
                                            } catch (error) {
                                                console.error('Error rescheduling:', error);
                                                setErrorMessage('Failed to reschedule. Please try again.');
                                            }
                                            setTimeout(() => { setSuccessMessage(''); setErrorMessage(''); }, 3000);
                                        }}
                                        disabled={!rescheduleDate || !rescheduleTime}
                                        className={`flex-1 px-6 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 ${
                                            rescheduleDate && rescheduleTime
                                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:shadow-lg'
                                                : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                        }`}>
                                        <i className="fas fa-calendar-check"></i>
                                        Confirm Reschedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    );
                })()}
                
                {showAddConditionModal && <AddConditionModal user={user} onClose={() => setShowAddConditionModal(false)} onConditionAdded={() => { fetchMedicalConditions(); setConditionMessage("Added!"); setTimeout(() => setConditionMessage(""), 3000); }} />}

                {showAddRecordModal && (
                    <AddRecordModal
                        user={user}
                        onClose={() => setShowAddRecordModal(false)}
                        onRecordAdded={fetchMedicalRecords}
                    />
                )}
                
                {selectedRecordForView && 
                    <ViewRecordModal 
                        record={selectedRecordForView} 
                        patientProfile={user} // <-- Pass the fetched profile
                        onClose={() => setSelectedRecordForView(null)} 
                    />
                }

                {/* REPORT ISSUE MODAL */}
                {showReportIssueModal && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 animate-fade-in">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold text-slate-800"><i className="fas fa-flag text-orange-500 mr-2"></i> Report an Issue</h3>
                                <button onClick={() => setShowReportIssueModal(false)} className="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                            </div>
                            <div className="space-y-4">
                                <input type="text" placeholder="Your Name" value={issueForm.name || (user?.firstName + ' ' + user?.lastName) || ''} onChange={e => setIssueForm({...issueForm, name: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <input type="email" placeholder="Your Email" value={issueForm.email || user?.email || ''} onChange={e => setIssueForm({...issueForm, email: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <input type="tel" placeholder="Phone Number (optional)" value={issueForm.phoneNumber} onChange={e => setIssueForm({...issueForm, phoneNumber: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <input type="text" placeholder="Subject" value={issueForm.subject} onChange={e => setIssueForm({...issueForm, subject: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <textarea placeholder="Describe your issue in detail..." value={issueForm.message} onChange={e => setIssueForm({...issueForm, message: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg h-32 resize-none"></textarea>
                            </div>
                            <div className="flex gap-3 mt-6">
                                <button onClick={() => setShowReportIssueModal(false)} className="flex-1 py-3 border border-slate-300 rounded-lg font-bold text-slate-600 hover:bg-slate-50">Cancel</button>
                                <button onClick={() => {
                                    const payload = {
                                        name: issueForm.name || (user?.firstName + ' ' + user?.lastName),
                                        email: issueForm.email || user?.email,
                                        phoneNumber: issueForm.phoneNumber,
                                        subject: issueForm.subject,
                                        message: issueForm.message,
                                        userType: 'PATIENT',
                                        userId: user?.userId
                                    };
                                    fetch('http://localhost:8080/api/issues', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload)
                                    }).then(r => {
                                        if (r.ok) {
                                            setShowReportIssueModal(false);
                                            setIssueForm({ name: '', email: '', phoneNumber: '', subject: '', message: '' });
                                            fetchUserIssues();
                                            setSuccessMessage('Issue reported successfully!');
                                            setTimeout(() => setSuccessMessage(''), 3000);
                                        } else {
                                            setErrorMessage('Failed to submit issue');
                                            setTimeout(() => setErrorMessage(''), 3000);
                                        }
                                    }).catch(err => {
                                        setErrorMessage('Error: ' + err.message);
                                        setTimeout(() => setErrorMessage(''), 3000);
                                    });
                                }} className="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg font-bold hover:shadow-lg">Submit Issue</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };
     // --- DOCTOR DASHBOARD ---
    const DoctorDashboard = ({ user, onLogout }) => {
        // UI State
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);
        const [activeSection, setActiveSection] = useState('dashboard');
        const [showNotifications, setShowNotifications] = useState(false);
        const [message, setMessage] = useState("");
        
        // Data State 
        const [doctorProfile, setDoctorProfile] = useState({});
        const [isEditingProfile, setIsEditingProfile] = useState(false);
        const [notifications, setNotifications] = useState([]);
        const [unreadCount, setUnreadCount] = useState(0);
        const [stats, setStats] = useState({
            pendingRequests: 0,
            todayAppointments: 0,
            totalPatients: 0,
            totalEarnings: 0,
            averageRating: 4.5,
            emergencyCases: 0
        });

        // Lists
        const [pendingAppointments, setPendingAppointments] = useState([]); // Regular pending
        const [approvedAppointments, setApprovedAppointments] = useState([]); // Regular approved
        const [rejectedAppointments, setRejectedAppointments] = useState([]); // Regular rejected
        const [completedAppointments, setCompletedAppointments] = useState([]); // Regular completed + passed emergency
        const [emergencyRequests, setEmergencyRequests] = useState([]); // Pending emergency
        const [approvedEmergency, setApprovedEmergency] = useState([]); // Upcoming emergency
        
        const [slots, setSlots] = useState([]);
        const [qualifications, setQualifications] = useState([]);
        const [allPatients, setAllPatients] = useState(new Map());
        const [userIssues, setUserIssues] = useState([]);
        const [showReportIssueModal, setShowReportIssueModal] = useState(false);
        const [issueForm, setIssueForm] = useState({ name: '', email: '', phoneNumber: '', subject: '', message: '' });
        
        // Modals & Forms
        const [showCreateSlotModal, setShowCreateSlotModal] = useState(false);
        const [showUploadQualificationModal, setShowUploadQualificationModal] = useState(false);
        const [showUploadModal, setShowUploadModal] = useState(false);
        const [showViewRecordsModal, setShowViewRecordsModal] = useState(false);
        const [selectedPatientForUpload, setSelectedPatientForUpload] = useState(null);
        const [selectedPatientForView, setSelectedPatientForView] = useState(null);
        const [slotData, setSlotData] = useState({ slotDate: '', slotTime: '' });
        const [qualificationData, setQualificationData] = useState({ documentName: '', documentType: 'Degree', file: null });
        const [uploadedPrescriptions, setUploadedPrescriptions] = useState(new Set());
        const [activeTab, setActiveTab] = useState('all'); // For Appointments Tab
        const [consentStatus, setConsentStatus] = useState(new Map());
        
        // --- CONSENT LOGIC ---
        // Note: Consent is per-appointment for regular appointments, per-emergency-request for emergency
        const fetchAllConsentStatus = async (appointments) => {
            if (!user?.doctorId) return;
            const newConsentStatus = new Map();
            
            for (const apt of appointments) {
                const patientId = apt.patient?.patientId || apt.patientId;
                const isEmergency = apt.requestId && !apt.appointmentId;
                // For regular appointments use appointmentId, for emergency use requestId
                const appointmentId = apt.appointmentId;
                const emergencyRequestId = isEmergency ? apt.requestId : null;
                const statusKey = isEmergency ? `${patientId}_${apt.requestId}` : (appointmentId ? `${patientId}_${appointmentId}` : patientId);
                
                if (!patientId) continue;
                
                try {
                    // Build URL with appropriate parameters
                    let url = `http://localhost:8080/api/consent-requests/status?doctorId=${user.doctorId}&patientId=${patientId}`;
                    if (isEmergency && emergencyRequestId) {
                        // For emergency requests, pass emergencyRequestId
                        url += `&emergencyRequestId=${emergencyRequestId}`;
                    } else if (appointmentId) {
                        // For regular appointments, pass appointmentId
                        url += `&appointmentId=${appointmentId}`;
                    }
                    
                    const res = await fetch(url, { credentials: 'include' });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.hasPermission) {
                            newConsentStatus.set(statusKey, 'APPROVED');
                        } else if (data.hasPendingRequest) {
                            newConsentStatus.set(statusKey, 'PENDING');
                        } else {
                            newConsentStatus.set(statusKey, 'LOCKED');
                        }
                    } else {
                        newConsentStatus.set(statusKey, 'LOCKED');
                    }
                } catch (e) {
                    console.error(`Failed to fetch consent status for patient ${patientId}`, e);
                    newConsentStatus.set(statusKey, 'LOCKED');
                }
            }
            setConsentStatus(newConsentStatus);
        };

        // Updated to handle both regular appointments and emergency requests
        const handleRequestAccess = async (patientId, appointmentId = null, emergencyRequestId = null) => {
            if (!user?.doctorId) return;
            try {
                const requestBody = { doctorId: user.doctorId, patientId: patientId };
                if (emergencyRequestId) {
                    requestBody.emergencyRequestId = emergencyRequestId.toString();
                } else if (appointmentId) {
                    requestBody.appointmentId = appointmentId;
                }
                console.log('🔐 Requesting access:', requestBody);
                const res = await fetch(`http://localhost:8080/api/consent-requests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${user.token}` },
                    body: JSON.stringify(requestBody),
                });
                if (res.ok) {
                    setMessage('✅ Access requested successfully! Patient will be notified.');
                    // Update consent status with the correct key
                    const newConsentStatus = new Map(consentStatus);
                    const statusKey = emergencyRequestId ? `${patientId}_${emergencyRequestId}` : 
                                     (appointmentId ? `${patientId}_${appointmentId}` : patientId);
                    newConsentStatus.set(statusKey, 'PENDING');
                    setConsentStatus(newConsentStatus);
                } else {
                    const error = await res.text();
                    setMessage(`❌ ${error}`);
                }
            } catch (e) {
                console.error('❌ Request access error:', e);
                setMessage('❌ Failed to request access.');
            }
            setTimeout(() => setMessage(''), 3000);
        };

        const handleViewRecords = (patient, appointmentId = null, emergencyRequestId = null) => {
            // Fix: Check if patient and patientId exist
            if (!patient || !patient.patientId) {
                setMessage('❌ Patient information not available. Please try again.');
                setTimeout(() => setMessage(''), 3000);
                return;
            }
            
            // Use the correct key format based on type
            const statusKey = emergencyRequestId ? `${patient.patientId}_${emergencyRequestId}` :
                             (appointmentId ? `${patient.patientId}_${appointmentId}` : patient.patientId);
            const status = consentStatus.get(statusKey);
            console.log('🔐 Checking consent for key:', statusKey, 'status:', status, 'emergencyRequestId:', emergencyRequestId);
            
            switch (status) {
                case 'APPROVED':
                    setSelectedPatientForView(patient);
                    setShowViewRecordsModal(true);
                    break;
                case 'LOCKED':
                    handleRequestAccess(patient.patientId, appointmentId, emergencyRequestId);
                    break;
                case 'PENDING':
                    setMessage('Request is already pending approval.');
                    setTimeout(() => setMessage(''), 3000);
                    break;
                default:
                    // If status is unknown (undefined), request access
                    console.log('🔐 Status unknown, requesting access');
                    handleRequestAccess(patient.patientId, appointmentId, emergencyRequestId);
            }
        };

        // --- NOTIFICATION LOGIC (Robust Fix) ---
        const fetchNotifications = () => {
            // 1. Try to find the correct ID from the user object
            // The database has UUIDs like "0a910776...", we need to find that string in the user object
            const currentUserId = user?.userId || user?.id || user?.user_id;

            if (!currentUserId) {
                console.warn("⚠️ Notification Error: No User ID found in 'user' object. Cannot fetch.");
                console.log("Current User Object:", user);
                return;
            }

            // 2. Fetch using the found ID
            fetch(`http://localhost:8080/api/notifications/user/${currentUserId}`)
                .then(r => {
                    if (!r.ok) throw new Error("Failed to fetch");
                    return r.json();
                })
                .then(d => { 
                    console.log("✅ Notifications fetched:", d); // Debug log
                    setNotifications(d); 
                    setUnreadCount(d.filter(n => !n.isRead).length); 
                })
                .catch(err => console.error("Notification fetch error:", err));
        };

        // --- NOTIFICATION: Handler for clicking the bell icon ---
        const handleBellClick = () => {
            setShowNotifications(prev => !prev); // Toggle the view
            
            // If we are opening the list AND there are unread items
            if (!showNotifications && unreadCount > 0) {
                fetch(`http://localhost:8080/api/notifications/user/${user.userId}/read-all`, {
                    method: 'PUT'
                })
                .then(res => {
                    if (res.ok) {
                        setUnreadCount(0); // Optimistically set count to 0
                        
                        // Update the local list to show as "read"
                        setNotifications(prev => prev.map(n => ({ ...n, isRead: true })));
                    }
                })
                .catch(console.error);
            }
        };

        // --- NOTIFICATION: Handler for clicking a single notification item ---
        const handleNotificationClick = (notification) => {
            // Mark as read if it's not already
            if (!notification.isRead) {
                fetch(`http://localhost:8080/api/notifications/${notification.notificationId}/read`, {
                    method: 'PUT'
                })
                .catch(console.error); // Fire and forget
            }
            
            // --- Navigation Logic ---
            // If it's an appointment, go to the appointments page
            if (notification.notificationType && notification.notificationType.includes('APPOINTMENT')) {
                setActiveSection('appointments');
            }
            
            setShowNotifications(false); // Close dropdown
        };
        // --- UTILITIES ---
        const generateTimeSlots = () => {
             const slots = [];
             for (let hour = 9; hour < 21; hour++) {
                 for (let minute = 0; minute < 60; minute += 30) {
                     const startHour = hour;
                     const startMin = minute;
                     const endMin = minute + 30;
                     const endHour = endMin >= 60 ? hour + 1 : hour;
                     const finalEndMin = endMin >= 60 ? 0 : endMin;
                     const period = startHour >= 12 ? 'PM' : 'AM';
                     const endPeriod = endHour >= 12 ? 'PM' : 'AM';
                     // Value in 24-hour format for backend (HH:mm)
                     const value24h = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`;
                     // Display format: 9:00 AM - 9:30 AM
                     const displayStart = `${startHour > 12 ? startHour - 12 : (startHour === 0 ? 12 : startHour)}:${String(startMin).padStart(2, '0')} ${period}`;
                     const displayEnd = `${endHour > 12 ? endHour - 12 : (endHour === 0 ? 12 : endHour)}:${String(finalEndMin).padStart(2, '0')} ${endPeriod}`;
                     
                     slots.push({ value: value24h, label: `${displayStart} - ${displayEnd}` });
                 }
             }
             return slots;
        };
        const timeSlots = generateTimeSlots();

        // --- FETCH DATA EFFECTS ---
        useEffect(() => {
            const doctorId = user?.doctorId || user?.professionalId;
            if (!doctorId) return;

            const fetchData = async () => {
                try {
                    // 1. Profile
                    const profileRes = await fetch(`http://localhost:8080/api/doctors/${doctorId}`);
                    if (profileRes.ok) {
                        const data = await profileRes.json();
                        setDoctorProfile({
                            firstName: data.firstName || '',
                            lastName: data.lastName || '',
                            email: data.email || user.email || '',
                            phone: data.phone || '',
                            specialization: data.specialization || '',
                            licenseNumber: data.licenseNumber || '',
                            licenseExpiry: data.licenseExpiry || '',
                            qualification: data.qualification || '',
                            consultationFee: data.consultationFee || '',
                            experienceYears: data.experienceYears || '',
                            hospitalAffiliation: data.hospitalAffiliation || '',
                            address: data.address || '',
                            city: data.city || '',
                            state: data.state || '',
                            country: data.country || '',
                            postalCode: data.postalCode || '',
                            isVerified: data.isVerified || data.verified || false
                        });
                    }

                    // 2. Notifications
                    const notifRes = await fetch(`http://localhost:8080/api/notifications/user/${user.userId}`);
                    if (notifRes.ok) {
                        const data = await notifRes.json();
                        setNotifications(data);
                        setUnreadCount(data.filter(n => !n.isRead).length);
                    }

                    // 3. Slots
                    const slotsRes = await fetch(`http://localhost:8080/api/slots/doctor/${doctorId}`);
                    if (slotsRes.ok) setSlots(await slotsRes.json());

                    // 4. Qualifications
                    const qualRes = await fetch(`http://localhost:8080/api/qualifications/doctor/${doctorId}`);
                    if (qualRes.ok) setQualifications(await qualRes.json());

                    // --- COMBINED APPOINTMENT & EMERGENCY FETCH ---
                    const appRes = await fetch(`http://localhost:8080/api/appointments/doctor/${doctorId}`);
                    const appData = appRes.ok ? await appRes.json() : [];

                    const emerRes = await fetch(`http://localhost:8080/api/emergency-requests/doctor/${doctorId}`);
                    const emerData = emerRes.ok ? await emerRes.json() : [];
                    
                    // --- POPULATE PATIENT MAP (FIX) ---
                    const pMap = new Map();
                    appData.forEach(a => { if(a.patient) pMap.set(a.patient.patientId, a.patient); });
                    emerData.forEach(e => { if(e.patient) pMap.set(e.patient.patientId, e.patient); });
                    setAllPatients(pMap);
                    
                    // Fetch consent status for all appointments (regular + emergency)
                    const allAppointmentsForConsent = [...appData, ...emerData];
                    fetchAllConsentStatus(allAppointmentsForConsent);

                    // --- PROCESS & SET STATE (FIX) ---
                    const now = new Date();
                    setPendingAppointments(appData.filter(a => a.status?.toUpperCase() === "PENDING"));
                    
                    // ONLY regular approved appointments (NO emergency)
                    setApprovedAppointments(appData.filter(a => a.status?.toUpperCase() === "APPROVED"));
                    
                    // Rejected appointments
                    setRejectedAppointments(appData.filter(a => a.status?.toUpperCase() === "REJECTED"));
                    
                    const regularCompleted = appData.filter(a => a.status?.toUpperCase() === "COMPLETED");
                    const passedEmer = emerData.filter(r => r.status === 'APPROVED' && new Date(r.requestDateTime) < now);
                    setCompletedAppointments([...regularCompleted, ...passedEmer.map(e => ({...e, isEmergency: true, patientId: e.patient?.patientId || e.patientId}))]); // Add patientId fix

                    // Emergency requests - pending ones
                    const pendingEmer = emerData.filter(r => r.status === 'PENDING');
                    setEmergencyRequests(pendingEmer);

                    // Approved emergency requests with future dates - for Emergency tab
                    const futureEmer = emerData.filter(r => r.status === 'APPROVED' && new Date(r.requestDateTime) >= now);
                    setApprovedEmergency(futureEmer);
                    // --- END OF FIX ---

                } catch (e) { console.error("Data fetch error", e); }
            };
            
            fetchData();

            // LocalStorage Prescriptions
            const stored = JSON.parse(localStorage.getItem('uploadedPrescriptions') || '[]');
            setUploadedPrescriptions(new Set(stored));
            
            // Fetch user issues
            if (user?.email) fetch(`http://localhost:8080/api/issues/email/${user.email}`).then(r=>r.ok?r.json():[]).then(d=>setUserIssues(d)).catch(console.error);

        }, [user]);
        
        // This separate fetch function can be used to refresh *just* appointments
        const fetchDoctorAppointments = () => {
            if (!user?.doctorId) return;
            fetch(`http://localhost:8080/api/appointments/doctor/${user.doctorId}`)
                .then(res => res.ok ? res.json() : [])
                .then(data => {
                    const now = new Date();
                    setPendingAppointments(data.filter(a => a.status?.toUpperCase() === "PENDING"));
                    setApprovedAppointments(data.filter(a => a.status?.toUpperCase() === "APPROVED"));
                    setRejectedAppointments(data.filter(a => a.status?.toUpperCase() === "REJECTED"));
                    
                    const regularCompleted = data.filter(a => a.status?.toUpperCase() === "COMPLETED");
                    // Re-check passed emergencies when refreshing
                    const passedEmer = emergencyRequests.filter(r => r.status === 'APPROVED' && new Date(r.requestDateTime) < now);
                    setCompletedAppointments([...regularCompleted, ...passedEmer.map(e => ({...e, isEmergency: true, patientId: e.patient?.patientId || e.patientId}))]);
                    
                    const pMap = new Map(allPatients); // Copy existing map
                    data.forEach(a => { if(a.patient) pMap.set(a.patient.patientId, a.patient); });
                    setAllPatients(pMap);
                })
                .catch(console.error);
        };
        
        // Refresh emergency requests (e.g., after approval)
        const fetchEmergencyRequests = () => {
            if (!user?.doctorId) return;
            fetch(`http://localhost:8080/api/emergency-requests/doctor/${user.doctorId}`)
                .then(res => res.ok ? res.json() : [])
                .then(emerData => {
                    const now = new Date();
                    const pendingEmer = emerData.filter(r => r.status === 'PENDING');
                    setEmergencyRequests(pendingEmer);
                    const futureEmer = emerData.filter(r => r.status === 'APPROVED' && new Date(r.requestDateTime) >= now);
                    setApprovedEmergency(futureEmer);
                    
                    // Update completed list as well
                    const regularCompleted = completedAppointments.filter(a => !a.isEmergency);
                    const passedEmer = emerData.filter(r => r.status === 'APPROVED' && new Date(r.requestDateTime) < now);
                    setCompletedAppointments([...regularCompleted, ...passedEmer.map(e => ({...e, isEmergency: true, patientId: e.patient?.patientId || e.patientId}))]);
                });
        };
        
        // Fetch user issues
        const fetchUserIssues = () => { 
            if (user?.email) fetch(`http://localhost:8080/api/issues/email/${user.email}`).then(r=>r.ok?r.json():[]).then(d=>setUserIssues(d)).catch(console.error); 
        };

        // Stats Calculation
        useEffect(() => {
            const today = new Date().toDateString();
            const todayAppts = approvedAppointments.filter(a => new Date(a.appointmentDateTime).toDateString() === today).length;
            const uniquePatients = allPatients.size;
            setStats(prev => ({
                ...prev,
                pendingRequests: pendingAppointments.length + emergencyRequests.length, // Total pending
                todayAppointments: todayAppts,
                totalPatients: uniquePatients,
                totalEarnings: completedAppointments.length * (doctorProfile.consultationFee || 500),
                averageRating: 4.5, // Hardcoded as per screenshot
                emergencyCases: emergencyRequests.length + approvedEmergency.length // Pending + Upcoming
            }));
        }, [pendingAppointments, approvedAppointments, completedAppointments, emergencyRequests, approvedEmergency, doctorProfile, allPatients]);


        // --- HANDLERS ---
        const handleCreateSlot = async () => {
            if (!slotData.slotDate || !slotData.slotTime) { setMessage('❌ Please select date and time'); return; }
            try {
                const res = await fetch(`http://localhost:8080/api/slots/create`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doctorId: user.doctorId, slotDate: slotData.slotDate, slotTimes: [slotData.slotTime] })
                });
                if (res.ok) {
                    setMessage('✅ Slot created!');
                    fetch(`http://localhost:8080/api/slots/doctor/${user.doctorId}`).then(r=>r.json()).then(setSlots);
                    setSlotData({slotDate:'', slotTime:''});
                    setTimeout(()=>setMessage(''), 3000);
                }
            } catch (e) { setMessage('❌ Failed to create slot'); }
        };

        const handleUploadQualification = async () => {
            if (!qualificationData.documentName || !qualificationData.file) { setMessage('❌ Missing fields'); return; }
            if (qualificationData.file.type !== 'application/pdf') { setMessage('❌ Only PDF files are allowed.'); return; }
            
            try {
                const fd = new FormData();
                fd.append('doctorId', user.doctorId);
                fd.append('documentName', qualificationData.documentName);
                fd.append('documentType', qualificationData.documentType);
                fd.append('file', qualificationData.file);
                const res = await fetch(`http://localhost:8080/api/qualifications/uploads`, { method: 'POST', body: fd });
                if (res.ok) {
                    setMessage('✅ Uploaded!');
                    fetch(`http://localhost:8080/api/qualifications/doctor/${user.doctorId}`).then(r=>r.json()).then(setQualifications);
                    setQualificationData({documentName:'', documentType:'Degree', file:null});
                    setShowUploadQualificationModal(false); // Close modal on success
                    setTimeout(()=>setMessage(''), 3000);
                }
            } catch(e) { setMessage('❌ Upload failed'); }
        };

        const updateAppointmentStatus = async (id, status) => {
            try {
                await fetch(`http://localhost:8080/api/appointments/${id}/status`, {
                    method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ status })
                });
                fetchDoctorAppointments();
                setMessage(`✅ Appointment ${status.toLowerCase()}!`);
                setTimeout(()=>setMessage(''), 3000);
            } catch(e) { setMessage('❌ Update failed'); }
        };

        const updateEmergencyRequestStatus = async (id, status) => {
             try {
                await fetch(`http://localhost:8080/api/emergency-requests/${id}/status`, {
                    method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ status })
                });
                fetchEmergencyRequests(); // Refresh emergency list
                fetchDoctorAppointments(); // Refresh regular lists
                setMessage(`✅ Request ${status.toLowerCase()}!`);
                setTimeout(()=>setMessage(''), 3000);
            } catch(e) { setMessage('❌ Update failed'); }
        };

        const handlePrescriptionAdded = () => {
            setShowUploadModal(false);
            setMessage("✅ Prescription Sent!");
            const appointmentId = selectedPatientForUpload?.appointmentId || selectedPatientForUpload?.requestId;
            if (appointmentId) {
                const newSet = new Set(uploadedPrescriptions).add(appointmentId);
                setUploadedPrescriptions(newSet);
                localStorage.setItem('uploadedPrescriptions', JSON.stringify([...newSet]));
            }
            setTimeout(()=>setMessage(""), 3000);
        };

        const handleUploadPrescription = (patient, appointmentId) => { 
            setSelectedPatientForUpload({...patient, appointmentId: appointmentId}); 
            setShowUploadModal(true); 
        };

        const handleDownloadQual = (qualification) => {
            if (!qualification.documentPath) {
                setMessage("❌ Document path not found.");
                setTimeout(() => setMessage(""), 3000);
                return;
            }
            setMessage(`Downloading ${qualification.documentName}...`);
            
            const link = document.createElement('a');
            link.href = qualification.documentPath;
            link.setAttribute('download', qualification.documentName || 'qualification.pdf');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => setMessage(""), 3000);
        };


        // Sidebar Items for Doctor
        const sidebarItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-line' },
            { id: 'profile', label: 'My Profile', icon: 'fa-user-md' },
            { id: 'slots', label: 'Manage Slots', icon: 'fa-clock' },
            { id: 'appointments', label: 'Manage Appointments', icon: 'fa-calendar-check' },
            { id: 'requests', label: 'Booking Requests', icon: 'fa-inbox' },
            { id: 'reviews', label: 'Reviews & Prescriptions', icon: 'fa-file-prescription' },
            { id: 'qualifications', label: 'Qualifications', icon: 'fa-certificate' },
            { id: 'reports', label: 'Reports & Issues', icon: 'fa-flag' },
        ];
        
        // --- DERIVED STATE FOR SLOTS & APPOINTMENTS (FOR COUNTS & LISTS) ---
        const today = new Date(new Date().setHours(0, 0, 0, 0));
        const activeSlots = slots.filter(s => new Date(s.slotDate) >= today).sort((a,b) => new Date(a.slotDate) - new Date(b.slotDate));
        const passedSlots = slots.filter(s => new Date(s.slotDate) < today).sort((a,b) => new Date(b.slotDate) - new Date(a.slotDate));
        
        const upcomingAppointments = approvedAppointments.filter(a => {
            const dateTime = a.appointmentDateTime || a.requestDateTime;
            return new Date(dateTime) > new Date();
        });
        
        // Combine all appointments (completed + approved + rejected + emergency completed + active emergency)
        // and remove duplicates based on appointmentId or requestId
        const allAppointmentsRaw = [...approvedAppointments, ...completedAppointments, ...rejectedAppointments, ...approvedEmergency];
        const seenIds = new Set();
        const allAppointments = allAppointmentsRaw.filter(a => {
            const id = a.appointmentId || a.requestId;
            // If no valid ID, include the item (don't filter it out)
            if (!id) return true;
            if (seenIds.has(id)) return false;
            seenIds.add(id);
            return true;
        });

        return (
            <div className="flex min-h-screen bg-brand-bg font-sans">
                {/* SIDEBAR */}
                <Sidebar 
                    isOpen={isSidebarOpen} 
                    toggle={() => setIsSidebarOpen(!isSidebarOpen)} 
                    activeSection={activeSection} 
                    onSelectSection={setActiveSection} 
                    menuItems={sidebarItems} 
                    onLogout={onLogout}
                    userRole="doctor"
                />

                {/* MAIN CONTENT AREA */}
                <div className={`flex-1 flex flex-col transition-all duration-300 ${isSidebarOpen ? 'ml-72' : 'ml-20'}`}>
                    
                    {/* HEADER (UPDATED) */}
                    <header className="bg-gradient-to-r from-purple-600 via-pink-600 to-yellow-500 shadow-lg sticky top-0 z-30 px-8 py-4 h-20 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <h1 className="text-2xl font-extrabold text-white flex items-center cursor-pointer" onClick={()=>window.location.reload()}>
                                <i className="fas fa-shield-heart text-3xl mr-2"></i> MedVault
                            </h1>
                        </div>

                        {/* --- UPDATED HEADER BUTTONS (GLASS EFFECT) --- */}
                        <div className="flex items-center gap-4">
                            <button onClick={() => { sessionStorage.removeItem('loggedInUser'); window.location.href = 'http://localhost:5173/'; }} className="bg-white/30 backdrop-blur-sm border border-white/40 text-white px-4 py-2 rounded-lg font-bold hover:bg-white/50 transition flex items-center text-sm">
                                <i className="fas fa-home mr-2"></i> Home
                            </button>
                            <button onClick={() => { window.location.hash = '#support'; }} className="bg-white/30 backdrop-blur-sm border border-white/40 text-white px-4 py-2 rounded-lg font-bold hover:bg-white/50 transition flex items-center text-sm">
                                <i className="fas fa-exclamation-circle mr-2"></i> Report Issue
                            </button>
                            
                            {/* Notification Bell (RED COUNTER) */}
                            <div className="relative">
                                <button onClick={() => { setShowNotifications(!showNotifications); if (!showNotifications && unreadCount > 0) { fetch(`http://localhost:8080/api/notifications/user/${user.userId}/read-all`, { method: 'PUT' }).then(() => { setUnreadCount(0); setNotifications(prev => prev.map(n => ({...n, isRead: true}))); }).catch(console.error); } }} className="text-white hover:text-yellow-200 relative transition-colors transform hover:scale-110">
                                    <i className="fas fa-bell text-2xl"></i>
                                    {unreadCount > 0 && (
                                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                                            {unreadCount}
                                        </span>
                                    )}
                                </button>
                                {showNotifications && (
                                    <div className="absolute right-0 mt-4 w-80 bg-white rounded-xl shadow-2xl z-50 border border-slate-100 p-4">
                                        <h3 className="font-bold text-purple-600 border-b pb-2 mb-2">Notifications</h3>
                                        {notifications.length === 0 ? <p className="text-sm text-slate-500">No notifications</p> : notifications.map(n=>(
                                            <div key={n.notificationId} className="p-2 border-b text-sm hover:bg-slate-50">{n.message}</div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="p-8 max-w-7xl w-full mx-auto bg-brand-bg">
                        
                        {/* --- BANNER (FULL PURPLE) --- */}
                        <div className="relative bg-gradient-to-r from-purple-600 to-brand-purple rounded-3xl shadow-lg p-8 mb-10 flex items-center overflow-hidden animate-fade-in">
                             <div className="flex items-center gap-6 z-10">
                                <div className="p-1 rounded-full bg-white/30 border-2 border-white/50">
                                    <img
                                        src={user.profilePictureUrl || `https://placehold.co/128x128/B8BDFF/7209B7?text=${user.name?.charAt(0)}`}
                                        alt="Profile"
                                        className="w-28 h-28 rounded-full object-cover"
                                    />
                                </div>
                                <div>
                                    <h2 className="text-4xl font-bold text-white mb-2 flex items-center gap-3">
                                        {/* --- GREETING & VERIFIED BADGE --- */}
                                        {getISTGreeting()}, {user.name}!
                                        {(doctorProfile.isVerified || doctorProfile.verified) && (
                                            <img src="https://cdn-icons-png.flaticon.com/128/2143/2143150.png" alt="Verified" title="Verified Doctor" className="w-8 h-8" />
                                        )}
                                    </h2>
                                    <p className="text-purple-100 text-lg opacity-90 italic">Dedicated to healing, committed to care</p>
                                </div>
                             </div>
                        </div>
                        
                        {message && <div className="mb-6 p-4 bg-yellow-100 text-yellow-800 rounded-xl font-bold text-center border border-yellow-200 shadow-sm">{message}</div>}

                        {/* --- DASHBOARD SECTION (NEW STATS CARDS) --- */}
                        {activeSection === 'dashboard' && (
                            <div className="animate-fade-in">
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-purple-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i className="fas fa-clock text-2xl"></i></div>
                                        <div><p className="text-3xl font-bold text-slate-800">{stats.pendingRequests}</p><p className="text-slate-500 font-bold text-xs uppercase">Pending Requests</p></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-yellow-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600"><i className="fas fa-calendar-day text-2xl"></i></div>
                                        <div><p className="text-3xl font-bold text-slate-800">{stats.todayAppointments}</p><p className="text-slate-500 font-bold text-xs uppercase">Today's Appointments</p></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-blue-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i className="fas fa-users text-2xl"></i></div>
                                        <div><p className="text-3xl font-bold text-slate-800">{stats.totalPatients}</p><p className="text-slate-500 font-bold text-xs uppercase">Total Patients</p></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-2xl shadow-md border-l-4 border-red-500 flex items-center gap-4 hover:shadow-lg transition-all">
                                        <div className="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i className="fas fa-ambulance text-2xl"></i></div>
                                        <div><p className="text-3xl font-bold text-slate-800">{stats.emergencyCases}</p><p className="text-slate-500 font-bold text-xs uppercase">Emergency requests</p></div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm p-8 border border-slate-100">
                                    <h4 className="text-lg font-bold text-slate-800 mb-6 flex items-center"><i className="fas fa-calendar-alt mr-2 text-purple-600"></i> Today's Schedule</h4>
                                    {approvedAppointments.filter(a => new Date(a.appointmentDateTime).toDateString() === new Date().toDateString()).length === 0 ? (
                                        <p className="text-slate-500 italic">No appointments scheduled for today.</p>
                                    ) : (
                                        <div className="space-y-4">
                                            {approvedAppointments.filter(a => new Date(a.appointmentDateTime).toDateString() === new Date().toDateString()).map(a => (
                                                <div key={a.appointmentId} className="flex items-center p-4 bg-slate-50 rounded-xl">
                                                    <div className="flex items-center gap-4 flex-1">
                                                        <div className="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                                                            {a.patient?.firstName?.charAt(0) || 'P'}
                                                        </div>
                                                        <div className="flex-1">
                                                            <p className="font-bold text-slate-800">{a.patient ? `${a.patient.firstName} ${a.patient.lastName}` : 'N/A'}</p>
                                                            <div className="flex items-center gap-4 text-sm text-slate-500">
                                                                <span><i className="fas fa-calendar mr-1"></i>{new Date(a.appointmentDateTime).toLocaleDateString()}</span>
                                                                <span><i className="fas fa-clock mr-1"></i>{new Date(a.appointmentDateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                                                {a.reason && <span className="text-slate-600 border-l border-slate-300 pl-4"><i className="fas fa-notes-medical mr-1"></i>{a.reason}</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">APPROVED</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* --- MY PROFILE SECTION --- */}
                        {activeSection === 'profile' && (
                            <div className="animate-fade-in bg-white rounded-2xl shadow-sm p-8 border border-slate-100">
                                <div className="flex justify-between items-center mb-8">
                                    <h3 className="text-2xl font-bold text-slate-800 flex items-center"><i className="fas fa-user-circle mr-2 text-purple-600"></i> My Profile</h3>
                                    <button onClick={() => setIsEditingProfile(!isEditingProfile)} className="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-700 transition">
                                        {isEditingProfile ? 'Save Profile' : 'Edit Profile'}
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {['firstName', 'lastName', 'email', 'phone', 'specialization', 'experienceYears', 'licenseNumber', 'licenseExpiry', 'consultationFee', 'city', 'state', 'country', 'postalCode', 'hospitalAffiliation', 'qualification'].map(field => (
                                        <div key={field} className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">
                                                {field === 'experienceYears' ? 'Experience' : field.replace(/([A-Z])/g, ' $1')}
                                            </label>
                                            {isEditingProfile ? (
                                                <input 
                                                    className="w-full bg-white border border-slate-300 rounded p-1" 
                                                    value={doctorProfile[field] || ''} 
                                                    onChange={(e) => setDoctorProfile({...doctorProfile, [field]: e.target.value})}
                                                />
                                            ) : (
                                                <p className="text-slate-800 font-semibold text-lg">
                                                    {field === 'consultationFee' && '₹'}{doctorProfile[field] || 'N/A'}{field === 'experienceYears' && ' years'}
                                                </p>
                                            )}
                                        </div>
                                    ))}
                                    <div className="md:col-span-3 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Address</label>
                                        {isEditingProfile ? (
                                            <textarea className="w-full bg-white border border-slate-300 rounded p-1" value={doctorProfile.address || ''} onChange={(e)=>setDoctorProfile({...doctorProfile, address:e.target.value})} />
                                        ) : <p className="text-slate-800 font-semibold">{doctorProfile.address || 'N/A'}</p>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- CREATE SLOTS SECTION (UPDATED) --- */}
                        {activeSection === 'slots' && (
                            <div className="animate-fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold text-slate-800 flex items-center"><i className="fas fa-clock mr-2 text-yellow-600"></i> My Availability Slots</h3>
                                    <button onClick={() => setShowCreateSlotModal(true)} className="bg-orange-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-600 shadow-md">
                                        + Create Slot
                                    </button>
                                </div>
                                
                                <div className="bg-white rounded-2xl p-8 shadow-sm border border-slate-100 mb-8">
                                    <h4 className="font-bold text-slate-800 mb-4">Active Slots ({activeSlots.length})</h4>
                                    {activeSlots.length === 0 ? (
                                        <div className="p-8 text-center bg-yellow-50 rounded-xl border border-yellow-100 text-yellow-700">No active slots found.</div>
                                    ) : (
                                        <div className="space-y-6">
                                            {/* Group slots by date */}
                                            {Object.entries(activeSlots.reduce((groups, slot) => {
                                                const date = new Date(slot.slotDate).toLocaleDateString();
                                                if (!groups[date]) groups[date] = [];
                                                groups[date].push(slot);
                                                return groups;
                                            }, {})).map(([date, slotsForDate]) => {
                                                const bookedCount = slotsForDate.filter(s => !s.isAvailable).length;
                                                const totalCount = slotsForDate.length;
                                                return (
                                                    <div key={date} className="border border-slate-200 rounded-xl overflow-hidden">
                                                        <div className="bg-slate-100 px-4 py-3 flex justify-between items-center">
                                                            <h5 className="font-bold text-slate-800">{date}</h5>
                                                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${bookedCount === totalCount ? 'bg-red-100 text-red-700' : bookedCount > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>
                                                                {bookedCount}/{totalCount} Booked
                                                            </span>
                                                        </div>
                                                        <div className="p-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                                                            {slotsForDate.map(s => (
                                                                <div key={s.slotId} className={`p-3 rounded-lg border ${s.isAvailable ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                                                    <p className="text-sm font-semibold text-slate-700">{s.slotTime}</p>
                                                                    <span className={`inline-block mt-1 px-2 py-0.5 rounded text-xs font-bold ${s.isAvailable ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}`}>
                                                                        {s.isAvailable ? 'Available' : 'Booked'}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>

                                <div className="bg-white rounded-2xl p-8 shadow-sm border border-slate-100">
                                    <h4 className="font-bold text-slate-500 mb-4">Passed Slots ({passedSlots.length})</h4>
                                    {passedSlots.length === 0 ? (
                                        <div className="p-8 text-center bg-slate-50 rounded-xl border border-slate-100 text-slate-500 italic">No passed slots.</div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            {passedSlots.slice(0, 8).map(s => ( // Show max 8 passed slots
                                                <div key={s.slotId} className="p-4 rounded-xl border bg-slate-50 border-slate-200 opacity-70">
                                                    <p className="font-semibold text-slate-600">{new Date(s.slotDate).toLocaleDateString()}</p>
                                                    <p className="text-sm text-slate-500">{s.slotTime}</p>
                                                    <span className="inline-block mt-2 px-2 py-0.5 rounded text-xs font-bold bg-slate-200 text-slate-600">
                                                        {s.isAvailable ? 'Expired' : 'Completed'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* --- MANAGE APPOINTMENTS SECTION (ACTION COLUMN FIX) --- */}
                        {activeSection === 'appointments' && (
                            <div className="animate-fade-in bg-white rounded-2xl shadow-sm p-8 border border-slate-100">
                                <h3 className="text-2xl font-bold text-slate-800 mb-6 flex items-center"><i className="fas fa-calendar-check mr-2 text-blue-600"></i> Manage Appointments</h3>
                                
                                <div className="flex gap-8 border-b border-slate-200 mb-6">
                                    <button onClick={() => setActiveTab('all')} className={`pb-3 font-bold text-sm transition-colors ${activeTab === 'all' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-slate-400 hover:text-purple-600'}`}>
                                        All ({allAppointments.length})
                                    </button>
                                    <button onClick={() => setActiveTab('upcoming')} className={`pb-3 font-bold text-sm transition-colors ${activeTab === 'upcoming' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-slate-400 hover:text-purple-600'}`}>
                                        Upcoming ({upcomingAppointments.length})
                                    </button>
                                    <button onClick={() => setActiveTab('approved')} className={`pb-3 font-bold text-sm transition-colors ${activeTab === 'approved' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-slate-400 hover:text-purple-600'}`}>
                                        Approved ({approvedAppointments.length})
                                    </button>
                                    <button onClick={() => setActiveTab('emergency')} className={`pb-3 font-bold text-sm transition-colors ${activeTab === 'emergency' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-slate-400 hover:text-purple-600'}`}>
                                        Emergency ({approvedEmergency.length})
                                    </button>
                                    <button onClick={() => setActiveTab('completed')} className={`pb-3 font-bold text-sm transition-colors ${activeTab === 'completed' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-slate-400 hover:text-purple-600'}`}>
                                        Completed ({completedAppointments.length})
                                    </button>
                                </div>

                                {/* --- DYNAMIC HEADER --- */}
                                <div className={`grid ${activeTab === 'all' || activeTab === 'completed' || activeTab === 'upcoming' ? 'grid-cols-5' : 'grid-cols-6'} gap-4 font-bold text-slate-800 mb-4 px-4`}>
                                    <div>Patient</div>
                                    <div>Date</div>
                                    <div>Time</div>
                                    <div>Reason</div>
                                    <div>Status</div>
                                    {activeTab !== 'all' && activeTab !== 'completed' && activeTab !== 'upcoming' && (
                                        <div>Action</div>
                                    )}
                                </div>

                                <div className="space-y-2">
                                    {/* --- ALL (grid-cols-5) --- */}
                                    {activeTab === 'all' && allAppointments.length === 0 && <p className="text-center p-4 text-slate-500 italic">No appointments found.</p>}
                                    {activeTab === 'all' && allAppointments.map((a, index) => {
                                        const patient = allPatients.get(a.patient?.patientId || a.patientId);
                                        const isEmergency = a.isEmergency || a.requestId;
                                        const dateTime = a.appointmentDateTime || a.requestDateTime;
                                        const patientName = a.patientName || (patient ? `${patient.firstName} ${patient.lastName}` : (a.patient ? `${a.patient.firstName} ${a.patient.lastName}` : 'Unknown Patient'));
                                        const reason = isEmergency ? (a.conditionDescription || 'Emergency') : (a.reason || 'General Checkup');
                                        const uniqueKey = a.appointmentId || a.requestId || `all-${index}`;
                                        // Determine emergency status: EMERGENCY (COMPLETED) or EMERGENCY (UPCOMING)
                                        const isUpcomingEmergency = isEmergency && a.status === 'APPROVED' && new Date(dateTime) >= new Date();
                                        const isCompletedEmergency = isEmergency && (a.status === 'COMPLETED' || (a.status === 'APPROVED' && new Date(dateTime) < new Date()));
                                        const displayStatus = isEmergency 
                                            ? (isCompletedEmergency ? 'EMERGENCY (COMPLETED)' : isUpcomingEmergency ? 'EMERGENCY (UPCOMING)' : a.status)
                                            : a.status;
                                        return (
                                            <div key={uniqueKey} className={`grid grid-cols-5 gap-4 items-center p-4 rounded-xl ${isEmergency ? 'bg-red-50' : 'bg-slate-50'}`}>
                                                <div className="font-semibold text-slate-700">{patientName}</div>
                                                <div className="text-slate-600 text-sm">{new Date(dateTime).toLocaleDateString()}</div>
                                                <div className="text-slate-600 text-sm">{new Date(dateTime).toLocaleTimeString()}</div>
                                                <div className="text-slate-600 text-sm">{reason}</div>
                                                <div>
                                                    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${
                                                        displayStatus === 'EMERGENCY (COMPLETED)' ? 'bg-orange-100 text-orange-800' :
                                                        displayStatus === 'EMERGENCY (UPCOMING)' ? 'bg-red-100 text-red-800' :
                                                        a.status === 'APPROVED' ? 'bg-green-100 text-green-800' : 
                                                        a.status === 'COMPLETED' ? 'bg-blue-100 text-blue-800' : 
                                                        a.status === 'REJECTED' ? 'bg-red-100 text-red-800' :
                                                        'bg-yellow-100 text-yellow-800'
                                                    }`}>
                                                        {displayStatus}
                                                    </span>
                                                </div>
                                                {/* --- NO ACTION COLUMN --- */}
                                            </div>
                                        )
                                    })}
                                    
                                    {/* --- UPCOMING (grid-cols-6) --- */}
                                    {activeTab === 'upcoming' && upcomingAppointments.length === 0 && <p className="text-center p-4 text-slate-500 italic">No upcoming appointments.</p>}
                                    {activeTab === 'upcoming' && upcomingAppointments.map(a => {
                                        // Fix: Get patient from multiple sources
                                        const isEmergency = a.isEmergency || a.requestId;
                                        const dateTime = a.appointmentDateTime || a.requestDateTime;
                                        const patientFromMap = allPatients.get(a.patient?.patientId || a.patientId);
                                        const patient = patientFromMap || a.patient || { patientId: a.patientId, firstName: 'Unknown', lastName: 'Patient' };
                                        const patientIdForConsent = patient?.patientId || a.patient?.patientId || a.patientId;
                                        // Use appointment-specific consent key
                                        const appointmentId = a.appointmentId || a.requestId;
                                        const consentKey = appointmentId ? `${patientIdForConsent}_${appointmentId}` : patientIdForConsent;
                                        const status = consentStatus.get(consentKey) || 'LOCKED';
                                        const reason = isEmergency ? (a.conditionDescription || 'Emergency') : (a.reason || 'General Checkup');
                                        return (
                                            <div key={a.appointmentId || a.requestId} className="grid grid-cols-5 gap-4 items-center p-4 rounded-xl bg-slate-50">
                                                <div className="font-semibold text-slate-700">{patient?.firstName || 'Unknown'} {patient?.lastName || 'Patient'}</div>
                                                <div className="text-slate-600 text-sm">{new Date(dateTime).toLocaleDateString()}</div>
                                                <div className="text-slate-600 text-sm">{new Date(dateTime).toLocaleTimeString()}</div>
                                                <div className="text-slate-600 text-sm">{reason}</div>
                                                <div><span className="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">UPCOMING</span></div>
                                            </div>
                                        )
                                    })}

                                    {/* --- APPROVED (grid-cols-6) --- */}
                                    {activeTab === 'approved' && approvedAppointments.length === 0 && <p className="text-center p-4 text-slate-500 italic">No approved appointments.</p>}
                                    {activeTab === 'approved' && approvedAppointments.map(a => {
                                        // Fix: Get patient from multiple sources
                                        const patientFromMap = allPatients.get(a.patient?.patientId);
                                        const patient = patientFromMap || a.patient || { patientId: a.patientId, firstName: 'Unknown', lastName: 'Patient' };
                                        const patientIdForConsent = patient?.patientId || a.patient?.patientId;
                                        // Use appointment-specific consent key
                                        const consentKey = a.appointmentId ? `${patientIdForConsent}_${a.appointmentId}` : patientIdForConsent;
                                        const status = consentStatus.get(consentKey) || 'LOCKED';
                                        const reason = a.reason || 'General Checkup';
                                        return (
                                            <div key={a.appointmentId} className="grid grid-cols-6 gap-4 items-center p-4 bg-slate-50 rounded-xl">
                                                <div className="font-semibold text-slate-700">{patient?.firstName || 'Unknown'} {patient?.lastName || 'Patient'}</div>
                                                <div className="text-slate-600 text-sm">{new Date(a.appointmentDateTime).toLocaleDateString()}</div>
                                                <div className="text-slate-600 text-sm">{new Date(a.appointmentDateTime).toLocaleTimeString()}</div>
                                                <div className="text-slate-600 text-sm">{reason}</div>
                                                <div><span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">APPROVED</span></div>
                                                <div>
                                                    <button
                                                        onClick={() => {
                                                            if (patient && patientIdForConsent) {
                                                                handleViewRecords({ ...patient, patientId: patientIdForConsent }, a.appointmentId);
                                                            } else {
                                                                setMessage('❌ Patient information not available');
                                                                setTimeout(() => setMessage(''), 3000);
                                                            }
                                                        }}
                                                        className={`font-bold text-sm flex items-center gap-1 w-fit px-3 py-1 rounded-lg
                                                            ${status === 'APPROVED' ? 'bg-blue-100 text-blue-600 hover:bg-blue-200' : ''}
                                                            ${status === 'LOCKED' ? 'bg-yellow-400 text-white hover:bg-yellow-500' : ''}
                                                            ${status === 'PENDING' ? 'bg-gray-400 text-white cursor-not-allowed' : ''}
                                                        `}
                                                        disabled={status === 'PENDING'}
                                                    >
                                                        <i className={`fas ${status === 'LOCKED' ? 'fa-lock' : 'fa-file-alt'}`}></i>
                                                        {status === 'APPROVED' ? 'View Records' :
                                                         status === 'LOCKED' ? 'Request Access' : 'Pending'}
                                                    </button>
                                                    {status === 'LOCKED' && (
                                                        <p className="text-xs text-slate-500 mt-1 italic">View health records, medical conditions and prescriptions</p>
                                                    )}
                                                </div>
                                            </div>
                                        )
                                    })}

                                    {/* --- EMERGENCY (grid-cols-6) --- */}
                                    {activeTab === 'emergency' && approvedEmergency.length === 0 && <p className="text-center p-4 text-slate-500 italic">No upcoming emergency appointments.</p>}
                                    {activeTab === 'emergency' && approvedEmergency.map(a => {
                                        // Fix: Get patient from multiple sources
                                        const patientFromMap = allPatients.get(a.patientId) || allPatients.get(a.patient?.patientId);
                                        const patient = patientFromMap || a.patient || { patientId: a.patientId, firstName: 'Unknown', lastName: 'Patient' };
                                        const patientName = a.patientName || (patient ? `${patient.firstName || ''} ${patient.lastName || ''}`.trim() : 'Unknown Patient');
                                        const patientIdForConsent = patient?.patientId || a.patientId;
                                        // Use appointment-specific consent key (requestId for emergency)
                                        const consentKey = a.requestId ? `${patientIdForConsent}_${a.requestId}` : patientIdForConsent;
                                        const status = consentStatus.get(consentKey) || 'LOCKED';
                                        const reason = a.conditionDescription || 'Emergency';
                                        return (
                                            <div key={a.requestId} className="grid grid-cols-6 gap-4 items-center p-4 bg-red-50 rounded-xl">
                                                <div className="font-semibold text-slate-700">{patientName}</div>
                                                <div className="text-slate-600 text-sm">{new Date(a.requestDateTime).toLocaleDateString()}</div>
                                                <div className="text-slate-600 text-sm">{new Date(a.requestDateTime).toLocaleTimeString()}</div>
                                                <div className="text-slate-600 text-sm">{reason}</div>
                                                <div><span className="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold">EMERGENCY</span></div>
                                                <div>
                                                    <button
                                                        onClick={() => {
                                                            // Fix: Ensure patient object has patientId before calling
                                                            // Pass null for appointmentId and requestId as emergencyRequestId
                                                            if (patient && (patient.patientId || a.patientId)) {
                                                                handleViewRecords({ ...patient, patientId: patient.patientId || a.patientId }, null, a.requestId);
                                                            } else {
                                                                setMessage('❌ Patient information not available');
                                                                setTimeout(() => setMessage(''), 3000);
                                                            }
                                                        }}
                                                        className={`font-bold text-sm flex items-center gap-1 w-fit px-3 py-1 rounded-lg
                                                            ${status === 'APPROVED' ? 'bg-blue-100 text-blue-600 hover:bg-blue-200' : ''}
                                                            ${status === 'LOCKED' ? 'bg-yellow-400 text-white hover:bg-yellow-500' : ''}
                                                            ${status === 'PENDING' ? 'bg-gray-400 text-white cursor-not-allowed' : ''}
                                                        `}
                                                        disabled={status === 'PENDING'}
                                                    >
                                                        <i className={`fas ${status === 'LOCKED' ? 'fa-lock' : 'fa-file-alt'}`}></i>
                                                        {status === 'APPROVED' ? 'View Records' :
                                                         status === 'LOCKED' ? 'Request Access' : 'Pending'}
                                                    </button>
                                                    {status === 'LOCKED' && (
                                                        <p className="text-xs text-slate-500 mt-1 italic">View health records, medical conditions and prescriptions</p>
                                                    )}
                                                </div>
                                            </div>
                                        )
                                    })}

                                    {/* --- COMPLETED (grid-cols-5) --- */}
                                    {activeTab === 'completed' && completedAppointments.length === 0 && <p className="text-center p-4 text-slate-500 italic">No completed appointments.</p>}
                                    {activeTab === 'completed' && completedAppointments.map(a => {
                                        const patient = allPatients.get(a.patient?.patientId || a.patientId);
                                        const isEmergency = a.isEmergency || false;
                                        const patientName = a.patientName || (patient ? `${patient.firstName} ${patient.lastName}` : (a.patient ? `${a.patient.firstName} ${a.patient.lastName}` : 'Unknown Patient'));
                                        const reason = isEmergency ? (a.conditionDescription || 'Emergency') : (a.reason || 'General Checkup');
                                        return (
                                            <div key={a.appointmentId || a.requestId} className={`grid grid-cols-5 gap-4 items-center p-4 rounded-xl ${isEmergency ? 'bg-red-50' : 'bg-slate-50'}`}>
                                                <div className="font-semibold text-slate-700">{patientName}</div>
                                                <div className="text-slate-600 text-sm">{new Date(a.appointmentDateTime || a.requestDateTime).toLocaleDateString()}</div>
                                                <div className="text-slate-600 text-sm">{new Date(a.appointmentDateTime || a.requestDateTime).toLocaleTimeString()}</div>
                                                <div className="text-slate-600 text-sm">{reason}</div>
                                                <div>
                                                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${isEmergency ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`}>
                                                        {isEmergency ? 'COMPLETED (EMERGENCY)' : 'COMPLETED'}
                                                    </span>
                                                </div>
                                                {/* --- NO ACTION COLUMN --- */}
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {/* --- BOOKING REQUESTS SECTION --- */}
                        {activeSection === 'requests' && (
                            <div className="animate-fade-in bg-white rounded-2xl shadow-sm p-8 border border-slate-100">
                                <h3 className="text-2xl font-bold text-slate-800 mb-6">Booking Requests</h3>
                                
                                {emergencyRequests.length > 0 && (
                                    <div className="mb-8">
                                        <h4 className="text-lg font-bold text-red-600 mb-4 flex items-center"><i className="fas fa-ambulance mr-2"></i> Emergency Requests</h4>
                                        <div className="border-2 border-red-100 rounded-xl overflow-hidden">
                                            <div className="grid grid-cols-5 gap-4 bg-red-50 p-4 font-bold text-red-800 border-b border-red-100">
                                                <div>Patient</div>
                                                <div>Date & Time</div>
                                                <div>Urgency</div>
                                                <div>Condition</div>
                                                <div>Actions</div>
                                            </div>
                                            {emergencyRequests.length === 0 ? (
                                                <div className="p-8 text-center">
                                                    <i className="fas fa-ambulance text-4xl text-red-200 mb-4"></i>
                                                    <p className="text-slate-500 font-medium">No pending emergency requests</p>
                                                    <p className="text-slate-400 text-sm mt-1">Emergency requests will appear here</p>
                                                </div>
                                            ) : emergencyRequests.map(r => {
                                                const patient = allPatients.get(r.patientId);
                                                const patientName = r.patientName || (patient ? `${patient.firstName} ${patient.lastName}` : 'Unknown Patient');
                                                return (
                                                <div key={r.requestId} className="grid grid-cols-5 gap-4 p-4 items-center border-b border-red-50 hover:bg-red-50/50">
                                                    <div className="font-semibold text-slate-700">{patientName}</div>
                                                    <div className="text-sm text-slate-600">{new Date(r.requestDateTime).toLocaleString()}</div>
                                                    <div><span className="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold uppercase">{r.urgencyLevel}</span></div>
                                                    <div className="text-sm text-slate-600 italic">{r.conditionDescription}</div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => updateEmergencyRequestStatus(r.requestId, 'APPROVED')} className="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200">Approve</button>
                                                        <button onClick={() => updateEmergencyRequestStatus(r.requestId, 'REJECTED')} className="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200">Reject</button>
                                                    </div>
                                                </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                <h4 className="text-lg font-bold text-slate-800 mb-4">Regular Appointments</h4>
                                <div className="border border-slate-200 rounded-xl overflow-hidden">
                                    <div className="grid grid-cols-4 gap-4 bg-slate-50 p-4 font-bold text-slate-700 border-b border-slate-200">
                                        <div>Patient</div>
                                        <div>Date</div>
                                        <div>Reason</div>
                                        <div>Actions</div>
                                    </div>
                                    {pendingAppointments.length === 0 ? <div className="p-4 text-center text-slate-500 italic">No pending regular appointments.</div> : 
                                        pendingAppointments.map(a => (
                                            <div key={a.appointmentId} className="grid grid-cols-4 gap-4 p-4 items-center border-b border-slate-100 hover:bg-slate-50">
                                                <div className="font-semibold text-slate-700">{a.patient?.firstName} {a.patient?.lastName}</div>
                                                <div className="text-sm text-slate-600">{new Date(a.appointmentDateTime).toLocaleString()}</div>
                                                <div className="text-sm text-slate-600">{a.reason || 'Checkup'}</div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => updateAppointmentStatus(a.appointmentId, 'APPROVED')} className="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200">Approve</button>
                                                    <button onClick={() => updateAppointmentStatus(a.appointmentId, 'REJECTED')} className="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200">Reject</button>
                                                </div>
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                        )}

                        {/* --- REVIEWS & PRESCRIPTIONS SECTION (UPDATED) --- */}
                        {activeSection === 'reviews' && (
                            <div className="animate-fade-in space-y-6">
                                {/* Rating Distribution Card */}
                                <div className="bg-white rounded-2xl shadow-sm p-6 border border-slate-100">
                                    <h3 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <i className="fas fa-star text-amber-500"></i> Rating Distribution
                                    </h3>
                                    <div className="bg-amber-50 rounded-xl p-4 border border-amber-100">
                                        {[5, 4, 3, 2, 1].map(star => {
                                            const reviewsWithRating = completedAppointments.filter(a => a.review && a.review.rating === star);
                                            const totalReviews = completedAppointments.filter(a => a.review).length;
                                            const count = reviewsWithRating.length;
                                            const percentage = totalReviews > 0 ? Math.round((count / totalReviews) * 100) : 0;
                                            return (
                                                <div key={star} className="flex items-center gap-3 mb-2">
                                                    <span className="text-amber-600 w-8 font-bold">{star} ☆</span>
                                                    <div className="flex-1 bg-amber-100 rounded-full h-4 overflow-hidden">
                                                        <div 
                                                            className="bg-amber-500 h-full rounded-full transition-all duration-500"
                                                            style={{ width: `${percentage}%` }}
                                                        ></div>
                                                    </div>
                                                    <span className="text-slate-600 text-sm w-20 text-right">{count} ({percentage}%)</span>
                                                </div>
                                            );
                                        })}
                                        <div className="mt-4 pt-4 border-t border-amber-200 flex justify-between items-center">
                                            <span className="text-slate-700 font-semibold">Total Reviews: {completedAppointments.filter(a => a.review).length}</span>
                                            <span className="text-amber-600 font-bold text-lg">
                                                Avg: {completedAppointments.filter(a => a.review).length > 0 
                                                    ? (completedAppointments.filter(a => a.review).reduce((sum, a) => sum + (a.review?.rating || 0), 0) / completedAppointments.filter(a => a.review).length).toFixed(1)
                                                    : '0.0'} ★
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Feedbacks & Prescriptions Table */}
                                <div className="bg-white rounded-2xl shadow-sm p-8 border border-slate-100">
                                <h3 className="text-2xl font-bold text-slate-800 mb-6">Feedbacks & Prescriptions</h3>
                                <div className="overflow-x-auto">
                                    <div className="min-w-full">
                                        <div className="grid grid-cols-6 gap-4 bg-slate-50 p-4 rounded-t-xl font-bold text-slate-700 text-sm">
                                            <div>Patient</div>
                                            <div>Date</div>
                                            <div>Time</div>
                                            <div>Reason</div>
                                            <div>Patient Feedback</div>
                                            <div>Action</div>
                                        </div>
                                        <div className="border border-t-0 border-slate-200 rounded-b-xl">
                                            {completedAppointments.map(a => {
                                                const patient = allPatients.get(a.patient?.patientId || a.patientId);
                                                const patientName = patient ? `${patient.firstName} ${patient.lastName}` : (a.patient ? `${a.patient.firstName} ${a.patient.lastName}` : 'N/A');
                                                const dateTime = a.appointmentDateTime || a.requestDateTime;
                                                const appointmentId = a.appointmentId || a.requestId; // Use correct ID
                                                const reason = a.reason || a.conditionDescription || 'N/A';
                                                return (
                                                    <div key={appointmentId} className={`grid grid-cols-6 gap-4 p-4 items-center border-b border-slate-100 ${a.isEmergency ? 'bg-red-50/50' : 'hover:bg-slate-50'} transition`}>
                                                        <div className="font-semibold text-slate-700">{patientName}</div>
                                                        <div className="text-sm text-slate-600">{new Date(dateTime).toLocaleDateString()}</div>
                                                        <div className="text-sm text-slate-600">{new Date(dateTime).toLocaleTimeString()}</div>
                                                        <div className="text-sm text-slate-600">{reason}</div>
                                                        <div>
                                                            {a.review ? (
                                                                <div>
                                                                    <div className="text-amber-400 text-xs">{'★'.repeat(a.review.rating)}</div>
                                                                    <div className="text-xs text-slate-500 italic">"{a.review.feedback}"</div>
                                                                </div>
                                                            ) : (
                                                                <span className={`text-xs ${a.isEmergency ? 'text-red-500' : 'text-slate-400'} italic`}>
                                                                    {a.isEmergency ? 'Emergency Consult' : 'No feedback submitted.'}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div>
                                                            {uploadedPrescriptions.has(appointmentId) ? (
                                                                <span className="px-3 py-1 bg-green-100 text-green-700 rounded text-xs font-bold flex items-center w-fit"><i className="fas fa-check mr-1"></i> Uploaded</span>
                                                            ) : (
                                                                <button onClick={() => handleUploadPrescription(patient, appointmentId)} className="bg-purple-100 text-purple-700 px-3 py-1 rounded text-xs font-bold hover:bg-purple-200 flex items-center w-fit">
                                                                    <i className="fas fa-upload mr-1"></i> Upload Prescription
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        )}

                        {/* --- QUALIFICATIONS SECTION (DOWNLOAD FIX) --- */}
                        {activeSection === 'qualifications' && (
                            <div className="animate-fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold text-slate-800"><i className="fas fa-certificate mr-2 text-purple-600"></i> My Qualifications</h3>
                                    <button onClick={() => setShowUploadQualificationModal(true)} className="bg-purple-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-purple-600 shadow-md">
                                        <i className="fas fa-upload mr-2"></i> Upload Qualification
                                    </button>
                                </div>
                                
                                <div className="bg-white rounded-2xl shadow-sm p-8 border border-slate-100">
                                    <h4 className="font-bold text-slate-800 mb-4">Uploaded Documents ({qualifications.length})</h4>
                                    {qualifications.length === 0 ? <div className="p-8 text-center text-slate-500">No qualifications uploaded yet.</div> : 
                                        <div className="space-y-4">
                                            {qualifications.map(q => (
                                                <div key={q.qualificationId} className="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                                                    <div className="flex items-center gap-4">
                                                        <div className="w-10 h-10 bg-red-100 text-red-600 rounded-lg flex items-center justify-center text-xl">
                                                            <i className="fas fa-file-pdf"></i>
                                                        </div>
                                                        <div>
                                                            <p className="font-bold text-slate-800">{q.documentName}</p>
                                                            <p className="text-xs text-slate-500">{q.documentType}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        <span className={`text-xs font-bold px-3 py-1.5 rounded-full uppercase flex items-center gap-1.5 ${
                                                            (q.verificationStatus === 'VERIFIED' || q.verificationStatus === 'APPROVED') ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                                        }`}>
                                                            {(q.verificationStatus === 'VERIFIED' || q.verificationStatus === 'APPROVED') && <i className="fas fa-check-circle"></i>}
                                                            {q.verificationStatus === 'APPROVED' ? 'Verified' : (q.verificationStatus || 'Pending')}
                                                        </span>
                                                        <button 
                                                            onClick={() => handleDownloadQual(q)} 
                                                            className="text-blue-600 font-bold text-sm hover:underline flex items-center gap-1"
                                                        >
                                                            <i className="fas fa-download"></i> Download
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    }
                                </div>
                            </div>
                        )}

                        {/* REPORTS & ISSUES - DOCTOR */}
                        {activeSection === 'reports' && (
                            <section className="animate-fade-in space-y-6">
                                <div className="bg-white rounded-2xl shadow-lg p-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                            <i className="fas fa-flag text-orange-500"></i> My Reports & Issues
                                        </h3>
                                        <button onClick={() => { window.location.hash = '#support'; }} className="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg font-bold hover:shadow-lg transition-all">
                                            <i className="fas fa-plus mr-2"></i> Report New Issue
                                        </button>
                                    </div>
                                    
                                    {userIssues.length === 0 ? (
                                        <div className="text-center py-12">
                                            <i className="fas fa-check-circle text-6xl text-green-300 mb-4"></i>
                                            <p className="text-slate-500 text-lg">No issues reported yet.</p>
                                            <p className="text-slate-400 text-sm mt-2">If you face any problems, click "Report New Issue" above.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {userIssues.map(issue => {
                                                const statusLower = (issue.status || 'pending').toLowerCase();
                                                const isResolved = statusLower === 'resolved';
                                                const isInProgress = statusLower === 'in-progress' || statusLower === 'in_progress';
                                                return (
                                                <div key={issue.id} className={`p-5 rounded-xl border-2 ${isResolved ? 'bg-green-50 border-green-200' : isInProgress ? 'bg-blue-50 border-blue-200' : 'bg-orange-50 border-orange-200'}`}>
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <h4 className="font-bold text-lg text-slate-800">{issue.subject || 'Issue Report'}</h4>
                                                            <p className="text-sm text-slate-500">Submitted: {new Date(issue.createdAt).toLocaleDateString()}</p>
                                                        </div>
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${isResolved ? 'bg-green-500 text-white' : isInProgress ? 'bg-blue-500 text-white' : 'bg-orange-500 text-white'}`}>
                                                            {issue.status || 'PENDING'}
                                                        </span>
                                                    </div>
                                                    <p className="text-slate-700 mb-3">{issue.message}</p>
                                                    {issue.adminMessage && (
                                                        <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                                            <p className="text-sm font-bold text-blue-700 mb-1"><i className="fas fa-reply mr-1"></i> Admin Response:</p>
                                                            <p className="text-slate-700">{issue.adminMessage}</p>
                                                        </div>
                                                    )}
                                                </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </section>
                        )}
                    </main>
                </div>

                {/* --- DOCTOR MODALS --- */}
                {showCreateSlotModal && (
                    <div className="modal-overlay" onClick={()=>setShowCreateSlotModal(false)}>
                        <div className="modal-content" onClick={e=>e.stopPropagation()}>
                            <h2 className="text-xl font-bold mb-4">Add Availability Slot</h2>
                            <input type="date" className="w-full p-3 border rounded mb-4" value={slotData.slotDate} onChange={e=>setSlotData({...slotData, slotDate:e.target.value})} />
                            <select className="w-full p-3 border rounded mb-4" value={slotData.slotTime} onChange={e=>setSlotData({...slotData, slotTime:e.target.value})}>
                                <option value="">Select Time</option>
                                {timeSlots.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}
                            </select>
                            <button onClick={handleCreateSlot} className="w-full bg-purple-600 text-white py-3 rounded font-bold">Create Slot</button>
                        </div>
                    </div>
                )}

                {showUploadQualificationModal && (
                    <div className="modal-overlay" onClick={()=>setShowUploadQualificationModal(false)}>
                        <div className="modal-content" onClick={e=>e.stopPropagation()}>
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-slate-800">Upload Qualification</h2>
                                <button onClick={() => setShowUploadQualificationModal(false)} className="text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Document Name</label>
                                    <input type="text" placeholder="e.g., MBBS Certificate" className="w-full p-3 border rounded" value={qualificationData.documentName} onChange={e=>setQualificationData({...qualificationData, documentName:e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Document Type</label>
                                    <select className="w-full p-3 border rounded" value={qualificationData.documentType} onChange={e=>setQualificationData({...qualificationData, documentType:e.target.value})}>
                                        <option>Degree</option><option>Certificate</option><option>License</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Upload File <span className="text-red-500 font-normal">(Only PDF allowed)</span></label>
                                    <input 
                                        type="file" 
                                        className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" 
                                        accept=".pdf" // Ensures only PDFs can be selected
                                        onChange={e=>setQualificationData({...qualificationData, file:e.target.files[0]})} 
                                    />
                                </div>
                                <button onClick={handleUploadQualification} className="w-full bg-purple-600 text-white py-3 rounded font-bold">Upload</button>
                            </div>
                        </div>
                    </div>
                )}
                
                {showUploadModal && selectedPatientForUpload && (
                    <DoctorAddPrescriptionModal
                        doctorUser={user}
                        patient={selectedPatientForUpload}
                        onClose={() => setShowUploadModal(false)}
                        onRecordAdded={handlePrescriptionAdded}
                    />
                )}

                {showViewRecordsModal && selectedPatientForView && (
                    <DoctorViewRecordsModal
                        patient={selectedPatientForView}
                        doctorId={user?.doctorId}
                        onClose={() => setShowViewRecordsModal(false)}
                        onUploadPrescription={handleUploadPrescription}
                    />
                )}

                {/* REPORT ISSUE MODAL - DOCTOR */}
                {showReportIssueModal && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 animate-fade-in">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold text-slate-800"><i className="fas fa-flag text-orange-500 mr-2"></i> Report an Issue</h3>
                                <button onClick={() => setShowReportIssueModal(false)} className="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                            </div>
                            <div className="space-y-4">
                                <input type="text" placeholder="Your Name" value={issueForm.name || (doctorProfile?.firstName + ' ' + doctorProfile?.lastName) || ''} onChange={e => setIssueForm({...issueForm, name: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <input type="email" placeholder="Your Email" value={issueForm.email || user?.email || ''} onChange={e => setIssueForm({...issueForm, email: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <input type="tel" placeholder="Phone Number (optional)" value={issueForm.phoneNumber} onChange={e => setIssueForm({...issueForm, phoneNumber: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <input type="text" placeholder="Subject" value={issueForm.subject} onChange={e => setIssueForm({...issueForm, subject: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg" />
                                <textarea placeholder="Describe your issue in detail..." value={issueForm.message} onChange={e => setIssueForm({...issueForm, message: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg h-32 resize-none"></textarea>
                            </div>
                            <div className="flex gap-3 mt-6">
                                <button onClick={() => setShowReportIssueModal(false)} className="flex-1 py-3 border border-slate-300 rounded-lg font-bold text-slate-600 hover:bg-slate-50">Cancel</button>
                                <button onClick={() => {
                                    const payload = {
                                        name: issueForm.name || (doctorProfile?.firstName + ' ' + doctorProfile?.lastName),
                                        email: issueForm.email || user?.email,
                                        phoneNumber: issueForm.phoneNumber,
                                        subject: issueForm.subject,
                                        message: issueForm.message,
                                        userType: 'DOCTOR',
                                        userId: user?.userId
                                    };
                                    fetch('http://localhost:8080/api/issues', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload)
                                    }).then(r => {
                                        if (r.ok) {
                                            setShowReportIssueModal(false);
                                            setIssueForm({ name: '', email: '', phoneNumber: '', subject: '', message: '' });
                                            fetchUserIssues();
                                            setMessage('Issue reported successfully!');
                                            setTimeout(() => setMessage(''), 3000);
                                        } else {
                                            setMessage('Failed to submit issue');
                                            setTimeout(() => setMessage(''), 3000);
                                        }
                                    }).catch(err => {
                                        setMessage('Error: ' + err.message);
                                        setTimeout(() => setMessage(''), 3000);
                                    });
                                }} className="flex-1 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg font-bold hover:shadow-lg">Submit Issue</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };
    // --- DashboardHeader (MODIFIED) ---
    const DashboardHeader = ({ onLogout, menuItems, notifications, unreadCount, showNotifications, handleBellClick, handleNotificationClick }) => (
        <header className="bg-white shadow-sm">
            <div className="container mx-auto p-4 flex justify-between items-center">
                <h1 className="text-2xl font-extrabold text-brand-purple flex items-center">
                    <i className="fas fa-shield-heart text-3xl mr-2"></i> MedVault
                </h1>
                <div className="flex items-center gap-4">
                    {/* Notification Bell (RED COUNTER) */}
                    <div className="relative">
                        <button onClick={handleBellClick} className="text-slate-600 hover:text-brand-purple relative transition-colors transform hover:scale-110">
                            <i className="fas fa-bell text-2xl"></i>
                            {unreadCount > 0 && (
                                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                                    {unreadCount}
                                </span>
                            )}
                        </button>
                        {showNotifications && (
                            <div className="absolute right-0 mt-4 w-80 bg-white rounded-xl shadow-2xl z-50 border border-slate-100 max-h-96 overflow-y-auto">
                                <div className="p-4 border-b bg-purple-50"><h3 className="font-bold text-brand-purple">Notifications</h3></div>
                                {notifications.length === 0 ? <p className="p-4 text-slate-500 text-center">No notifications</p> : notifications.map(n => (
                                    <div key={n.notificationId} className="p-4 border-b hover:bg-slate-50 cursor-pointer" onClick={() => handleNotificationClick(n)}><p className="text-sm text-slate-800">{n.message}</p></div>
                                ))}
                            </div>
                        )}
                    </div>
                    {/* ADMIN MENU AND LOGOUT */}
                    <DashboardMenu menuItems={menuItems} />
                    <button onClick={onLogout} className="font-semibold text-slate-600 hover:text-red-500">
                        <i className="fas fa-sign-out-alt mr-2"></i>Log Out
                    </button>
                </div>
            </div>
        </header>
    );

    // --- Auth Components (Unchanged) ---
    const AuthPage = ({ role, onBack, onLoginSuccess }) => {
        const [authType, setAuthType] = useState('register');
        const [message, setMessage] = useState({ text: '', type: '' });

        const handleRegister = async (e, formData) => {
            e.preventDefault();
            setMessage({ text: 'Registering...', type: 'info' });
            const payload = Object.fromEntries(
                Object.entries(formData).filter(([_, v]) => v != null && v !== '')
            );
            try {
                const response = await fetch(`http://localhost:8080/api/auth/register/${role}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const responseText = await response.text();
                if (response.ok) {
                    setMessage({ text: `${responseText}. You can now sign in.`, type: 'success' });
                    e.target.reset();
                    setAuthType('login');
                } else {
                    setMessage({ text: responseText || `Registration failed`, type: 'error' });
                }
            } catch (error) {
                setMessage({ text: 'Could not connect to the server.', type: 'error' });
            }
        };

        const handleLogin = async (e, formData) => {
            e.preventDefault();
            setMessage({ text: 'Signing in...', type: 'info' });
            try {
                const response = await fetch(`http://localhost:8080/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                if (response.ok) {
                    const userData = await response.json();
                    if (userData.role !== role) {
                        // Special check for admin login from the "secret" URL
                        if (role === 'admin') {
                             setMessage({ text: `Login failed. Please use the correct portal for your role.`, type: 'error' });
                             return;
                        }
                        setMessage({ text: `Login failed. Please use the correct portal for your role.`, type: 'error' });
                        return;
                    }
                    onLoginSuccess(userData);
                } else {
                    const errorText = await response.text();
                    setMessage({ text: errorText || `Login failed. Check credentials.`, type: 'error' });
                }
            } catch (error) {
                setMessage({ text: 'Could not connect to the server.', type: 'error' });
            }
        };

        const renderForm = () => {
            if (role === 'admin') {
                return <LoginForm onSubmit={handleLogin} role={role} />;
            }
        
            if (authType === 'login') {
                return <LoginForm onSubmit={handleLogin} role={role} />;
            }
            switch (role) {
                case 'patient': return <PatientRegistrationForm onSubmit={handleRegister} onSwitchToLogin={() => setAuthType('login')} />;
                case 'doctor': return <DoctorRegistrationForm onSubmit={handleRegister} onSwitchToLogin={() => setAuthType('login')} />;
                default: return null;
            }
        };

        const sidebarGradient = role === 'patient' 
            ? 'bg-gradient-to-br from-purple-600 to-green-600'
            : role === 'doctor'
            ? 'bg-gradient-to-br from-purple-600 to-yellow-500'
            : 'bg-brand-purple';
        
        return (
            <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-brand-bg to-brand-lavender/30">
                <main className="w-full max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl grid grid-cols-1 lg:grid-cols-2 overflow-hidden">
                    <div className={`hidden lg:flex flex-col justify-center p-12 ${sidebarGradient} text-white relative items-center text-center`}>
                        <i className={`fas ${role === 'patient' ? 'fa-user-injured' : role === 'doctor' ? 'fa-user-md' : 'fa-user-shield'} text-9xl mb-8`}></i>
                        <h1 className="text-4xl font-extrabold mb-4 capitalize">{role} Portal</h1>
                        <p className="text-indigo-100 text-lg">
                            {authType === 'login' ? 'Welcome back! Sign in to continue.' : 'Create your account to get started.'}
                        </p>
                    </div>
                    <div className="p-8 md:p-12">
                        <div className="flex items-center mb-8">
                            <button onClick={onBack} className="text-slate-500 hover:text-slate-800 mr-4">
                                <i className="fas fa-arrow-left"></i> Back
                            </button>
                            {role === 'admin' ? (
                                <div className="text-center w-full">
                                     <h2 className="text-2xl font-semibold text-slate-700">Sign In</h2>
                                </div>
                            ) : (
                                <div className="bg-slate-100 p-1 rounded-full flex">
                                    <button onClick={() => setAuthType('register')} className={`px-6 py-2 rounded-full font-semibold ${authType === 'register' ? 'bg-white text-brand-purple shadow' : 'text-slate-500'}`}>Create Account</button>
                                    <button onClick={() => setAuthType('login')} className={`px-6 py-2 rounded-full font-semibold ${authType === 'login' ? 'bg-white text-brand-purple shadow' : 'text-slate-500'}`}>Sign In</button>
                                </div>
                            )}

                        </div>
                        {message.text && (
                            <div className={`p-4 mb-6 rounded-lg text-center ${
                                message.type === 'success' ? 'bg-green-100 text-green-800' :
                                    message.type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'
                            }`}>{message.text}</div>
                        )}
                        {renderForm()}
                    </div>
                </main>
            </div>
        );
    };
    const PatientRegistrationForm = ({ onSubmit, onSwitchToLogin }) => {
        const handleFormSubmit = (e) => {
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            onSubmit(e, data);
        };
        return (
            <form onSubmit={handleFormSubmit} className="space-y-6">
                <h2 className="text-2xl font-semibold text-slate-700 text-center">Patient Registration</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <InputField id="email" label="Email Address" type="email" required placeholder="you@example.com" />
                    <InputField id="password" label="Password" type="password" required placeholder="••••••••" />
                    <InputField id="firstName" label="First Name" required placeholder="John" />
                    <InputField id="lastName" label="Last Name" required placeholder="Doe" />
                    <InputField id="dateOfBirth" label="Date of Birth" type="date" required />
                    <InputField id="phone" label="Phone Number" type="tel" required placeholder="e.g., +91 1234567890" />
                    <InputField id="gender" label="Gender" placeholder="e.g., female"/>
                    <InputField id="bloodGroup" label="Blood Group" placeholder="e.g., O+"/>
                    <InputField id="emergencyContactName" label="Emergency Contact Name" placeholder="Jane Doe"/>
                    <InputField id="emergencyContactPhone" label="Emergency Contact Phone" type="tel" placeholder="e.g., +91 9876543210"/>
                    <div className="md:col-span-2">
                        <InputField id="address" label="Full Address" placeholder="123 Health St, Medville"/>
                    </div>
                    <InputField id="city" label="City" placeholder="Jamshedpur"/>
                    <InputField id="state" label="State" placeholder="Jharkhand"/>
                    <InputField id="country" label="Country" placeholder="India"/>
                    <InputField id="postalCode" label="Postal Code" placeholder="831011"/>
                    <div className="md:col-span-2">
                        <InputField id="profilePictureUrl" label="Profile Picture URL" placeholder="https://example.com/image.jpg"/>
                    </div>
                </div>
                <button type="submit" className="w-full bg-brand-purple text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300">Create Account</button>
                <p className="text-center text-sm text-slate-600 mt-4">
                    Already have an account? <button type="button" onClick={onSwitchToLogin} className="text-brand-purple font-semibold hover:underline">Sign in</button>
                </p>
            </form>
        );
    };
    const DoctorRegistrationForm = ({ onSubmit, onSwitchToLogin }) => {
        const handleFormSubmit = (e) => {
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            onSubmit(e, data);
        };
        return (
            <form onSubmit={handleFormSubmit} className="space-y-6">
                <h2 className="text-2xl font-semibold text-slate-700 text-center">Doctor Registration</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <InputField id="email" label="Email Address" type="email" required placeholder="dr.smith@hospital.com"/>
                    <InputField id="password" label="Password" type="password" required placeholder="••••••••" />
                    <InputField id="firstName" label="First Name" required placeholder="Jane"/>
                    <InputField id="lastName" label="Last Name" required placeholder="Smith"/>
                    <InputField id="specialization" label="Specialization" required placeholder="Cardiology"/>
                    <InputField id="licenseNumber" label="License Number" required placeholder="e.g., MED12345"/>
                    <InputField id="licenseExpiry" label="License Expiry" type="date"/>
                    <InputField id="qualification" label="Qualification" placeholder="MD, MBBS"/>
                    <InputField id="consultationFee" label="Consultation Fee (INR)" type="number" placeholder="e.g., 500"/>
                    <InputField id="experienceYears" label="Years of Experience" type="number" placeholder="10"/>
                    <InputField id="phone" label="Phone Number" type="tel" required placeholder="e.g., +91 1234567890"/>
                    <InputField id="hospitalAffiliation" label="Hospital Affiliation" placeholder="City General Hospital"/>
                    <div className="md:col-span-2">
                        <InputField id="address" label="Clinic Address" placeholder="123 Health St, Medville"/>
                    </div>
                    <InputField id="city" label="City" placeholder="Jamshedpur"/>
                    <InputField id="state" label="State" placeholder="Jharkhand"/>
                    <InputField id="country" label="Country" placeholder="India"/>
                    <InputField id="postalCode" label="Postal Code" placeholder="831011"/>
                    <div className="md:col-span-2">
                        <InputField id="profilePictureUrl" label="Profile Picture URL" placeholder="https://example.com/image.jpg"/>
                    </div>
                </div>
                <button type="submit" className="w-full bg-brand-purple text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300">Create Professional Account</button>
                <p className="text-center text-sm text-slate-600 mt-4">
                    Already have an account? <button type="button" onClick={onSwitchToLogin} className="text-brand-purple font-semibold hover:underline">Sign in</button>
                </p>
            </form>
        );
    };
    const InputField = ({ id, label, type = 'text', required = false, placeholder = '' }) => (
        <div>
            <label htmlFor={id} className="block text-sm font-medium text-slate-600 mb-1">{label}{required && <span className="text-red-500">*</span>}</label>
            <input
                type={type}
                id={id}
                name={id}
                className="w-full px-4 py-2 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-purple"
                required={required}
                placeholder={placeholder}
            />
        </div>
    );
    const LoginForm = ({ onSubmit, role }) => {
        const handleFormSubmit = (e) => {
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            onSubmit(e, data);
        };
        return (
            <form onSubmit={handleFormSubmit} className="space-y-6">
                {role !== 'admin' && (
                     <h2 className="text-2xl font-semibold text-slate-700 text-center capitalize">{role} Sign In</h2>
                )}
                <div className="space-y-6">
                    <InputField id="email" label="Email Address" type="email" required placeholder="you@example.com"/>
                    <InputField id="password" label="Password" type="password" required placeholder="••••••••"/>
                </div>
                <button type="submit" className="w-full bg-brand-purple text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300">Sign In</button>
            </form>
        );
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
</script>
</body>
</html>