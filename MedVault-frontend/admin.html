<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedVault - Admin Portal</title>
    <link rel="icon" type="image/png" href="/medvault-logo.png" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        
        /* Dark Mode Variables */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        .dark body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .dark .admin-bg {
            background: #0f172a;
        }
        
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(51, 65, 85, 0.5);
        }
        
        .dark .bg-white {
            background: #1e293b !important;
        }
        
        /* Dark mode text colors - make everything visible */
        .dark .text-slate-900,
        .dark .text-slate-800,
        .dark .text-slate-700,
        .dark .text-slate-600 {
            color: #f1f5f9 !important;
        }
        
        .dark .text-slate-500 {
            color: #cbd5e1 !important;
        }
        
        .dark .text-slate-400 {
            color: #94a3b8 !important;
        }
        
        /* Dark mode for inputs, selects, textareas */
        .dark input,
        .dark select,
        .dark textarea {
            background: #1e293b !important;
            color: #f1f5f9 !important;
            border-color: #334155 !important;
        }
        
        .dark input::placeholder,
        .dark select::placeholder,
        .dark textarea::placeholder {
            color: #94a3b8 !important;
        }
        
        /* Dark mode for labels - FORCE visibility */
        .dark label,
        .dark label *,
        .dark label span,
        .dark label div {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for all text in settings cards */
        .dark .rounded-lg label,
        .dark .rounded-xl label,
        .dark .rounded-2xl label {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for colored text - make brighter */
        .dark .text-indigo-600,
        .dark .text-indigo-700 {
            color: #a5b4fc !important;
        }
        
        .dark .text-purple-600,
        .dark .text-purple-700 {
            color: #c4b5fd !important;
        }
        
        .dark .text-blue-600,
        .dark .text-blue-700 {
            color: #93c5fd !important;
        }
        
        .dark .text-teal-600,
        .dark .text-teal-700 {
            color: #5eead4 !important;
        }
        
        .dark .text-rose-600,
        .dark .text-rose-700 {
            color: #fda4af !important;
        }
        
        .dark .text-amber-600,
        .dark .text-amber-700 {
            color: #fcd34d !important;
        }
        
        .dark .text-emerald-600,
        .dark .text-emerald-700 {
            color: #6ee7b7 !important;
        }
        
        /* Dark mode for white text */
        .dark .text-white {
            color: #ffffff !important;
        }
        
        .dark .border-slate-100,
        .dark .border-slate-200 {
            border-color: #334155 !important;
        }
        
        .dark .bg-slate-50 {
            background: #1e293b !important;
        }
        
        .dark .hover\:bg-slate-50:hover {
            background: #334155 !important;
        }
        
        .dark .hover\:bg-slate-100:hover {
            background: #475569 !important;
        }
        
        /* Additional dark mode fixes for better visibility */
        .dark .bg-purple-50,
        .dark .bg-indigo-50,
        .dark .bg-blue-50,
        .dark .bg-teal-50,
        .dark .bg-emerald-50,
        .dark .bg-amber-50,
        .dark .bg-rose-50,
        .dark .bg-green-50,
        .dark .bg-yellow-50 {
            background: #334155 !important;
        }
        
        .dark .bg-gradient-to-r,
        .dark .bg-gradient-to-br {
            opacity: 0.9;
        }
        
        /* Dark mode for card backgrounds */
        .dark .rounded-xl,
        .dark .rounded-2xl {
            border-color: #475569 !important;
        }
        
        /* Dark mode for table headers */
        .dark thead {
            background: #1e293b !important;
        }
        
        .dark th {
            color: #94a3b8 !important;
        }
        
        .dark td {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for status badges - keep them visible */
        .dark .status-pending { background: #78350f !important; color: #fcd34d !important; }
        .dark .status-confirmed { background: #064e3b !important; color: #6ee7b7 !important; }
        .dark .status-verified { background: #064e3b !important; color: #6ee7b7 !important; }
        .dark .status-rejected { background: #7f1d1d !important; color: #fca5a5 !important; }
        .dark .status-cancelled { background: #7f1d1d !important; color: #fca5a5 !important; }
        .dark .status-completed { background: #1e3a5f !important; color: #93c5fd !important; }
        
        /* Dark mode for colored backgrounds in cards */
        .dark .border-l-purple-500,
        .dark .border-l-indigo-500,
        .dark .border-l-blue-500,
        .dark .border-l-teal-500,
        .dark .border-l-emerald-500,
        .dark .border-l-amber-500,
        .dark .border-l-rose-500 {
            border-left-width: 4px !important;
        }
        
        /* Dark mode for modal backgrounds */
        .dark .modal-content,
        .dark [class*="modal"] {
            background: #1e293b !important;
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for dropdown/select options */
        .dark option {
            background: #1e293b !important;
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for hover states on buttons */
        .dark .hover\:bg-indigo-100:hover,
        .dark .hover\:bg-purple-100:hover,
        .dark .hover\:bg-rose-100:hover {
            background: #475569 !important;
        }
        
        /* Dark mode for text in colored backgrounds */
        .dark .text-indigo-600,
        .dark .text-purple-600,
        .dark .text-blue-600,
        .dark .text-teal-600,
        .dark .text-emerald-600,
        .dark .text-amber-600,
        .dark .text-rose-600,
        .dark .text-green-600 {
            filter: brightness(1.3);
        }
        
        /* Dark mode for detail view text */
        .dark h1, .dark h2, .dark h3, .dark h4, .dark h5, .dark h6 {
            color: #f1f5f9 !important;
        }
        
        .dark p {
            color: #e2e8f0 !important;
        }
        
        .dark span {
            color: #e2e8f0 !important;
        }
        
        /* Dark mode for Quick Actions section - FORCE all text visible */
        .dark .from-purple-50,
        .dark .to-indigo-50,
        .dark .bg-gradient-to-r.from-purple-50,
        .dark .bg-gradient-to-r.to-indigo-50 {
            background: #334155 !important;
        }
        
        .dark .from-purple-50 *,
        .dark .to-indigo-50 *,
        .dark .bg-gradient-to-r.from-purple-50 *,
        .dark .bg-gradient-to-r.to-indigo-50 * {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for System Settings - FORCE all text visible */
        .dark .bg-gradient-to-r {
            background: linear-gradient(to right, #334155, #475569) !important;
        }
        
        .dark .bg-gradient-to-r * {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for all card backgrounds with gradients */
        .dark [class*="from-purple"],
        .dark [class*="from-indigo"],
        .dark [class*="from-blue"],
        .dark [class*="from-slate"] {
            background: #334155 !important;
        }
        
        /* Dark mode for buttons in colored backgrounds */
        .dark .from-purple-50 button,
        .dark .to-indigo-50 button,
        .dark .bg-gradient-to-r button {
            background: #475569 !important;
            color: #f1f5f9 !important;
            border-color: #64748b !important;
        }
        
        .dark .from-purple-50 button:hover,
        .dark .to-indigo-50 button:hover,
        .dark .bg-gradient-to-r button:hover {
            background: #64748b !important;
        }
        
        .dark .bg-white button {
            background: #475569 !important;
            color: #f1f5f9 !important;
        }
        
        .dark .bg-white button:hover {
            background: #64748b !important;
        }
        
        /* Dark mode for divs inside colored backgrounds */
        .dark .from-purple-50 div,
        .dark .to-indigo-50 div,
        .dark .bg-gradient-to-r div {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for specific detail sections */
        .dark .bg-purple-50 p,
        .dark .bg-indigo-50 p,
        .dark .bg-blue-50 p,
        .dark .bg-teal-50 p,
        .dark .bg-emerald-50 p,
        .dark .bg-amber-50 p,
        .dark .bg-rose-50 p,
        .dark .bg-orange-50 p,
        .dark .bg-yellow-50 p {
            color: #f1f5f9 !important;
        }
        
        /* Dark mode for card content */
        .dark .rounded-lg p,
        .dark .rounded-xl p {
            color: #e2e8f0 !important;
        }
        
        /* Dark mode for font-bold and font-semibold text */
        .dark .font-bold,
        .dark .font-semibold {
            color: #f8fafc !important;
        }
        
        /* Dark mode for gradient text - make visible */
        .dark .bg-clip-text {
            -webkit-background-clip: text !important;
            background-clip: text !important;
        }
        
        /* Dark mode for detail view backgrounds */
        .dark .bg-gradient-to-b,
        .dark .bg-gradient-to-br {
            background: linear-gradient(to bottom right, #1e293b, #334155) !important;
        }
        
        /* Dark mode for sidebar in detail view */
        .dark .from-purple-600 {
            --tw-gradient-from: #7c3aed !important;
        }
        
        .dark .to-indigo-700 {
            --tw-gradient-to: #4338ca !important;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #eef2ff; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f46e5; }
        
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Sidebar scrollbar - thin white/purple, always visible */
        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 2px;
            transition: background 0.3s;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.7);
        }
        /* Horizontal scrollbar */
        .sidebar-scroll::-webkit-scrollbar:horizontal {
            height: 4px;
        }

        /* Clean light background */
        .admin-bg {
            background: #f8fafc;
            min-height: 100vh;
        }
        
        /* Login page gradient - original */
        .login-page-bg {
            background: linear-gradient(135deg, #e0e7ff 0%, #f0e8f7 100%);
        }
        
        /* Glassmorphism effect for content */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* Sidebar with login page gradient */
        .sidebar-glass {
            background: linear-gradient(135deg, #7c3aed 0%, #10b981 50%, #fbbf24 100%);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Header with login page gradient */
        .header-glass {
            background: linear-gradient(135deg, #7c3aed 0%, #10b981 50%, #fbbf24 100%);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Status badges */
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #d1fae5; color: #065f46; }
        .status-verified { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        
        /* Sidebar transition */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="admin-bg">
<div id="root"></div>
<!-- React Application -->
<script type="text/babel" data-type="module">
    import * as LucideReact from "https://esm.sh/lucide-react@0.263.1";
    const { useState, useEffect, useMemo } = React;

    const Icon = ({ name, size = 20, className = "" }) => {
        const LucideIcon = LucideReact[name];
        return LucideIcon ? <LucideIcon size={size} className={className} /> : null;
    };

    const fetchAdminProfile = async (email = null) => {
        try {
            // Use provided email or try to get from localStorage or use your admin email
            const adminEmail = email || localStorage.getItem('adminEmail') || 'mahesh123qr@gmail.com';
            console.log('ðŸ” Fetching admin profile for:', adminEmail);
            
            const response = await fetch(`${API_BASE_URL}/admin/profile/email/${encodeURIComponent(adminEmail)}`);
            console.log('ðŸ“¡ Response status:', response.status);
            
            if (response.ok) {
                const adminData = await response.json();
                console.log('âœ… Admin profile loaded:', adminData);
                
                // Store email for future use
                localStorage.setItem('adminEmail', adminData.email);
                
                return {
                    uid: adminData.userId || adminData.adminId || adminData.id, // Use userId for notifications
                    adminId: adminData.adminId,
                    userId: adminData.userId, // Store userId separately
                    displayName: adminData.name || `${adminData.firstName || ''} ${adminData.lastName || ''}`.trim(),
                    name: adminData.name || `${adminData.firstName || ''} ${adminData.lastName || ''}`.trim(),
                    firstName: adminData.firstName,
                    lastName: adminData.lastName,
                    email: adminData.email,
                    phone: adminData.phone,
                    department: adminData.department,
                    photoURL: adminData.profilePictureUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(adminData.firstName || 'Admin')}+${encodeURIComponent(adminData.lastName || '')}&background=6366f1&color=fff&size=200`,
                    role: 'admin'
                };
            } else {
                const errorData = await response.json().catch(() => ({}));
                console.error('âŒ Admin profile not found:', errorData);
                console.log('ðŸ’¡ Trying fallback admin email...');
                
                // Try fallback email
                if (adminEmail !== 'mahesh123qr@gmail.com') {
                    return await fetchAdminProfile('mahesh123qr@gmail.com');
                }
                
                throw new Error('Admin profile not found');
            }
        } catch (error) {
            console.error('âŒ Error fetching admin profile:', error);
            throw error;
        }
    };

    // 1. Login Component
    function Login({ onLogin }) {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setError('');
            setLoading(true);
            
            try {
                // Call backend to authenticate admin
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    // Check if user is admin
                    if (userData.role && userData.role.toUpperCase() === 'ADMIN') {
                        localStorage.setItem('adminEmail', email);
                        onLogin('admin', email);
                    } else {
                        setError('Access denied. Only administrators can login here.');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    setError(errorData.message || 'Invalid email or password');
                }
            } catch (err) {
                console.error('Login error:', err);
                setError('Unable to connect to server. Please try again.');
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-4 login-page-bg">
                <div className="w-full max-w-5xl flex flex-col md:flex-row rounded-3xl overflow-hidden shadow-2xl animate-fadeIn">
                        {/* Left Side - Gradient with branding */}
                        <div className="md:w-5/12 p-12 text-white flex flex-col justify-between relative overflow-hidden" style={{ background: 'linear-gradient(135deg, #7c3aed 0%, #10b981 50%, #fbbf24 100%)' }}>
                            <div className="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/medical-icons.png')]"></div>
                            <div className="relative z-10">
                                <button onClick={() => window.location.href = '/'} className="flex items-center gap-2 text-white/90 hover:text-white transition-colors mb-12">
                                    <Icon name="ArrowLeft" size={18} /> Back to Home
                                </button>
                                
                                <div className="w-20 h-20 bg-white/20 backdrop-blur-md rounded-3xl flex items-center justify-center mb-6">
                                    <Icon name="ShieldCheck" size={40} className="text-white" />
                                </div>
                                <h2 className="text-4xl font-bold mb-3">Admin Portal</h2>
                                <p className="text-white/90 text-lg">Welcome back, Administrator.<br/>Please sign in to continue.</p>
                            </div>
                        </div>

                        {/* Right Side - Login Form */}
                        <div className="md:w-7/12 p-12 bg-white flex flex-col justify-center">
                            <h3 className="text-3xl font-bold text-slate-900 mb-8">Sign In</h3>
                            {error && (
                                <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm">
                                    <Icon name="AlertCircle" size={16} className="inline mr-2" />
                                    {error}
                                </div>
                            )}
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Email Address</label>
                                    <div className="relative">
                                        <Icon name="Mail" size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                                        <input
                                            type="email"
                                            required
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            className="w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all outline-none"
                                            placeholder="admin@medvault.co"
                                            disabled={loading}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-2">Password</label>
                                    <div className="relative">
                                        <Icon name="Lock" size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                                        <input
                                            type="password"
                                            required
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all outline-none"
                                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                            disabled={loading}
                                        />
                                    </div>
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-medium py-4 px-4 rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    {loading ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            Signing in...
                                        </>
                                    ) : (
                                        <>
                                            <Icon name="LogIn" size={20} />
                                            Access Dashboard
                                        </>
                                    )}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
        );
    }

    // 2. Stats Card Component - Clean Design with Left Border
    function StatsCard({ title, value, icon, color }) {
        const colorSchemes = {
            indigo: { icon: 'text-indigo-500', bg: 'bg-indigo-50', border: 'border-l-indigo-500' },
            teal: { icon: 'text-teal-500', bg: 'bg-teal-50', border: 'border-l-teal-500' },
            blue: { icon: 'text-blue-500', bg: 'bg-blue-50', border: 'border-l-blue-500' },
            rose: { icon: 'text-rose-500', bg: 'bg-rose-50', border: 'border-l-rose-500' },
            purple: { icon: 'text-purple-500', bg: 'bg-purple-50', border: 'border-l-purple-500' },
            amber: { icon: 'text-amber-500', bg: 'bg-amber-50', border: 'border-l-amber-500' },
            emerald: { icon: 'text-emerald-500', bg: 'bg-emerald-50', border: 'border-l-emerald-500' },
        };

        const scheme = colorSchemes[color] || colorSchemes.blue;

        return (
            <div className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 p-6 border border-slate-100 border-l-4 ${scheme.border}`}>
                <div className="flex items-start justify-between">
                    <div>
                        <p className="text-slate-500 text-sm font-medium mb-2 whitespace-nowrap">{title}</p>
                        <p className="text-3xl font-bold text-slate-900">{value}</p>
                    </div>
                    <div className={`p-3 rounded-lg ${scheme.bg}`}>
                        <Icon name={icon} size={24} className={scheme.icon} />
                    </div>
                </div>
            </div>
        );
    }

    // API Configuration
    const API_BASE_URL = 'http://localhost:8080/api';

    // Helper function for safe API calls
    const safeFetch = async (url, options = {}) => {
        try {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`âŒ API Error [${response.status}] ${url}:`, errorText);
                return { success: false, status: response.status, error: errorText };
            }
            
            const data = await response.json();
            return { success: true, data };
        } catch (error) {
            console.error(`âŒ Network Error ${url}:`, error.message);
            return { success: false, error: error.message };
        }
    };

    // Helper function to get time-based greeting
    const getGreeting = () => {
        const hour = new Date().getHours();
        if (hour < 12) return 'Good Morning';
        if (hour < 18) return 'Good Afternoon';
        return 'Good Evening';
    };

    // 3. Main Admin Dashboard with Retractable Sidebar
    function AdminDashboard({ user, onLogout }) {
        const [activeView, setActiveView] = useState('dashboard');
        const [sidebarOpen, setSidebarOpen] = useState(false); // Default collapsed
        const [selectedItem, setSelectedItem] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [filterType, setFilterType] = useState('all');
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        
        // Invite Doctor Modal State
        const [showInviteDoctorModal, setShowInviteDoctorModal] = useState(false);
        const [inviteDoctorEmail, setInviteDoctorEmail] = useState('');
        const [inviteDoctorName, setInviteDoctorName] = useState('');
        
        // Document View Modal State
        const [showDocumentViewModal, setShowDocumentViewModal] = useState(false);
        const [selectedDocumentForView, setSelectedDocumentForView] = useState(null);
        
        // Settings State
        const [darkMode, setDarkMode] = useState(() => {
            const saved = localStorage.getItem('adminDarkMode');
            return saved === 'true';
        });
        const [emailNotifications, setEmailNotifications] = useState(() => {
            const saved = localStorage.getItem('emailNotifications');
            return saved !== 'false';
        });
        const [smsAlerts, setSmsAlerts] = useState(() => {
            const saved = localStorage.getItem('smsAlerts');
            return saved !== 'false';
        });
        const [emergencyAlerts, setEmergencyAlerts] = useState(() => {
            const saved = localStorage.getItem('emergencyAlerts');
            return saved !== 'false';
        });
        const [systemUpdates, setSystemUpdates] = useState(() => {
            const saved = localStorage.getItem('systemUpdates');
            return saved !== 'false';
        });
        const [autoRefresh, setAutoRefresh] = useState(() => {
            const saved = localStorage.getItem('autoRefresh');
            return saved === 'true';
        });
        const [compactView, setCompactView] = useState(() => {
            const saved = localStorage.getItem('compactView');
            return saved === 'true';
        });
        
        // Notification State
        const [notificationOpen, setNotificationOpen] = useState(false);
        const [notifications, setNotifications] = useState([]);
        const [unreadCount, setUnreadCount] = useState(0);
        
        // Apply dark mode
        useEffect(() => {
            if (darkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('adminDarkMode', 'true');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('adminDarkMode', 'false');
            }
        }, [darkMode]);
        
        // Fetch notifications
        useEffect(() => {
            const userId = user?.userId || user?.uid;
            if (userId) {
                fetchNotifications();
                // Refresh notifications every 5 seconds for real-time updates
                const interval = setInterval(fetchNotifications, 5000);
                return () => clearInterval(interval);
            }
        }, [user?.userId, user?.uid]);
        
        const fetchNotifications = async () => {
            const userId = user?.userId || user?.uid;
            if (!userId) return;
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/user/${userId}`);
                if (response.ok) {
                    const data = await response.json();
                    setNotifications(data);
                    setUnreadCount(data.length); // API returns only unread
                }
            } catch (error) {
                console.error('Error fetching notifications:', error);
            }
        };
        
        const handleNotificationClick = async (notification) => {
            try {
                await fetch(`${API_BASE_URL}/notifications/${notification.notificationId}/read`, {
                    method: 'PUT'
                });
                // Remove from list immediately
                setNotifications(prev => prev.filter(n => n.notificationId !== notification.notificationId));
                setUnreadCount(prev => Math.max(0, prev - 1));
                setNotificationOpen(false);
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        };
        
        const markAllNotificationsAsRead = async () => {
            const userId = user?.userId || user?.uid;
            if (!userId) return;
            try {
                await fetch(`${API_BASE_URL}/notifications/user/${userId}/read-all`, {
                    method: 'PUT'
                });
                setNotifications([]);
                setUnreadCount(0);
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        };
        
        const formatNotificationTime = (timestamp) => {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        };
        
        // Auto refresh data every 30 seconds if enabled
        useEffect(() => {
            if (autoRefresh) {
                const interval = setInterval(() => {
                    fetchAllData();
                }, 30000);
                return () => clearInterval(interval);
            }
        }, [autoRefresh]);

        // Data State
        const [stats, setStats] = useState({
            totalUsers: 0,
            totalPatients: 0,
            newPatients: 0,
            totalDoctors: 0,
            verifiedDoctors: 0,
            pendingDoctors: 0,
            appointmentsToday: 0,
            totalAppointments: 0,
            pendingAppointments: 0,
            completedAppointments: 0,
            emergencyRequests: 0,
            pendingDocuments: 0,
            verifiedDocuments: 0,
            activeUsers: 0
        });
        
        const [doctorsList, setDoctorsList] = useState([]);
        const [patientsList, setPatientsList] = useState([]);
        const [appointmentsList, setAppointmentsList] = useState([]);
        const [documentsList, setDocumentsList] = useState([]);
        const [emergencyList, setEmergencyList] = useState([]);
        const [qualificationsList, setQualificationsList] = useState([]);
        const [issuesList, setIssuesList] = useState([]);
        const [appointmentFilter, setAppointmentFilter] = useState('all');
        const [issuesFilter, setIssuesFilter] = useState('all');
        const [selectedIssueForReply, setSelectedIssueForReply] = useState(null);
        const [replyMessage, setReplyMessage] = useState('');
        const [replyStatus, setReplyStatus] = useState('');
        const [selectedPrescriptionForView, setSelectedPrescriptionForView] = useState(null);
        const [selectedRecordForView, setSelectedRecordForView] = useState(null);
        const [expandedMenu, setExpandedMenu] = useState(null);
        const [adminProfile, setAdminProfile] = useState(null);
        
        // Reschedule Modal State
        const [showRescheduleModal, setShowRescheduleModal] = useState(false);
        const [selectedAppointmentForReschedule, setSelectedAppointmentForReschedule] = useState(null);
        const [rescheduleDate, setRescheduleDate] = useState('');
        const [rescheduleTime, setRescheduleTime] = useState('');
        const [rescheduleSlotId, setRescheduleSlotId] = useState(null); // Track selected slot ID for rescheduling
        const [availableSlotsForReschedule, setAvailableSlotsForReschedule] = useState([]);
        const [allDoctorSlots, setAllDoctorSlots] = useState([]); // All slots including booked ones
        const [allDoctorSlotsIncludingBooked, setAllDoctorSlotsIncludingBooked] = useState([]); // For checking if date has any slots

        // Fetch admin profile
        useEffect(() => {
            const fetchAdminProfile = async () => {
                if (user?.email) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/admin/profile/email/${encodeURIComponent(user.email)}`);
                        if (response.ok) {
                            const profile = await response.json();
                            setAdminProfile(profile);
                        }
                    } catch (error) {
                        console.error('Error fetching admin profile:', error);
                    }
                }
            };
            fetchAdminProfile();
        }, [user?.email]);

        // Fetch all data from backend
        useEffect(() => {
            fetchAllData();
        }, []);

        const fetchAllData = async () => {
            setLoading(true);
            setError(null);
            
            // Helper to calculate age from dateOfBirth
            const calculateAge = (dob) => {
                if (!dob) return 'N/A';
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            };
            
            try {
                // Fetch doctors from /api/admin/doctors
                const doctorsResult = await safeFetch(`${API_BASE_URL}/admin/doctors`);
                let formattedDoctors = [];
                
                if (doctorsResult.success) {
                    let doctorsArray = doctorsResult.data;
                    if (!Array.isArray(doctorsArray)) {
                        if (doctorsArray.doctors) doctorsArray = doctorsArray.doctors;
                        else if (doctorsArray.data) doctorsArray = doctorsArray.data;
                        else if (doctorsArray.results) doctorsArray = doctorsArray.results;
                    }
                    
                    if (Array.isArray(doctorsArray)) {
                        formattedDoctors = await Promise.all(doctorsArray.map(async (d) => {
                            // Map name using firstName + lastName like index.html
                            const doctorId = d.professionalId || d.doctorId || d.id;
                            const doctorName = d.name || `Dr. ${d.firstName || ''} ${d.lastName || ''}`.trim();
                            
                            // Fetch reviews for each doctor to calculate rating
                            let rating = d.averageRating || d.rating || 0;
                            let reviewCount = d.reviewCount || d.totalReviews || 0;
                            
                            try {
                                const reviewsRes = await fetch(`${API_BASE_URL}/reviews/doctor/${doctorId}`);
                                if (reviewsRes.ok) {
                                    const reviews = await reviewsRes.json();
                                    if (reviews.length > 0) {
                                        const totalRating = reviews.reduce((sum, r) => sum + (r.rating || 0), 0);
                                        rating = (totalRating / reviews.length).toFixed(1);
                                        reviewCount = reviews.length;
                                    }
                                }
                            } catch (e) {
                                // Fallback: use data from doctor object
                            }
                            
                            return {
                                id: doctorId,
                                name: doctorName,
                                email: d.email || d.user?.email || 'N/A',
                                specialization: d.specialization || 'General',
                                joinedDate: d.dateJoined ? new Date(d.dateJoined).toLocaleDateString() : 'N/A',
                                isVerified: d.isVerified || d.verified || false,
                                qualifications: d.qualification || d.qualifications || 'MBBS, MD',
                                license: d.licenseNumber || d.professionalId || d.id,
                                phone: d.phone || d.phoneNumber || d.user?.phone || 'N/A',
                                experienceYears: d.experienceYears || d.experience || 0,
                                consultationFee: d.consultationFee || d.fee || 500,
                                rating: rating,
                                averageRating: rating,
                                reviewCount: reviewCount,
                                totalReviews: reviewCount,
                                address: d.address || 'N/A',
                                city: d.city || 'N/A',
                                state: d.state || 'N/A',
                                hospitalAffiliation: d.hospitalAffiliation || 'N/A',
                                appointments: { upcoming: 0, pending: 0, emergency: 0 }
                            };
                        }));
                        setDoctorsList(formattedDoctors);
                    }
                }

                // Fetch patients from /api/admin/patients
                const patientsResult = await safeFetch(`${API_BASE_URL}/admin/patients`);
                let formattedPatients = [];
                
                if (patientsResult.success) {
                    let patientsArray = patientsResult.data;
                    if (!Array.isArray(patientsArray)) {
                        if (patientsArray.patients) patientsArray = patientsArray.patients;
                        else if (patientsArray.data) patientsArray = patientsArray.data;
                        else if (patientsArray.results) patientsArray = patientsArray.results;
                    }
                    
                    if (Array.isArray(patientsArray)) {
                        // Map patients using firstName + lastName and calculate age from dateOfBirth (like index.html)
                        formattedPatients = patientsArray.map(p => {
                            const patientName = p.name || `${p.firstName || ''} ${p.lastName || ''}`.trim();
                            // Calculate age from dateOfBirth like index.html
                            const patientAge = p.age || (p.dateOfBirth ? calculateAge(p.dateOfBirth) : 'N/A');
                            
                            return {
                                id: p.patientId || p.id,
                                name: patientName,
                                email: p.email,
                                joinedDate: p.dateJoined || p.createdAt ? new Date(p.dateJoined || p.createdAt).toLocaleDateString() : 'N/A',
                                age: patientAge,
                                gender: p.gender || 'N/A',
                                dateOfBirth: p.dateOfBirth ? new Date(p.dateOfBirth).toLocaleDateString() : 'N/A',
                                bloodGroup: p.bloodGroup || p.bloodType || 'N/A',
                                phone: p.phone || p.phoneNumber || 'N/A',
                                address: p.address || 'N/A',
                                city: p.city || 'N/A',
                                state: p.state || 'N/A',
                                postalCode: p.postalCode || 'N/A',
                                emergencyContactName: p.emergencyContactName || 'N/A',
                                emergencyContactPhone: p.emergencyContactPhone || 'N/A',
                                lastVisit: p.lastVisit ? new Date(p.lastVisit).toLocaleDateString() : 'N/A',
                                status: p.status || p.isActive ? 'active' : 'inactive',
                                // Include stats from backend
                                totalAppointments: p.totalAppointments || 0,
                                completedAppointments: p.completedAppointments || 0,
                                upcomingAppointments: p.upcomingAppointments || 0,
                                totalRecords: p.totalRecords || 0,
                                totalConditions: p.totalConditions || 0
                            };
                        });
                        setPatientsList(formattedPatients);
                        console.log('âœ… Patients loaded with stats:', formattedPatients.length, 'patients');
                    }
                }

                // Fetch appointments from /api/admin/appointments
                const appointmentsResult = await safeFetch(`${API_BASE_URL}/admin/appointments`);
                let formattedAppointments = [];
                
                if (appointmentsResult.success) {
                    let appointmentsArray = appointmentsResult.data;
                    if (!Array.isArray(appointmentsArray)) {
                        if (appointmentsArray.appointments) appointmentsArray = appointmentsArray.appointments;
                        else if (appointmentsArray.data) appointmentsArray = appointmentsArray.data;
                        else if (appointmentsArray.results) appointmentsArray = appointmentsArray.results;
                    }
                    
                    if (Array.isArray(appointmentsArray)) {
                        formattedAppointments = appointmentsArray.map(a => {
                            const doctorId = a.doctor?.professionalId || a.doctor?.id || a.doctorId;
                            return {
                                id: a.appointmentId || a.id,
                                patientName: a.patientName || (a.patient ? `${a.patient.firstName || ''} ${a.patient.lastName || ''}`.trim() : 'N/A'),
                                doctorName: a.doctorName || (a.doctor ? `Dr. ${a.doctor.firstName || ''} ${a.doctor.lastName || ''}`.trim() : 'N/A'),
                                doctorId: doctorId,
                                date: a.appointmentDate || a.appointmentDateTime || a.date ? new Date(a.appointmentDate || a.appointmentDateTime || a.date).toLocaleDateString() : 'N/A',
                                time: a.appointmentTime || a.time || (a.appointmentDateTime ? new Date(a.appointmentDateTime).toLocaleTimeString() : 'N/A'),
                                status: (a.status || 'pending').toLowerCase(),
                                type: a.type || a.appointmentType || 'REGULAR',
                                reason: a.reason || 'Regular Checkup',
                                consultationFee: a.consultationFee || (a.doctor ? a.doctor.consultationFee : null) || 500,
                                feedback: a.feedback || null,
                                rating: a.rating || null
                            };
                        });
                        setAppointmentsList(formattedAppointments);
                    }
                }

                // Fetch emergency requests from /api/admin/emergency-requests
                const emergencyResult = await safeFetch(`${API_BASE_URL}/admin/emergency-requests`);
                let formattedEmergencyList = [];
                
                if (emergencyResult.success) {
                    let emergencyArray = emergencyResult.data;
                    if (!Array.isArray(emergencyArray)) {
                        if (emergencyArray.emergencies) emergencyArray = emergencyArray.emergencies;
                        else if (emergencyArray.data) emergencyArray = emergencyArray.data;
                        else if (emergencyArray.results) emergencyArray = emergencyArray.results;
                    }
                    
                    if (Array.isArray(emergencyArray)) {
                        const formattedEmergency = emergencyArray.map(e => ({
                            id: e.requestId || e.emergencyId || e.id,
                            patientName: e.patientName || (e.patient ? `${e.patient.firstName || ''} ${e.patient.lastName || ''}`.trim() : 'N/A'),
                            doctorName: e.doctorName || (e.doctor ? `Dr. ${e.doctor.firstName || ''} ${e.doctor.lastName || ''}`.trim() : 'N/A'),
                            doctorId: e.doctorId || (e.doctor ? e.doctor.professionalId : null),
                            requestTime: e.requestDateTime || e.requestTime || e.createdAt ? new Date(e.requestDateTime || e.requestTime || e.createdAt).toLocaleString() : 'N/A',
                            requestDateTime: e.requestDateTime || e.requestTime || e.createdAt,
                            severity: e.severity || e.urgencyLevel || 'medium',
                            status: e.status || 'active',
                            reason: e.reason || e.conditionDescription || e.description || 'N/A',
                            patientAddress: e.patientAddress || e.currentLocation || (e.patient ? `${e.patient.address || ''}, ${e.patient.city || ''}, ${e.patient.state || ''}`.trim() : 'N/A'),
                            consultationFee: e.consultationFee,
                            feedback: e.feedback || null,
                            rating: e.rating || null
                        }));
                        formattedEmergencyList = formattedEmergency;
                        setEmergencyList(formattedEmergency);
                        
                        // NOTE: Emergency appointments are now included in /api/admin/appointments endpoint
                        // No need to add them separately here to avoid duplicates
                    }
                }

                // Fetch qualifications for document verification
                const qualificationsResult = await safeFetch(`${API_BASE_URL}/admin/qualifications/all`);
                let formattedDocs = [];
                
                try {
                    if (qualificationsResult.success) {
                        let qualificationsArray = qualificationsResult.data;
                        if (!Array.isArray(qualificationsArray)) {
                            if (qualificationsArray.qualifications) qualificationsArray = qualificationsArray.qualifications;
                            else if (qualificationsArray.data) qualificationsArray = qualificationsArray.data;
                        }
                        
                        if (Array.isArray(qualificationsArray) && qualificationsArray.length > 0) {
                            console.log('ðŸ“‹ Qualifications received:', qualificationsArray);
                            setQualificationsList(qualificationsArray);
                            
                            // Also populate documentsList for the documents view
                            // Each qualification is a separate document entry - show ALL uploads
                            formattedDocs = qualificationsArray.map(q => {
                                const uploadDate = q.uploadedAt || q.createdAt || q.uploadDate;
                                // Get doctor name - backend returns it directly as doctorName
                                const doctorName = q.doctorName || 
                                    (q.doctor ? `Dr. ${q.doctor.firstName || ''} ${q.doctor.lastName || ''}`.trim() : null) ||
                                    'Unknown Doctor';
                                
                                // Check if verified - backend returns APPROVED status
                                const isVerified = q.isVerified || q.verified || q.verificationStatus === 'APPROVED';
                                
                                return {
                                    id: q.qualificationId || q.id,
                                    doctorId: q.doctorId || q.doctor?.professionalId,
                                    doctorName: doctorName,
                                    doctorEmail: q.doctorEmail || q.doctor?.email || 'N/A',
                                    specialization: q.specialization || q.doctor?.specialization || 'N/A',
                                    documentType: q.documentType || q.qualificationType || q.type || 'Certificate',
                                    documentName: q.documentName || q.degreeName || q.name || 'Qualification Document',
                                    uploadedDate: uploadDate ? new Date(uploadDate).toLocaleDateString() : 'N/A',
                                    status: isVerified ? 'verified' : 'pending',
                                    isVerified: isVerified,
                                    documentPath: q.documentPath || q.filePath || q.fileUrl,
                                    verificationStatus: q.verificationStatus || (isVerified ? 'APPROVED' : 'PENDING')
                                };
                            });
                            setDocumentsList(formattedDocs);
                            setQualificationsList(qualificationsArray);
                        } else {
                            // Fallback: Generate documents list from unverified doctors
                            formattedDocs = formattedDoctors.filter(d => !d.isVerified).map(d => ({
                                id: d.id,
                                doctorId: d.id,
                                doctorName: d.name,
                                documentType: 'License',
                                documentName: 'Professional License',
                                uploadedDate: new Date().toLocaleDateString(),
                                status: 'pending',
                                isVerified: false,
                                documentPath: null
                            }));
                            setDocumentsList(formattedDocs);
                        }
                    } else {
                        // Fallback: Generate documents list from unverified doctors
                        formattedDocs = formattedDoctors.filter(d => !d.isVerified).map(d => ({
                            id: d.id,
                            doctorId: d.id,
                            doctorName: d.name,
                            documentType: 'License',
                            documentName: 'Professional License',
                            uploadedDate: new Date().toLocaleDateString(),
                            status: 'pending',
                            isVerified: false,
                            documentPath: null
                        }));
                        setDocumentsList(formattedDocs);
                    }
                } catch (e) {
                    console.log('â„¹ï¸ Qualifications endpoint not available, using fallback');
                    // Fallback: Generate documents list from unverified doctors
                    formattedDocs = formattedDoctors.filter(d => !d.isVerified).map(d => ({
                        id: d.id,
                        doctorId: d.id,
                        doctorName: d.name,
                        documentType: 'License',
                        documentName: 'Professional License',
                        uploadedDate: new Date().toLocaleDateString(),
                        status: 'pending',
                        isVerified: false,
                        documentPath: null
                    }));
                    setDocumentsList(formattedDocs);
                }

                // Fetch issue reports
                const issuesResult = await safeFetch(`${API_BASE_URL}/admin/issues`);
                
                if (issuesResult.success) {
                    let issuesArray = issuesResult.data;
                    if (!Array.isArray(issuesArray)) {
                        if (issuesArray.issues) issuesArray = issuesArray.issues;
                        else if (issuesArray.data) issuesArray = issuesArray.data;
                        else if (issuesArray.results) issuesArray = issuesArray.results;
                    }
                    
                    if (Array.isArray(issuesArray)) {
                        const formattedIssues = issuesArray.map(issue => ({
                            id: issue.issueId || issue.issue_id || issue.id,
                            name: issue.name || 'N/A',
                            email: issue.email || 'N/A',
                            phone: issue.phoneNumber || issue.phone_number || issue.phone || 'N/A',
                            message: issue.message || 'N/A',
                            subject: issue.subject || 'General Issue',
                            status: issue.status || 'pending',
                            adminMessage: issue.adminMessage || issue.admin_message || null,
                            userId: issue.userId || issue.user_id || null,
                            userType: issue.userType || issue.user_type || null,
                            createdAt: issue.createdAt || issue.created_at ? new Date(issue.createdAt || issue.created_at).toLocaleString() : 'N/A'
                        }));
                        setIssuesList(formattedIssues);
                    }
                }

                // Try to fetch stats from admin endpoint first
                const statsResult = await safeFetch(`${API_BASE_URL}/admin/stats`);
                
                if (statsResult.success) {
                    const statsData = statsResult.data;
                    setStats({
                        totalUsers: (statsData.totalPatients || 0) + (statsData.totalDoctors || 0),
                        totalPatients: statsData.totalPatients || formattedPatients.length,
                        newPatients: statsData.newPatients || 0,
                        totalDoctors: statsData.totalDoctors || formattedDoctors.length,
                        verifiedDoctors: statsData.verifiedDoctors || formattedDoctors.filter(d => d.isVerified).length,
                        pendingDoctors: statsData.pendingDoctors || formattedDoctors.filter(d => !d.isVerified).length,
                        appointmentsToday: statsData.appointmentsToday || 0,
                        totalAppointments: statsData.totalAppointments || formattedAppointments.length,
                        pendingAppointments: statsData.pendingAppointments || formattedAppointments.filter(a => a.status === 'pending').length,
                        completedAppointments: statsData.completedAppointments || formattedAppointments.filter(a => a.status === 'completed').length,
                        emergencyRequests: statsData.emergencyRequests || formattedEmergencyList.length,
                        pendingDocuments: statsData.pendingDocuments || formattedDocs.filter(d => !d.isVerified).length,
                        verifiedDocuments: statsData.verifiedDocuments || formattedDocs.filter(d => d.isVerified).length,
                        activeUsers: statsData.activeUsers || 0
                    });
                } else {
                    // Fallback: Calculate stats from the fetched arrays
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    const verifiedDoctorsCount = formattedDoctors.filter(d => d.isVerified).length;
                    const pendingDoctorsCount = formattedDoctors.filter(d => !d.isVerified).length;
                    const pendingAppointmentsCount = formattedAppointments.filter(a => a.status === 'pending').length;
                    const completedAppointmentsCount = formattedAppointments.filter(a => a.status === 'completed').length;
                    const appointmentsTodayCount = formattedAppointments.filter(a => {
                        const aptDate = new Date(a.date);
                        return aptDate >= today && aptDate < tomorrow;
                    }).length;
                    const activeEmergenciesCount = formattedEmergencyList.filter(e => {
                        if (e.status === 'COMPLETED') return false;
                        if (e.status === 'PENDING') return true;
                        const emergencyDate = new Date(e.requestDateTime);
                        const now = new Date();
                        const oneHourAfterAppointment = new Date(emergencyDate.getTime() + (60 * 60 * 1000));
                        return emergencyDate > now || now < oneHourAfterAppointment;
                    }).length;
                    const pendingDocsCount = formattedDocs.filter(d => !d.isVerified).length;
                    const verifiedDocsCount = formattedDocs.filter(d => d.isVerified).length;
                    
                    setStats({
                        totalUsers: formattedDoctors.length + formattedPatients.length,
                        totalPatients: formattedPatients.length,
                        newPatients: formattedPatients.length,
                        totalDoctors: formattedDoctors.length,
                        verifiedDoctors: verifiedDoctorsCount,
                        pendingDoctors: pendingDoctorsCount,
                        appointmentsToday: appointmentsTodayCount,
                        totalAppointments: formattedAppointments.length,
                        pendingAppointments: pendingAppointmentsCount,
                        completedAppointments: completedAppointmentsCount,
                        emergencyRequests: activeEmergenciesCount,
                        pendingDocuments: pendingDocsCount,
                        verifiedDocuments: verifiedDocsCount,
                        activeUsers: formattedPatients.length + formattedDoctors.length
                    });
                }

            } catch (error) {
                console.error('âŒ Data fetch error:', error.message);
                setError('Failed to load data. Please ensure backend is running on http://localhost:8080');
            } finally {
                setLoading(false);
            }
        };

        const handleVerifyDoctor = async (doctorId) => {
            try {
                console.log('ðŸ”„ Verifying doctor:', doctorId);
                const response = await fetch(`${API_BASE_URL}/admin/doctors/${doctorId}/verify`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    console.log('âœ… Doctor verified successfully');
                    alert('Doctor verified successfully! The doctor will see this update in their dashboard.');
                    // Refresh all data to get updated status
                    await fetchAllData();
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Verification failed:', errorText);
                    alert('Failed to verify doctor. Please try again.');
                }
            } catch (error) {
                console.error('âŒ Error verifying doctor:', error);
                alert('Failed to verify doctor. Please try again.');
            }
        };

        // Handle issue reply submission
        const handleIssueReply = async () => {
            if (!selectedIssueForReply || !replyMessage.trim()) {
                alert('Please enter a reply message');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/issues/${selectedIssueForReply.id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        status: 'resolved',
                        adminMessage: replyMessage 
                    })
                });
                
                if (response.ok) {
                    alert('âœ… Reply sent and issue resolved successfully!');
                    setSelectedIssueForReply(null);
                    setReplyMessage('');
                    setReplyStatus('');
                    await fetchAllData();
                } else {
                    const errorText = await response.text();
                    console.error('âŒ Reply failed:', errorText);
                    alert('Failed to send reply. Please try again.');
                }
            } catch (error) {
                console.error('âŒ Error sending reply:', error);
                alert('Failed to send reply. Please try again.');
            }
        };

        const [detailData, setDetailData] = useState(null);
        const [activeTab, setActiveTab] = useState('profile');
        const [navigationHistory, setNavigationHistory] = useState([]);

        // Auto-refresh slots when slots tab is active
        useEffect(() => {
            if (activeTab === 'slots' && selectedItem?.type === 'doctor' && selectedItem?.data?.doctorId) {
                const refreshInterval = setInterval(async () => {
                    const refreshedData = await fetchDoctorDetails(selectedItem.data.doctorId || selectedItem.data.id);
                    if (refreshedData) {
                        setSelectedItem({ type: 'doctor', data: refreshedData });
                    }
                }, 30000); // Refresh every 30 seconds
                
                return () => clearInterval(refreshInterval);
            }
        }, [activeTab, selectedItem?.type, selectedItem?.data?.doctorId]);

        // Fetch individual patient details using working endpoints
        const fetchPatientDetails = async (patientId) => {
            try {
                console.log('ðŸ”„ Fetching patient details for ID:', patientId);
                
                // Fetch basic patient data first
                const patientRes = await fetch(`${API_BASE_URL}/patients/${patientId}`);
                const data = patientRes.ok ? await patientRes.json() : null;
                
                if (!data) {
                    console.error('âŒ Failed to fetch patient details');
                    return null;
                }
                
                console.log('âœ… Patient details fetched:', data);
                
                // Try to fetch additional data using correct endpoints
                let conditions = [];
                let prescriptions = [];
                let records = [];
                
                try {
                    const conditionsRes = await fetch(`${API_BASE_URL}/medical-conditions/patient/${patientId}`);
                    if (conditionsRes.ok) conditions = await conditionsRes.json();
                } catch (e) { console.log('â„¹ï¸ Medical conditions endpoint not available'); }
                
                try {
                    const prescriptionsRes = await fetch(`${API_BASE_URL}/medications/patient/${patientId}`);
                    if (prescriptionsRes.ok) prescriptions = await prescriptionsRes.json();
                } catch (e) { console.log('â„¹ï¸ Prescriptions endpoint not available'); }
                
                try {
                    const recordsRes = await fetch(`${API_BASE_URL}/health-records/patient/${patientId}`);
                    if (recordsRes.ok) {
                        records = await recordsRes.json();
                    } else {
                        // Fallback to alternative endpoint
                        const altRecordsRes = await fetch(`${API_BASE_URL}/records/patient/${patientId}`);
                        if (altRecordsRes.ok) records = await altRecordsRes.json();
                    }
                } catch (e) { console.log('â„¹ï¸ Health records endpoint not available'); }
                
                // Calculate age from dateOfBirth
                const calculateAge = (dob) => {
                    if (!dob) return 'N/A';
                    const birthDate = new Date(dob);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    return age;
                };
                
                // Handle profile picture URL - convert relative paths to absolute
                let profilePicUrl = data.profilePictureUrl;
                if (profilePicUrl && !profilePicUrl.startsWith('http')) {
                    profilePicUrl = `http://localhost:8080/${profilePicUrl.startsWith('/') ? profilePicUrl.substring(1) : profilePicUrl}`;
                }
                if (!profilePicUrl) {
                    profilePicUrl = `https://ui-avatars.com/api/?name=${data.firstName}+${data.lastName}&background=7209B7&color=fff&size=200`;
                }
                
                return {
                    ...data,
                    age: calculateAge(data.dateOfBirth),
                    profilePictureUrl: profilePicUrl,
                    status: data.user?.isActive ? 'active' : 'inactive',
                    fullName: `${data.firstName} ${data.lastName}`,
                    medicalConditions: conditions,
                    prescriptions: prescriptions,
                    healthRecords: records
                };
            } catch (error) {
                console.error('âŒ Error fetching patient details:', error);
                return null;
            }
        };

        // Fetch individual doctor details using working endpoints
        const fetchDoctorDetails = async (doctorId) => {
            try {
                console.log('ðŸ”„ Fetching doctor details for ID:', doctorId);
                
                // Fetch basic doctor data first
                const doctorRes = await fetch(`${API_BASE_URL}/doctors/${doctorId}`);
                const data = doctorRes.ok ? await doctorRes.json() : null;
                
                if (!data) {
                    console.error('âŒ Failed to fetch doctor details');
                    return null;
                }
                
                console.log('âœ… Doctor details fetched:', data);
                
                // Try to fetch additional data using correct endpoints
                let slots = [];
                let qualifications = [];
                let prescriptions = [];
                let reviews = [];
                let averageRating = data.averageRating || 0;
                
                try {
                    const slotsRes = await fetch(`${API_BASE_URL}/slots/doctor/${doctorId}`);
                    if (slotsRes.ok) {
                        slots = await slotsRes.json();
                        console.log('âœ… Slots fetched:', slots);
                    }
                } catch (e) { console.log('â„¹ï¸ Slots endpoint not available'); }
                
                try {
                    const qualificationsRes = await fetch(`${API_BASE_URL}/qualifications/doctor/${doctorId}`);
                    if (qualificationsRes.ok) {
                        qualifications = await qualificationsRes.json();
                        console.log('âœ… Qualifications fetched:', qualifications);
                    }
                } catch (e) { console.log('â„¹ï¸ Qualifications endpoint not available'); }
                
                try {
                    // Fetch prescriptions uploaded by this doctor
                    const prescriptionsRes = await fetch(`${API_BASE_URL}/prescriptions/doctor/${doctorId}`);
                    if (prescriptionsRes.ok) {
                        prescriptions = await prescriptionsRes.json();
                        console.log('âœ… Prescriptions fetched:', prescriptions);
                    }
                } catch (e) { console.log('â„¹ï¸ Prescriptions endpoint not available'); }
                
                try {
                    // Fetch reviews from /api/reviews/doctor/{doctorId}
                    const reviewsRes = await fetch(`${API_BASE_URL}/reviews/doctor/${doctorId}`);
                    if (reviewsRes.ok) {
                        reviews = await reviewsRes.json();
                        console.log('âœ… Reviews fetched:', reviews);
                        
                        // Calculate average rating from reviews
                        if (reviews.length > 0) {
                            const totalRating = reviews.reduce((sum, r) => sum + (r.rating || 0), 0);
                            averageRating = (totalRating / reviews.length).toFixed(1);
                        }
                    } else {
                        // Fallback: try to get reviews from appointments
                        const appointmentsRes = await fetch(`${API_BASE_URL}/appointments/doctor/${doctorId}`);
                        if (appointmentsRes.ok) {
                            const appointments = await appointmentsRes.json();
                            reviews = appointments.filter(apt => apt.review && apt.rating).map(apt => ({
                                review: apt.review,
                                rating: apt.rating,
                                patientName: apt.patient ? `${apt.patient.firstName} ${apt.patient.lastName}` : 'Anonymous'
                            }));
                            
                            if (reviews.length > 0) {
                                const totalRating = reviews.reduce((sum, r) => sum + (r.rating || 0), 0);
                                averageRating = (totalRating / reviews.length).toFixed(1);
                            }
                        }
                    }
                } catch (e) { console.log('â„¹ï¸ Reviews endpoint not available'); }
                
                // Extract proper values with fallbacks
                const phone = data.phone || data.phoneNumber || data.user?.phone || 'N/A';
                const experience = data.experienceYears || data.experience || 0;
                const fee = data.consultationFee || data.fee || 500;
                
                // Handle profile picture URL - convert relative paths to absolute
                let profilePicUrl = data.profilePictureUrl;
                if (profilePicUrl && !profilePicUrl.startsWith('http')) {
                    profilePicUrl = `http://localhost:8080/${profilePicUrl.startsWith('/') ? profilePicUrl.substring(1) : profilePicUrl}`;
                }
                if (!profilePicUrl) {
                    profilePicUrl = `https://ui-avatars.com/api/?name=Dr+${data.firstName}+${data.lastName}&background=14B8A6&color=fff&size=200`;
                }
                
                return {
                    ...data,
                    profilePictureUrl: profilePicUrl,
                    fullName: `Dr. ${data.firstName} ${data.lastName}`,
                    isVerified: data.isVerified || data.verified || false,
                    phone: phone,
                    experienceYears: experience,
                    consultationFee: fee,
                    averageRating: averageRating,
                    reviewCount: reviews.length,
                    availableSlots: slots,
                    qualifications: qualifications,
                    uploadedPrescriptions: prescriptions,
                    patientReviews: reviews
                };
            } catch (error) {
                console.error('âŒ Error fetching doctor details:', error);
                return null;
            }
        };

        // Fetch individual appointment details using working endpoints
        const fetchAppointmentDetails = async (appointmentId) => {
            try {
                console.log('ðŸ”„ Fetching appointment details for ID:', appointmentId);
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Appointment details fetched:', data);
                    
                    return {
                        ...data,
                        appointmentDate: data.appointmentDateTime ? new Date(data.appointmentDateTime).toLocaleDateString() : 'N/A',
                        appointmentTime: data.appointmentDateTime ? new Date(data.appointmentDateTime).toLocaleTimeString() : 'N/A',
                        patientName: `${data.patient?.firstName} ${data.patient?.lastName}`,
                        doctorName: `Dr. ${data.doctor?.firstName} ${data.doctor?.lastName}`,
                        reason: data.reason || 'Regular checkup'
                    };
                } else {
                    console.error('âŒ Failed to fetch appointment details:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('âŒ Error fetching appointment details:', error);
                return null;
            }
        };

        // Handle view details with navigation history
        const handleViewDetails = async (type, data) => {
            // Save current state to history
            setNavigationHistory([...navigationHistory, { 
                view: activeView, 
                filters: { searchTerm, filterType, appointmentFilter } 
            }]);
            
            // Fetch detailed data based on type
            let detailedData = null;
            if (type === 'patient') {
                detailedData = await fetchPatientDetails(data.id);
            } else if (type === 'doctor') {
                detailedData = await fetchDoctorDetails(data.id);
            } else if (type === 'appointment') {
                detailedData = await fetchAppointmentDetails(data.id);
            }
            
            if (detailedData) {
                setDetailData(detailedData);
                setSelectedItem({ type, data: detailedData });
                setActiveTab('profile');
            } else {
                alert('Failed to load details. Please try again.');
            }
        };

        // Handle back navigation
        const handleBackNavigation = () => {
            if (navigationHistory.length > 0) {
                const lastState = navigationHistory[navigationHistory.length - 1];
                setActiveView(lastState.view);
                setSearchTerm(lastState.filters.searchTerm);
                setFilterType(lastState.filters.filterType);
                setAppointmentFilter(lastState.filters.appointmentFilter);
                setNavigationHistory(navigationHistory.slice(0, -1));
            }
            setSelectedItem(null);
            setDetailData(null);
            setActiveTab('profile');
        };

        const handleResolveEmergency = async (emergencyId) => {
            try {
                console.log('ðŸ”„ Sending reminder for emergency:', emergencyId);
                // Call the backend endpoint to send reminder notification to doctor
                const response = await fetch(`${API_BASE_URL}/admin/emergency-requests/${emergencyId}/remind`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    alert('âœ… Reminder notification sent to the assigned doctor successfully!');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    alert('âŒ Failed to send reminder: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('âŒ Error sending reminder:', error);
                alert('âŒ Failed to send reminder. Please try again.');
            }
        };

        const handleVerifyDocument = async (docId) => {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/doctors/qualifications/${docId}/verify`, {
                    method: 'PUT'
                });
                if (response.ok) {
                    setDocumentsList(prev => prev.map(d => d.id === docId ? { ...d, status: 'verified' } : d));
                    // Refresh data to update doctor verification status
                    fetchAllData();
                } else {
                    alert('Failed to verify document. Please try again.');
                }
            } catch (error) {
                console.error('Error verifying document:', error);
                alert('Failed to verify document. Please try again.');
            }
        };

        // --- Navigation Helper ---
        const NavItem = ({ icon, label, view, isSubItem = false }) => (
            <button
                onClick={() => setActiveView(view)}
                className={`w-full flex items-center gap-3 px-4 py-3 transition-colors rounded-r-full mr-4 text-sm font-medium font-sans
                    ${activeView === view
                        ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600'
                        : 'text-slate-600 hover:bg-slate-100 hover:text-indigo-600 border-l-4 border-transparent'
                    } ${isSubItem ? 'pl-12' : ''}`}
            >
                <Icon name={icon} size={isSubItem ? 18 : 20} className={activeView === view ? 'text-indigo-600' : 'text-slate-400'} />
                {label}
            </button>
        );

        const NavGroup = ({ icon, label, groupName, children }) => {
            const isExpanded = expandedMenu === groupName;
            return (
                <div className="mb-2">
                    <button
                        onClick={() => setExpandedMenu(isExpanded ? null : groupName)}
                        className={`w-full flex items-center justify-between px-4 py-3 text-slate-700 font-medium hover:bg-slate-50 transition-colors font-sans
                            ${isExpanded ? 'bg-slate-50' : ''}`}
                    >
                        <div className="flex items-center gap-3">
                            <Icon name={icon} size={20} className="text-indigo-500/80" />
                            {label}
                        </div>
                        <Icon name="ChevronDown" size={16} className={`transition-transform ${isExpanded ? 'rotate-180' : ''} text-slate-400`} />
                    </button>
                    <div className={`overflow-hidden transition-all ${isExpanded ? 'max-h-[500px] opacity-100' : 'max-h-0 opacity-0'}`}>
                        {children}
                    </div>
                </div>
            );
        };

        // --- Content Renderers ---
        const renderDashboardHome = () => {
            if (loading) {
                return (
                    <div className="flex items-center justify-center h-96">
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-slate-600 font-sans">Loading dashboard data...</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="space-y-8 animate-fadeIn">
                    {/* Error Banner */}
                    {error && (
                        <div className="glass-card rounded-xl p-4 border-l-4 border-rose-500 bg-rose-50/50">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Icon name="AlertCircle" size={24} className="text-rose-600" />
                                    <div>
                                        <h3 className="font-bold text-rose-900">Connection Error</h3>
                                        <p className="text-sm text-rose-700">{error}</p>
                                        <p className="text-xs text-rose-600 mt-1">Make sure the backend is running on http://localhost:8080</p>
                                    </div>
                                </div>
                                <button 
                                    onClick={fetchAllData}
                                    className="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition-colors">
                                    Retry
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Dashboard Header with Greeting - Purple Background */}
                    <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <img 
                                    src={user.photoURL || 'https://placehold.co/60x60/ffffff/6366f1?text=AD'} 
                                    alt={user.displayName}
                                    className="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover"
                                />
                                <div>
                                    <h1 className="text-3xl font-bold text-white font-sans">
                                        {getGreeting()}, {user.displayName || user.name || 'Admin'}!
                                    </h1>
                                    <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                        <Icon name="Mail" size={14} className="text-white/80" />
                                        {user.email || 'admin@medvault.com'}
                                    </p>
                                </div>
                            </div>
                            <button 
                                onClick={fetchAllData}
                                disabled={loading}
                                className="flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-md text-white rounded-lg hover:bg-white/30 transition-all font-sans disabled:opacity-50 disabled:cursor-not-allowed border border-white/30">
                                <Icon name="RefreshCw" size={18} className={loading ? 'animate-spin' : ''} />
                                {loading ? 'Loading...' : 'Refresh Data'}
                            </button>
                        </div>
                    </div>

                    {/* Stats Cards Grid - Primary Metrics */}
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 mb-4 font-sans flex items-center gap-2">
                            <Icon name="BarChart3" size={20} className="text-indigo-600" />
                            Primary Metrics
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                            <StatsCard title="Total Users" value={stats.totalUsers || (patientsList.length + doctorsList.length)} icon="Users" color="blue" />
                            <StatsCard title="Total Patients" value={stats.totalPatients || patientsList.length} icon="UserCheck" color="teal" />
                            <StatsCard title="Total Doctors" value={stats.totalDoctors || doctorsList.length} icon="Stethoscope" color="indigo" />
                            <StatsCard title="Total Appointments" value={stats.totalAppointments || appointmentsList.length} icon="CalendarCheck" color="purple" />
                            <StatsCard title="Active Emergencies" value={emergencyList.filter(e => {
                                if (e.status === 'COMPLETED') return false;
                                if (e.status === 'PENDING') return true;
                                const emergencyDate = new Date(e.requestDateTime);
                                const now = new Date();
                                const oneHourAfterAppointment = new Date(emergencyDate.getTime() + (60 * 60 * 1000));
                                return emergencyDate > now || now < oneHourAfterAppointment;
                            }).length} icon="Siren" color="rose" />
                        </div>
                    </div>

                    {/* Stats Cards Grid - Secondary Metrics */}
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 mb-4 font-sans flex items-center gap-2">
                            <Icon name="TrendingUp" size={20} className="text-purple-600" />
                            Activity & Status
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatsCard title="Verified Doctors" value={stats.verifiedDoctors || doctorsList.filter(d => d.isVerified).length} icon="BadgeCheck" color="emerald" />
                            <StatsCard title="Pending Verifications" value={doctorsList.filter(d => !d.isVerified).length} icon="Clock" color="amber" />
                            <StatsCard title="Appointments Today" value={stats.appointmentsToday || appointmentsList.filter(a => {
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                const aptDate = new Date(a.date);
                                aptDate.setHours(0, 0, 0, 0);
                                return aptDate.getTime() === today.getTime();
                            }).length} icon="Calendar" color="blue" />
                            <StatsCard title="Pending Appointments" value={stats.pendingAppointments || appointmentsList.filter(a => a.status === 'pending').length} icon="ClipboardList" color="amber" />
                        </div>
                    </div>

                    {/* Doctor Earnings Section */}
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 mb-4 font-sans flex items-center gap-2">
                            <Icon name="DollarSign" size={20} className="text-emerald-600" />
                            Doctor Earnings 
                        </h2>
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Doctor</th>
                                            <th className="text-left py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Specialization</th>
                                            <th className="text-center py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Completed Appointments</th>
                                            <th className="text-center py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Fee</th>
                                            <th className="text-right py-3 px-4 text-xs font-semibold text-slate-500 uppercase">Total Earnings</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {doctorsList.map(doctor => {
                                            const completedCount = appointmentsList.filter(a => 
                                                a.doctorId === doctor.id && 
                                                (a.status === 'completed' || a.status === 'COMPLETED')
                                            ).length;
                                            const fee = doctor.consultationFee || 500;
                                            const totalEarnings = completedCount * fee;
                                            return (
                                                <tr key={doctor.id} className="hover:bg-slate-50">
                                                    <td className="py-3 px-4">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-8 h-8 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                                                {doctor.name.replace('Dr. ', '').charAt(0)}
                                                            </div>
                                                            <span className="font-medium text-slate-800">{doctor.name}</span>
                                                        </div>
                                                    </td>
                                                    <td className="py-3 px-4 text-slate-600">{doctor.specialization}</td>
                                                    <td className="py-3 px-4 text-center">
                                                        <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold">{completedCount}</span>
                                                    </td>
                                                    <td className="py-3 px-4 text-center text-slate-600">â‚¹{fee}</td>
                                                    <td className="py-3 px-4 text-right font-bold text-emerald-600">â‚¹{totalEarnings.toLocaleString()}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                    <tfoot className="bg-emerald-50 border-t-2 border-emerald-200">
                                        <tr>
                                            <td colSpan="4" className="py-3 px-4 text-right font-bold text-slate-800">Total Platform Earnings:</td>
                                            <td className="py-3 px-4 text-right font-bold text-emerald-700 text-lg">
                                                â‚¹{doctorsList.reduce((total, doctor) => {
                                                    const completedCount = appointmentsList.filter(a => 
                                                        a.doctorId === doctor.id && 
                                                        (a.status === 'completed' || a.status === 'COMPLETED')
                                                    ).length;
                                                    return total + (completedCount * (doctor.consultationFee || 500));
                                                }, 0).toLocaleString()}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* Rating Distribution Section */}
                    <div>
                        <h2 className="text-lg font-bold text-slate-800 mb-4 font-sans flex items-center gap-2">
                            <Icon name="Star" size={20} className="text-amber-500" />
                            Rating Distribution (All Doctors)
                        </h2>
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                            <div className="bg-amber-50 rounded-xl p-4 border border-amber-100">
                                {[5, 4, 3, 2, 1].map(star => {
                                    const count = doctorsList.filter(d => Math.round(parseFloat(d.rating || d.averageRating || 0)) === star).length;
                                    const percentage = doctorsList.length > 0 ? Math.round((count / doctorsList.length) * 100) : 0;
                                    return (
                                        <div key={star} className="flex items-center gap-3 mb-2">
                                            <span className="text-amber-600 w-8">{star} â˜†</span>
                                            <div className="flex-1 bg-amber-100 rounded-full h-4 overflow-hidden">
                                                <div 
                                                    className="bg-amber-500 h-full rounded-full transition-all duration-500"
                                                    style={{ width: `${percentage}%` }}
                                                ></div>
                                            </div>
                                            <span className="text-slate-600 text-sm w-20 text-right">{count} ({percentage}%)</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                {/* Emergency Alert - Only show if there are active emergencies */}
                {emergencyList.filter(e => {
                    // Use requestDateTime (raw ISO string) for accurate date parsing
                    const emergencyDate = new Date(e.requestDateTime);
                    const now = new Date();
                    const oneHourAfterAppointment = new Date(emergencyDate.getTime() + (60 * 60 * 1000));
                    // Show if PENDING, or if APPROVED and either future appointment or within 1 hour after
                    return e.status === 'PENDING' || (e.status === 'APPROVED' && now < oneHourAfterAppointment);
                }).length > 0 && (
                    <div className="glass-card rounded-2xl p-6 border-l-4 border-rose-500 shadow-lg animate-pulse-slow">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-gradient-to-br from-rose-500 to-pink-600 rounded-xl shadow-lg">
                                    <Icon name="Siren" size={28} className="text-white" />
                                </div>
                                <div>
                                    <h3 className="text-rose-900 font-bold text-lg font-sans">ðŸš¨ Emergency Requests Active</h3>
                                    <p className="text-rose-700 font-sans">{emergencyList.filter(e => {
                                        const emergencyDate = new Date(e.requestDateTime);
                                        const now = new Date();
                                        const oneHourAfterAppointment = new Date(emergencyDate.getTime() + (60 * 60 * 1000));
                                        return e.status === 'PENDING' || (e.status === 'APPROVED' && now < oneHourAfterAppointment);
                                    }).length} critical requests require immediate attention</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => setActiveView('emergency')} 
                                className="px-6 py-3 bg-gradient-to-r from-rose-600 to-pink-600 text-white rounded-xl font-medium hover:shadow-lg transition-all font-sans flex items-center gap-2">
                                <Icon name="Eye" size={18} />
                                View Now
                            </button>
                        </div>
                    </div>
                )}

                {/* Quick Actions Section */}
                <div>
                    <h2 className="text-xl font-bold text-slate-800 mb-4 font-sans flex items-center gap-2">
                        <Icon name="Link" size={24} className="text-amber-600" />
                        Quick Links
                    </h2>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Pending Approvals Card */}
                        <div className="glass-card rounded-2xl p-6 shadow-lg border border-white/50">
                            
                            <div className="grid grid-cols-2 gap-4">
                                {/* Add New Doctor/Patient */}
                                <button 
                                    onClick={() => window.open('http://localhost:5173/#role-selection', '_blank')}
                                    className="flex flex-col items-center justify-center p-5 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl hover:shadow-lg hover:scale-105 transition-all border border-purple-100 group">
                                    <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center text-white mb-3 shadow-md group-hover:shadow-lg transition-all">
                                        <Icon name="UserPlus" size={24} />
                                    </div>
                                    <span className="text-sm font-semibold text-slate-700 text-center">Add New Patient</span>
                                    <span className="text-xs text-slate-400 mt-1">Register via portal</span>
                                </button>
                                
                                {/* Invite Doctor */}
                                <button 
                                    onClick={() => setShowInviteDoctorModal(true)}
                                    className="flex flex-col items-center justify-center p-5 bg-gradient-to-br from-teal-50 to-green-50 rounded-xl hover:shadow-lg hover:scale-105 transition-all border border-teal-100 group">
                                    <div className="w-12 h-12 bg-gradient-to-br from-teal-500 to-green-600 rounded-xl flex items-center justify-center text-white mb-3 shadow-md group-hover:shadow-lg transition-all">
                                        <Icon name="Mail" size={24} />
                                    </div>
                                    <span className="text-sm font-semibold text-slate-700 text-center">Invite Doctor</span>
                                    <span className="text-xs text-slate-400 mt-1">Send registration link</span>
                                </button>
                                
                                {/* View All Appointments */}
                                <button 
                                    onClick={() => setActiveView('appointments')}
                                    className="flex flex-col items-center justify-center p-5 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl hover:shadow-lg hover:scale-105 transition-all border border-blue-100 group">
                                    <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center text-white mb-3 shadow-md group-hover:shadow-lg transition-all">
                                        <Icon name="CalendarCheck" size={24} />
                                    </div>
                                    <span className="text-sm font-semibold text-slate-700 text-center">View All Appointments</span>
                                    <span className="text-xs text-slate-400 mt-1">{appointmentsList.length} total</span>
                                </button>
                                
                                {/* Patient Reports */}
                                <button 
                                    onClick={() => setActiveView('patients-all')}
                                    className="flex flex-col items-center justify-center p-5 bg-gradient-to-br from-teal-50 to-emerald-50 rounded-xl hover:shadow-lg hover:scale-105 transition-all border border-teal-100 group">
                                    <div className="w-12 h-12 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-xl flex items-center justify-center text-white mb-3 shadow-md group-hover:shadow-lg transition-all">
                                        <Icon name="Users" size={24} />
                                    </div>
                                    <span className="text-sm font-semibold text-slate-700 text-center">Patient Reports</span>
                                    <span className="text-xs text-slate-400 mt-1">{patientsList.length} patients</span>
                                </button>
                                
                                {/* System Settings */}
                                <button 
                                    onClick={() => setActiveView('settings')}
                                    className="flex flex-col items-center justify-center p-5 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl hover:shadow-lg hover:scale-105 transition-all border border-amber-100 group">
                                    <div className="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center text-white mb-3 shadow-md group-hover:shadow-lg transition-all">
                                        <Icon name="Settings" size={24} />
                                    </div>
                                    <span className="text-sm font-semibold text-slate-700 text-center">System Settings</span>
                                    <span className="text-xs text-slate-400 mt-1">Configure options</span>
                                </button>
                            </div>
                        </div>

                        {/* Recent Activity Card */}
                        <div className="glass-card rounded-2xl p-6 shadow-lg border border-white/50">
                            <h3 className="text-lg font-bold text-slate-800 mb-6 font-sans flex items-center gap-2">
                                <Icon name="Activity" size={20} className="text-purple-600" />
                                Recent Activity
                            </h3>
                         <div className="space-y-4">
                             {[
                                 { action: 'New appointment booked', time: '10:15 AM' },
                                 { action: 'Doctor verification completed', time: '10:16 AM' },
                                 { action: 'Patient registered', time: '10:17 AM' },
                                 { action: 'Emergency request resolved', time: '10:18 AM' }
                             ].map((activity, i) => (
                                 <div key={i} className="flex gap-4 items-start">
                                     <div className="mt-2"><div className="w-3 h-3 rounded-full bg-teal-400"></div></div>
                                     <div className="flex-1">
                                         <p className="text-lg text-slate-700 font-sans"><span className="font-medium">{activity.action}</span></p>
                                         <p className="text-base text-slate-400 font-sans">Today, {activity.time}</p>
                                     </div>
                                 </div>
                             ))}
                         </div>
                     </div>
                    </div>
                </div>
            </div>
            );
        };

        const AdminTable = ({ headers, children }) => (
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead className="bg-slate-50 border-b border-slate-100">
                            <tr>
                                {headers.map((h, i) => (
                                    <th key={i} className="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase tracking-wider font-sans">{h}</th>
                                ))}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 font-sans">{children}</tbody>
                    </table>
                </div>
            </div>
        );

        // Patient Detail View - Full Profile with Sidebar Layout
        if (selectedItem && selectedItem.type === 'patient') {
             return (
                 <div className="h-screen flex bg-gradient-to-br from-slate-50 to-slate-100">
                     {/* Left Sidebar */}
                     <div className="w-80 bg-gradient-to-b from-purple-600 to-indigo-700 overflow-y-auto shadow-2xl">
                         <div className="p-6">
                             <button onClick={handleBackNavigation} className="flex items-center gap-2 text-white/90 hover:text-white mb-6 transition-colors">
                                 <Icon name="ArrowLeft" size={20} />
                                 <span>Back</span>
                             </button>
                             
                             {/* Profile Card */}
                             <div className="text-center mb-6">
                                 <img 
                                     src={selectedItem.data.profilePictureUrl} 
                                     alt={selectedItem.data.fullName}
                                     className="w-48 h-48 mx-auto rounded-full border-4 border-white shadow-xl mb-4 object-cover"
                                     onError={(e) => {
                                         e.target.src = `https://ui-avatars.com/api/?name=${selectedItem.data.fullName}&background=7209B7&color=fff&size=200`;
                                     }}
                                 />
                                 <h2 className="text-xl font-bold text-white mb-1">{selectedItem.data.fullName}</h2>
                                 <p className="text-white/80 text-sm">{selectedItem.data.user?.email || selectedItem.data.email}</p>
                             </div>
                             
                             {/* Navigation Tabs */}
                             <div className="space-y-2">
                                 <button 
                                     onClick={() => setActiveTab('profile')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'profile' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <Icon name="User" size={16} className="inline mr-2" />
                                     Profile Details
                                 </button>
                                 <button 
                                     onClick={() => setActiveTab('medical')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'medical' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <img 
                                         src="https://cdn-icons-png.flaticon.com/128/13784/13784158.png" 
                                         alt="Medical" 
                                         className="inline mr-2 w-4 h-4"
                                         style={{filter: 'brightness(0) invert(1)'}}
                                     />
                                     Medical Conditions
                                 </button>
                                 <button 
                                     onClick={() => setActiveTab('prescriptions')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'prescriptions' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <Icon name="Pill" size={16} className="inline mr-2" />
                                     Prescriptions
                                 </button>
                                 <button 
                                     onClick={() => setActiveTab('records')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'records' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <Icon name="FileText" size={16} className="inline mr-2" />
                                     Health Records
                                 </button>
                             </div>
                         </div>
                     </div>
                     
                     {/* Right Content Area */}
                     <div className="flex-1 overflow-y-auto p-8">
                         {activeTab === 'profile' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <Icon name="User" size={20} className="text-purple-600" />
                                     Personal Information
                                 </h3>
                                 {/* Read-Only Form Grid Layout */}
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                     {/* First Name */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">First Name</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.firstName || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Last Name */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Last Name</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.lastName || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Email */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Email</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.email || selectedItem.data.user?.email || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Phone */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Phone</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.phone || selectedItem.data.phoneNumber || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Date of Birth */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Date of Birth</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.dateOfBirth ? new Date(selectedItem.data.dateOfBirth).toLocaleDateString() : 'N/A'}
                                         </div>
                                     </div>
                                     {/* Age */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Age</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.age} years
                                         </div>
                                     </div>
                                     {/* Gender */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Gender</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900 capitalize">
                                             {selectedItem.data.gender || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Blood Group */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Blood Group</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.bloodGroup || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Address - Full Width */}
                                     <div className="md:col-span-2">
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Address</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.address || 'N/A'}
                                         </div>
                                     </div>
                                     {/* City */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">City</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.city || 'N/A'}
                                         </div>
                                     </div>
                                     {/* State */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">State</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.state || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Country */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Country</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.country || 'India'}
                                         </div>
                                     </div>
                                     {/* Postal Code */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Postal Code</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.postalCode || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Emergency Contact Name */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Emergency Contact Name</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.emergencyContactName || 'N/A'}
                                         </div>
                                     </div>
                                     {/* Emergency Contact Phone */}
                                     <div>
                                         <label className="block text-sm font-bold text-slate-700 mb-2">Emergency Contact Phone</label>
                                         <div className="w-full p-3 bg-slate-100 border border-slate-200 rounded-lg text-slate-900">
                                             {selectedItem.data.emergencyContactPhone || 'N/A'}
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         )}
                         
                         {activeTab === 'medical' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <img 
                                         src="https://cdn-icons-png.flaticon.com/128/13784/13784158.png" 
                                         alt="Medical Conditions" 
                                         className="w-6 h-6"
                                     />
                                     Medical Conditions
                                 </h3>
                                 {selectedItem.data.medicalConditions && selectedItem.data.medicalConditions.length > 0 ? (
                                     <div className="space-y-4">
                                         {selectedItem.data.medicalConditions.map((condition, idx) => {
                                             const conditionName = condition.conditionName || condition.name || 'Unknown Condition';
                                             const diagnosedDate = condition.diagnosedDate ? new Date(condition.diagnosedDate).toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
                                             const notes = condition.notes || condition.description || 'No notes';
                                             const severity = condition.severity || 'chronic';
                                             
                                             return (
                                                 <div key={idx} className="bg-yellow-50 rounded-xl p-5 border-l-4 border-yellow-400 hover:shadow-md transition-all">
                                                     <div className="flex justify-between items-start mb-2">
                                                         <h4 className="font-bold text-slate-900 text-lg">{conditionName}</h4>
                                                         <span className="px-3 py-1 rounded-full text-xs font-bold bg-teal-100 text-teal-700 capitalize">
                                                             {severity}
                                                         </span>
                                                     </div>
                                                     <p className="text-sm text-slate-600 mb-2">Diagnosed: {diagnosedDate}</p>
                                                     <p className="text-sm text-slate-700 italic">Note: {notes}</p>
                                                 </div>
                                             );
                                         })}
                                     </div>
                                 ) : (
                                     <div className="text-center py-12">
                                         <Icon name="Heart" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500 text-lg">No medical conditions recorded</p>
                                         <p className="text-slate-400 text-sm mt-2">This patient has no documented medical conditions</p>
                                     </div>
                                 )}
                             </div>
                         )}
                         
                         {activeTab === 'prescriptions' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <Icon name="Pill" size={24} className="text-green-600" />
                                     Prescriptions
                                 </h3>
                                 {selectedItem.data.prescriptions && selectedItem.data.prescriptions.length > 0 ? (
                                     (() => {
                                         const now = new Date();
                                         const activePrescriptions = selectedItem.data.prescriptions.filter(med => {
                                             if (!med.endDate) return true;
                                             return new Date(med.endDate) >= now;
                                         });
                                         const pastPrescriptions = selectedItem.data.prescriptions.filter(med => {
                                             if (!med.endDate) return false;
                                             return new Date(med.endDate) < now;
                                         });
                                         
                                         return (
                                             <div className="space-y-8">
                                                 {/* Active Prescriptions */}
                                                 <div>
                                                     <h4 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                         <Icon name="Pill" size={18} className="text-green-600" />
                                                         Active Prescriptions ({activePrescriptions.length})
                                                     </h4>
                                                     {activePrescriptions.length > 0 ? (
                                                         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                             {activePrescriptions.map((med, idx) => (
                                                                 <div key={idx} className="bg-green-50 border border-green-200 rounded-xl p-4 hover:shadow-md transition-all">
                                                                     <div className="flex justify-between items-start mb-3">
                                                                         <h5 className="font-bold text-slate-900">{med.medicationName || med.name}</h5>
                                                                         <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Active</span>
                                                                     </div>
                                                                     <p className="text-sm text-slate-600 mb-3">Dosage: {med.dosage || 'N/A'}</p>
                                                                     <button 
                                                                         onClick={() => setSelectedPrescriptionForView(med)}
                                                                         className="w-full px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                                                         <Icon name="Eye" size={16} />
                                                                         View Details
                                                                     </button>
                                                                 </div>
                                                             ))}
                                                         </div>
                                                     ) : (
                                                         <p className="text-center text-slate-500 py-4">No active prescriptions found.</p>
                                                     )}
                                                 </div>
                                                 
                                                 {/* Past Prescriptions */}
                                                 {pastPrescriptions.length > 0 && (
                                                     <div>
                                                         <h4 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                             <Icon name="History" size={18} className="text-slate-500" />
                                                             Past Prescriptions ({pastPrescriptions.length})
                                                         </h4>
                                                         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                             {pastPrescriptions.map((med, idx) => (
                                                                 <div key={idx} className="bg-slate-50 border border-slate-200 rounded-xl p-4 opacity-75">
                                                                     <div className="flex justify-between items-start mb-3">
                                                                         <h5 className="font-bold text-slate-700">{med.medicationName || med.name}</h5>
                                                                         <span className="px-2 py-1 bg-slate-200 text-slate-600 rounded-full text-xs font-bold">Completed</span>
                                                                     </div>
                                                                     <p className="text-sm text-slate-500 mb-3">Ended: {new Date(med.endDate).toLocaleDateString()}</p>
                                                                     <button 
                                                                         onClick={() => setSelectedPrescriptionForView(med)}
                                                                         className="w-full px-4 py-2 bg-slate-500 text-white rounded-lg text-sm font-medium hover:bg-slate-600 transition-colors flex items-center justify-center gap-2">
                                                                         <Icon name="Eye" size={16} />
                                                                         View Details
                                                                     </button>
                                                                 </div>
                                                             ))}
                                                         </div>
                                                     </div>
                                                 )}
                                             </div>
                                         );
                                     })()
                                 ) : (
                                     <div className="text-center py-12">
                                         <Icon name="Pill" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500 text-lg">No prescriptions recorded</p>
                                         <p className="text-slate-400 text-sm mt-2">This patient has no prescription history</p>
                                     </div>
                                 )}
                             </div>
                         )}
                         
                         {activeTab === 'records' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <Icon name="FileText" size={24} className="text-purple-600" />
                                     Health Records
                                 </h3>
                                 {selectedItem.data.healthRecords && selectedItem.data.healthRecords.length > 0 ? (
                                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                         {selectedItem.data.healthRecords.map((record, idx) => (
                                             <div key={idx} className="bg-purple-50 border border-purple-200 rounded-xl p-4 hover:shadow-md transition-all">
                                                 <div className="flex items-start gap-3 mb-3">
                                                     <div className="p-2 bg-purple-100 rounded-lg">
                                                         <Icon name="FileText" size={20} className="text-purple-600" />
                                                     </div>
                                                     <div className="flex-1">
                                                         <h4 className="font-bold text-slate-900 break-words">Patient Information for '{record.title || 'Untitled'}'</h4>
                                                         <p className="text-sm text-slate-600">{record.recordDate ? new Date(record.recordDate).toLocaleDateString() : 'N/A'}</p>
                                                     </div>
                                                 </div>
                                                 <button 
                                                     onClick={() => setSelectedRecordForView(record)}
                                                     className="w-full px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                                                     <Icon name="Eye" size={16} />
                                                     View Details
                                                 </button>
                                             </div>
                                         ))}
                                     </div>
                                 ) : (
                                     <div className="text-center py-12">
                                         <Icon name="FileText" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500 text-lg">No health records found</p>
                                         <p className="text-slate-400 text-sm mt-2">This patient has no health records on file</p>
                                     </div>
                                 )}
                             </div>
                         )}
                         

                         

                         {activeTab === 'uploaded-prescriptions' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <Icon name="Upload" size={24} className="text-indigo-600" />
                                     Uploaded Prescriptions
                                 </h3>
                                 {selectedItem.data.prescriptions && selectedItem.data.prescriptions.filter(p => p.documentPath || p.filePath).length > 0 ? (
                                     <div className="space-y-4">
                                         {selectedItem.data.prescriptions.filter(p => p.documentPath || p.filePath).map((presc, idx) => {
                                             const docPath = presc.documentPath || presc.filePath;
                                             return (
                                                 <div key={idx} className="bg-indigo-50 rounded-xl p-5 border-l-4 border-indigo-500 hover:shadow-md transition-all">
                                                     <div className="flex justify-between items-start mb-3">
                                                         <div className="flex-1">
                                                             <div className="flex items-center gap-2 mb-2">
                                                                 <Icon name="FileText" size={18} className="text-indigo-600" />
                                                                 <h4 className="font-bold text-slate-900 text-lg">{presc.medicationName || presc.name || 'Prescription Document'}</h4>
                                                             </div>
                                                             <div className="space-y-1 text-sm text-slate-600">
                                                                 {presc.dosage && <p><span className="font-semibold">Dosage:</span> {presc.dosage}</p>}
                                                                 {presc.frequency && <p><span className="font-semibold">Frequency:</span> {presc.frequency}</p>}
                                                                 {presc.startDate && <p><span className="font-semibold">Start Date:</span> {new Date(presc.startDate).toLocaleDateString()}</p>}
                                                                 {presc.endDate && <p><span className="font-semibold">End Date:</span> {new Date(presc.endDate).toLocaleDateString()}</p>}
                                                             </div>
                                                         </div>
                                                     </div>
                                                     <div className="flex gap-2 mt-3 pt-3 border-t border-indigo-200">
                                                         <button 
                                                             onClick={() => {
                                                                 const fileUrl = `http://localhost:8080/${docPath.startsWith('/') ? docPath.substring(1) : docPath}`;
                                                                 window.open(fileUrl, '_blank');
                                                             }}
                                                             className="inline-flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors">
                                                             <Icon name="Eye" size={14} /> View
                                                         </button>
                                                         <button 
                                                             onClick={() => {
                                                                 const fileUrl = `http://localhost:8080/${docPath.startsWith('/') ? docPath.substring(1) : docPath}`;
                                                                 const link = document.createElement('a');
                                                                 link.href = fileUrl;
                                                                 link.download = presc.medicationName || 'prescription';
                                                                 link.target = '_blank';
                                                                 document.body.appendChild(link);
                                                                 link.click();
                                                                 document.body.removeChild(link);
                                                             }}
                                                             className="inline-flex items-center gap-1 px-3 py-1.5 bg-teal-600 text-white rounded-lg text-sm font-medium hover:bg-teal-700 transition-colors">
                                                             <Icon name="Download" size={14} /> Download
                                                         </button>
                                                     </div>
                                                 </div>
                                             );
                                         })}
                                     </div>
                                 ) : (
                                     <div className="text-center py-12">
                                         <Icon name="Upload" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500 text-lg">No uploaded prescriptions</p>
                                         <p className="text-slate-400 text-sm mt-2">This patient has no prescription documents uploaded</p>
                                     </div>
                                 )}
                             </div>
                         )}
                     </div>
                     
                     {/* Prescription View Modal for Patient Detail View */}
                     {selectedPrescriptionForView && (
                         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setSelectedPrescriptionForView(null)}>
                             <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                 <div className="flex items-center justify-between p-6 border-b border-slate-200">
                                     <h3 className="text-2xl font-bold text-[#7209B7] flex items-center gap-2">
                                         <Icon name="Pill" size={28} className="text-[#7209B7]" />
                                         {selectedPrescriptionForView.medicationName || selectedPrescriptionForView.name || 'Prescription'}
                                     </h3>
                                     <button onClick={() => setSelectedPrescriptionForView(null)} className="p-2 text-red-500 hover:text-red-700 transition-colors">
                                         <Icon name="X" size={24} />
                                     </button>
                                 </div>
                                 <div className="p-6 space-y-6">
                                     <div className="grid grid-cols-2 gap-6">
                                         <div>
                                             <p className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Dosage</p>
                                             <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.dosage || 'N/A'}</p>
                                         </div>
                                         <div>
                                             <p className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Frequency</p>
                                             <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.frequency || 'N/A'}</p>
                                         </div>
                                     </div>
                                     <div>
                                         <p className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Description</p>
                                         <p className="text-slate-700">{selectedPrescriptionForView.instructions || selectedPrescriptionForView.notes || selectedPrescriptionForView.description || 'No description provided'}</p>
                                     </div>
                                     <div className="grid grid-cols-2 gap-6">
                                         <div className="bg-purple-50 rounded-lg p-4 border border-purple-100">
                                             <p className="text-sm font-semibold text-purple-600 uppercase tracking-wide mb-1">Start Date</p>
                                             <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.startDate ? new Date(selectedPrescriptionForView.startDate).toLocaleDateString() : 'N/A'}</p>
                                         </div>
                                         <div className="bg-purple-50 rounded-lg p-4 border border-purple-100">
                                             <p className="text-sm font-semibold text-purple-600 uppercase tracking-wide mb-1">End Date</p>
                                             <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.endDate ? new Date(selectedPrescriptionForView.endDate).toLocaleDateString() : 'Ongoing'}</p>
                                         </div>
                                     </div>
                                 </div>
                                 <div className="p-6 border-t border-slate-200">
                                     <button 
                                         onClick={() => {
                                             const docPath = selectedPrescriptionForView.documentPath || selectedPrescriptionForView.filePath;
                                             if (docPath) {
                                                 const fileUrl = `http://localhost:8080/${docPath.startsWith('/') ? docPath.substring(1) : docPath}`;
                                                 const link = document.createElement('a');
                                                 link.href = fileUrl;
                                                 link.download = selectedPrescriptionForView.medicationName || 'prescription';
                                                 link.target = '_blank';
                                                 document.body.appendChild(link);
                                                 link.click();
                                                 document.body.removeChild(link);
                                             } else {
                                                 alert('No document available for download');
                                             }
                                         }}
                                         className="w-full flex items-center justify-center gap-2 px-6 py-4 bg-[#7209B7] text-white rounded-xl font-bold text-lg hover:bg-[#5c078f] transition-colors shadow-lg">
                                         <Icon name="Download" size={22} />
                                         Download Prescription
                                     </button>
                                 </div>
                             </div>
                         </div>
                     )}
                     
                     {/* Health Record View Modal for Patient Detail View */}
                     {selectedRecordForView && (
                         <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setSelectedRecordForView(null)}>
                             <div className="bg-white rounded-2xl w-full max-w-3xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                 <div className="p-6 border-b border-slate-200">
                                     <div className="flex items-center justify-between">
                                         <div>
                                             <h3 className="text-2xl font-bold text-[#7209B7] break-words">
                                                 Patient Information for '{selectedRecordForView.title || 'Untitled'}'
                                             </h3>
                                             <p className="text-sm text-slate-500 mt-1">
                                                 {selectedRecordForView.recordType?.toUpperCase() || 'RECORD'} | {selectedRecordForView.recordDate ? new Date(selectedRecordForView.recordDate).toLocaleDateString() : 'N/A'}
                                             </p>
                                         </div>
                                         <button onClick={() => setSelectedRecordForView(null)} className="p-2 text-red-500 hover:text-red-700 transition-colors">
                                             <Icon name="X" size={24} />
                                         </button>
                                     </div>
                                 </div>
                                 <div className="p-6 space-y-6 overflow-y-auto flex-1">
                                     {/* Gray - Basic Info */}
                                     <div className="bg-slate-100 rounded-xl p-5 border border-slate-200">
                                         <h4 className="font-bold text-slate-700 mb-4 text-lg border-b border-slate-300 pb-2">Basic Info</h4>
                                         <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                             <div>
                                                 <p className="text-xs font-semibold text-slate-500 uppercase mb-1">Full Name</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.fullName || selectedRecordForView.patientName || selectedItem?.data?.fullName || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-slate-500 uppercase mb-1">Marital Status</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.maritalStatus || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-slate-500 uppercase mb-1">Address</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.address || selectedItem?.data?.address || 'N/A'}</p>
                                             </div>
                                         </div>
                                     </div>
                                     {/* Blue - Vitals */}
                                     <div className="bg-blue-50 rounded-xl p-5 border border-blue-200">
                                         <h4 className="font-bold text-blue-800 mb-4 text-lg border-b border-blue-200 pb-2">Current Health (Vitals)</h4>
                                         <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                             <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                                 <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Weight</p>
                                                 <p className="text-xl font-bold text-slate-900">{selectedRecordForView.weight || selectedRecordForView.weightKg || 'N/A'}</p>
                                                 {(selectedRecordForView.weight || selectedRecordForView.weightKg) && <p className="text-xs text-slate-500">kg</p>}
                                             </div>
                                             <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                                 <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Height</p>
                                                 <p className="text-xl font-bold text-slate-900">{selectedRecordForView.height || selectedRecordForView.heightCm || 'N/A'}</p>
                                                 {(selectedRecordForView.height || selectedRecordForView.heightCm) && <p className="text-xs text-slate-500">cm</p>}
                                             </div>
                                             <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                                 <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">BMI</p>
                                                 <p className="text-xl font-bold text-slate-900">{selectedRecordForView.bmi || 'N/A'}</p>
                                             </div>
                                             <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                                 <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Pulse</p>
                                                 <p className="text-xl font-bold text-slate-900">{selectedRecordForView.pulse || selectedRecordForView.pulseRate || 'N/A'}</p>
                                                 {(selectedRecordForView.pulse || selectedRecordForView.pulseRate) && <p className="text-xs text-slate-500">bpm</p>}
                                             </div>
                                             <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                                 <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Temp</p>
                                                 <p className="text-xl font-bold text-slate-900">{selectedRecordForView.temperature || selectedRecordForView.bodyTemperature || 'N/A'}</p>
                                                 {(selectedRecordForView.temperature || selectedRecordForView.bodyTemperature) && <p className="text-xs text-slate-500">Â°C</p>}
                                             </div>
                                         </div>
                                     </div>
                                     {/* Orange - Identification */}
                                     <div className="bg-orange-50 rounded-xl p-5 border border-orange-200">
                                         <h4 className="font-bold text-orange-800 mb-4 text-lg border-b border-orange-200 pb-2">Identification Details</h4>
                                         <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                             <div>
                                                 <p className="text-xs font-semibold text-orange-600 uppercase mb-1">Aadhaar Number</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.aadhaarNumber || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-orange-600 uppercase mb-1">Insurance</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.insuranceDetails || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-orange-600 uppercase mb-1">Birth Mark</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.birthMark || 'N/A'}</p>
                                             </div>
                                         </div>
                                     </div>
                                     {/* Green - Lifestyle */}
                                     <div className="bg-green-50 rounded-xl p-5 border border-green-200">
                                         <h4 className="font-bold text-green-800 mb-4 text-lg border-b border-green-200 pb-2">Lifestyle</h4>
                                         <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                             <div>
                                                 <p className="text-xs font-semibold text-green-600 uppercase mb-1">Smoking</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.smokingStatus || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-green-600 uppercase mb-1">Alcohol</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.alcoholConsumption || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-green-600 uppercase mb-1">Diet</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.dietPreference || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-green-600 uppercase mb-1">Activity</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.physicalActivityLevel || 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-green-600 uppercase mb-1">Sleep</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.sleepHours ? `${selectedRecordForView.sleepHours} hrs/night` : 'N/A'}</p>
                                             </div>
                                             <div>
                                                 <p className="text-xs font-semibold text-green-600 uppercase mb-1">Stress Level</p>
                                                 <p className="font-medium text-slate-900">{selectedRecordForView.stressLevel || 'N/A'}</p>
                                             </div>
                                         </div>
                                     </div>
                                     {/* Purple - Description */}
                                     {selectedRecordForView.description && (
                                         <div className="bg-purple-50 rounded-xl p-5 border border-purple-200">
                                             <h4 className="font-bold text-purple-800 mb-4 text-lg border-b border-purple-200 pb-2">Description / Notes</h4>
                                             <p className="text-slate-700">{selectedRecordForView.description}</p>
                                         </div>
                                     )}
                                 </div>
                                 <div className="p-6 border-t border-slate-200">
                                     <button 
                                         onClick={() => {
                                             const docPath = selectedRecordForView.documentPath || selectedRecordForView.document_path || selectedRecordForView.filePath;
                                             if (docPath) {
                                                 const fileUrl = `http://localhost:8080/${docPath.startsWith('/') ? docPath.substring(1) : docPath}`;
                                                 const link = document.createElement('a');
                                                 link.href = fileUrl;
                                                 link.download = selectedRecordForView.title || 'health-record';
                                                 link.target = '_blank';
                                                 document.body.appendChild(link);
                                                 link.click();
                                                 document.body.removeChild(link);
                                             } else {
                                                 alert('No document available for download');
                                             }
                                         }}
                                         className="w-full flex items-center justify-center gap-2 px-6 py-4 bg-[#7209B7] text-white rounded-xl font-bold text-lg hover:bg-[#5c078f] transition-colors shadow-lg">
                                         <Icon name="Download" size={22} />
                                         Download Attached Document
                                     </button>
                                 </div>
                             </div>
                         </div>
                     )}
                 </div>
             );
        }

        // Doctor Detail View - Full Profile with Sidebar Layout
        if (selectedItem && selectedItem.type === 'doctor') {
             return (
                 <div className="h-screen flex bg-gradient-to-br from-slate-50 to-slate-100">
                     {/* Left Sidebar */}
                     <div className="w-80 bg-gradient-to-b from-teal-600 to-emerald-700 overflow-y-auto shadow-2xl">
                         <div className="p-6">
                             <button onClick={handleBackNavigation} className="flex items-center gap-2 text-white/90 hover:text-white mb-6 transition-colors">
                                 <Icon name="ArrowLeft" size={20} />
                                 <span>Back</span>
                             </button>
                             
                             {/* Profile Card */}
                             <div className="text-center mb-6">
                                 <img 
                                     src={selectedItem.data.profilePictureUrl} 
                                     alt={selectedItem.data.fullName}
                                     className="w-48 h-48 mx-auto rounded-full border-4 border-white shadow-xl mb-4 object-cover"
                                     onError={(e) => {
                                         e.target.src = `https://ui-avatars.com/api/?name=${selectedItem.data.fullName}&background=14B8A6&color=fff&size=200`;
                                     }}
                                 />
                                 <h2 className="text-xl font-bold text-white mb-1">{selectedItem.data.fullName}</h2>
                                 <p className="text-white/80 text-sm">{selectedItem.data.specialization}</p>
                                 <div className="flex justify-center gap-2 mt-4">
                                     {selectedItem.data.isVerified && (
                                         <span className="px-3 py-1 bg-emerald-500 text-white rounded-full text-xs font-bold flex items-center gap-1">
                                             <Icon name="BadgeCheck" size={12} /> Verified
                                         </span>
                                     )}
                                 </div>
                             </div>
                             
                             {/* Navigation Tabs */}
                             <div className="space-y-2">
                                 <button 
                                     onClick={() => setActiveTab('profile')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'profile' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <Icon name="User" size={16} className="inline mr-2" />
                                     Profile Details
                                 </button>
                                 <button 
                                     onClick={() => setActiveTab('slots')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'slots' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <Icon name="Calendar" size={16} className="inline mr-2" />
                                     Available Slots
                                 </button>
                                 <button 
                                     onClick={() => setActiveTab('qualifications')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'qualifications' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <Icon name="Award" size={16} className="inline mr-2" />
                                     Qualifications
                                 </button>
                                 <button 
                                     onClick={() => setActiveTab('reviews')}
                                     className={`w-full text-left px-4 py-3 rounded-lg transition-colors ${activeTab === 'reviews' ? 'bg-white/20 text-white font-semibold' : 'text-white/70 hover:bg-white/10'}`}>
                                     <Icon name="Star" size={16} className="inline mr-2" />
                                     Patient Reviews
                                 </button>
                             </div>
                         </div>
                     </div>
                     
                     {/* Right Content Area */}
                     <div className="flex-1 overflow-y-auto p-8">
                         {activeTab === 'profile' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <Icon name="User" size={20} className="text-teal-600" />
                                     Professional Information
                                 </h3>
                                 <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">First Name</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.firstName || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Last Name</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.lastName || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Email</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.email || selectedItem.data.user?.email || 'N/A'}</p>
                                     </div>
                                 </div>
                                 
                                 <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Phone</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.phone || selectedItem.data.phoneNumber || selectedItem.data.user?.phone || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Specialization</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.specialization || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Experience</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.experienceYears || selectedItem.data.experience || 0} years</p>
                                     </div>
                                 </div>
                                 
                                 <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">License Number</p>
                                         <p className="text-lg font-mono font-bold text-slate-900">{selectedItem.data.licenseNumber || selectedItem.data.professionalId || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">License Expiry</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.licenseExpiry ? new Date(selectedItem.data.licenseExpiry).toLocaleDateString() : 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Consultation Fee</p>
                                         <p className="text-lg font-bold text-slate-900">â‚¹{selectedItem.data.consultationFee || selectedItem.data.fee || 500}</p>
                                     </div>
                                 </div>
                                 
                                 <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">City</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.city || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">State</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.state || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Country</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.country || 'India'}</p>
                                     </div>
                                 </div>
                                 
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Postal Code</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.postalCode || 'N/A'}</p>
                                     </div>
                                     <div className="bg-slate-50 rounded-lg p-4">
                                         <p className="text-xs text-slate-500 uppercase mb-1">Hospital Affiliation</p>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.hospitalAffiliation || 'N/A'}</p>
                                     </div>
                                 </div>
                                 
                                 <div className="bg-slate-50 rounded-lg p-4 mb-6">
                                     <p className="text-xs text-slate-500 uppercase mb-1">Qualification</p>
                                     <p className="text-lg font-bold text-slate-900">{selectedItem.data.qualification || selectedItem.data.qualifications || 'N/A'}</p>
                                 </div>
                                 
                                 <div className="bg-slate-50 rounded-lg p-4">
                                     <p className="text-xs text-slate-500 uppercase mb-1">Address</p>
                                     <p className="text-lg font-bold text-slate-900">{selectedItem.data.address || 'N/A'}</p>
                                 </div>
                             </div>
                         )}
                         
                         {activeTab === 'slots' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <div className="flex justify-between items-center mb-6">
                                     <h3 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                         <Icon name="Calendar" size={24} className="text-blue-600" />
                                         Available Slots
                                     </h3>
                                     <button 
                                         onClick={async () => {
                                             const refreshedData = await fetchDoctorDetails(selectedItem.data.doctorId || selectedItem.data.id);
                                             if (refreshedData) {
                                                 setSelectedItem({ type: 'doctor', data: refreshedData });
                                             }
                                         }}
                                         className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                                     >
                                         <Icon name="RefreshCw" size={16} />
                                         Refresh Slots
                                     </button>
                                 </div>
                                 {selectedItem.data.availableSlots && selectedItem.data.availableSlots.length > 0 ? (
                                     (() => {
                                         const now = new Date();
                                         now.setHours(0, 0, 0, 0); // Compare dates only, not time
                                         
                                         const upcomingSlots = selectedItem.data.availableSlots.filter(slot => {
                                             if (!slot.slotDate) return true; // No date = show as upcoming
                                             const slotDate = new Date(slot.slotDate);
                                             slotDate.setHours(0, 0, 0, 0);
                                             return slotDate >= now;
                                         });
                                         const pastSlots = selectedItem.data.availableSlots.filter(slot => {
                                             if (!slot.slotDate) return false;
                                             const slotDate = new Date(slot.slotDate);
                                             slotDate.setHours(0, 0, 0, 0);
                                             return slotDate < now;
                                         });
                                         
                                         // Calculate statistics for upcoming slots
                                         const totalUpcoming = upcomingSlots.length;
                                         const bookedUpcoming = upcomingSlots.filter(s => s.isBooked || !s.isAvailable).length;
                                         const freeUpcoming = totalUpcoming - bookedUpcoming;
                                         
                                         // Calculate statistics for past slots
                                         const totalPast = pastSlots.length;
                                         const bookedPast = pastSlots.filter(s => s.isBooked || !s.isAvailable).length;
                                         const expiredPast = totalPast - bookedPast;
                                         
                                         return (
                                             <div className="space-y-8">
                                                 {/* Upcoming/Active Slots */}
                                                 {upcomingSlots.length > 0 && (
                                                     <div>
                                                         <h4 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                             <Icon name="Clock" size={18} className="text-green-600" />
                                                             Upcoming Slots ({freeUpcoming} Free, {bookedUpcoming} Booked)
                                                         </h4>
                                                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                             {upcomingSlots.map((slot, idx) => {
                                                                 // Handle different time formats
                                                                 const times = slot.slotTime || slot.times || [slot.startTime];
                                                                 const timeArray = Array.isArray(times) ? times : [times];
                                                                 const isBooked = slot.isBooked || !slot.isAvailable;
                                                                 
                                                                 return (
                                                                     <div key={idx} className={`rounded-xl p-4 border-l-4 ${isBooked ? 'bg-red-50 border-red-400' : 'bg-emerald-50 border-emerald-500'}`}>
                                                                         <div className="flex items-center gap-2 mb-2">
                                                                             <Icon name="Calendar" size={16} className={isBooked ? 'text-red-600' : 'text-emerald-600'} />
                                                                             <span className="font-bold text-slate-900">
                                                                                 {slot.dayOfWeek || (slot.slotDate ? new Date(slot.slotDate).toLocaleDateString('en-US', { weekday: 'long' }) : 'N/A')}
                                                                             </span>
                                                                         </div>
                                                                         {slot.slotDate && (
                                                                             <p className="text-sm font-semibold text-slate-700 mb-2">
                                                                                 {new Date(slot.slotDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                                             </p>
                                                                         )}
                                                                         <div className="flex flex-wrap gap-1 mb-2">
                                                                             {timeArray.filter(t => t).map((time, tidx) => (
                                                                                 <span key={tidx} className={`px-2 py-1 rounded text-xs font-medium ${isBooked ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                                                                     {time}
                                                                                 </span>
                                                                             ))}
                                                                             {timeArray.filter(t => t).length === 0 && slot.startTime && slot.endTime && (
                                                                                 <span className="text-sm text-slate-600">{slot.startTime} - {slot.endTime}</span>
                                                                             )}
                                                                             {timeArray.filter(t => t).length === 0 && !slot.startTime && (
                                                                                 <span className="text-sm text-slate-400">Time not specified</span>
                                                                             )}
                                                                         </div>
                                                                         <span className={`inline-block mt-2 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 w-fit ${isBooked ? 'bg-red-200 text-red-800' : 'bg-emerald-200 text-emerald-800'}`}>
                                                                             {isBooked ? 'ðŸ”’ Booked' : 'âœ“ Available'}
                                                                         </span>
                                                                     </div>
                                                                 );
                                                             })}
                                                         </div>
                                                     </div>
                                                 )}
                                                 
                                                 {/* Past Slots */}
                                                 {pastSlots.length > 0 && (
                                                     <div>
                                                         <h4 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                             <Icon name="History" size={18} className="text-slate-500" />
                                                             Past Slots ({bookedPast} Completed, {expiredPast} Expired)
                                                         </h4>
                                                         <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                             {pastSlots.map((slot, idx) => {
                                                                 const times = slot.slotTime || slot.times || [slot.startTime];
                                                                 const timeArray = Array.isArray(times) ? times : [times];
                                                                 const wasBooked = slot.isBooked || !slot.isAvailable;
                                                                 
                                                                 return (
                                                                     <div key={idx} className={`rounded-xl p-4 border-l-4 ${
                                                                         wasBooked 
                                                                             ? 'bg-amber-50 border-amber-200 opacity-80' 
                                                                             : 'bg-slate-50 border-slate-200 opacity-60'
                                                                     }`}>
                                                                         <div className="flex items-center gap-2 mb-2">
                                                                             <Icon name="Calendar" size={16} className={wasBooked ? 'text-amber-700' : 'text-slate-500'} />
                                                                             <span className={`font-bold ${wasBooked ? 'text-amber-700' : 'text-slate-500'}`}>
                                                                                 {slot.dayOfWeek || (slot.slotDate ? new Date(slot.slotDate).toLocaleDateString('en-US', { weekday: 'long' }) : 'N/A')}
                                                                             </span>
                                                                         </div>
                                                                         {slot.slotDate && (
                                                                             <p className={`text-sm font-semibold mb-2 ${wasBooked ? 'text-amber-600' : 'text-slate-500'}`}>
                                                                                 {new Date(slot.slotDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                                             </p>
                                                                         )}
                                                                         <div className="flex flex-wrap gap-1 mb-2">
                                                                             {timeArray.filter(t => t).map((time, tidx) => (
                                                                                 <span key={tidx} className={`px-2 py-1 rounded text-xs font-medium ${
                                                                                     wasBooked ? 'bg-amber-100 text-amber-700' : 'bg-slate-200 text-slate-600'
                                                                                 }`}>
                                                                                     {time}
                                                                                 </span>
                                                                             ))}
                                                                         </div>
                                                                         <span className={`inline-block mt-2 px-2 py-1 rounded-full text-xs font-bold ${
                                                                             wasBooked ? 'bg-amber-100 text-amber-800' : 'bg-slate-200 text-slate-600'
                                                                         }`}>
                                                                             {wasBooked ? 'Completed' : 'Expired'}
                                                                         </span>
                                                                     </div>
                                                                 );
                                                             })}
                                                         </div>
                                                     </div>
                                                 )}
                                             </div>
                                         );
                                     })()
                                 ) : (
                                     <div className="text-center py-8">
                                         <Icon name="Calendar" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500">No available slots configured</p>
                                     </div>
                                 )}
                             </div>
                         )}
                         
                         {activeTab === 'qualifications' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <Icon name="Award" size={24} className="text-amber-600" />
                                     Qualifications
                                 </h3>
                                 {selectedItem.data.qualifications && selectedItem.data.qualifications.length > 0 ? (
                                     <div className="space-y-4">
                                         {selectedItem.data.qualifications.map((qual, idx) => {
                                             // Extract document name and type
                                             const documentName = qual.documentName || qual.degreeName || qual.degree || qual.qualificationName || 'Qualification Document';
                                             const documentType = qual.documentType || qual.type || qual.qualificationType || 'Degree';
                                             const isVerified = qual.isVerified || qual.verified || qual.verificationStatus === 'VERIFIED' || qual.verificationStatus === 'APPROVED' || false;
                                             const documentPath = qual.documentPath || qual.documentUrl || qual.filePath || null;
                                             
                                             return (
                                                 <div key={idx} className="bg-amber-50 rounded-xl p-5 border-l-4 border-amber-500 hover:shadow-md transition-all">
                                                     <div className="flex justify-between items-start mb-3">
                                                         <div className="flex-1">
                                                             <div className="flex items-center gap-2 mb-2">
                                                                 <Icon name="Award" size={18} className="text-amber-600" />
                                                                 <h4 className="font-bold text-slate-900 text-lg">{documentName}</h4>
                                                             </div>
                                                             <div className="space-y-1">
                                                                 <p className="text-sm text-slate-700 flex items-center gap-2">
                                                                     <span className="font-semibold">Type:</span>
                                                                     <span className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-medium">{documentType}</span>
                                                                 </p>
                                                             </div>
                                                         </div>
                                                         <span className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 whitespace-nowrap ${
                                                             isVerified ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'
                                                         }`}>
                                                             <Icon name={isVerified ? 'BadgeCheck' : 'Clock'} size={12} />
                                                             {isVerified ? 'Verified' : 'Pending'}
                                                         </span>
                                                     </div>
                                                     <div className="flex gap-2 mt-3 pt-3 border-t border-amber-200">
                                                         <button 
                                                             onClick={() => {
                                                                 // Show placeholder certificate image
                                                                 window.open('https://static.toiimg.com/thumb/msid-65879382,imgsize-341916,width-400,height-225,resizemode-72/certifictae.jpg', '_blank');
                                                             }}
                                                             className="inline-flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors">
                                                             <Icon name="Eye" size={14} /> View
                                                         </button>
                                                         <button 
                                                             onClick={() => {
                                                                 alert('ðŸ“¥ Downloading...');
                                                             }}
                                                             className="inline-flex items-center gap-1 px-3 py-1.5 bg-teal-600 text-white rounded-lg text-sm font-medium hover:bg-teal-700 transition-colors">
                                                             <Icon name="Download" size={14} /> Download
                                                         </button>
                                                     </div>
                                                 </div>
                                             );
                                         })}
                                     </div>
                                 ) : (
                                     <div className="text-center py-8">
                                         <Icon name="Award" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500">No qualifications uploaded</p>
                                     </div>
                                 )}
                             </div>
                         )}
                         
                         {activeTab === 'prescriptions' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <h3 className="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                                     <Icon name="FileText" size={24} className="text-indigo-600" />
                                     Uploaded Prescriptions
                                 </h3>
                                 {selectedItem.data.uploadedPrescriptions && selectedItem.data.uploadedPrescriptions.length > 0 ? (
                                     (() => {
                                         const now = new Date();
                                         const ongoingPrescriptions = selectedItem.data.uploadedPrescriptions.filter(presc => {
                                             if (!presc.endDate && !presc.expiryDate) return true; // No end date = ongoing
                                             const endDate = new Date(presc.endDate || presc.expiryDate);
                                             return endDate >= now;
                                         });
                                         const pastPrescriptions = selectedItem.data.uploadedPrescriptions.filter(presc => {
                                             if (!presc.endDate && !presc.expiryDate) return false;
                                             const endDate = new Date(presc.endDate || presc.expiryDate);
                                             return endDate < now;
                                         });
                                         
                                         return (
                                             <div className="space-y-8">
                                                 {/* Ongoing Prescriptions */}
                                                 {ongoingPrescriptions.length > 0 && (
                                                     <div>
                                                         <h4 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                             <Icon name="Activity" size={18} className="text-green-600" />
                                                             Ongoing Prescriptions ({ongoingPrescriptions.length})
                                                         </h4>
                                                         <div className="space-y-4">
                                                             {ongoingPrescriptions.map((presc, idx) => (
                                                                 <div key={idx} className="bg-indigo-50 rounded-xl p-4 border-l-4 border-indigo-500 hover:shadow-md transition-all">
                                                                     <div className="flex justify-between items-start mb-2">
                                                                         <div className="flex-1">
                                                                             <h4 className="font-bold text-slate-900 text-lg">{presc.title || presc.medicationName || presc.name || 'Prescription'}</h4>
                                                                             <p className="text-sm text-slate-600 mt-1">{presc.description || presc.notes || 'No description'}</p>
                                                                         </div>
                                                                         <span className="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Active</span>
                                                                     </div>
                                                                     <div className="flex gap-4 mt-3 text-xs text-slate-500">
                                                                         {presc.startDate && <span>Start: {new Date(presc.startDate).toLocaleDateString()}</span>}
                                                                         {(presc.endDate || presc.expiryDate) && <span>End: {new Date(presc.endDate || presc.expiryDate).toLocaleDateString()}</span>}
                                                                         {presc.patientName && <span>Patient: {presc.patientName}</span>}
                                                                     </div>
                                                                 </div>
                                                             ))}
                                                         </div>
                                                     </div>
                                                 )}
                                                 
                                                 {/* Past Prescriptions */}
                                                 {pastPrescriptions.length > 0 && (
                                                     <div>
                                                         <h4 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                             <Icon name="History" size={18} className="text-slate-500" />
                                                             Past Prescriptions ({pastPrescriptions.length})
                                                         </h4>
                                                         <div className="space-y-4">
                                                             {pastPrescriptions.map((presc, idx) => (
                                                                 <div key={idx} className="bg-slate-50 rounded-xl p-4 border-l-4 border-slate-300 opacity-75">
                                                                     <div className="flex justify-between items-start mb-2">
                                                                         <div className="flex-1">
                                                                             <h4 className="font-bold text-slate-700 text-lg">{presc.title || presc.medicationName || presc.name || 'Prescription'}</h4>
                                                                             <p className="text-sm text-slate-500 mt-1">{presc.description || presc.notes || 'No description'}</p>
                                                                         </div>
                                                                         <span className="px-2 py-1 bg-slate-200 text-slate-600 rounded-full text-xs font-bold">Expired</span>
                                                                     </div>
                                                                     <div className="flex gap-4 mt-3 text-xs text-slate-400">
                                                                         {presc.startDate && <span>Start: {new Date(presc.startDate).toLocaleDateString()}</span>}
                                                                         {(presc.endDate || presc.expiryDate) && <span>End: {new Date(presc.endDate || presc.expiryDate).toLocaleDateString()}</span>}
                                                                         {presc.patientName && <span>Patient: {presc.patientName}</span>}
                                                                     </div>
                                                                 </div>
                                                             ))}
                                                         </div>
                                                     </div>
                                                 )}
                                             </div>
                                         );
                                     })()
                                 ) : (
                                     <div className="text-center py-8">
                                         <Icon name="FileText" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500">No prescriptions uploaded by this doctor</p>
                                     </div>
                                 )}
                             </div>
                         )}
                         
                         {activeTab === 'reviews' && (
                             <div className="bg-white rounded-2xl p-8 shadow-lg">
                                 <div className="flex items-center justify-between mb-6">
                                     <h3 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                         <Icon name="Star" size={24} className="text-amber-600" />
                                         Patient Reviews
                                     </h3>
                                     {selectedItem.data.patientReviews && selectedItem.data.patientReviews.length > 0 && (
                                         <div className="text-right">
                                             <div className="flex items-center gap-2">
                                                 <span className="text-3xl font-bold text-amber-600">{selectedItem.data.averageRating || 0}</span>
                                                 <div>
                                                     <div className="flex items-center gap-1">
                                                         {[...Array(5)].map((_, i) => (
                                                             <Icon key={i} name="Star" size={16} className={i < Math.round(selectedItem.data.averageRating || 0) ? 'text-amber-500 fill-amber-500' : 'text-slate-300'} />
                                                         ))}
                                                     </div>
                                                     <p className="text-xs text-slate-500">{selectedItem.data.reviewCount || 0} reviews</p>
                                                 </div>
                                             </div>
                                         </div>
                                     )}
                                 </div>
                                 {selectedItem.data.patientReviews && selectedItem.data.patientReviews.length > 0 ? (
                                     <div className="space-y-4">
                                         {selectedItem.data.patientReviews.map((review, idx) => {
                                             // Extract patient name from review object - handle both direct patientName and nested patient object
                                             const patientName = review.patientName || 
                                                 (review.patient ? `${review.patient.firstName || ''} ${review.patient.lastName || ''}`.trim() : null) ||
                                                 'Patient';
                                             
                                             return (
                                                 <div key={idx} className="bg-amber-50 rounded-xl p-5 border-l-4 border-amber-500 hover:shadow-md transition-all">
                                                     <div className="flex items-start justify-between mb-3">
                                                         <div className="flex items-center gap-3">
                                                             <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold">
                                                                 {patientName.charAt(0).toUpperCase()}
                                                             </div>
                                                             <div>
                                                                 <p className="font-semibold text-slate-900">{patientName}</p>
                                                                 <div className="flex items-center gap-2 mt-1">
                                                                     {[...Array(5)].map((_, i) => (
                                                                         <Icon key={i} name="Star" size={14} className={i < (review.rating || 0) ? 'text-amber-500 fill-amber-500' : 'text-slate-300'} />
                                                                     ))}
                                                                     <span className="text-sm font-bold text-amber-700">{review.rating}/5</span>
                                                                 </div>
                                                             </div>
                                                         </div>
                                                         {review.createdAt && (
                                                             <span className="text-xs text-slate-500">{new Date(review.createdAt).toLocaleDateString()}</span>
                                                         )}
                                                     </div>
                                                     <p className="text-slate-700 leading-relaxed italic">"{review.feedback || review.review || review.comment || 'No comment provided'}"</p>
                                                 </div>
                                             );
                                         })}
                                     </div>
                                 ) : (
                                     <div className="text-center py-12">
                                         <Icon name="Star" size={48} className="mx-auto text-slate-300 mb-3" />
                                         <p className="text-slate-500 text-lg">No reviews yet</p>
                                         <p className="text-slate-400 text-sm mt-2">This doctor hasn't received any patient reviews</p>
                                     </div>
                                 )}
                             </div>
                         )}
                     </div>
                 </div>
             );
        }

        // Appointment Detail View - Sidebar on RIGHT
        if (selectedItem && selectedItem.type === 'appointment') {
             return (
                 <div className="h-screen flex bg-gradient-to-br from-slate-50 to-slate-100">
                     {/* Left Content Area */}
                     <div className="flex-1 overflow-y-auto p-8">
                         <button onClick={handleBackNavigation} className="flex items-center gap-2 text-slate-600 hover:text-slate-900 mb-6 transition-colors">
                             <Icon name="ArrowLeft" size={20} />
                             <span className="font-medium">Back</span>
                         </button>
                         
                         <div className="bg-white rounded-2xl shadow-lg border border-slate-200 p-8">
                             <div className="mb-8 pb-6 border-b border-slate-200">
                                 <div className="flex items-center justify-between">
                                     <div>
                                         <h1 className="text-3xl font-bold text-slate-900 font-sans mb-2">Appointment #{selectedItem.data.appointmentId || selectedItem.data.id}</h1>
                                         <p className="text-slate-500">Complete appointment information</p>
                                     </div>
                                     <span className={`px-4 py-2 text-sm font-bold rounded-full capitalize border-2 ${
                                         selectedItem.data.type === 'emergency' || selectedItem.data.status === 'emergency' ? 'bg-rose-50 text-rose-700 border-rose-300' : 
                                         selectedItem.data.status === 'approved' || selectedItem.data.status === 'APPROVED' ? 'bg-emerald-50 text-emerald-700 border-emerald-300' : 
                                         selectedItem.data.status === 'pending' || selectedItem.data.status === 'PENDING' ? 'bg-amber-50 text-amber-700 border-amber-300' : 
                                         selectedItem.data.status === 'completed' || selectedItem.data.status === 'COMPLETED' ? 'bg-indigo-50 text-indigo-700 border-indigo-300' : 
                                         'bg-slate-50 text-slate-700 border-slate-300'
                                     }`}>
                                         {selectedItem.data.type === 'emergency' && selectedItem.data.status === 'completed' ? 'Emergency (Completed)' : 
                                          selectedItem.data.status}
                                     </span>
                                 </div>
                             </div>
                             
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                 <div className="space-y-6">
                                     <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                         <Icon name="User" size={20} className="text-purple-600" />
                                         Patient Information
                                     </h3>
                                     <div className="bg-purple-50 rounded-xl p-4 border-l-4 border-purple-500">
                                         <h4 className="text-sm font-semibold text-slate-500 mb-2">Patient Name</h4>
                                         <p className="text-lg font-bold text-slate-900">{selectedItem.data.patientName}</p>
                                     </div>
                                 </div>
                                 
                                 <div className="space-y-6">
                                     <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                         <Icon name="Stethoscope" size={20} className="text-indigo-600" />
                                         Doctor Information
                                     </h3>
                                     <div className="bg-indigo-50 rounded-xl p-4 border-l-4 border-indigo-500">
                                         <h4 className="text-sm font-semibold text-slate-500 mb-2">Doctor Name</h4>
                                         <p className="text-lg font-bold text-indigo-700">{selectedItem.data.doctorName}</p>
                                     </div>
                                 </div>
                             </div>

                             <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                                 <div className="bg-blue-50 rounded-xl p-4 border-l-4 border-blue-500">
                                     <div className="flex items-center gap-2 mb-2">
                                         <Icon name="Calendar" size={16} className="text-blue-600" />
                                         <h4 className="text-sm font-semibold text-slate-500">Date</h4>
                                     </div>
                                     <p className="text-lg font-bold text-slate-900">{selectedItem.data.appointmentDate || selectedItem.data.date}</p>
                                 </div>
                                 <div className="bg-teal-50 rounded-xl p-4 border-l-4 border-teal-500">
                                     <div className="flex items-center gap-2 mb-2">
                                         <Icon name="Clock" size={16} className="text-teal-600" />
                                         <h4 className="text-sm font-semibold text-slate-500">Time</h4>
                                     </div>
                                     <p className="text-lg font-bold text-slate-900">{selectedItem.data.appointmentTime || selectedItem.data.time}</p>
                                 </div>
                                 <div className="bg-emerald-50 rounded-xl p-4 border-l-4 border-emerald-500">
                                     <div className="flex items-center gap-2 mb-2">
                                         <Icon name="DollarSign" size={16} className="text-emerald-600" />
                                         <h4 className="text-sm font-semibold text-slate-500">Consultation Fee</h4>
                                     </div>
                                     <p className="text-lg font-bold text-emerald-700">â‚¹{selectedItem.data.consultationFee || selectedItem.data.fee || (() => {
                                         const doctor = doctorsList.find(d => d.name === selectedItem.data.doctorName || d.id === selectedItem.data.doctorId);
                                         return doctor?.consultationFee || doctor?.fee || 500;
                                     })()} (Paid)</p>
                                 </div>
                             </div>

                             <div className="mt-8 bg-amber-50 rounded-xl p-6 border-l-4 border-amber-500">
                                 <div className="flex items-center gap-2 mb-3">
                                     <Icon name="FileText" size={20} className="text-amber-600" />
                                     <h4 className="text-lg font-bold text-slate-900">Reason for Visit</h4>
                                 </div>
                                 <p className="text-slate-900 text-base leading-relaxed">{selectedItem.data.reason || 'Regular Checkup - No specific reason provided'}</p>
                             </div>

                             <div className="mt-8 grid grid-cols-2 gap-6">
                                 <div className="bg-slate-50 rounded-xl p-4">
                                     <h4 className="text-sm font-semibold text-slate-500 mb-2">Appointment Type</h4>
                                     <p className="text-base font-bold text-slate-900 capitalize">{selectedItem.data.type || 'Regular'}</p>
                                 </div>
                                 <div className="bg-slate-50 rounded-xl p-4">
                                     <h4 className="text-sm font-semibold text-slate-500 mb-2">Appointment ID</h4>
                                     <p className="text-base font-mono font-bold text-slate-900">{selectedItem.data.appointmentId || selectedItem.data.id}</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     {/* Right Sidebar - Admin Navigation */}
                     <aside className="w-64 sidebar-glass shadow-2xl overflow-y-auto">
                         <div className="p-6 border-b border-white/20">
                             <div className="flex items-center gap-3">
                                 <img src="/medvault-logo.png" alt="MedVault" className="w-10 h-10 object-contain" />
                                 <span className="text-xl font-bold text-white">MedVault</span>
                             </div>
                         </div>

                         <nav className="flex-1 py-4 px-3">
                             <button 
                                 onClick={() => { setSelectedItem(null); setActiveView('dashboard'); }}
                                 className="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all font-sans mb-2 text-white/80 hover:bg-white/10">
                                 <Icon name="LayoutDashboard" size={20} />
                                 <span>Dashboard</span>
                             </button>
                             
                             <button 
                                 onClick={() => { setSelectedItem(null); setActiveView('patients-all'); }}
                                 className="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all font-sans mb-2 text-white/80 hover:bg-white/10">
                                 <Icon name="Users" size={20} />
                                 <span>Manage Patients</span>
                             </button>
                             
                             <button 
                                 onClick={() => { setSelectedItem(null); setActiveView('doctors-all'); }}
                                 className="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all font-sans mb-2 text-white/80 hover:bg-white/10">
                                 <Icon name="Stethoscope" size={20} />
                                 <span>Manage Doctors</span>
                             </button>
                             
                             <button 
                                 onClick={() => { setSelectedItem(null); setActiveView('appointments'); }}
                                 className="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all font-sans mb-2 bg-white/20 text-white font-semibold shadow-lg">
                                 <Icon name="Calendar" size={20} />
                                 <span>Appointments</span>
                             </button>
                             
                             <button 
                                 onClick={() => { setSelectedItem(null); setActiveView('emergency'); }}
                                 className="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all font-sans mb-2 text-white/80 hover:bg-white/10">
                                 <Icon name="Siren" size={20} />
                                 <span>Emergency</span>
                             </button>
                         </nav>
                     </aside>
                 </div>
             );
        }

        const DoctorAppointmentRow = ({ doctor }) => {
            const [expanded, setExpanded] = useState(false);
            const [activeTab, setActiveTab] = useState('all');
            const tabs = ['all', 'upcoming', 'pending', 'emergency', 'approved', 'rejected'];
            return (
                <>
                    <tr className={`hover:bg-slate-50 transition-colors ${expanded ? 'bg-slate-50' : ''}`}>
                        <td className="py-4 px-6">
                            <div className="font-medium text-slate-900">{doctor.name}</div>
                            <div className="text-sm text-slate-500">{doctor.email}</div>
                        </td>
                        <td className="py-4 px-6">
                            <div className="flex gap-2">
                                {doctor.appointments.emergency > 0 && <span className="px-2 py-1 bg-rose-100 text-rose-700 text-xs font-bold rounded-full flex items-center gap-1"><Icon name="Siren" size={12} /> {doctor.appointments.emergency}</span>}
                                <span className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">{doctor.appointments.upcoming} Upcoming</span>
                            </div>
                        </td>
                        <td className="py-4 px-6 text-right">
                            <button onClick={() => setExpanded(!expanded)} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors">
                                <Icon name={expanded ? "ChevronUp" : "ChevronDown"} size={20} />
                            </button>
                        </td>
                    </tr>
                    {expanded && (
                        <tr>
                            <td colSpan="3" className="p-0">
                                <div className="bg-slate-50/50 border-y border-slate-200 p-6 animate-fadeIn">
                                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                                        {tabs.map(tab => (
                                            <button key={tab} onClick={() => setActiveTab(tab)}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium capitalize whitespace-nowrap transition-all font-sans
                                                    ${activeTab === tab ? 'bg-white text-teal-700 shadow-sm' : 'text-slate-500 hover:text-teal-700 hover:bg-teal-50/50'}`}>
                                                {tab}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="bg-white rounded-xl border border-slate-200 p-6 text-center text-slate-500 font-sans">
                                        <Icon name="Calendar" size={40} className="mx-auto text-slate-300 mb-3" />
                                        <p>No {activeTab} appointments for {doctor.name}.</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    )}
                </>
            );
        };

        return (
            <div className="flex h-screen overflow-hidden admin-gradient-bg">
                {/* Retractable Sidebar with Glass Effect - Shows icons when collapsed */}
                <aside className={`fixed inset-y-0 left-0 z-50 sidebar-glass shadow-2xl sidebar-transition ${sidebarOpen ? 'w-64' : 'w-16'}`}>
                    
                    {/* Sidebar Header with Menu Toggle */}
                    <div className={`p-4 border-b border-white/20 ${sidebarOpen ? 'px-6' : 'px-3'}`}>
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={() => setSidebarOpen(!sidebarOpen)}
                                className="p-2 hover:bg-white/10 rounded-lg transition-colors text-white"
                                title={sidebarOpen ? "Collapse Menu" : "Expand Menu"}>
                                <Icon name="Menu" size={20} />
                            </button>
                            {sidebarOpen && (
                                <>
                                    <img src="/medvault-logo.png" alt="MedVault" className="w-10 h-10 object-contain" />
                                    <span className="text-xl font-bold text-white">MedVault</span>
                                </>
                            )}
                        </div>
                    </div>

                    {/* Sidebar Navigation */}
                    <nav className={`flex-1 overflow-y-auto overflow-x-auto py-4 ${sidebarOpen ? 'px-3' : 'px-2'} sidebar-scroll`}>
                        <button 
                            onClick={() => setActiveView('dashboard')}
                            title="Dashboard"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'dashboard' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="LayoutDashboard" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Dashboard</span>}
                        </button>
                        
                        <button 
                            onClick={() => setActiveView('patients-all')}
                            title="Manage Patients"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'patients-all' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="Users" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Manage Patients</span>}
                        </button>
                        
                        <button 
                            onClick={() => setActiveView('doctors-all')}
                            title="Manage Doctors"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'doctors-all' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="Stethoscope" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Manage Doctors</span>}
                        </button>
                        
                        <button 
                            onClick={() => setActiveView('appointments')}
                            title="Appointments"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'appointments' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="Calendar" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Appointments</span>}
                        </button>
                        
                        <button 
                            onClick={() => setActiveView('documents')}
                            title="Document Verification"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'documents' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="FileCheck" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Document Verification</span>}
                        </button>
                        
                        <button 
                            onClick={() => setActiveView('emergency')}
                            title="Emergency Requests"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'emergency' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="Siren" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Emergency Requests</span>}
                        </button>
                        
                        <button 
                            onClick={() => setActiveView('issues')}
                            title="Manage Issues"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'issues' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="AlertTriangle" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Manage Issues</span>}
                        </button>
                        
                        <button 
                            onClick={() => setActiveView('settings')}
                            title="Settings"
                            className={`w-full flex items-center ${sidebarOpen ? 'gap-3 px-4' : 'justify-center px-2'} py-3 rounded-lg transition-all font-sans mb-2 text-base ${
                                activeView === 'settings' 
                                    ? 'bg-white/20 text-white font-semibold shadow-lg' 
                                    : 'text-white/80 hover:bg-white/10'
                            }`}>
                            <Icon name="Settings" size={22} />
                            {sidebarOpen && <span className="whitespace-nowrap">Settings</span>}
                        </button>
                    </nav>
                    
                    {/* Logout Button - Bright Red */}
                    <div className={`p-4 border-t border-white/20 ${sidebarOpen ? '' : 'px-2'}`}>
                        <button 
                            onClick={onLogout} 
                            title="Log Out"
                            className={`w-full flex items-center justify-center ${sidebarOpen ? 'gap-2 px-4' : 'px-2'} py-3 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition-all font-medium font-sans shadow-xl`}>
                            <Icon name="LogOut" size={20} />
                            {sidebarOpen && <span>Log Out</span>}
                        </button>
                    </div>
                </aside>

                {/* Main Content Area */}
                <div className={`flex-1 flex flex-col transition-all duration-300 ${sidebarOpen ? 'ml-64' : 'ml-16'}`}>
                    {/* Top Header with Glass Effect */}
                    <header className="header-glass shadow-lg sticky top-0 z-40">
                        <div className="flex items-center justify-between px-6 py-4">
                            {/* Left: Logo */}
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-3">
                                    <img src="/medvault-logo.png" alt="MedVault" className="w-8 h-8 object-contain" />
                                    <span className="text-xl font-bold text-white hidden md:block">MedVault Admin</span>
                                </div>
                            </div>

                            {/* Right: Home + Notifications */}
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => { 
                                        sessionStorage.removeItem('adminUser'); 
                                        window.location.href = '/'; 
                                    }}
                                    className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-all shadow-sm"
                                    title="Go to Home Page">
                                    <Icon name="Home" size={18} />
                                    <span className="hidden md:inline text-sm font-medium">Home</span>
                                </button>
                                <div className="relative">
                                    <button 
                                        onClick={() => setNotificationOpen(!notificationOpen)}
                                        className="relative p-2.5 bg-white/20 hover:bg-white/30 rounded-lg transition-all shadow-sm">
                                        <Icon name="Bell" size={20} className="text-white" />
                                        {unreadCount > 0 && (
                                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-rose-500 text-white text-xs font-bold rounded-full flex items-center justify-center animate-pulse">
                                                {unreadCount > 9 ? '9+' : unreadCount}
                                            </span>
                                        )}
                                    </button>
                                    {notificationOpen && (
                                        <>
                                            <div className="fixed inset-0 z-40" onClick={() => setNotificationOpen(false)}></div>
                                            <div className="absolute right-0 mt-2 w-96 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 animate-fadeIn max-h-96 overflow-hidden flex flex-col">
                                                <div className="p-4 border-b border-slate-200 flex items-center justify-between">
                                                    <h3 className="font-bold text-slate-900">Notifications</h3>
                                                    {unreadCount > 0 && (
                                                        <button 
                                                            onClick={markAllNotificationsAsRead}
                                                            className="text-xs text-indigo-600 hover:text-indigo-700 font-medium">
                                                            Mark all as read
                                                        </button>
                                                    )}
                                                </div>
                                                <div className="overflow-y-auto flex-1">
                                                    {notifications.length > 0 ? (
                                                        <div className="divide-y divide-slate-100">
                                                            {notifications.map(notif => (
                                                                <div 
                                                                    key={notif.notificationId}
                                                                    className={`p-4 hover:bg-slate-50 transition-colors cursor-pointer ${!notif.isRead ? 'bg-indigo-50/50' : ''}`}
                                                                    onClick={() => handleNotificationClick(notif)}>
                                                                    <div className="flex gap-3">
                                                                        <div className={`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${!notif.isRead ? 'bg-indigo-600' : 'bg-slate-300'}`}></div>
                                                                        <div className="flex-1 min-w-0">
                                                                            <p className="font-semibold text-slate-900 text-sm">{notif.title}</p>
                                                                            <p className="text-slate-600 text-xs mt-1 line-clamp-2">{notif.message}</p>
                                                                            <p className="text-slate-400 text-xs mt-1">{formatNotificationTime(notif.createdAt)}</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="p-8 text-center">
                                                            <Icon name="Bell" size={48} className="mx-auto text-slate-300 mb-3" />
                                                            <p className="text-slate-500">No notifications</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content with Glass Container */}
                    <main className="flex-1 overflow-y-auto p-6">
                        <div className="max-w-7xl mx-auto glass-card rounded-2xl p-8 shadow-xl">
                        {activeView === 'dashboard' && renderDashboardHome()}

                        {activeView === 'patients-all' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header - Purple Background */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={adminProfile?.profilePictureUrl || user.photoURL || `https://ui-avatars.com/api/?name=${adminProfile?.name || user.displayName || 'Admin'}&background=6366f1&color=fff&size=60`} 
                                            alt={adminProfile?.name || user.displayName}
                                            className="w-14 h-14 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {adminProfile?.name || user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/90 text-sm font-sans">{adminProfile?.email || user.email || 'Managing Patients'}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-800 font-sans">All Patients</h2>
                                    <div className="flex gap-3">
                                        <div className="relative">
                                            <Icon name="Search" size={20} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                            <input 
                                                type="text" 
                                                placeholder="Search patients..." 
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="pl-10 pr-4 py-2.5 rounded-lg glass-card focus:ring-2 focus:ring-purple-500 w-64 font-sans outline-none" 
                                            />
                                        </div>
                                        <select 
                                            value={filterType}
                                            onChange={(e) => setFilterType(e.target.value)}
                                            className="px-4 py-2.5 rounded-lg glass-card focus:ring-2 focus:ring-purple-500 font-sans outline-none">
                                            <option value="all">All Patients</option>
                                        </select>
                                    </div>
                                </div>
                                {patientsList.length === 0 ? (
                                    <div className="glass-card rounded-xl p-12 text-center">
                                        <Icon name="Users" size={48} className="mx-auto text-slate-300 mb-4" />
                                        <h3 className="text-lg font-bold text-slate-700 mb-2">No Patients Found</h3>
                                        <p className="text-slate-500">No patient records available in the system.</p>
                                        <button 
                                            onClick={fetchAllData}
                                            className="mt-4 px-4 py-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200 transition-colors">
                                            Refresh Data
                                        </button>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {patientsList.filter(p => 
                                            p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                            p.email.toLowerCase().includes(searchTerm.toLowerCase())
                                        ).filter(p => filterType === 'all' || p.status === filterType).map(patient => (
                                            <div key={patient.id} className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-lg transition-all">
                                                <div className="flex items-start justify-between mb-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold">
                                                            {patient.name.charAt(0)}
                                                        </div>
                                                        <div>
                                                            <h3 className="font-bold text-slate-900">{patient.name}</h3>
                                                            <p className="text-sm text-slate-500">Patient</p>
                                                        </div>
                                                    </div>
                                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
                                                        Active
                                                    </span>
                                                </div>
                                                
                                                <div className="space-y-2 mb-4">
                                                    <div className="flex items-center gap-2 text-sm text-slate-600">
                                                        <Icon name="Mail" size={14} />
                                                        <span className="truncate">{patient.email}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-slate-600">
                                                        <Icon name="Phone" size={14} />
                                                        <span>{patient.phone && patient.phone !== 'N/A' ? patient.phone : (patient.phoneNumber || 'Not provided')}</span>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-3 gap-3 mb-4 pt-4 border-t border-slate-100">
                                                    <div className="flex flex-col items-center">
                                                        <Icon name="Calendar" size={16} className="text-indigo-500 mb-1" />
                                                        <p className="text-xs text-slate-500">Appointments</p>
                                                        <p className="font-semibold text-indigo-600">{patient.totalAppointments || 0}</p>
                                                    </div>
                                                    <div className="flex flex-col items-center">
                                                        <Icon name="FileText" size={16} className="text-emerald-500 mb-1" />
                                                        <p className="text-xs text-slate-500">Records</p>
                                                        <p className="font-semibold text-emerald-600">{patient.totalRecords || 0}</p>
                                                    </div>
                                                    <div className="flex flex-col items-center">
                                                        <img 
                                                            src="https://cdn-icons-png.flaticon.com/128/13784/13784158.png" 
                                                            alt="Medical Conditions" 
                                                            className="w-4 h-4 mb-1"
                                                        />
                                                        <p className="text-xs text-slate-500">Conditions</p>
                                                        <p className="font-semibold text-amber-600">{patient.totalConditions || 0}</p>
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-4 mb-4 pb-4 border-b border-slate-100">
                                                    <div>
                                                        <p className="text-xs text-slate-500">Age</p>
                                                        <p className="font-semibold text-slate-900">
                                                            {patient.age && patient.age !== 'N/A' ? patient.age : 
                                                             patient.dateOfBirth ? (() => {
                                                                const birthDate = new Date(patient.dateOfBirth);
                                                                const today = new Date();
                                                                let age = today.getFullYear() - birthDate.getFullYear();
                                                                const monthDiff = today.getMonth() - birthDate.getMonth();
                                                                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) age--;
                                                                return age;
                                                             })() : 'N/A'}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-slate-500">Blood Group</p>
                                                        <p className="font-semibold text-slate-900">{patient.bloodGroup || patient.bloodType || 'N/A'}</p>
                                                    </div>
                                                </div>

                                                <div className="flex items-center gap-2 text-sm text-slate-600 mb-4">
                                                    <Icon name="Calendar" size={14} />
                                                    <span>Joined: {patient.joinedDate || new Date(patient.createdAt).toLocaleDateString()}</span>
                                                </div>

                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => handleViewDetails('patient', patient)}
                                                        className="flex-1 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors text-sm font-medium flex items-center justify-center gap-2">
                                                        <Icon name="Eye" size={16} />
                                                        View Profile
                                                    </button>
                                                    <button 
                                                        onClick={async () => {
                                                            if (confirm(`Are you sure you want to delete patient ${patient.name}?`)) {
                                                                try {
                                                                    const response = await fetch(`${API_BASE_URL}/admin/patients/${patient.id}`, { method: 'DELETE' });
                                                                    if (response.ok) {
                                                                        alert('âœ… Patient deleted successfully!');
                                                                        fetchAllData();
                                                                    } else {
                                                                        alert('âŒ Failed to delete patient');
                                                                    }
                                                                } catch (error) {
                                                                    alert('âŒ Error deleting patient');
                                                                }
                                                            }
                                                        }}
                                                        className="p-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-100 transition-colors"
                                                        title="Delete">
                                                        <Icon name="Trash2" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeView === 'doctors-all' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header - Purple Background */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={adminProfile?.profilePictureUrl || user.photoURL || `https://ui-avatars.com/api/?name=${adminProfile?.name || user.displayName || 'Admin'}&background=6366f1&color=fff&size=60`} 
                                            alt={adminProfile?.name || user.displayName}
                                            className="w-16 h-16 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {adminProfile?.name || user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                                <Icon name="Mail" size={14} className="text-white/80" />
                                                {adminProfile?.email || user.email || 'admin@medvault.com'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-slate-800 font-sans">All Doctors</h2>
                                    <div className="flex gap-3">
                                        <div className="relative">
                                            <Icon name="Search" size={20} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                            <input 
                                                type="text" 
                                                placeholder="Search doctors..." 
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="pl-10 pr-4 py-2.5 rounded-lg glass-card focus:ring-2 focus:ring-purple-500 w-64 font-sans outline-none" 
                                            />
                                        </div>
                                        <select 
                                            value={filterType}
                                            onChange={(e) => setFilterType(e.target.value)}
                                            className="px-4 py-2.5 rounded-lg glass-card focus:ring-2 focus:ring-purple-500 font-sans outline-none">
                                            <option value="all">All Specializations</option>
                                            <option value="General Physician">General Physician</option>
                                            <option value="Dentist">Dentist</option>
                                            <option value="Cardiologist">Cardiologist</option>
                                            <option value="Dermatologist">Dermatologist</option>
                                            <option value="Orthopedist">Orthopedist</option>
                                            <option value="Pediatrician">Pediatrician</option>
                                            <option value="Neurologist">Neurologist</option>
                                            <option value="Gynecologist">Gynecologist</option>
                                            <option value="Psychiatrist">Psychiatrist</option>
                                            <option value="Ophthalmologist">Ophthalmologist</option>
                                        </select>
                                        <select 
                                            value={filterType}
                                            onChange={(e) => setFilterType(e.target.value)}
                                            className="px-4 py-2.5 rounded-lg glass-card focus:ring-2 focus:ring-purple-500 font-sans outline-none">
                                            <option value="all">All Status</option>
                                            <option value="verified">Verified</option>
                                            <option value="pending">Pending</option>
                                        </select>
                                    </div>
                                </div>
                                {doctorsList.length === 0 ? (
                                    <div className="glass-card rounded-xl p-12 text-center">
                                        <Icon name="Stethoscope" size={48} className="mx-auto text-slate-300 mb-4" />
                                        <h3 className="text-lg font-bold text-slate-700 mb-2">No Doctors Found</h3>
                                        <p className="text-slate-500">No doctor records available in the system.</p>
                                        <button 
                                            onClick={fetchAllData}
                                            className="mt-4 px-4 py-2 bg-purple-100 text-purple-600 rounded-lg hover:bg-purple-200 transition-colors">
                                            Refresh Data
                                        </button>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {doctorsList.filter(d => {
                                            const matchesSearch = d.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                                                 d.email.toLowerCase().includes(searchTerm.toLowerCase());
                                            const matchesSpecialization = filterType === 'all' || d.specialization.toLowerCase() === filterType.toLowerCase();
                                            const matchesStatus = filterType === 'verified' ? d.isVerified : filterType === 'pending' ? !d.isVerified : true;
                                            return matchesSearch && (filterType === 'all' || filterType === 'verified' || filterType === 'pending' ? matchesStatus : matchesSpecialization);
                                        }).map(doctor => (
                                            <div key={doctor.id} className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-lg transition-all">
                                                <div className="flex items-start justify-between mb-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold">
                                                            {doctor.name.replace('Dr. ', '').charAt(0).toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <h3 className="font-bold text-slate-900">{doctor.name}</h3>
                                                            <p className="text-sm text-indigo-600">{doctor.specialization}</p>
                                                        </div>
                                                    </div>
                                                    {doctor.isVerified 
                                                        ? <span className="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold flex items-center gap-1">
                                                            <Icon name="BadgeCheck" size={14} />
                                                            Verified
                                                          </span>
                                                        : <span className="px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">Pending</span>
                                                    }
                                                </div>
                                                
                                                <div className="space-y-2 mb-4">
                                                    <div className="flex items-center gap-2 text-sm text-slate-600">
                                                        <Icon name="Star" size={14} className="text-amber-500" />
                                                        <span className="font-medium">{doctor.rating || doctor.averageRating || '0.0'}</span>
                                                        <span className="text-slate-400">({doctor.reviewCount || doctor.totalReviews || 0} reviews)</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-slate-600">
                                                        <Icon name="Mail" size={14} />
                                                        <span className="truncate">{doctor.email && doctor.email !== 'N/A' ? doctor.email : 'Not provided'}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm text-slate-600">
                                                        <Icon name="Phone" size={14} />
                                                        <span>{doctor.phone && doctor.phone !== 'N/A' ? doctor.phone : (doctor.phoneNumber || 'Not provided')}</span>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-2 gap-4 mb-4 pt-4 border-t border-slate-100">
                                                    <div>
                                                        <p className="text-xs text-slate-500">Experience</p>
                                                        <p className="font-semibold text-slate-900">{doctor.experienceYears || doctor.experience || 0} years</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-slate-500">Fee</p>
                                                        <p className="font-semibold text-emerald-600 font-bold">â‚¹{doctor.consultationFee || doctor.fee || 500}</p>
                                                    </div>
                                                </div>

                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => handleViewDetails('doctor', doctor)}
                                                        className="flex-1 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors text-sm font-medium flex items-center justify-center gap-2">
                                                        <Icon name="Eye" size={16} />
                                                        View Profile
                                                    </button>
                                                    <button 
                                                        onClick={async () => {
                                                            if (confirm(`Are you sure you want to delete Dr. ${doctor.name}?`)) {
                                                                try {
                                                                    const response = await fetch(`${API_BASE_URL}/admin/doctors/${doctor.id}`, { method: 'DELETE' });
                                                                    if (response.ok) {
                                                                        alert('âœ… Doctor deleted successfully!');
                                                                        fetchAllData();
                                                                    } else {
                                                                        alert('âŒ Failed to delete doctor');
                                                                    }
                                                                } catch (error) {
                                                                    alert('âŒ Error deleting doctor');
                                                                }
                                                            }
                                                        }}
                                                        className="p-2 bg-rose-50 text-rose-600 rounded-lg hover:bg-rose-100 transition-colors"
                                                        title="Delete">
                                                        <Icon name="Trash2" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                         {activeView === 'doctors-qualification' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={adminProfile?.profilePictureUrl || user.photoURL || `https://ui-avatars.com/api/?name=${adminProfile?.name || user.displayName || 'Admin'}&background=6366f1&color=fff&size=60`} 
                                            alt={adminProfile?.name || user.displayName}
                                            className="w-16 h-16 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {adminProfile?.name || user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                                <Icon name="Mail" size={14} className="text-white/80" />
                                                {adminProfile?.email || user.email || 'admin@medvault.com'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <h2 className="text-xl font-bold text-slate-800 font-sans">Doctor Qualification Verification</h2>
                                <AdminTable headers={['Doctor Details', 'Document Type', 'Date Uploaded', 'Status', 'Actions']}>
                                    {qualificationsList.length > 0 ? qualificationsList.map(qual => (
                                        <tr key={qual.qualificationId} className={`hover:bg-slate-50 transition-colors ${qual.verificationStatus === 'APPROVED' ? 'bg-emerald-50/30' : 'bg-white'}`}>
                                            <td className="py-4 px-6">
                                                <div className="font-medium text-slate-900">{qual.doctorName || `${qual.doctor?.firstName || ''} ${qual.doctor?.lastName || ''}`.trim()}</div>
                                                <div className="text-sm text-indigo-600">{qual.specialization || qual.doctor?.specialization || 'N/A'}</div>
                                                <div className="text-xs text-slate-500 mt-1">{qual.doctorEmail || qual.doctor?.email || ''}</div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="flex flex-col gap-1">
                                                    <div className="flex items-center gap-2">
                                                        <Icon name="FileText" size={16} className="text-slate-400" />
                                                        <span className="text-sm font-medium">{qual.documentType || qual.qualificationType || 'Medical Certificate'}</span>
                                                    </div>
                                                    <span className="text-xs text-slate-500">{qual.documentName || 'Document'}</span>
                                                </div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <span className="text-sm text-slate-600">
                                                    {qual.uploadedAt ? new Date(qual.uploadedAt).toLocaleDateString() : 'N/A'}
                                                </span>
                                            </td>
                                            <td className="py-4 px-6">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 whitespace-nowrap ${
    (qual.verificationStatus === 'APPROVED' || qual.verificationStatus === 'VERIFIED' || qual.isVerified) 
    ? 'bg-emerald-100 text-emerald-700' 
    : 'bg-amber-100 text-amber-700'
}`}>
    <Icon name={(qual.verificationStatus === 'APPROVED' || qual.verificationStatus === 'VERIFIED') ? 'BadgeCheck' : 'Clock'} size={12} />
    {(qual.verificationStatus === 'APPROVED' || qual.verificationStatus === 'VERIFIED') ? 'Verified' : 'Pending'}
</span>
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            setSelectedDocumentForView({
                                                                id: qual.qualificationId,
                                                                doctorName: qual.doctorName || `${qual.doctor?.firstName || ''} ${qual.doctor?.lastName || ''}`.trim(),
                                                                documentType: qual.documentType || qual.qualificationType || 'Medical Certificate',
                                                                documentName: qual.documentName || 'Document',
                                                                uploadedDate: qual.uploadedAt ? new Date(qual.uploadedAt).toLocaleDateString() : 'N/A',
                                                                documentPath: qual.documentPath
                                                            });
                                                            setShowDocumentViewModal(true);
                                                        }}
                                                        className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 transition-colors font-sans flex items-center gap-1">
                                                        <Icon name="Eye" size={14} />
                                                        View
                                                    </button>
                                                    {qual.verificationStatus !== 'APPROVED' && (
                                                        <button 
                                                            onClick={() => handleVerifyDoctor(qual.qualificationId)} 
                                                            className="px-3 py-1.5 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-lg text-sm font-medium hover:from-emerald-700 hover:to-teal-600 transition-all shadow-md hover:shadow-lg font-sans flex items-center gap-1">
                                                            <Icon name="CheckCircle" size={14} />
                                                            Verify
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    )) : doctorsList.map(doc => (
                                        <tr key={doc.id} className={`hover:bg-slate-50 transition-colors ${doc.isVerified ? 'bg-emerald-50/30' : 'bg-white'}`}>
                                            <td className="py-4 px-6">
                                                <div className="font-medium text-slate-900">{doc.name}</div>
                                                <div className="text-sm text-indigo-600">{doc.specialization}</div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="FileText" size={16} className="text-slate-400" />
                                                    <span className="text-sm font-medium">Medical Certificate</span>
                                                </div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <span className="text-sm text-slate-600">N/A</span>
                                            </td>
                                            <td className="py-4 px-6">
                                                {doc.isVerified
                                                    ? <span className="flex items-center gap-1 text-emerald-600 font-bold"><Icon name="BadgeCheck" size={16} /> Verified</span>
                                                    : <span className="flex items-center gap-1 text-amber-600 font-medium"><Icon name="Clock" size={16} /> Pending</span>
                                                }
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => alert('No document uploaded yet')}
                                                        className="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 transition-colors font-sans flex items-center gap-1">
                                                        <Icon name="Eye" size={14} />
                                                        View
                                                    </button>
                                                    {!doc.isVerified && (
                                                        <button 
                                                            onClick={() => handleVerifyDoctor(doc.id)} 
                                                            className="px-3 py-1.5 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-lg text-sm font-medium hover:from-emerald-700 hover:to-teal-600 transition-all shadow-md hover:shadow-lg font-sans flex items-center gap-1">
                                                            <Icon name="CheckCircle" size={14} />
                                                            Verify
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </AdminTable>
                            </div>
                        )}

                        {activeView === 'doctors-appointments' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={user.photoURL || 'https://placehold.co/60x60/6366f1/ffffff?text=AD'} 
                                            alt={user.displayName}
                                            className="w-16 h-16 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                                <Icon name="Mail" size={14} className="text-white/80" />
                                                {user.email || 'admin@medvault.com'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <header>
                                    <h2 className="text-xl font-bold text-slate-800 font-sans">Master Appointment Manager</h2>
                                    <p className="text-slate-500 font-sans">Expand a doctor row to manage their specific schedules.</p>
                                </header>
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                    <table className="w-full">
                                        <thead className="bg-slate-50 border-b border-slate-100">
                                            <tr>
                                                <th className="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase">Doctor</th>
                                                <th className="text-left py-4 px-6 text-xs font-semibold text-slate-500 uppercase">Quick Status</th>
                                                <th className="text-right py-4 px-6 text-xs font-semibold text-slate-500 uppercase">Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {doctorsList.map(doctor => <DoctorAppointmentRow key={doctor.id} doctor={doctor} />)}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeView === 'appointments' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header - Purple Background */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={user.photoURL || 'https://placehold.co/60x60/ffffff/6366f1?text=AD'} 
                                            alt={user.displayName}
                                            className="w-16 h-16 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                                <Icon name="Mail" size={14} className="text-white/80" />
                                                {user.email || 'admin@medvault.com'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800 font-sans">All Appointments</h2>
                                        <p className="text-slate-500 font-sans">Manage and monitor all system appointments</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="relative">
                                            <Icon name="Search" size={20} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                            <input 
                                                type="text" 
                                                placeholder="Search Patients, Doctors, etc..." 
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="pl-10 pr-4 py-2.5 rounded-lg glass-card focus:ring-2 focus:ring-purple-500 w-64 font-sans outline-none" 
                                            />
                                        </div>
                                        {['all', 'pending', 'approved', 'emergency', 'completed', 'rejected'].map(status => (
                                            <button 
                                                key={status} 
                                                onClick={() => setAppointmentFilter(status)}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all capitalize font-sans ${
                                                    appointmentFilter === status 
                                                        ? status === 'emergency' ? 'bg-rose-500 text-white shadow-lg' :
                                                          status === 'approved' ? 'bg-emerald-500 text-white shadow-lg' :
                                                          status === 'pending' ? 'bg-amber-500 text-white shadow-lg' :
                                                          status === 'completed' ? 'bg-indigo-500 text-white shadow-lg' :
                                                          status === 'rejected' ? 'bg-slate-500 text-white shadow-lg' :
                                                          'bg-indigo-500 text-white shadow-lg'
                                                        : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'
                                                }`}>
                                                {status === 'emergency' ? 'Emergency (Completed)' : status}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <AdminTable headers={appointmentFilter === 'completed' || appointmentFilter === 'emergency' || appointmentFilter === 'all' ? ['Patient', 'Doctor', 'Date & Time', 'Reason', 'Fee', 'Status', 'Feedback'] : ['Patient', 'Doctor', 'Date & Time', 'Reason', 'Fee', 'Status']}>
                                    {(() => {
                                        const filteredAppointments = appointmentsList.filter(apt => {
                                            const matchesSearch = apt.patientName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                                                apt.doctorName.toLowerCase().includes(searchTerm.toLowerCase());
                                            let matchesFilter = appointmentFilter === 'all';
                                            if (appointmentFilter === 'cancelled') {
                                                matchesFilter = apt.status === 'cancelled' || apt.status === 'rejected';
                                            } else if (appointmentFilter === 'emergency') {
                                                matchesFilter = apt.type === 'EMERGENCY' && apt.status.toLowerCase() === 'completed';
                                            } else if (appointmentFilter === 'completed') {
                                                matchesFilter = apt.status.toLowerCase() === 'completed' && apt.type !== 'EMERGENCY';
                                            } else {
                                                matchesFilter = matchesFilter || apt.status.toLowerCase() === appointmentFilter;
                                            }
                                            return matchesSearch && matchesFilter;
                                        });
                                        
                                        if (filteredAppointments.length === 0) {
                                            const filterMessages = {
                                                'all': { icon: 'Calendar', text: 'No appointments found', subtext: 'Appointments will appear here once booked' },
                                                'pending': { icon: 'Clock', text: 'No pending appointments', subtext: 'Appointments awaiting approval will appear here' },
                                                'approved': { icon: 'CheckCircle', text: 'No approved appointments', subtext: 'Approved appointments will appear here' },
                                                'emergency': { icon: 'AlertTriangle', text: 'No emergency appointments', subtext: 'Completed emergency appointments will appear here' },
                                                'completed': { icon: 'CheckCircle2', text: 'No completed appointments', subtext: 'Completed appointments will appear here' },
                                                'rejected': { icon: 'XCircle', text: 'No rejected appointments', subtext: 'Rejected appointments will appear here' },
                                                'cancelled': { icon: 'XCircle', text: 'No cancelled appointments', subtext: 'Cancelled appointments will appear here' }
                                            };
                                            const msg = filterMessages[appointmentFilter] || filterMessages['all'];
                                            return (
                                                <tr>
                                                    <td colSpan={appointmentFilter === 'completed' || appointmentFilter === 'emergency' || appointmentFilter === 'all' ? 7 : 6} className="py-12 text-center">
                                                        <div className="flex flex-col items-center justify-center">
                                                            <Icon name={msg.icon} size={48} className="text-slate-300 mb-4" />
                                                            <p className="text-slate-500 font-medium">{msg.text}</p>
                                                            <p className="text-slate-400 text-sm mt-1">{msg.subtext}</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        }
                                        
                                        return filteredAppointments.map(apt => (
                                        <tr key={apt.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="py-4 px-6">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                        {apt.patientName.charAt(0)}
                                                    </div>
                                                    <span className="font-medium text-slate-900">{apt.patientName}</span>
                                                </div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="text-indigo-600 font-medium">{apt.doctorName}</div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="text-slate-700">{apt.date}</div>
                                                <div className="text-sm text-slate-500">{apt.time}</div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <span className="text-slate-700">{apt.reason || 'Regular Checkup'}</span>
                                            </td>
                                            <td className="py-4 px-6">
    {/* Default to 500 if fee is missing (common for emergency) */}
    <span className="font-semibold text-emerald-700">â‚¹{apt.consultationFee || 500}</span>
</td>
<td className="py-4 px-6">
    <div className="flex items-center gap-2">
        <span className={`px-3 py-1.5 text-xs font-medium rounded-full capitalize border whitespace-nowrap ${
            (apt.type === 'EMERGENCY') ? 'bg-rose-100 text-rose-700 border-rose-300' : 
            (apt.status === 'completed' || apt.status === 'COMPLETED') ? 'bg-blue-100 text-blue-700 border-blue-300' :
            (apt.status === 'approved' || apt.status === 'APPROVED') ? 'bg-emerald-100 text-emerald-700 border-emerald-300' : 
            (apt.status === 'pending' || apt.status === 'PENDING') ? 'bg-yellow-100 text-yellow-700 border-yellow-300' :
            (apt.status === 'rejected' || apt.status === 'REJECTED' || apt.status === 'cancelled') ? 'bg-red-100 text-red-700 border-red-300' :
            'bg-slate-100 text-slate-700 border-slate-300'
        }`}>
            {apt.type === 'EMERGENCY' ? 'Emergency (Completed)' : apt.status}
        </span>
        {(apt.status === 'approved' || apt.status === 'APPROVED') && (
            <button 
                onClick={async () => {
                    setSelectedAppointmentForReschedule(apt);
                    setRescheduleDate('');
                    setRescheduleTime('');
                    setAvailableSlotsForReschedule([]);
                    setAllDoctorSlots([]);
                    setAllDoctorSlotsIncludingBooked([]);
                    setShowRescheduleModal(true);
                    // Fetch ALL slots for the doctor (including booked ones)
                    try {
                        const response = await fetch(`${API_BASE_URL}/slots/doctor/${apt.doctorId}`);
                        if (response.ok) {
                            const slots = await response.json();
                            // Store all slots (for checking if date has any slots)
                            setAllDoctorSlotsIncludingBooked(slots);
                            // Filter to only available slots
                            const availableSlots = slots.filter(s => s.isAvailable);
                            setAllDoctorSlots(availableSlots);
                            setAvailableSlotsForReschedule(availableSlots);
                        }
                    } catch (error) {
                        console.error('Error fetching slots:', error);
                    }
                }}
                className="px-2 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-medium hover:bg-amber-200 transition-colors flex items-center gap-1">
                <Icon name="Calendar" size={12} />
                Reschedule
            </button>
        )}
    </div>
</td>
{(appointmentFilter === 'completed' || appointmentFilter === 'emergency' || appointmentFilter === 'all') && (
<td className="py-4 px-6">
    {apt.feedback ? (
        <div className="text-sm">
            <div className="flex items-center gap-1 mb-1">
                {[...Array(5)].map((_, i) => (
                    <span key={i} className={`text-${i < apt.rating ? 'amber' : 'gray'}-400`}>â˜…</span>
                ))}
            </div>
            <p className="text-slate-600 italic text-xs">"{apt.feedback}"</p>
        </div>
    ) : (
        <span className="text-slate-400 text-sm">No feedback</span>
    )}
</td>
)}
                                        </tr>
                                    ));
                                    })()}
                                </AdminTable>
                            </div>
                        )}

                        {activeView === 'documents' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header - Purple Background */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={user.photoURL || 'https://placehold.co/60x60/ffffff/6366f1?text=AD'} 
                                            alt={user.displayName}
                                            className="w-16 h-16 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                                <Icon name="Mail" size={14} className="text-white/80" />
                                                {user.email || 'admin@medvault.com'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h2 className="text-xl font-bold text-slate-800 font-sans">Document Verification</h2>
                                    <p className="text-slate-500 font-sans">Review and verify uploaded documents</p>
                                </div>
                                <AdminTable headers={['Doctor Name', 'Document Type', 'Upload Date', 'Status', 'Actions']}>
                                    {documentsList.map(doc => (
                                        <tr key={doc.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="py-4 px-6">
                                                <div className="font-medium text-slate-900">{doc.doctorName}</div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="FileText" size={16} className="text-slate-400" />
                                                    <span className="text-slate-700">{doc.documentType}</span>
                                                </div>
                                            </td>
                                            <td className="py-4 px-6 text-slate-600">{doc.uploadedDate}</td>
                                            <td className="py-4 px-6">
                                                {(doc.status === 'verified' || doc.verificationStatus === 'APPROVED')
                                                    ? <span className="flex items-center gap-1 text-green-600 font-medium text-sm bg-green-50 px-3 py-1 rounded-full"><Icon name="BadgeCheck" size={16} /> Verified</span>
                                                    : <span className="flex items-center gap-1 text-amber-600 font-medium text-sm bg-amber-50 px-3 py-1 rounded-full"><Icon name="Clock" size={16} /> Pending</span>
                                                }
                                            </td>
                                            <td className="py-4 px-6">
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => {
                                                            window.open('https://static.toiimg.com/thumb/msid-65879382,imgsize-341916,width-400,height-225,resizemode-72/certifictae.jpg', '_blank');
                                                        }}
                                                        className="px-3 py-1.5 bg-white border border-indigo-200 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-50 transition-colors font-sans flex items-center gap-1">
                                                        <Icon name="Eye" size={14} />
                                                        View
                                                    </button>
                                                    {doc.status === 'pending' && (
                                                        <button 
                                                            onClick={async () => {
                                                                try {
                                                                    // Verify the doctor using their doctorId
                                                                    const response = await fetch(`${API_BASE_URL}/admin/doctors/${doc.doctorId}/verify`, {
                                                                        method: 'PUT',
                                                                        headers: { 'Content-Type': 'application/json' }
                                                                    });
                                                                    if (response.ok) {
                                                                        alert('âœ… Doctor verified successfully!');
                                                                        // Refresh data to update status
                                                                        await fetchAllData();
                                                                    } else {
                                                                        alert('âŒ Failed to verify doctor');
                                                                    }
                                                                } catch (error) {
                                                                    console.error('Error verifying:', error);
                                                                    alert('âŒ Error verifying doctor');
                                                                }
                                                            }}
                                                            className="px-3 py-1.5 bg-teal-600 text-white rounded-lg text-sm font-medium hover:bg-teal-700 transition-colors font-sans flex items-center gap-1">
                                                            <Icon name="CheckCircle" size={14} />
                                                            Verify
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </AdminTable>
                            </div>
                        )}

                        {activeView === 'emergency' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header - Purple Background */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={adminProfile?.profilePictureUrl || user.photoURL || `https://ui-avatars.com/api/?name=${adminProfile?.name || user.displayName || 'Admin'}&background=6366f1&color=fff&size=60`} 
                                            alt={adminProfile?.name || user.displayName}
                                            className="w-14 h-14 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {adminProfile?.name || user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/90 text-sm font-sans">{adminProfile?.email || user.email || 'Emergency Management'}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-rose-50 border-l-4 border-rose-500 p-4 rounded-r-xl flex items-center gap-3 shadow-sm">
                                    <div className="p-2 bg-rose-100 rounded-full text-rose-600"><Icon name="Siren" size={24} /></div>
                                    <div>
                                        <h3 className="text-rose-900 font-bold font-sans">Emergency Management Center</h3>
                                        <p className="text-rose-700 text-sm font-sans">Monitor and respond to critical patient requests</p>
                                    </div>
                                </div>

                                <div className="grid gap-4">
                                    {emergencyList.filter(emergency => {
                                        // Show all emergencies that are not COMPLETED
                                        // PENDING or APPROVED emergencies are considered active
                                        if (emergency.status === 'COMPLETED') return false;
                                        if (emergency.status === 'PENDING') return true;
                                        // For APPROVED, show if appointment is in future OR within 1 hour after appointment time
                                        const emergencyDate = new Date(emergency.requestDateTime);
                                        const now = new Date();
                                        const oneHourAfterAppointment = new Date(emergencyDate.getTime() + (60 * 60 * 1000));
                                        // Show if: appointment is in future OR current time is within 1 hour after appointment
                                        return emergencyDate > now || now < oneHourAfterAppointment;
                                    }).map(emergency => (
                                        <div key={emergency.id} className={`bg-white rounded-xl shadow-md border-l-4 p-4 hover:shadow-lg transition-all ${
                                            emergency.severity === 'critical' ? 'border-rose-600' :
                                            emergency.severity === 'high' ? 'border-orange-500' :
                                            'border-amber-500'
                                        }`}>
                                            {/* Urgency Level & Tope/Time - Top */}
                                            {/* Urgency Level & Date/Time - Top Row */}
                                            <div className="flex items-center justify-between mb-3">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase inline-flex items-center gap-1 ${
                                                    emergency.severity === 'critical' ? 'bg-rose-100 text-rose-700' :
                                                    emergency.severity === 'high' ? 'bg-orange-100 text-orange-700' :
                                                    'bg-amber-100 text-amber-700'
                                                }`}>
                                                    <Icon name="Siren" size={14} className={`${
                                                        emergency.severity === 'critical' ? 'animate-pulse' : ''
                                                    }`} />
                                                    {emergency.severity || 'HIGH'} PRIORITY
                                                </span>
                                                <div className="text-right">
                                                    <p className="text-xs text-slate-500 font-semibold">Date & Time</p>
                                                    <p className="text-xs text-slate-900 font-medium">{emergency.requestTime}</p>
                                                </div>
                                            </div>
                                            
                                            {/* Compact Grid Layout */}
                                            <div className="grid grid-cols-2 gap-x-6 gap-y-2 mb-3">
                                                {/* Row 1: Patient Name | Assigned Doctor */}
                                                <div>
                                                    <p className="text-xs text-slate-500 font-semibold">Patient</p>
                                                    <p className="text-sm font-bold text-slate-900 truncate">{emergency.patientName}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-slate-500 font-semibold">Assigned Doctor</p>
                                                    <p className="text-sm font-bold text-indigo-700 truncate">{emergency.doctorName}</p>
                                                </div>
                                                
                                                {/* Row 2: Reason | Location */}
                                                <div className="col-span-2">
                                                    <p className="text-xs text-slate-500 font-semibold">Reason</p>
                                                    <p className="text-sm text-slate-900 truncate">{emergency.reason || 'Urgent medical attention required'}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-slate-500 font-semibold">Location</p>
                                                    <p className="text-sm text-slate-900 truncate">{emergency.patientAddress || 'N/A'}</p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-slate-500 font-semibold">Fee</p>
                                                    <p className="text-sm font-bold text-emerald-700">â‚¹{emergency.consultationFee ? emergency.consultationFee : 'N/A'} (Paid)</p>
                                                </div>
                                            </div>
                                            
                                            {/* Row 3: Button */}
                                            <div className="pt-2 border-t border-slate-100">
                                                <button 
                                                    onClick={() => handleResolveEmergency(emergency.id)}
                                                    className="px-4 py-1.5 bg-teal-600 text-white rounded-lg text-xs font-bold hover:bg-teal-700 transition-colors font-sans flex items-center gap-1">
                                                    <Icon name="Bell" size={12} />
                                                    Remind Doctor
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {emergencyList.filter(emergency => {
                                    if (emergency.status === 'COMPLETED') return false;
                                    if (emergency.status === 'PENDING') return true;
                                    const emergencyDate = new Date(emergency.requestDateTime);
                                    const now = new Date();
                                    const oneHourAfterAppointment = new Date(emergencyDate.getTime() + (60 * 60 * 1000));
                                    return emergencyDate > now || now < oneHourAfterAppointment;
                                }).length === 0 && (
                                    <div className="bg-white rounded-2xl p-12 text-center">
                                        <div className="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <Icon name="CheckCircle" size={32} className="text-teal-600" />
                                        </div>
                                        <h3 className="text-lg font-bold text-slate-800 mb-2 font-sans">All Clear</h3>
                                        <p className="text-slate-500 font-sans">No active emergency requests at this time.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeView === 'issues' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={user.photoURL || 'https://placehold.co/60x60/ffffff/6366f1?text=AD'} 
                                            alt={user.displayName}
                                            className="w-16 h-16 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                                <Icon name="Mail" size={14} className="text-white/80" />
                                                {user.email || 'admin@medvault.com'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800 font-sans">Reported Issues</h2>
                                        <p className="text-slate-500 font-sans">Review and manage user-reported issues</p>
                                    </div>
                                    <div className="flex gap-2">
                                        {['all', 'pending', 'resolved', 'in-progress'].map(status => (
                                            <button 
                                                key={status} 
                                                onClick={() => setIssuesFilter(status)}
                                                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all capitalize font-sans ${
                                                    issuesFilter === status 
                                                        ? status === 'pending' ? 'bg-amber-500 text-white shadow-lg' :
                                                          status === 'resolved' ? 'bg-emerald-500 text-white shadow-lg' :
                                                          status === 'in-progress' ? 'bg-blue-500 text-white shadow-lg' :
                                                          'bg-indigo-500 text-white shadow-lg'
                                                        : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50'
                                                }`}>
                                                {status}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="grid gap-6">
                                    {issuesList.filter(issue => issuesFilter === 'all' || issue.status === issuesFilter).map(issue => (
                                        <div key={issue.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-md transition-all">
                                            {/* Header with user info and status */}
                                            <div className="px-6 py-4 bg-gradient-to-r from-slate-50 to-purple-50 border-b border-slate-100">
                                                <div className="flex items-start justify-between mb-2">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md">
                                                            {issue.name ? issue.name.charAt(0).toUpperCase() : 'U'}
                                                        </div>
                                                        <div>
                                                            <h3 className="font-bold text-slate-800 text-lg">{issue.name}</h3>
                                                            <div className="flex items-center gap-2 text-base text-purple-500 mt-1 mb-2">
                                                                <Icon name="AlertTriangle" size={14} />
                                                                <span className="font-semibold">{issue.subject}</span>
                                                            </div>
                                                            <div className="flex items-center gap-3 text-sm text-slate-600">
                                                                <span className="flex items-center gap-1">
                                                                    <Icon name="Phone" size={12} />
                                                                    {issue.phone}
                                                                </span>
                                                                <span className="flex items-center gap-1">
                                                                    <Icon name="Mail" size={12} />
                                                                    {issue.email}
                                                                </span>
                                                            </div>
                                                            <div className="text-sm text-slate-500 flex items-center gap-1 mt-1">
                                                                <Icon name="Clock" size={12} />
                                                                <span className="font-medium">{issue.createdAt}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <span className={`px-4 py-2 rounded-full text-sm font-bold uppercase shadow-sm ${
                                                        issue.status === 'resolved' ? 'bg-green-500 text-white' :
                                                        issue.status === 'in-progress' ? 'bg-blue-500 text-white' :
                                                        'bg-amber-500 text-white'
                                                    }`}>
                                                        {issue.status}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            {/* Chat-style messages */}
                                            <div className="p-6 space-y-4">
                                                {/* User message - with left gap */}
                                                <div className="pl-4">
                                                    <div className="bg-gradient-to-r from-rose-50 to-pink-50 text-slate-800 rounded-2xl px-5 py-3 shadow-sm border border-rose-100">
                                                        <p className="text-xs text-rose-600 font-semibold mb-1">User Message</p>
                                                        <p className="text-sm leading-relaxed">{issue.message}</p>
                                                    </div>
                                                </div>
                                                
                                                {/* Admin response - no gap */}
                                                {issue.adminMessage && (
                                                    <div>
                                                        <div className="bg-gradient-to-r from-emerald-50 to-teal-50 text-slate-800 rounded-2xl px-5 py-3 shadow-sm border border-emerald-100">
                                                            <p className="text-xs text-emerald-600 font-semibold mb-1 flex items-center gap-1">
                                                                <Icon name="CheckCircle" size={12} /> Support Team
                                                            </p>
                                                            <p className="text-sm leading-relaxed">{issue.adminMessage}</p>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Action Buttons */}
                                                {issue.status !== 'resolved' && (
                                                    <div className="flex flex-wrap gap-3 pt-4 border-t border-slate-100">
                                                        <button 
                                                            onClick={() => {
                                                                setSelectedIssueForReply(issue);
                                                                setReplyMessage(issue.adminMessage || '');
                                                                setReplyStatus(issue.status);
                                                            }}
                                                            className="px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl text-sm font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                                                            <Icon name="MessageSquare" size={16} />
                                                            Reply & Resolve
                                                        </button>
                                                        {issue.status === 'pending' && (
                                                            <button 
                                                                onClick={async () => {
                                                                    try {
                                                                        const response = await fetch(`${API_BASE_URL}/admin/issues/${issue.id}/status`, {
                                                                            method: 'PUT',
                                                                            headers: { 'Content-Type': 'application/json' },
                                                                            body: JSON.stringify({ status: 'in-progress' })
                                                                        });
                                                                        if (response.ok) {
                                                                            alert('âœ… Issue marked as In Progress!');
                                                                            fetchAllData();
                                                                        }
                                                                    } catch (error) {
                                                                        alert('âŒ Failed to update status');
                                                                    }
                                                                }}
                                                                className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl text-sm font-semibold hover:from-blue-600 hover:to-cyan-600 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                                                                <Icon name="PlayCircle" size={16} />
                                                                Mark In Progress
                                                            </button>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {issuesList.filter(issue => issuesFilter === 'all' || issue.status === issuesFilter).length === 0 && (
                                    <div className="bg-white rounded-2xl p-12 text-center">
                                        <div className="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <Icon name="CheckCircle" size={32} className="text-purple-600" />
                                        </div>
                                        <h3 className="text-lg font-bold text-slate-800 mb-2 font-sans">No Issues Found</h3>
                                        <p className="text-slate-500 font-sans">No {issuesFilter !== 'all' ? issuesFilter : ''} issues at this time.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeView === 'patients-appointments' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header */}
                                <div className="glass-card rounded-2xl p-6 shadow-lg border border-white/50">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={user.photoURL || 'https://placehold.co/60x60/6366f1/ffffff?text=AD'} 
                                            alt={user.displayName}
                                            className="w-14 h-14 rounded-full border-4 border-white shadow-lg"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent font-sans">
                                                {getGreeting()}, {user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-slate-600 text-sm font-sans">Patient Appointments</p>
                                        </div>
                                    </div>
                                </div>

                                <h2 className="text-xl font-bold text-slate-800 font-sans">Patient Appointments</h2>
                                <AdminTable headers={['Patient', 'Doctor', 'Date & Time', 'Status']}>
                                    {appointmentsList.slice(0, 15).map(apt => (
                                        <tr key={apt.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="py-4 px-6 font-medium text-slate-900">{apt.patientName}</td>
                                            <td className="py-4 px-6 text-indigo-600">{apt.doctorName}</td>
                                            <td className="py-4 px-6">
                                                <div className="text-slate-700">{apt.date}</div>
                                                <div className="text-sm text-slate-500">{apt.time}</div>
                                            </td>
                                            <td className="py-4 px-6">
                                                <span className={`px-2 py-1 text-xs font-medium rounded-full capitalize ${
                                                    apt.status === 'approved' ? 'bg-teal-100 text-teal-700' : 
                                                    apt.status === 'pending' ? 'bg-amber-100 text-amber-700' : 
                                                    'bg-slate-100 text-slate-700'
                                                }`}>
                                                    {apt.status}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </AdminTable>
                            </div>
                        )}

                        {activeView === 'patients-medical' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header */}
                                <div className="glass-card rounded-2xl p-6 shadow-lg border border-white/50">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={user.photoURL || 'https://placehold.co/60x60/6366f1/ffffff?text=AD'} 
                                            alt={user.displayName}
                                            className="w-14 h-14 rounded-full border-4 border-white shadow-lg"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent font-sans">
                                                {getGreeting()}, {user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-slate-600 text-sm font-sans">Patient Medical Records</p>
                                        </div>
                                    </div>
                                </div>

                                <h2 className="text-xl font-bold text-slate-800 font-sans">Patient Medical Records</h2>
                                <div className="bg-white rounded-2xl p-12 text-center border border-slate-100">
                                    <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icon name="FileText" size={32} className="text-indigo-600" />
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-2 font-sans">Medical Records System</h3>
                                    <p className="text-slate-500 max-w-md mx-auto font-sans">Access and manage patient medical records, prescriptions, and health history.</p>
                                    <button className="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors font-sans">
                                        Browse Records
                                    </button>
                                </div>
                            </div>
                        )}

                        {activeView === 'settings' && (
                            <div className="space-y-6 animate-fadeIn">
                                {/* Greeting Header - Purple Background */}
                                <div className="bg-gradient-to-r from-purple-600 via-purple-500 to-indigo-600 rounded-2xl p-6 shadow-lg border border-purple-400">
                                    <div className="flex items-center gap-4">
                                        <img 
                                            src={user.photoURL || 'https://placehold.co/60x60/ffffff/6366f1?text=AD'} 
                                            alt={user.displayName}
                                            className="w-16 h-16 rounded-full border-4 border-white shadow-lg object-cover"
                                        />
                                        <div>
                                            <h1 className="text-2xl font-bold text-white font-sans">
                                                {getGreeting()}, {user.displayName || 'Admin'}!
                                            </h1>
                                            <p className="text-white/80 text-sm font-sans flex items-center gap-2 mt-1">
                                                <Icon name="Mail" size={14} className="text-white/80" />
                                                {user.email || 'admin@medvault.com'}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <h2 className="text-xl font-bold text-slate-800 font-sans">System Settings</h2>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    {/* Appearance Settings */}
                                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="p-3 bg-purple-50 rounded-xl text-purple-600">
                                                <Icon name="Palette" size={24} />
                                            </div>
                                            <h2 className="text-lg font-bold text-slate-800 font-sans">Appearance</h2>
                                        </div>
                                        <p className="text-slate-600 mb-4 font-sans">Customize the look and feel of your dashboard</p>
                                        <div className="space-y-3">
                                            <label className="flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-purple-50 rounded-lg cursor-pointer hover:shadow-md transition-all border border-slate-200">
                                                <div className="flex items-center gap-3">
                                                    <Icon name={darkMode ? "Moon" : "Sun"} size={20} className={darkMode ? "text-indigo-600" : "text-amber-500"} />
                                                    <div>
                                                        <span className="text-slate-900 font-semibold font-sans block">Dark Mode</span>
                                                        <span className="text-xs text-slate-500 font-sans">Switch to {darkMode ? 'light' : 'dark'} theme</span>
                                                    </div>
                                                </div>
                                                <div className="relative">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={darkMode}
                                                        onChange={(e) => setDarkMode(e.target.checked)}
                                                        className="sr-only peer" 
                                                    />
                                                    <div className="w-14 h-7 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-purple-600"></div>
                                                </div>
                                            </label>
                                            
                                            <label className="flex items-center justify-between p-4 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors border border-slate-200">
                                                <div className="flex items-center gap-3">
                                                    <Icon name="Minimize2" size={20} className="text-blue-600" />
                                                    <div>
                                                        <span className="text-slate-900 font-semibold font-sans block">Compact View</span>
                                                        <span className="text-xs text-slate-500 font-sans">Reduce spacing and padding</span>
                                                    </div>
                                                </div>
                                                <div className="relative">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={compactView}
                                                        onChange={(e) => {
                                                            setCompactView(e.target.checked);
                                                            localStorage.setItem('compactView', e.target.checked);
                                                            alert(e.target.checked ? 'âœ… Compact view enabled!' : 'âœ… Normal view restored!');
                                                        }}
                                                        className="sr-only peer" 
                                                    />
                                                    <div className="w-14 h-7 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    {/* Notification Settings */}
                                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="p-3 bg-indigo-50 rounded-xl text-indigo-600">
                                                <Icon name="Bell" size={24} />
                                            </div>
                                            <h2 className="text-lg font-bold text-slate-800 font-sans">Notifications</h2>
                                        </div>
                                        <p className="text-slate-600 mb-4 font-sans">Configure system-wide notification preferences</p>
                                        <div className="space-y-3">
                                            <label className="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="Mail" size={16} className="text-blue-600" />
                                                    <span className="text-slate-700 font-sans">Email Notifications</span>
                                                </div>
                                                <input 
                                                    type="checkbox" 
                                                    checked={emailNotifications}
                                                    onChange={(e) => {
                                                        setEmailNotifications(e.target.checked);
                                                        localStorage.setItem('emailNotifications', e.target.checked);
                                                    }}
                                                    className="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" 
                                                />
                                            </label>
                                            <label className="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="MessageSquare" size={16} className="text-green-600" />
                                                    <span className="text-slate-700 font-sans">SMS Alerts</span>
                                                </div>
                                                <input 
                                                    type="checkbox" 
                                                    checked={smsAlerts}
                                                    onChange={(e) => {
                                                        setSmsAlerts(e.target.checked);
                                                        localStorage.setItem('smsAlerts', e.target.checked);
                                                    }}
                                                    className="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" 
                                                />
                                            </label>
                                            <label className="flex items-center justify-between p-3 bg-rose-50 rounded-lg cursor-pointer hover:bg-rose-100 transition-colors border border-rose-200">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="Siren" size={16} className="text-rose-600" />
                                                    <span className="text-slate-700 font-sans font-semibold">Emergency Alerts</span>
                                                </div>
                                                <input 
                                                    type="checkbox" 
                                                    checked={emergencyAlerts}
                                                    onChange={(e) => {
                                                        setEmergencyAlerts(e.target.checked);
                                                        localStorage.setItem('emergencyAlerts', e.target.checked);
                                                    }}
                                                    className="w-5 h-5 text-rose-600 rounded focus:ring-2 focus:ring-rose-500" 
                                                />
                                            </label>
                                            <label className="flex items-center justify-between p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="Download" size={16} className="text-purple-600" />
                                                    <span className="text-slate-700 font-sans">System Updates</span>
                                                </div>
                                                <input 
                                                    type="checkbox" 
                                                    checked={systemUpdates}
                                                    onChange={(e) => {
                                                        setSystemUpdates(e.target.checked);
                                                        localStorage.setItem('systemUpdates', e.target.checked);
                                                    }}
                                                    className="w-5 h-5 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500" 
                                                />
                                            </label>
                                        </div>
                                    </div>

                                    {/* Data & Performance */}
                                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="p-3 bg-teal-50 rounded-xl text-teal-600">
                                                <Icon name="Database" size={24} />
                                            </div>
                                            <h2 className="text-lg font-bold text-slate-800 font-sans">Data & Performance</h2>
                                        </div>
                                        <p className="text-slate-600 mb-4 font-sans">Optimize dashboard performance and data handling</p>
                                        <div className="space-y-3">
                                            <label className="flex items-center justify-between p-4 bg-teal-50 rounded-lg cursor-pointer hover:bg-teal-100 transition-colors border border-teal-200">
                                                <div className="flex items-center gap-3">
                                                    <Icon name="RefreshCw" size={20} className="text-teal-600" />
                                                    <div>
                                                        <span className="text-slate-900 font-semibold font-sans block">Auto Refresh</span>
                                                        <span className="text-xs text-slate-500 font-sans">Refresh data every 30 seconds</span>
                                                    </div>
                                                </div>
                                                <div className="relative">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={autoRefresh}
                                                        onChange={(e) => {
                                                            setAutoRefresh(e.target.checked);
                                                            localStorage.setItem('autoRefresh', e.target.checked);
                                                            alert(e.target.checked ? 'âœ… Auto-refresh enabled! Data will update every 30 seconds.' : 'âœ… Auto-refresh disabled.');
                                                        }}
                                                        className="sr-only peer" 
                                                    />
                                                    <div className="w-14 h-7 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-teal-600"></div>
                                                </div>
                                            </label>
                                            
                                            <button 
                                                onClick={() => {
                                                    fetchAllData();
                                                    alert('âœ… Data refreshed successfully!');
                                                }}
                                                className="w-full p-3 bg-slate-50 rounded-lg text-left hover:bg-slate-100 transition-colors flex items-center gap-3">
                                                <Icon name="Download" size={20} className="text-blue-600" />
                                                <div>
                                                    <div className="font-medium text-slate-900 font-sans">Refresh Data Now</div>
                                                    <div className="text-sm text-slate-500 font-sans">Manually refresh all dashboard data</div>
                                                </div>
                                            </button>
                                            
                                            <button 
                                                onClick={() => {
                                                    localStorage.clear();
                                                    alert('âœ… Cache cleared! Please refresh the page.');
                                                }}
                                                className="w-full p-3 bg-slate-50 rounded-lg text-left hover:bg-slate-100 transition-colors flex items-center gap-3">
                                                <Icon name="Trash2" size={20} className="text-rose-600" />
                                                <div>
                                                    <div className="font-medium text-slate-900 font-sans">Clear Cache</div>
                                                    <div className="text-sm text-slate-500 font-sans">Clear all stored preferences and cache</div>
                                                </div>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Security Settings */}
                                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="p-3 bg-amber-50 rounded-xl text-amber-600">
                                                <Icon name="Shield" size={24} />
                                            </div>
                                            <h2 className="text-lg font-bold text-slate-800 font-sans">Security</h2>
                                        </div>
                                        <p className="text-slate-600 mb-4 font-sans">Manage security and access controls</p>
                                        <div className="space-y-3">
                                            <button 
                                                onClick={() => alert('ðŸ” Password change feature coming soon!')}
                                                className="w-full p-3 bg-slate-50 rounded-lg text-left hover:bg-slate-100 transition-colors flex items-center gap-3">
                                                <Icon name="Lock" size={20} className="text-indigo-600" />
                                                <div>
                                                    <div className="font-medium text-slate-900 font-sans">Change Password</div>
                                                    <div className="text-sm text-slate-500 font-sans">Update your admin password</div>
                                                </div>
                                            </button>
                                            <button 
                                                onClick={() => alert('ðŸ” 2FA setup coming soon!')}
                                                className="w-full p-3 bg-slate-50 rounded-lg text-left hover:bg-slate-100 transition-colors flex items-center gap-3">
                                                <Icon name="Smartphone" size={20} className="text-green-600" />
                                                <div>
                                                    <div className="font-medium text-slate-900 font-sans">Two-Factor Authentication</div>
                                                    <div className="text-sm text-slate-500 font-sans">Enable 2FA for extra security</div>
                                                </div>
                                            </button>
                                            <button 
                                                onClick={() => alert('ðŸ“Š Access logs feature coming soon!')}
                                                className="w-full p-3 bg-slate-50 rounded-lg text-left hover:bg-slate-100 transition-colors flex items-center gap-3">
                                                <Icon name="FileText" size={20} className="text-purple-600" />
                                                <div>
                                                    <div className="font-medium text-slate-900 font-sans">Access Logs</div>
                                                    <div className="text-sm text-slate-500 font-sans">View admin access history</div>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Quick Actions */}
                                <div className="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl p-6 border border-purple-200">
                                    <h3 className="text-lg font-bold text-slate-900 mb-4 font-sans flex items-center gap-2">
                                        <Icon name="Zap" size={20} className="text-purple-600" />
                                        Quick Actions
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <button 
                                            onClick={() => {
                                                const data = {
                                                    stats,
                                                    doctors: doctorsList.length,
                                                    patients: patientsList.length,
                                                    appointments: appointmentsList.length,
                                                    emergencies: emergencyList.length,
                                                    exportDate: new Date().toISOString()
                                                };
                                                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = `medvault-report-${new Date().toISOString().split('T')[0]}.json`;
                                                a.click();
                                                alert('âœ… Report exported successfully!');
                                            }}
                                            className="p-4 bg-white rounded-xl hover:shadow-lg transition-all flex items-center gap-3 border border-slate-200">
                                            <div className="p-2 bg-blue-50 rounded-lg">
                                                <Icon name="Download" size={20} className="text-blue-600" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold text-slate-900 font-sans">Export Report</div>
                                                <div className="text-xs text-slate-500 font-sans">Download system data</div>
                                            </div>
                                        </button>
                                        
                                        <button 
                                            onClick={() => {
                                                if (confirm('Are you sure you want to backup the database?')) {
                                                    alert('âœ… Database backup initiated! You will receive an email when complete.');
                                                }
                                            }}
                                            className="p-4 bg-white rounded-xl hover:shadow-lg transition-all flex items-center gap-3 border border-slate-200">
                                            <div className="p-2 bg-teal-50 rounded-lg">
                                                <Icon name="Database" size={20} className="text-teal-600" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold text-slate-900 font-sans">Backup Database</div>
                                                <div className="text-xs text-slate-500 font-sans">Create system backup</div>
                                            </div>
                                        </button>
                                        
                                        <button 
                                            onClick={() => {
                                                const settings = {
                                                    darkMode,
                                                    emailNotifications,
                                                    smsAlerts,
                                                    emergencyAlerts,
                                                    systemUpdates,
                                                    autoRefresh,
                                                    compactView
                                                };
                                                alert(`Current Settings:\n\n${JSON.stringify(settings, null, 2)}`);
                                            }}
                                            className="p-4 bg-white rounded-xl hover:shadow-lg transition-all flex items-center gap-3 border border-slate-200">
                                            <div className="p-2 bg-purple-50 rounded-lg">
                                                <Icon name="Settings" size={20} className="text-purple-600" />
                                            </div>
                                            <div className="text-left">
                                                <div className="font-semibold text-slate-900 font-sans">View Settings</div>
                                                <div className="text-xs text-slate-500 font-sans">Check current config</div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        </div>
                    </main>
                </div>
                
                {/* Issue Reply Modal */}
                {selectedIssueForReply && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setSelectedIssueForReply(null)}>
                        <div className="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl" onClick={e => e.stopPropagation()}>
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                                    <Icon name="MessageSquare" size={24} className="text-indigo-600" />
                                    Reply to Issue
                                </h3>
                                <button onClick={() => setSelectedIssueForReply(null)} className="text-slate-400 hover:text-slate-600">
                                    <Icon name="X" size={24} />
                                </button>
                            </div>
                            
                            <div className="bg-slate-50 rounded-lg p-4 mb-4">
                                <p className="text-sm text-slate-500 mb-1">Issue from: <span className="font-semibold text-slate-700">{selectedIssueForReply.name}</span></p>
                                <p className="text-sm text-slate-500 mb-2">Phone: <span className="font-semibold text-slate-700">{selectedIssueForReply.phone}</span></p>
                                <p className="text-sm text-slate-700 italic">"{selectedIssueForReply.message}"</p>
                            </div>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-semibold text-slate-700 mb-2">Your Reply</label>
                                <textarea
                                    value={replyMessage}
                                    onChange={(e) => setReplyMessage(e.target.value)}
                                    placeholder="Enter your response to the user..."
                                    className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                                    rows={4}
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setSelectedIssueForReply(null)}
                                    className="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition-colors">
                                    Cancel
                                </button>
                                <button
                                    onClick={handleIssueReply}
                                    className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                                    <Icon name="Send" size={16} />
                                    Send Reply & Resolve
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Prescription View Modal - Purple Theme */}
                {selectedPrescriptionForView && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setSelectedPrescriptionForView(null)}>
                        <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                            {/* Header */}
                            <div className="flex items-center justify-between p-6 border-b border-slate-200">
                                <h3 className="text-2xl font-bold text-[#7209B7] flex items-center gap-2">
                                    <Icon name="Pill" size={28} className="text-[#7209B7]" />
                                    {selectedPrescriptionForView.medicationName || selectedPrescriptionForView.name || 'Prescription'}
                                </h3>
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={() => alert('Delete functionality')}
                                        className="p-2 text-slate-400 hover:text-red-500 transition-colors">
                                        <Icon name="Trash2" size={20} />
                                    </button>
                                    <button 
                                        onClick={() => setSelectedPrescriptionForView(null)} 
                                        className="p-2 text-red-500 hover:text-red-700 transition-colors">
                                        <Icon name="X" size={24} />
                                    </button>
                                </div>
                            </div>
                            
                            {/* Body */}
                            <div className="p-6 space-y-6">
                                {/* Dosage & Frequency */}
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <p className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Dosage</p>
                                        <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.dosage || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Frequency</p>
                                        <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.frequency || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                {/* Description/Instructions */}
                                <div>
                                    <p className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-1">Description</p>
                                    <p className="text-slate-700">{selectedPrescriptionForView.instructions || selectedPrescriptionForView.notes || selectedPrescriptionForView.description || 'No description provided'}</p>
                                </div>
                                
                                {/* Start & End Dates - Side by Side */}
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-purple-50 rounded-lg p-4 border border-purple-100">
                                        <p className="text-sm font-semibold text-purple-600 uppercase tracking-wide mb-1">Start Date</p>
                                        <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.startDate ? new Date(selectedPrescriptionForView.startDate).toLocaleDateString() : 'N/A'}</p>
                                    </div>
                                    <div className="bg-purple-50 rounded-lg p-4 border border-purple-100">
                                        <p className="text-sm font-semibold text-purple-600 uppercase tracking-wide mb-1">End Date</p>
                                        <p className="text-lg font-bold text-slate-900">{selectedPrescriptionForView.endDate ? new Date(selectedPrescriptionForView.endDate).toLocaleDateString() : 'Ongoing'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Footer - Full Width Purple Download Button */}
                            <div className="p-6 border-t border-slate-200">
                                <button 
                                    onClick={() => {
                                        const docPath = selectedPrescriptionForView.documentPath || selectedPrescriptionForView.filePath;
                                        if (docPath) {
                                            const fileUrl = `http://localhost:8080/${docPath.startsWith('/') ? docPath.substring(1) : docPath}`;
                                            const link = document.createElement('a');
                                            link.href = fileUrl;
                                            link.download = selectedPrescriptionForView.medicationName || 'prescription';
                                            link.target = '_blank';
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        } else {
                                            alert('No document available for download');
                                        }
                                    }}
                                    className="w-full flex items-center justify-center gap-2 px-6 py-4 bg-[#7209B7] text-white rounded-xl font-bold text-lg hover:bg-[#5c078f] transition-colors shadow-lg">
                                    <Icon name="Download" size={22} />
                                    Download Prescription
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Health Record View Modal - Colored Sections */}
                {selectedRecordForView && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setSelectedRecordForView(null)}>
                        <div className="bg-white rounded-2xl w-full max-w-3xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                            {/* Header */}
                            <div className="p-6 border-b border-slate-200">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h3 className="text-2xl font-bold text-[#7209B7]">
                                            {selectedRecordForView.title || selectedRecordForView.recordType || 'Health Record'}
                                        </h3>
                                        <p className="text-sm text-slate-500 mt-1">
                                            {selectedRecordForView.recordType?.toUpperCase() || 'RECORD'} | {selectedRecordForView.recordDate ? new Date(selectedRecordForView.recordDate).toLocaleDateString() : 'N/A'}
                                        </p>
                                    </div>
                                    <button 
                                        onClick={() => setSelectedRecordForView(null)} 
                                        className="p-2 text-red-500 hover:text-red-700 transition-colors">
                                        <Icon name="X" size={24} />
                                    </button>
                                </div>
                            </div>
                            
                            {/* Body - Scrollable */}
                            <div className="p-6 space-y-6 overflow-y-auto flex-1">
                                {/* Gray - Basic Info Section */}
                                <div className="bg-slate-100 rounded-xl p-5 border border-slate-200">
                                    <h4 className="font-bold text-slate-700 mb-4 text-lg border-b border-slate-300 pb-2">Basic Info</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <p className="text-xs font-semibold text-slate-500 uppercase mb-1">Full Name</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.patientName || selectedRecordForView.fullName || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-slate-500 uppercase mb-1">Marital Status</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.maritalStatus || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-slate-500 uppercase mb-1">Address</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.address || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Blue - Vitals Section */}
                                <div className="bg-blue-50 rounded-xl p-5 border border-blue-200">
                                    <h4 className="font-bold text-blue-800 mb-4 text-lg border-b border-blue-200 pb-2">Current Health (Vitals)</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                        <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                            <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Weight</p>
                                            <p className="text-xl font-bold text-slate-900">{selectedRecordForView.weight || selectedRecordForView.weightKg || 'N/A'}</p>
                                            {(selectedRecordForView.weight || selectedRecordForView.weightKg) && <p className="text-xs text-slate-500">kg</p>}
                                        </div>
                                        <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                            <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Height</p>
                                            <p className="text-xl font-bold text-slate-900">{selectedRecordForView.height || selectedRecordForView.heightCm || 'N/A'}</p>
                                            {(selectedRecordForView.height || selectedRecordForView.heightCm) && <p className="text-xs text-slate-500">cm</p>}
                                        </div>
                                        <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                            <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">BMI</p>
                                            <p className="text-xl font-bold text-slate-900">{selectedRecordForView.bmi || 'N/A'}</p>
                                        </div>
                                        <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                            <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Pulse</p>
                                            <p className="text-xl font-bold text-slate-900">{selectedRecordForView.pulse || selectedRecordForView.pulseRate || 'N/A'}</p>
                                            {(selectedRecordForView.pulse || selectedRecordForView.pulseRate) && <p className="text-xs text-slate-500">bpm</p>}
                                        </div>
                                        <div className="bg-white rounded-lg p-3 text-center border border-blue-100">
                                            <p className="text-xs text-blue-600 uppercase mb-1 font-semibold">Temp</p>
                                            <p className="text-xl font-bold text-slate-900">{selectedRecordForView.temperature || selectedRecordForView.bodyTemperature || 'N/A'}</p>
                                            {(selectedRecordForView.temperature || selectedRecordForView.bodyTemperature) && <p className="text-xs text-slate-500">Â°C</p>}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Orange - Identification Details Section */}
                                <div className="bg-orange-50 rounded-xl p-5 border border-orange-200">
                                    <h4 className="font-bold text-orange-800 mb-4 text-lg border-b border-orange-200 pb-2">Identification Details</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <p className="text-xs font-semibold text-orange-600 uppercase mb-1">Aadhaar Number</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.aadhaarNumber || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-orange-600 uppercase mb-1">Insurance</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.insuranceDetails || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-orange-600 uppercase mb-1">Birth Mark</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.birthMark || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Green - Lifestyle Section */}
                                <div className="bg-green-50 rounded-xl p-5 border border-green-200">
                                    <h4 className="font-bold text-green-800 mb-4 text-lg border-b border-green-200 pb-2">Lifestyle</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <div>
                                            <p className="text-xs font-semibold text-green-600 uppercase mb-1">Smoking</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.smokingStatus || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-green-600 uppercase mb-1">Alcohol</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.alcoholConsumption || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-green-600 uppercase mb-1">Diet</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.dietPreference || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-green-600 uppercase mb-1">Activity</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.physicalActivityLevel || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-green-600 uppercase mb-1">Sleep</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.sleepHours ? `${selectedRecordForView.sleepHours} hrs/night` : 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs font-semibold text-green-600 uppercase mb-1">Stress Level</p>
                                            <p className="font-medium text-slate-900">{selectedRecordForView.stressLevel || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Purple - Description/Notes Section */}
                                {selectedRecordForView.description && (
                                    <div className="bg-purple-50 rounded-xl p-5 border border-purple-200">
                                        <h4 className="font-bold text-purple-800 mb-4 text-lg border-b border-purple-200 pb-2">Description / Notes</h4>
                                        <p className="text-slate-700">{selectedRecordForView.description}</p>
                                    </div>
                                )}
                            </div>
                            
                            {/* Footer - Full Width Purple Download Button */}
                            <div className="p-6 border-t border-slate-200">
                                <button 
                                    onClick={() => {
                                        const docPath = selectedRecordForView.documentPath || selectedRecordForView.document_path || selectedRecordForView.filePath;
                                        if (docPath) {
                                            const fileUrl = `http://localhost:8080/${docPath.startsWith('/') ? docPath.substring(1) : docPath}`;
                                            const link = document.createElement('a');
                                            link.href = fileUrl;
                                            link.download = selectedRecordForView.title || 'health-record';
                                            link.target = '_blank';
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        } else {
                                            alert('No document available for download');
                                        }
                                    }}
                                    className="w-full flex items-center justify-center gap-2 px-6 py-4 bg-[#7209B7] text-white rounded-xl font-bold text-lg hover:bg-[#5c078f] transition-colors shadow-lg">
                                    <Icon name="Download" size={22} />
                                    Download Attached Document
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Invite Doctor Modal */}
                {showInviteDoctorModal && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-fadeIn">
                            <div className="sticky top-0 bg-white p-6 pb-4 border-b border-slate-100 z-10">
                                <div className="text-center">
                                    <div className="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-2 border-purple-100">
                                        <img src="/medvault-logo.png" alt="MedVault" className="w-14 h-14 object-contain" />
                                    </div>
                                    <h2 className="text-2xl font-bold text-slate-800">Invite Doctor to MedVault</h2>
                                    <p className="text-slate-500 mt-2">Send a professional invitation to join our platform</p>
                                </div>
                            </div>
                            
                            <div className="p-6 pt-4">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">Doctor's Name</label>
                                        <input 
                                            type="text"
                                            value={inviteDoctorName}
                                            onChange={(e) => setInviteDoctorName(e.target.value)}
                                            placeholder="Dr. Rajesh Kumar"
                                            className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">Doctor's Email</label>
                                        <input 
                                            type="email"
                                            value={inviteDoctorEmail}
                                            onChange={(e) => setInviteDoctorEmail(e.target.value)}
                                            placeholder="doctor@hospital.com"
                                            className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                        />
                                    </div>
                                </div>
                                
                                {/* Preview Email - Left Aligned */}
                                <div className="mt-6 bg-slate-50 rounded-xl p-4 border border-slate-200">
                                    <p className="text-xs text-slate-500 mb-2 font-semibold">EMAIL PREVIEW</p>
                                    <div className="bg-white rounded-lg p-4 border border-slate-100 text-sm text-left">
                                        <div className="flex items-center gap-2 mb-3 pb-3 border-b border-slate-100">
                                            <img src="/medvault-logo.png" alt="MedVault" className="w-8 h-8 object-contain" />
                                            <span className="font-bold text-purple-600">MedVault</span>
                                        </div>
                                        <p className="text-slate-700 mb-2">Hello <strong>{inviteDoctorName || 'Doctor'}</strong>! ðŸ‘‹</p>
                                        <p className="text-slate-600 mb-3">We are <strong>thrilled</strong> to invite you to join <strong className="text-purple-600">MedVault</strong> - India's most trusted healthcare management platform! ðŸŽ‰</p>
                                        <p className="text-slate-700 mb-2 font-semibold">âœ¨ As a MedVault practitioner, you will be able to:</p>
                                        <ul className="text-slate-600 text-xs mb-3 ml-1 space-y-1.5">
                                            <li>ðŸ“… Manage your appointments efficiently</li>
                                            <li>ðŸ”’ Access patient medical records (with consent)</li>
                                            <li>ðŸ—“ï¸ Set and customize your availability</li>
                                            <li>ðŸ’° Specify and update your consultation fees</li>
                                            <li>ðŸ’¬ Communicate with patients through secure messaging</li>
                                            <li>ðŸ‘¤ Maintain and enhance your professional profile</li>
                                            <li>â­ View and monitor patient feedback and ratings</li>
                                            <li>ðŸ“Š Track your earnings and payment settlements</li>
                                        </ul>
                                        <p className="text-slate-600 mb-3">Ready to transform your practice? Click below to register! ðŸš€</p>
                                        <div className="bg-purple-600 text-white py-2 px-4 rounded-lg text-xs font-semibold inline-block">ðŸŽ¯ Register Now â†’</div>
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => {
                                            setShowInviteDoctorModal(false);
                                            setInviteDoctorEmail('');
                                            setInviteDoctorName('');
                                        }}
                                        className="flex-1 px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50 transition-colors">
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            if (!inviteDoctorEmail || !inviteDoctorEmail.includes('@')) {
                                                alert('âŒ Please enter a valid email address');
                                                return;
                                            }
                                            try {
                                                const response = await fetch(`${API_BASE_URL}/admin/invite-doctor`, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({
                                                        email: inviteDoctorEmail,
                                                        name: inviteDoctorName || 'Doctor'
                                                    })
                                                });
                                                if (response.ok) {
                                                    alert(`âœ… Invitation email sent successfully to ${inviteDoctorEmail}!`);
                                                    setShowInviteDoctorModal(false);
                                                    setInviteDoctorEmail('');
                                                    setInviteDoctorName('');
                                                } else {
                                                    const error = await response.json();
                                                    alert(`âŒ Failed to send invitation: ${error.message || 'Unknown error'}`);
                                                }
                                            } catch (error) {
                                                console.error('Error sending invitation:', error);
                                                alert('âŒ Failed to send invitation. Please check if the backend is running.');
                                            }
                                        }}
                                        className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-2">
                                        <Icon name="Send" size={18} />
                                        Send Invitation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Reschedule Appointment Modal */}
                {showRescheduleModal && selectedAppointmentForReschedule && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-fadeIn">
                            <div className="sticky top-0 bg-white p-6 pb-4 border-b border-slate-100 z-10">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <h2 className="text-xl font-bold text-slate-800">Reschedule Appointment</h2>
                                        <p className="text-slate-500 text-sm mt-1">Change date and time for this appointment</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            setShowRescheduleModal(false);
                                            setSelectedAppointmentForReschedule(null);
                                        }}
                                        className="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                        <Icon name="X" size={24} className="text-slate-500" />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-6">
                                {/* Current Appointment Info */}
                                <div className="bg-slate-50 rounded-xl p-4 mb-6">
                                    <p className="text-xs text-slate-500 font-semibold mb-3">CURRENT APPOINTMENT</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <p className="text-xs text-slate-500">Patient</p>
                                            <p className="font-semibold text-slate-800">{selectedAppointmentForReschedule.patientName}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Doctor</p>
                                            <p className="font-semibold text-indigo-600">{selectedAppointmentForReschedule.doctorName}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Current Date</p>
                                            <p className="font-semibold text-slate-800">{selectedAppointmentForReschedule.date}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500">Current Time</p>
                                            <p className="font-semibold text-slate-800">{selectedAppointmentForReschedule.time}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* New Date Selection */}
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">Select New Date</label>
                                        <input 
                                            type="date"
                                            value={rescheduleDate}
                                            onChange={(e) => {
                                                setRescheduleDate(e.target.value);
                                                setRescheduleTime('');
                                                setRescheduleSlotId(null); // Reset slot ID when date changes
                                                // Filter slots for selected date from already fetched slots
                                                const filteredSlots = allDoctorSlots.filter(s => s.slotDate === e.target.value);
                                                setAvailableSlotsForReschedule(filteredSlots);
                                            }}
                                            min={new Date().toISOString().split('T')[0]}
                                            className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                        />
                                    </div>
                                    
                                    {rescheduleDate && (() => {
                                        // Check slot availability for the selected date
                                        const allSlotsForDate = allDoctorSlotsIncludingBooked.filter(s => s.slotDate === rescheduleDate);
                                        const availableSlotsForDate = allSlotsForDate.filter(s => s.isAvailable);
                                        
                                        // Doctor has no slots defined at all
                                        const doctorHasNoSlots = allDoctorSlotsIncludingBooked.length === 0;
                                        // Doctor has no slots for this specific date
                                        const noSlotsForThisDate = allSlotsForDate.length === 0;
                                        // Doctor has slots for this date but all are booked
                                        const allSlotsBookedForDate = allSlotsForDate.length > 0 && availableSlotsForDate.length === 0;
                                        // Doctor has available slots for this date
                                        const hasAvailableSlots = availableSlotsForDate.length > 0;
                                        
                                        // Generate default time slots for when doctor has no slots
                                        const defaultTimeSlots = [];
                                        for (let hour = 8; hour < 20; hour++) {
                                            defaultTimeSlots.push(`${hour.toString().padStart(2, '0')}:00:00`);
                                            defaultTimeSlots.push(`${hour.toString().padStart(2, '0')}:30:00`);
                                        }
                                        
                                        return (
                                        <div>
                                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                                                {hasAvailableSlots 
                                                    ? `Available Slots for ${rescheduleDate} (${availableSlotsForDate.length} available)`
                                                    : allSlotsBookedForDate 
                                                        ? `No slots available for ${rescheduleDate}`
                                                        : `Select Time Slot`
                                                }
                                            </label>
                                            {hasAvailableSlots ? (
                                                /* Doctor has available slots - show them */
                                                <div className="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                                                    {availableSlotsForDate.map(slot => (
                                                        <button
                                                            key={slot.slotId}
                                                            onClick={() => {
                                                                setRescheduleTime(slot.slotTime);
                                                                setRescheduleSlotId(slot.slotId); // Track the slot ID
                                                                if (slot.slotDate) setRescheduleDate(slot.slotDate);
                                                            }}
                                                            className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                                                rescheduleSlotId === slot.slotId
                                                                    ? 'bg-purple-600 text-white shadow-lg'
                                                                    : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                                                            }`}>
                                                            <div>{slot.slotTime}</div>
                                                        </button>
                                                    ))}
                                                </div>
                                            ) : allSlotsBookedForDate ? (
                                                /* Doctor has slots for this date but all are booked */
                                                <div className="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                                                    <Icon name="AlertCircle" size={24} className="mx-auto text-red-500 mb-2" />
                                                    <p className="text-red-700 font-medium">All slots are booked for this date</p>
                                                    <p className="text-red-600 text-sm mt-1">Please select a different date</p>
                                                </div>
                                            ) : (
                                                /* Doctor has no slots defined for this date - allow any time */
                                                <div>
                                                    <div className="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-3">
                                                        <p className="text-amber-700 text-sm">No pre-defined slots for this date. Select a time below:</p>
                                                    </div>
                                                    <select
                                                        value={rescheduleTime}
                                                        onChange={(e) => setRescheduleTime(e.target.value)}
                                                        className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none bg-white"
                                                    >
                                                        <option value="">-- Select Time Slot --</option>
                                                        {defaultTimeSlots.map(time => {
                                                            const [h, m] = time.split(':');
                                                            const endH = m === '00' ? h : (parseInt(h) + 1).toString().padStart(2, '0');
                                                            const endM = m === '00' ? '30' : '00';
                                                            return (
                                                                <option key={time} value={time}>
                                                                    {h}:{m.substring(0,2)} - {endH}:{endM}
                                                                </option>
                                                            );
                                                        })}
                                                    </select>
                                                </div>
                                            )}
                                        </div>
                                        );
                                    })()}
                                    
                                    {!rescheduleDate && (
                                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                                            <Icon name="Calendar" size={24} className="mx-auto text-blue-500 mb-2" />
                                            <p className="text-blue-700 font-medium">Select a date to see available slots</p>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button 
                                        onClick={() => {
                                            setShowRescheduleModal(false);
                                            setSelectedAppointmentForReschedule(null);
                                            setRescheduleSlotId(null); // Reset slot ID
                                        }}
                                        className="flex-1 px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50 transition-colors">
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            if (!rescheduleDate || !rescheduleTime) {
                                                alert('âŒ Please select both date and time');
                                                return;
                                            }
                                            try {
                                                // Combine date and time into ISO format
                                                const appointmentDateTime = `${rescheduleDate}T${rescheduleTime}:00`;
                                                const response = await fetch(`${API_BASE_URL}/appointments/${selectedAppointmentForReschedule.id}`, {
                                                    method: 'PUT',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({
                                                        appointmentDateTime: appointmentDateTime,
                                                        reason: selectedAppointmentForReschedule.reason || 'Rescheduled appointment',
                                                        slotId: rescheduleSlotId // Include the new slot ID
                                                    })
                                                });
                                                if (response.ok) {
                                                    alert(`âœ… Appointment rescheduled successfully to ${rescheduleDate} at ${rescheduleTime}!`);
                                                    setShowRescheduleModal(false);
                                                    setSelectedAppointmentForReschedule(null);
                                                    setRescheduleSlotId(null); // Reset slot ID
                                                    fetchAllData();
                                                } else {
                                                    const error = await response.text();
                                                    alert(`âŒ Failed to reschedule: ${error || 'Unknown error'}`);
                                                }
                                            } catch (error) {
                                                console.error('Error rescheduling:', error);
                                                alert('âŒ Failed to reschedule. Please try again.');
                                            }
                                        }}
                                        disabled={!rescheduleDate || !rescheduleTime}
                                        className={`flex-1 px-6 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 ${
                                            rescheduleDate && rescheduleTime
                                                ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:shadow-lg'
                                                : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                        }`}>
                                        <Icon name="Calendar" size={18} />
                                        Confirm Reschedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Document View Modal */}
                {showDocumentViewModal && selectedDocumentForView && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8 animate-fadeIn">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-slate-800">Document Preview</h2>
                                <button 
                                    onClick={() => {
                                        setShowDocumentViewModal(false);
                                        setSelectedDocumentForView(null);
                                    }}
                                    className="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                    <Icon name="X" size={24} className="text-slate-500" />
                                </button>
                            </div>
                            
                            <div className="bg-slate-50 rounded-xl p-4 mb-4">
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p className="text-slate-500">Doctor</p>
                                        <p className="font-semibold text-slate-800">{selectedDocumentForView.doctorName}</p>
                                    </div>
                                    <div>
                                        <p className="text-slate-500">Document Type</p>
                                        <p className="font-semibold text-slate-800">{selectedDocumentForView.documentType}</p>
                                    </div>
                                    <div>
                                        <p className="text-slate-500">Document Name</p>
                                        <p className="font-semibold text-slate-800">{selectedDocumentForView.documentName}</p>
                                    </div>
                                    <div>
                                        <p className="text-slate-500">Upload Date</p>
                                        <p className="font-semibold text-slate-800">{selectedDocumentForView.uploadedDate}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="border border-slate-200 rounded-xl overflow-hidden mb-4">
                                <img 
                                    src="https://static.toiimg.com/thumb/msid-65879382,imgsize-341916,width-400,height-225,resizemode-72/certifictae.jpg"
                                    alt="Certificate Preview"
                                    className="w-full h-64 object-contain bg-slate-100"
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button 
                                    onClick={() => {
                                        setShowDocumentViewModal(false);
                                        setSelectedDocumentForView(null);
                                    }}
                                    className="flex-1 px-6 py-3 border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50 transition-colors">
                                    Close
                                </button>
                                <button 
                                    onClick={() => handleVerifyDocument(selectedDocumentForView.id)}
                                    className="flex-1 px-6 py-3 bg-emerald-600 text-white rounded-xl font-semibold hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                                    <Icon name="CheckCircle" size={18} />
                                    Verify Document
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // 4. Main App Component
    function App() {
        const [user, setUser] = useState(null);
        const [loadingUser, setLoadingUser] = useState(true);
        
        // Restore session on page load
        useEffect(() => {
            const storedUser = sessionStorage.getItem('adminUser');
            if (storedUser) {
                try {
                    setUser(JSON.parse(storedUser));
                } catch (error) {
                    console.error('Failed to parse stored user:', error);
                    sessionStorage.removeItem('adminUser');
                }
            }
            setLoadingUser(false);
        }, []);
        
        const handleLogin = async (type, email) => {
            if (type === 'admin') {
                setLoadingUser(true);
                try {
                    const adminProfile = await fetchAdminProfile(email);
                    setUser(adminProfile);
                    // Store in sessionStorage
                    sessionStorage.setItem('adminUser', JSON.stringify(adminProfile));
                } catch (error) {
                    console.error('Failed to fetch admin profile:', error);
                    // Don't use mock admin - show error instead
                    alert('Failed to load admin profile. Please try again.');
                    setUser(null);
                } finally {
                    setLoadingUser(false);
                }
            }
        };
        
        const handleLogout = () => {
            setUser(null);
            sessionStorage.removeItem('adminUser');
        };
        
        if (loadingUser) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 to-indigo-700">
                    <div className="text-center text-white">
                        <div className="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <p className="text-lg font-medium">Loading admin profile...</p>
                    </div>
                </div>
            );
        }
        
        return (
            <>
                {!user ? (
                    <Login onLogin={handleLogin} />
                ) : (
                    <AdminDashboard user={user} onLogout={handleLogout} />
                )}
            </>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
    .animate-pulse-slow { animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
</style>
</body>
</html>